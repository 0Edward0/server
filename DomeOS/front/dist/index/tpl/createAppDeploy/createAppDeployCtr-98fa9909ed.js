'use strict';

domeApp.controller('CreateAppDeployCtr', ['$scope', '$domeAppStore', '$domeCluster', '$domeUser', '$state', '$stateParams', '$domePublic', function ($scope, $domeAppStore, $domeCluster, $domeUser, $state, $stateParams, $domePublic) {
	'use strict';

	if (!$stateParams.appName) {
		$state.go('appStore');
	}
	$scope.$emit('pageTitle', {
		title: $stateParams.appName,
		descrition: '',
		mod: 'appStore'
	});
	var appData = void 0;
	var nodeService = $domeCluster.getInstance('NodeService');
	$domeAppStore.getStoreApps().then(function (res) {
		var isExist = false;
		if (res.data) {
			for (var i = 0; i < res.data.length; i++) {
				if (res.data[i].appName === $stateParams.appName) {
					isExist = true;
					appData = res.data[i];
					break;
				}
			}
			if (!isExist) {
				$domePublic.openWarning('无相关应用数据');
				$state.go('appStore');
			} else {
				var logDraft = {
					logItemDrafts: []
				};
				var logPathList = appData.deploymentTemplate.logPathList;
				if (!logPathList) {
					logPathList = [];
				}
				for (var j = 0; j < logPathList.length; j++) {
					logDraft.logItemDrafts.push({
						logPath: logPathList[j],
						autoCollect: false,
						autoDelete: false
					});
				}
				delete appData.deploymentTemplate.logPathList;
				// 转换为部署需要的日志格式
				appData.deploymentTemplate.logDraft = logDraft;
				appData.deploymentTemplate.networkMode = 'DEFAULT';
				$scope.appInfoIns = $domeAppStore.getInstance('AppInfo', appData);
				$scope.config = $scope.appInfoIns.config;
				$scope.deployIns = $scope.appInfoIns.deployIns;
				$scope.deployConfig = $scope.deployIns.config;
				nodeService.getData().then(function (res) {
					$scope.deployIns.clusterListIns.init(res.data.result);
					$scope.deployIns.toggleCluster();
				});
				// $domeUser.userService.getGroupList().then(function(res) {
				// 	$scope.deployIns.userGroupListIns.init(res.data.result);
				// }).finally(function() {});
			}
		} else {
				$domePublic.openWarning('请求失败！');
				$state.go('appStore');
			}
	}, function () {
		$domePublic.openWarning('请求失败！');
		$state.go('appStore');
	});

	$scope.createDeploy = function () {
		$scope.isLoading = true;
		$scope.deployIns.create().then(function () {
			$domePublic.openPrompt('创建成功！');
			$state.go('deployManage');
		}, function (res) {
			if (res.type == 'namespace') {
				$domePublic.openWarning({
					title: '创建namespace失败！',
					msg: 'Msg:' + res.msg
				});
			} else {
				$domePublic.openWarning({
					title: '创建失败！',
					msg: 'Msg:' + res.msg
				});
			}
		}).finally(function () {
			$scope.isLoading = false;
		});
	};
}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4L3RwbC9jcmVhdGVBcHBEZXBsb3kvY3JlYXRlQXBwRGVwbG95Q3RyLmVzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsUUFBUSxVQUFSLENBQW1CLG9CQUFuQixFQUF5QyxDQUFDLFFBQUQsRUFBVyxlQUFYLEVBQTRCLGNBQTVCLEVBQTRDLFdBQTVDLEVBQXlELFFBQXpELEVBQW1FLGNBQW5FLEVBQW1GLGFBQW5GLEVBQWtHLFVBQVMsTUFBVCxFQUFpQixhQUFqQixFQUFnQyxZQUFoQyxFQUE4QyxTQUE5QyxFQUF5RCxNQUF6RCxFQUFpRSxZQUFqRSxFQUErRSxXQUEvRSxFQUE0RjtBQUN0TyxjQURzTzs7QUFFdE8sS0FBSSxDQUFDLGFBQWEsT0FBYixFQUFzQjtBQUMxQixTQUFPLEVBQVAsQ0FBVSxVQUFWLEVBRDBCO0VBQTNCO0FBR0EsUUFBTyxLQUFQLENBQWEsV0FBYixFQUEwQjtBQUN6QixTQUFPLGFBQWEsT0FBYjtBQUNQLGNBQVksRUFBWjtBQUNBLE9BQUssVUFBTDtFQUhELEVBTHNPO0FBVXRPLEtBQUksZ0JBQUosQ0FWc087QUFXdE8sS0FBTSxjQUFjLGFBQWEsV0FBYixDQUF5QixhQUF6QixDQUFkLENBWGdPO0FBWXRPLGVBQWMsWUFBZCxHQUE2QixJQUE3QixDQUFrQyxVQUFTLEdBQVQsRUFBYztBQUMvQyxNQUFJLFVBQVUsS0FBVixDQUQyQztBQUUvQyxNQUFJLElBQUksSUFBSixFQUFVO0FBQ2IsUUFBSyxJQUFJLElBQUksQ0FBSixFQUFPLElBQUksSUFBSSxJQUFKLENBQVMsTUFBVCxFQUFpQixHQUFyQyxFQUEwQztBQUN6QyxRQUFJLElBQUksSUFBSixDQUFTLENBQVQsRUFBWSxPQUFaLEtBQXdCLGFBQWEsT0FBYixFQUFzQjtBQUNqRCxlQUFVLElBQVYsQ0FEaUQ7QUFFakQsZUFBVSxJQUFJLElBQUosQ0FBUyxDQUFULENBQVYsQ0FGaUQ7QUFHakQsV0FIaUQ7S0FBbEQ7SUFERDtBQU9BLE9BQUksQ0FBQyxPQUFELEVBQVU7QUFDYixnQkFBWSxXQUFaLENBQXdCLFNBQXhCLEVBRGE7QUFFYixXQUFPLEVBQVAsQ0FBVSxVQUFWLEVBRmE7SUFBZCxNQUdPO0FBQ04sUUFBSSxXQUFXO0FBQ2Qsb0JBQWUsRUFBZjtLQURHLENBREU7QUFJTixRQUFJLGNBQWMsUUFBUSxrQkFBUixDQUEyQixXQUEzQixDQUpaO0FBS04sUUFBSSxDQUFDLFdBQUQsRUFBYztBQUNqQixtQkFBYyxFQUFkLENBRGlCO0tBQWxCO0FBR0EsU0FBSyxJQUFJLElBQUksQ0FBSixFQUFPLElBQUksWUFBWSxNQUFaLEVBQW9CLEdBQXhDLEVBQTZDO0FBQzVDLGNBQVMsYUFBVCxDQUF1QixJQUF2QixDQUE0QjtBQUMzQixlQUFTLFlBQVksQ0FBWixDQUFUO0FBQ0EsbUJBQWEsS0FBYjtBQUNBLGtCQUFZLEtBQVo7TUFIRCxFQUQ0QztLQUE3QztBQU9BLFdBQU8sUUFBUSxrQkFBUixDQUEyQixXQUEzQjs7QUFmRCxXQWlCTixDQUFRLGtCQUFSLENBQTJCLFFBQTNCLEdBQXNDLFFBQXRDLENBakJNO0FBa0JOLFlBQVEsa0JBQVIsQ0FBMkIsV0FBM0IsR0FBeUMsU0FBekMsQ0FsQk07QUFtQk4sV0FBTyxVQUFQLEdBQW9CLGNBQWMsV0FBZCxDQUEwQixTQUExQixFQUFxQyxPQUFyQyxDQUFwQixDQW5CTTtBQW9CTixXQUFPLE1BQVAsR0FBZ0IsT0FBTyxVQUFQLENBQWtCLE1BQWxCLENBcEJWO0FBcUJOLFdBQU8sU0FBUCxHQUFtQixPQUFPLFVBQVAsQ0FBa0IsU0FBbEIsQ0FyQmI7QUFzQk4sV0FBTyxZQUFQLEdBQXNCLE9BQU8sU0FBUCxDQUFpQixNQUFqQixDQXRCaEI7QUF1Qk4sZ0JBQVksT0FBWixHQUFzQixJQUF0QixDQUEyQixVQUFTLEdBQVQsRUFBYztBQUN4QyxZQUFPLFNBQVAsQ0FBaUIsY0FBakIsQ0FBZ0MsSUFBaEMsQ0FBcUMsSUFBSSxJQUFKLENBQVMsTUFBVCxDQUFyQyxDQUR3QztBQUV4QyxZQUFPLFNBQVAsQ0FBaUIsYUFBakIsR0FGd0M7S0FBZCxDQUEzQjs7OztBQXZCTSxJQUhQO0dBUkQsTUEwQ087QUFDTixnQkFBWSxXQUFaLENBQXdCLE9BQXhCLEVBRE07QUFFTixXQUFPLEVBQVAsQ0FBVSxVQUFWLEVBRk07SUExQ1A7RUFGaUMsRUFnRC9CLFlBQVc7QUFDYixjQUFZLFdBQVosQ0FBd0IsT0FBeEIsRUFEYTtBQUViLFNBQU8sRUFBUCxDQUFVLFVBQVYsRUFGYTtFQUFYLENBaERILENBWnNPOztBQWlFdE8sUUFBTyxZQUFQLEdBQXNCLFlBQVc7QUFDaEMsU0FBTyxTQUFQLEdBQW1CLElBQW5CLENBRGdDO0FBRWhDLFNBQU8sU0FBUCxDQUFpQixNQUFqQixHQUEwQixJQUExQixDQUErQixZQUFXO0FBQ3pDLGVBQVksVUFBWixDQUF1QixPQUF2QixFQUR5QztBQUV6QyxVQUFPLEVBQVAsQ0FBVSxjQUFWLEVBRnlDO0dBQVgsRUFHNUIsVUFBUyxHQUFULEVBQWM7QUFDaEIsT0FBSSxJQUFJLElBQUosSUFBWSxXQUFaLEVBQXlCO0FBQzVCLGdCQUFZLFdBQVosQ0FBd0I7QUFDdkIsWUFBTyxnQkFBUDtBQUNBLFVBQUssU0FBUyxJQUFJLEdBQUo7S0FGZixFQUQ0QjtJQUE3QixNQUtPO0FBQ04sZ0JBQVksV0FBWixDQUF3QjtBQUN2QixZQUFPLE9BQVA7QUFDQSxVQUFLLFNBQVMsSUFBSSxHQUFKO0tBRmYsRUFETTtJQUxQO0dBREUsQ0FISCxDQWVHLE9BZkgsQ0FlVyxZQUFXO0FBQ3JCLFVBQU8sU0FBUCxHQUFtQixLQUFuQixDQURxQjtHQUFYLENBZlgsQ0FGZ0M7RUFBWCxDQWpFZ047Q0FBNUYsQ0FBM0kiLCJmaWxlIjoiaW5kZXgvdHBsL2NyZWF0ZUFwcERlcGxveS9jcmVhdGVBcHBEZXBsb3lDdHIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJkb21lQXBwLmNvbnRyb2xsZXIoJ0NyZWF0ZUFwcERlcGxveUN0cicsIFsnJHNjb3BlJywgJyRkb21lQXBwU3RvcmUnLCAnJGRvbWVDbHVzdGVyJywgJyRkb21lVXNlcicsICckc3RhdGUnLCAnJHN0YXRlUGFyYW1zJywgJyRkb21lUHVibGljJywgZnVuY3Rpb24oJHNjb3BlLCAkZG9tZUFwcFN0b3JlLCAkZG9tZUNsdXN0ZXIsICRkb21lVXNlciwgJHN0YXRlLCAkc3RhdGVQYXJhbXMsICRkb21lUHVibGljKSB7XG5cdCd1c2Ugc3RyaWN0Jztcblx0aWYgKCEkc3RhdGVQYXJhbXMuYXBwTmFtZSkge1xuXHRcdCRzdGF0ZS5nbygnYXBwU3RvcmUnKTtcblx0fVxuXHQkc2NvcGUuJGVtaXQoJ3BhZ2VUaXRsZScsIHtcblx0XHR0aXRsZTogJHN0YXRlUGFyYW1zLmFwcE5hbWUsXG5cdFx0ZGVzY3JpdGlvbjogJycsXG5cdFx0bW9kOiAnYXBwU3RvcmUnXG5cdH0pO1xuXHRsZXQgYXBwRGF0YTtcblx0Y29uc3Qgbm9kZVNlcnZpY2UgPSAkZG9tZUNsdXN0ZXIuZ2V0SW5zdGFuY2UoJ05vZGVTZXJ2aWNlJyk7XG5cdCRkb21lQXBwU3RvcmUuZ2V0U3RvcmVBcHBzKCkudGhlbihmdW5jdGlvbihyZXMpIHtcblx0XHRsZXQgaXNFeGlzdCA9IGZhbHNlO1xuXHRcdGlmIChyZXMuZGF0YSkge1xuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCByZXMuZGF0YS5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRpZiAocmVzLmRhdGFbaV0uYXBwTmFtZSA9PT0gJHN0YXRlUGFyYW1zLmFwcE5hbWUpIHtcblx0XHRcdFx0XHRpc0V4aXN0ID0gdHJ1ZTtcblx0XHRcdFx0XHRhcHBEYXRhID0gcmVzLmRhdGFbaV07XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGlmICghaXNFeGlzdCkge1xuXHRcdFx0XHQkZG9tZVB1YmxpYy5vcGVuV2FybmluZygn5peg55u45YWz5bqU55So5pWw5o2uJyk7XG5cdFx0XHRcdCRzdGF0ZS5nbygnYXBwU3RvcmUnKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGxldCBsb2dEcmFmdCA9IHtcblx0XHRcdFx0XHRsb2dJdGVtRHJhZnRzOiBbXVxuXHRcdFx0XHR9O1xuXHRcdFx0XHRsZXQgbG9nUGF0aExpc3QgPSBhcHBEYXRhLmRlcGxveW1lbnRUZW1wbGF0ZS5sb2dQYXRoTGlzdDtcblx0XHRcdFx0aWYgKCFsb2dQYXRoTGlzdCkge1xuXHRcdFx0XHRcdGxvZ1BhdGhMaXN0ID0gW107XG5cdFx0XHRcdH1cblx0XHRcdFx0Zm9yIChsZXQgaiA9IDA7IGogPCBsb2dQYXRoTGlzdC5sZW5ndGg7IGorKykge1xuXHRcdFx0XHRcdGxvZ0RyYWZ0LmxvZ0l0ZW1EcmFmdHMucHVzaCh7XG5cdFx0XHRcdFx0XHRsb2dQYXRoOiBsb2dQYXRoTGlzdFtqXSxcblx0XHRcdFx0XHRcdGF1dG9Db2xsZWN0OiBmYWxzZSxcblx0XHRcdFx0XHRcdGF1dG9EZWxldGU6IGZhbHNlXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0ZGVsZXRlIGFwcERhdGEuZGVwbG95bWVudFRlbXBsYXRlLmxvZ1BhdGhMaXN0O1xuXHRcdFx0XHQvLyDovazmjaLkuLrpg6jnvbLpnIDopoHnmoTml6Xlv5fmoLzlvI9cblx0XHRcdFx0YXBwRGF0YS5kZXBsb3ltZW50VGVtcGxhdGUubG9nRHJhZnQgPSBsb2dEcmFmdDtcblx0XHRcdFx0YXBwRGF0YS5kZXBsb3ltZW50VGVtcGxhdGUubmV0d29ya01vZGUgPSAnREVGQVVMVCc7XG5cdFx0XHRcdCRzY29wZS5hcHBJbmZvSW5zID0gJGRvbWVBcHBTdG9yZS5nZXRJbnN0YW5jZSgnQXBwSW5mbycsIGFwcERhdGEpO1xuXHRcdFx0XHQkc2NvcGUuY29uZmlnID0gJHNjb3BlLmFwcEluZm9JbnMuY29uZmlnO1xuXHRcdFx0XHQkc2NvcGUuZGVwbG95SW5zID0gJHNjb3BlLmFwcEluZm9JbnMuZGVwbG95SW5zO1xuXHRcdFx0XHQkc2NvcGUuZGVwbG95Q29uZmlnID0gJHNjb3BlLmRlcGxveUlucy5jb25maWc7XG5cdFx0XHRcdG5vZGVTZXJ2aWNlLmdldERhdGEoKS50aGVuKGZ1bmN0aW9uKHJlcykge1xuXHRcdFx0XHRcdCRzY29wZS5kZXBsb3lJbnMuY2x1c3Rlckxpc3RJbnMuaW5pdChyZXMuZGF0YS5yZXN1bHQpO1xuXHRcdFx0XHRcdCRzY29wZS5kZXBsb3lJbnMudG9nZ2xlQ2x1c3RlcigpO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0Ly8gJGRvbWVVc2VyLnVzZXJTZXJ2aWNlLmdldEdyb3VwTGlzdCgpLnRoZW4oZnVuY3Rpb24ocmVzKSB7XG5cdFx0XHRcdC8vIFx0JHNjb3BlLmRlcGxveUlucy51c2VyR3JvdXBMaXN0SW5zLmluaXQocmVzLmRhdGEucmVzdWx0KTtcblx0XHRcdFx0Ly8gfSkuZmluYWxseShmdW5jdGlvbigpIHt9KTtcblx0XHRcdH1cblx0XHR9IGVsc2Uge1xuXHRcdFx0JGRvbWVQdWJsaWMub3Blbldhcm5pbmcoJ+ivt+axguWksei0pe+8gScpO1xuXHRcdFx0JHN0YXRlLmdvKCdhcHBTdG9yZScpO1xuXHRcdH1cblx0fSwgZnVuY3Rpb24oKSB7XG5cdFx0JGRvbWVQdWJsaWMub3Blbldhcm5pbmcoJ+ivt+axguWksei0pe+8gScpO1xuXHRcdCRzdGF0ZS5nbygnYXBwU3RvcmUnKTtcblx0fSk7XG5cblx0JHNjb3BlLmNyZWF0ZURlcGxveSA9IGZ1bmN0aW9uKCkge1xuXHRcdCRzY29wZS5pc0xvYWRpbmcgPSB0cnVlO1xuXHRcdCRzY29wZS5kZXBsb3lJbnMuY3JlYXRlKCkudGhlbihmdW5jdGlvbigpIHtcblx0XHRcdCRkb21lUHVibGljLm9wZW5Qcm9tcHQoJ+WIm+W7uuaIkOWKn++8gScpO1xuXHRcdFx0JHN0YXRlLmdvKCdkZXBsb3lNYW5hZ2UnKTtcblx0XHR9LCBmdW5jdGlvbihyZXMpIHtcblx0XHRcdGlmIChyZXMudHlwZSA9PSAnbmFtZXNwYWNlJykge1xuXHRcdFx0XHQkZG9tZVB1YmxpYy5vcGVuV2FybmluZyh7XG5cdFx0XHRcdFx0dGl0bGU6ICfliJvlu7puYW1lc3BhY2XlpLHotKXvvIEnLFxuXHRcdFx0XHRcdG1zZzogJ01zZzonICsgcmVzLm1zZ1xuXHRcdFx0XHR9KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdCRkb21lUHVibGljLm9wZW5XYXJuaW5nKHtcblx0XHRcdFx0XHR0aXRsZTogJ+WIm+W7uuWksei0pe+8gScsXG5cdFx0XHRcdFx0bXNnOiAnTXNnOicgKyByZXMubXNnXG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7XG5cdFx0XHQkc2NvcGUuaXNMb2FkaW5nID0gZmFsc2U7XG5cdFx0fSk7XG5cdH07XG59XSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
