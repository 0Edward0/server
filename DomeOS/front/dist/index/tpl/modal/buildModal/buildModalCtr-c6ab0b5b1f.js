'use strict';

(function (domeApp, undefined) {
	function BuildModalCtr(projectInfo, $domeProject, $domePublic, $modalInstance) {
		'use strict';

		var vm = this;
		vm.projectInfo = projectInfo;
		vm.loadingIns = $domePublic.getLoadingInstance();
		vm.buildWay = 'Branch';
		vm.searchKey = '';
		vm.imageTag = '';
		vm.selectedBranch = '';

		if (vm.projectInfo.hasCodeInfo) {
			vm.loadingIns.startLoading('branch');
			$domeProject.projectService.getBranches(vm.projectInfo.projectId).then(function (res) {
				vm.branches = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('branch');
			});
			vm.loadingIns.startLoading('tag');
			$domeProject.projectService.getTags(vm.projectInfo.projectId).then(function (res) {
				vm.tags = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('tag');
			});
		}

		vm.toggleBuildWay = function (type) {
			vm.buildWay = type;
			vm.searchKey = '';
			vm.selectedBranch = '';
		};
		vm.toggleBranch = function (branch) {
			vm.selectedBranch = branch;
			vm.searchKey = '';
		};
		vm.close = function () {
			$modalInstance.dismiss('cancel');
		};
		vm.toBuild = function () {
			var buildInfo = {
				projectId: vm.projectInfo.projectId,
				codeInfo: {}, //代码信息
				imageInfo: {} //镜像信息
			};
			if (vm.projectInfo.hasCodeInfo) {
				if (vm.buildWay == 'Branch') buildInfo.codeInfo.codeBranch = vm.selectedBranch;else buildInfo.codeInfo.codeTag = vm.selectedBranch;
			}

			if (vm.imageTag) {
				buildInfo.imageInfo.imageTag = vm.imageTag;
			}
			vm.loadingIns.startLoading('submit');
			$domeProject.projectService.build(buildInfo).then(function (res) {
				if (res.data.resultCode == 200) {
					$modalInstance.close();
					$domePublic.openPrompt('成功，正在构建！');
				} else {
					$modalInstance.close();
					$domePublic.openWarning('构建失败！错误信息：' + res.data.resultMsg);
				}
			}, function () {
				$domePublic.openWarning('构建失败，请重试！');
			}).finally(function () {
				vm.loadingIns.finishLoading('submit');
			});
		};
	}

	BuildModalCtr.$inject = ['projectInfo', '$domeProject', '$domePublic', '$modalInstance'];
	domeApp.controller('BuildModalCtr', BuildModalCtr);
})(window.domeApp);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4L3RwbC9tb2RhbC9idWlsZE1vZGFsL2J1aWxkTW9kYWxDdHIuZXMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxDQUFDLFVBQUMsT0FBRCxFQUFVLFNBQVYsRUFBd0I7QUFDeEIsVUFBUyxhQUFULENBQXVCLFdBQXZCLEVBQW9DLFlBQXBDLEVBQWtELFdBQWxELEVBQStELGNBQS9ELEVBQStFO0FBQzlFLGVBRDhFOztBQUU5RSxNQUFJLEtBQUssSUFBTCxDQUYwRTtBQUc5RSxLQUFHLFdBQUgsR0FBaUIsV0FBakIsQ0FIOEU7QUFJOUUsS0FBRyxVQUFILEdBQWdCLFlBQVksa0JBQVosRUFBaEIsQ0FKOEU7QUFLOUUsS0FBRyxRQUFILEdBQWMsUUFBZCxDQUw4RTtBQU05RSxLQUFHLFNBQUgsR0FBZSxFQUFmLENBTjhFO0FBTzlFLEtBQUcsUUFBSCxHQUFjLEVBQWQsQ0FQOEU7QUFROUUsS0FBRyxjQUFILEdBQW9CLEVBQXBCLENBUjhFOztBQVU5RSxNQUFJLEdBQUcsV0FBSCxDQUFlLFdBQWYsRUFBNEI7QUFDL0IsTUFBRyxVQUFILENBQWMsWUFBZCxDQUEyQixRQUEzQixFQUQrQjtBQUUvQixnQkFBYSxjQUFiLENBQTRCLFdBQTVCLENBQXdDLEdBQUcsV0FBSCxDQUFlLFNBQWYsQ0FBeEMsQ0FBa0UsSUFBbEUsQ0FBdUUsVUFBQyxHQUFELEVBQVM7QUFDL0UsT0FBRyxRQUFILEdBQWMsSUFBSSxJQUFKLENBQVMsTUFBVCxJQUFtQixFQUFuQixDQURpRTtJQUFULENBQXZFLENBRUcsT0FGSCxDQUVXLFlBQU07QUFDaEIsT0FBRyxVQUFILENBQWMsYUFBZCxDQUE0QixRQUE1QixFQURnQjtJQUFOLENBRlgsQ0FGK0I7QUFPL0IsTUFBRyxVQUFILENBQWMsWUFBZCxDQUEyQixLQUEzQixFQVArQjtBQVEvQixnQkFBYSxjQUFiLENBQTRCLE9BQTVCLENBQW9DLEdBQUcsV0FBSCxDQUFlLFNBQWYsQ0FBcEMsQ0FBOEQsSUFBOUQsQ0FBbUUsVUFBQyxHQUFELEVBQVM7QUFDM0UsT0FBRyxJQUFILEdBQVUsSUFBSSxJQUFKLENBQVMsTUFBVCxJQUFtQixFQUFuQixDQURpRTtJQUFULENBQW5FLENBRUcsT0FGSCxDQUVXLFlBQU07QUFDaEIsT0FBRyxVQUFILENBQWMsYUFBZCxDQUE0QixLQUE1QixFQURnQjtJQUFOLENBRlgsQ0FSK0I7R0FBaEM7O0FBZUEsS0FBRyxjQUFILEdBQW9CLFVBQUMsSUFBRCxFQUFVO0FBQzdCLE1BQUcsUUFBSCxHQUFjLElBQWQsQ0FENkI7QUFFN0IsTUFBRyxTQUFILEdBQWUsRUFBZixDQUY2QjtBQUc3QixNQUFHLGNBQUgsR0FBb0IsRUFBcEIsQ0FINkI7R0FBVixDQXpCMEQ7QUE4QjlFLEtBQUcsWUFBSCxHQUFrQixVQUFDLE1BQUQsRUFBWTtBQUM3QixNQUFHLGNBQUgsR0FBb0IsTUFBcEIsQ0FENkI7QUFFN0IsTUFBRyxTQUFILEdBQWUsRUFBZixDQUY2QjtHQUFaLENBOUI0RDtBQWtDOUUsS0FBRyxLQUFILEdBQVcsWUFBTTtBQUNoQixrQkFBZSxPQUFmLENBQXVCLFFBQXZCLEVBRGdCO0dBQU4sQ0FsQ21FO0FBcUM5RSxLQUFHLE9BQUgsR0FBYSxZQUFNO0FBQ2xCLE9BQUksWUFBWTtBQUNmLGVBQVcsR0FBRyxXQUFILENBQWUsU0FBZjtBQUNYLGNBQVUsRUFBVjtBQUNBLGVBQVcsRUFBWDtBQUhlLElBQVosQ0FEYztBQU1sQixPQUFJLEdBQUcsV0FBSCxDQUFlLFdBQWYsRUFBNEI7QUFDL0IsUUFBSSxHQUFHLFFBQUgsSUFBZSxRQUFmLEVBQXlCLFVBQVUsUUFBVixDQUFtQixVQUFuQixHQUFnQyxHQUFHLGNBQUgsQ0FBN0QsS0FDSyxVQUFVLFFBQVYsQ0FBbUIsT0FBbkIsR0FBNkIsR0FBRyxjQUFILENBRGxDO0lBREQ7O0FBS0EsT0FBSSxHQUFHLFFBQUgsRUFBYTtBQUNoQixjQUFVLFNBQVYsQ0FBb0IsUUFBcEIsR0FBK0IsR0FBRyxRQUFILENBRGY7SUFBakI7QUFHQSxNQUFHLFVBQUgsQ0FBYyxZQUFkLENBQTJCLFFBQTNCLEVBZGtCO0FBZWxCLGdCQUFhLGNBQWIsQ0FBNEIsS0FBNUIsQ0FBa0MsU0FBbEMsRUFBNkMsSUFBN0MsQ0FBa0QsVUFBQyxHQUFELEVBQVM7QUFDMUQsUUFBSSxJQUFJLElBQUosQ0FBUyxVQUFULElBQXVCLEdBQXZCLEVBQTRCO0FBQy9CLG9CQUFlLEtBQWYsR0FEK0I7QUFFL0IsaUJBQVksVUFBWixDQUF1QixVQUF2QixFQUYrQjtLQUFoQyxNQUdPO0FBQ04sb0JBQWUsS0FBZixHQURNO0FBRU4saUJBQVksV0FBWixDQUF3QixlQUFlLElBQUksSUFBSixDQUFTLFNBQVQsQ0FBdkMsQ0FGTTtLQUhQO0lBRGlELEVBUS9DLFlBQU07QUFDUixnQkFBWSxXQUFaLENBQXdCLFdBQXhCLEVBRFE7SUFBTixDQVJILENBVUcsT0FWSCxDQVVXLFlBQU07QUFDaEIsT0FBRyxVQUFILENBQWMsYUFBZCxDQUE0QixRQUE1QixFQURnQjtJQUFOLENBVlgsQ0Fma0I7R0FBTixDQXJDaUU7RUFBL0U7O0FBb0VBLGVBQWMsT0FBZCxHQUF3QixDQUFDLGFBQUQsRUFBZ0IsY0FBaEIsRUFBZ0MsYUFBaEMsRUFBK0MsZ0JBQS9DLENBQXhCLENBckV3QjtBQXNFeEIsU0FBUSxVQUFSLENBQW1CLGVBQW5CLEVBQW9DLGFBQXBDLEVBdEV3QjtDQUF4QixDQUFELENBd0VHLE9BQU8sT0FBUCxDQXhFSCIsImZpbGUiOiJpbmRleC90cGwvbW9kYWwvYnVpbGRNb2RhbC9idWlsZE1vZGFsQ3RyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKChkb21lQXBwLCB1bmRlZmluZWQpID0+IHtcblx0ZnVuY3Rpb24gQnVpbGRNb2RhbEN0cihwcm9qZWN0SW5mbywgJGRvbWVQcm9qZWN0LCAkZG9tZVB1YmxpYywgJG1vZGFsSW5zdGFuY2UpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cdFx0bGV0IHZtID0gdGhpcztcblx0XHR2bS5wcm9qZWN0SW5mbyA9IHByb2plY3RJbmZvO1xuXHRcdHZtLmxvYWRpbmdJbnMgPSAkZG9tZVB1YmxpYy5nZXRMb2FkaW5nSW5zdGFuY2UoKTtcblx0XHR2bS5idWlsZFdheSA9ICdCcmFuY2gnO1xuXHRcdHZtLnNlYXJjaEtleSA9ICcnO1xuXHRcdHZtLmltYWdlVGFnID0gJyc7XG5cdFx0dm0uc2VsZWN0ZWRCcmFuY2ggPSAnJztcblxuXHRcdGlmICh2bS5wcm9qZWN0SW5mby5oYXNDb2RlSW5mbykge1xuXHRcdFx0dm0ubG9hZGluZ0lucy5zdGFydExvYWRpbmcoJ2JyYW5jaCcpO1xuXHRcdFx0JGRvbWVQcm9qZWN0LnByb2plY3RTZXJ2aWNlLmdldEJyYW5jaGVzKHZtLnByb2plY3RJbmZvLnByb2plY3RJZCkudGhlbigocmVzKSA9PiB7XG5cdFx0XHRcdHZtLmJyYW5jaGVzID0gcmVzLmRhdGEucmVzdWx0IHx8IFtdO1xuXHRcdFx0fSkuZmluYWxseSgoKSA9PiB7XG5cdFx0XHRcdHZtLmxvYWRpbmdJbnMuZmluaXNoTG9hZGluZygnYnJhbmNoJyk7XG5cdFx0XHR9KTtcblx0XHRcdHZtLmxvYWRpbmdJbnMuc3RhcnRMb2FkaW5nKCd0YWcnKTtcblx0XHRcdCRkb21lUHJvamVjdC5wcm9qZWN0U2VydmljZS5nZXRUYWdzKHZtLnByb2plY3RJbmZvLnByb2plY3RJZCkudGhlbigocmVzKSA9PiB7XG5cdFx0XHRcdHZtLnRhZ3MgPSByZXMuZGF0YS5yZXN1bHQgfHwgW107XG5cdFx0XHR9KS5maW5hbGx5KCgpID0+IHtcblx0XHRcdFx0dm0ubG9hZGluZ0lucy5maW5pc2hMb2FkaW5nKCd0YWcnKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHZtLnRvZ2dsZUJ1aWxkV2F5ID0gKHR5cGUpID0+IHtcblx0XHRcdHZtLmJ1aWxkV2F5ID0gdHlwZTtcblx0XHRcdHZtLnNlYXJjaEtleSA9ICcnO1xuXHRcdFx0dm0uc2VsZWN0ZWRCcmFuY2ggPSAnJztcblx0XHR9O1xuXHRcdHZtLnRvZ2dsZUJyYW5jaCA9IChicmFuY2gpID0+IHtcblx0XHRcdHZtLnNlbGVjdGVkQnJhbmNoID0gYnJhbmNoO1xuXHRcdFx0dm0uc2VhcmNoS2V5ID0gJyc7XG5cdFx0fTtcblx0XHR2bS5jbG9zZSA9ICgpID0+IHtcblx0XHRcdCRtb2RhbEluc3RhbmNlLmRpc21pc3MoJ2NhbmNlbCcpO1xuXHRcdH07XG5cdFx0dm0udG9CdWlsZCA9ICgpID0+IHtcblx0XHRcdGxldCBidWlsZEluZm8gPSB7XG5cdFx0XHRcdHByb2plY3RJZDogdm0ucHJvamVjdEluZm8ucHJvamVjdElkLFxuXHRcdFx0XHRjb2RlSW5mbzoge30sIC8v5Luj56CB5L+h5oGvXG5cdFx0XHRcdGltYWdlSW5mbzoge30gLy/plZzlg4/kv6Hmga9cblx0XHRcdH07XG5cdFx0XHRpZiAodm0ucHJvamVjdEluZm8uaGFzQ29kZUluZm8pIHtcblx0XHRcdFx0aWYgKHZtLmJ1aWxkV2F5ID09ICdCcmFuY2gnKSBidWlsZEluZm8uY29kZUluZm8uY29kZUJyYW5jaCA9IHZtLnNlbGVjdGVkQnJhbmNoO1xuXHRcdFx0XHRlbHNlIGJ1aWxkSW5mby5jb2RlSW5mby5jb2RlVGFnID0gdm0uc2VsZWN0ZWRCcmFuY2g7XG5cdFx0XHR9XG5cblx0XHRcdGlmICh2bS5pbWFnZVRhZykge1xuXHRcdFx0XHRidWlsZEluZm8uaW1hZ2VJbmZvLmltYWdlVGFnID0gdm0uaW1hZ2VUYWc7XG5cdFx0XHR9XG5cdFx0XHR2bS5sb2FkaW5nSW5zLnN0YXJ0TG9hZGluZygnc3VibWl0Jyk7XG5cdFx0XHQkZG9tZVByb2plY3QucHJvamVjdFNlcnZpY2UuYnVpbGQoYnVpbGRJbmZvKS50aGVuKChyZXMpID0+IHtcblx0XHRcdFx0aWYgKHJlcy5kYXRhLnJlc3VsdENvZGUgPT0gMjAwKSB7XG5cdFx0XHRcdFx0JG1vZGFsSW5zdGFuY2UuY2xvc2UoKTtcblx0XHRcdFx0XHQkZG9tZVB1YmxpYy5vcGVuUHJvbXB0KCfmiJDlip/vvIzmraPlnKjmnoTlu7rvvIEnKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQkbW9kYWxJbnN0YW5jZS5jbG9zZSgpO1xuXHRcdFx0XHRcdCRkb21lUHVibGljLm9wZW5XYXJuaW5nKCfmnoTlu7rlpLHotKXvvIHplJnor6/kv6Hmga/vvJonICsgcmVzLmRhdGEucmVzdWx0TXNnKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwgKCkgPT4ge1xuXHRcdFx0XHQkZG9tZVB1YmxpYy5vcGVuV2FybmluZygn5p6E5bu65aSx6LSl77yM6K+36YeN6K+V77yBJyk7XG5cdFx0XHR9KS5maW5hbGx5KCgpID0+IHtcblx0XHRcdFx0dm0ubG9hZGluZ0lucy5maW5pc2hMb2FkaW5nKCdzdWJtaXQnKTtcblx0XHRcdH0pO1xuXHRcdH07XG5cdH1cblxuXHRCdWlsZE1vZGFsQ3RyLiRpbmplY3QgPSBbJ3Byb2plY3RJbmZvJywgJyRkb21lUHJvamVjdCcsICckZG9tZVB1YmxpYycsICckbW9kYWxJbnN0YW5jZSddO1xuXHRkb21lQXBwLmNvbnRyb2xsZXIoJ0J1aWxkTW9kYWxDdHInLCBCdWlsZE1vZGFsQ3RyKTtcblxufSkod2luZG93LmRvbWVBcHApOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
