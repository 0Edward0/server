var publicModule=angular.module("publicModule",[]);publicModule.service("$util",["$q",function(e){"use strict";var t=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},n=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!==n?unescape(n[2]):null},o=function(e,t){return null===e||void 0===e||isNaN(e)?e:"number"!=typeof e?parseFloat(parseFloat(e).toFixed(t)):parseFloat(e.toFixed(t))},i=function(e,t){if(void 0!==e&&null!==e&&!isNaN(e)){switch("number"!=typeof e&&(e=parseFloat(e)),t){case"MB":e=(e/1024/1024).toFixed(2);break;case"GB":e=(e/1024/1024/1024).toFixed(2);break;case"KB":e=(e/1024).toFixed(2);break;default:e=e.toFixed(2)}return parseFloat(e)}},r=function(e,t){for(var n,o=new RegExp("{#([a-zA-z0-9]+)}");null!==(n=o.exec(e));){var i=0===t[n[1]]?"0":t[n[1]]||"";e=e.replace(new RegExp(n[0],"g"),i)}return e},s=function(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n},a=function(e){return!!(!e||e&&t(e))},l=function(e,t){e=new Date(e),e.setDate(e.getDate()+t);var n=e.getFullYear(),o=e.getMonth()+1;10>o&&(o="0"+o);var i=e.getDate();return 10>i&&(i="0"+i),n+"-"+o+"-"+i},c=function(e,t,n){var o={};void 0===t&&(t=(new Date).getTime());var i=t-e;return o.day=Math.floor(i/864e5),i-=24*o.day*3600*1e3,o.hours=Math.floor(i/36e5),i-=3600*o.hours*1e3,o.mimutes=Math.floor(i/6e4),n&&(i-=60*o.mimutes*1e3,o.seconds=Math.floor(i/1e3)),o},u=function(e,t){var n,o="";return!e||!t||0>=t-e?o="0秒":(n=c(e,t,!0),0!==n.day&&(o+=n.day+"天"),0!==n.hours&&(o+=n.hours+"小时"),0!==n.mimutes&&(o+=n.mimutes+"分钟"),0!==n.seconds&&(o+=n.seconds+"秒"),""===o&&(o="0秒")),o},d=function(e,t,n){if(!e||!t||0>=e-t)return"无";var o,i=c(e,t,n),r=i.day,s=i.hours,a=i.mimutes;return o=0>r||0>s||0>a?"刚刚":r>60?"更早":r>30?"一个月前":r>3?r+"天前":3==r?"三天前":2==r?"两天前":1==r?"昨天":s>=1?s+"小时前":0===a?"刚刚":a+"分钟前"},f=function(t){var n=e.defer();return $.getScript(t,function(){n.resolve()}),n.promise};return{isEmptyObject:t,parseTpl:r,toDecimal:o,formartBytesData:i,getQueryString:n,objLength:s,isNullorEmpty:a,calculateDate:l,getPageInterval:u,getDateInterval:c,getPageDate:d,loadJs:f}}]).provider("$domeData",function(){"use strict";var e={},t=function(t,n){e[t]=n},n=function(t){return e[t]},o=function(t){e[t]&&(e[t]=null)};return{setData:t,$get:function(){return{setData:t,getData:n,delData:o}}}}),publicModule.directive("selectCon",function(){"use strict";return{restrict:"AEC",scope:!0,transclude:!0,replace:!0,template:"<div ng-transclude></div>",controller:["$scope","$element","$attrs",function(e,t,n){this.hideSelect=function(){e.hideSelect()}}],link:function(e,t,n){var o=t.find(".select-list"),i=t.find(".ui-btn-select"),r=t.find(".drop"),s=(t.find(".select-item"),!1);if(0!==i.length){o.hide(),i.on("blur",l);var a=function(e){s=void 0!==e?e:!s,s===!0?(o.show(),r.removeClass("up")):s===!1&&(o.hide(),r.addClass("up"))},l=function(e){return a(!1),e.stopPropagation()};i.on("blur",l),o.on("mouseenter",function(){i.off("blur",l)}).on("mouseleave",function(){i.on("blur",l)}),"INPUT"===i[0].tagName?i.on("focus",function(){a(!0)}):i.on("click",function(){a()}),"true"==n.label&&(t.on("click",function(){i.focus()}),i.bind("focus",function(e){i.width(t.width()-20-i.position().left),e.stopPropagation()}).bind("blur",function(){i.width(120)})),e.hideSelect=function(){a(!1)}}}}}).directive("selectItem",["$compile",function(e){"use strict";return{restrict:"AEC",require:"^?selectCon",link:function(t,n,o,i){t.hideSelect=function(){i.hideSelect()};var r=angular.element(o.$$element.find(">a")[0]),s=r.attr("ng-click");s?s+=";hideSelect($event.stopPropagation());":s="hideSelect($event.stopPropagation())",r.attr("ng-click",s),n.html(e(n.html())(t))}}}]).directive("loading",function(){"use strict";return{restrict:"AE",template:'<div class="com-loading"><div class="dot1"></div><div class="dot2"></div></div>',replace:!0}}),publicModule.directive("notEqual",function(){return{restrict:"A",require:"ngModel",scope:{notEqual:"=notEqual"},link:function(e,t,n,o){o.$parsers.unshift(function(t){var n=void 0===e.notEqual?!1:e.notEqual.toString()===t;return o.$setValidity("notEqual",!n),t})}}}).directive("equal",function(){return{restrict:"A",require:"ngModel",scope:{equal:"=equal"},link:function(e,t,n,o){o.$parsers.unshift(function(t){var n=void 0===e.equal?!0:e.equal.toString()===t;return o.$setValidity("equal",n),t})}}});var domeModule=angular.module("domeModule",[]);domeModule.config(["$httpProvider",function(e){"use strict";e.defaults.headers.post["Content-Type"]="application/json;charset=UTF-8",e.interceptors.push(["$rootScope","$q",function(e,t){return{response:function(e){return"string"==typeof e.data&&e.data.indexOf('<html ng-app="loginApp">')>=0&&(-1!==e.config.url.indexOf("api/user/logout")?location.href="/login/login.html":location.href="/login/login.html?redirect="+encodeURIComponent(location.href)),e.config.notIntercept?e:e.data.resultCode&&200!=e.data.resultCode?t.reject(e):e||t.resolve(e)}}}])}]),domeModule.controller("sureDeleteCtrl",["$scope","$modalInstance",function(e,t){"use strict";e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]).controller("promptModalCtrl",["$scope","$modalInstance","promptTxt","$timeout",function(e,t,n,o){"use strict";e.promptTxt=n,o(function(){t.dismiss("cancel")},1e3),e.cancel=function(){t.dismiss("cancel")}}]).controller("warningModalCtrl",["$scope","$modalInstance","promptTxt",function(e,t,n){"use strict";"string"==typeof n?e.titleInfo=n:(e.titleInfo=n.title,e.detailInfo=n.msg),e.cancel=function(){t.dismiss("cancel")}}]).controller("confirmModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){"use strict";e.promptTxt=n,e.cancel=function(){t.dismiss("cancel")},e.sure=function(){t.close()}}]).controller("deleteModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){"use strict";e.promptTxt=n||"确定要删除吗？",e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]),domeModule.factory("$domePublic",["$modal","$q",function(e,t){"use strict";var n={};n.openWarning=function(t){e.open({animation:!0,templateUrl:"warningModal.html",controller:"warningModalCtrl",size:"sm",resolve:{promptTxt:function(){return t}}})},n.openPrompt=function(t){var n=e.open({animation:!0,templateUrl:"promptModal.html",controller:"promptModalCtrl",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result},n.openConfirm=function(t){var n=e.open({animation:!0,templateUrl:"confirmModal.html",controller:"confirmModalCtr",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result},n.openDelete=function(t){var n=e.open({animation:!0,templateUrl:"deleteModal.html",controller:"deleteModalCtr",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result},n.isDelete=function(){var n=t.defer(),o=e.open({animation:!0,templateUrl:"sureDelete.html",controller:"sureDeleteCtrl",size:"sm"});return o.result.then(function(){n.resolve(!0)},function(){n.reject(!1)}),n.promise};var o=function(){this.isLoading=!1,this.loadingItems={}};return o.prototype={startLoading:function(e){this.loadingItems[e]=!0,this.isLoading||(this.isLoading=!0)},finishLoading:function(e){var t=this,n=!1;t.loadingItems[e]=!1,angular.forEach(t.loadingItems,function(e,t){e&&!n&&(n=!0)}),t.isLoading=n}},n.getLoadingInstance=function(){return new o},n}]).factory("$publicApi",["$http",function(e){"use strict";var t={};return t.getDomeVersion=function(){return e.get("/api/global/version")},t.getCurrentUser=function(){return e.get("/api/user/get")},t.logout=function(){return e.get("/api/user/logout")},t}]);var deployModule=angular.module("deployModule",[]);deployModule.factory("$domeDeploy",["$http","$domeCluster","$domeUser","$domeProject","$domeImage","$domePublic","$modal","$q",function(e,t,n,o,i,r,s,a){"use strict";var l=function(){return e.get("/api/deploy/namespacelist")},c=function(){return e.get("/api/deploy/list")},u=function(t){return e.get("/api/deploy/id/"+t)},d=function(t){return e.get("/api/deploy/event/list?deployId="+t)},f=function(t){return e.get("/api/deploy/"+t+"/instance")},p=function(t){return e.get("/api/version/list?deployId="+t)},g=function(t,n){return e.get("/api/version/id/"+t+"/"+n)},m=function(t){return e.post("/api/version/create?deployId="+t.deployId,angular.toJson(t))},h=function(t,n,o){return o?e.post("/api/deploy/action/rollback?deployId="+t+"&version="+n+"&replicas="+o):e.post("/api/deploy/action/rollback?deployId="+t+"&version="+n)},I=function(t,n,o){return o?e.post("/api/deploy/action/update?deployId="+t+"&version="+n+"&replicas="+o):e.post("/api/deploy/action/update?deployId="+t+"&version="+n)},v=function(t,n,o){return o?e.post("/api/deploy/action/start?deployId="+t+"&version="+n+"&replicas="+o):e.post("/api/deploy/action/start?deployId="+t+"&version="+n)},y=function(){this.namespaceList=[],this.isNewNamespace=!1,this.imageList=void 0,this.envList=[{value:"TEST",text:"测试环境"},{value:"PROD",text:"生产环境"}],this.envText="请选择部署环境",this.versionList=void 0,this.nodeListIns=t.getInstance("NodeList"),this.clusterListIns=t.getInstance("ClusterList"),this.userGroupListIns=n.getInstance("UserGroupList"),this.loadingIns=r.getLoadingInstance()};y.prototype={constructor:y,init:function(e){var t,n,o,i,r=this,s=-1;for(e||(e={}),void 0===e.replicas&&(e.replicas=3),void 0===e.exposePortNum&&(e.exposePortNum=""),e.loadBalanceDrafts||(e.loadBalanceDrafts=[]),e.innerServiceDrafts||(e.innerServiceDrafts=[]),e.innerServiceDrafts[0]||(e.innerServiceDrafts[0]={port:"",targetPort:""}),n=0;n<e.loadBalanceDrafts.length;n++){e.loadBalanceDrafts[n].externalIPs||(e.loadBalanceDrafts[n].externalIPs=[]);var a=e.loadBalanceDrafts[n].externalIPs,l=[];for(o=0;o<a.length;o++)l.push({ip:a[o]});l.push({ip:""}),e.loadBalanceDrafts[n].externalIPs=l}if(this.config=e,this.addLoadBalance(),this.config.healthChecker&&(this.config.healthCheckerDraft=this.config.healthChecker),r.config.healthCheckerDraft||(r.config.healthCheckerDraft={type:"NONE"}),r.config.networkMode||(r.config.networkMode="DEFAULT"),r.config.visitMode||(r.config.visitMode="noAccess"),r.config.accessType||(r.config.accessType="K8S_SERVICE"),t=this.config.currentVersions,r.config.deployId){if(r.versionList||p(r.config.deployId).then(function(e){r.versionList=e.data.result||[],t&&0!==t.length||r.toggleVersion(r.versionList[0].version)}),t&&0!==t.length){for(n=0;n<t.length;n++)t[n].createTime>s&&(s=t[n].createTime,i=t[n].version);r.toggleVersion(i)}}else r.initData()},initData:function(){var e,t=this;if(t.config.logDraft||(t.config.logDraft={}),t.config.logDraft.logItemDrafts||(t.config.logDraft.logItemDrafts=[]),t.config.logDraft.logItemDrafts.push({logPath:"",autoCollect:!1,autoDelete:!1}),t.config.containerDrafts||(t.config.containerDrafts=[]),t.config.labelSelectors||(t.config.labelSelectors=[]),t.initSelectedLabels(),t.config.hostEnv){for(e=0;e<t.envList.length;e++)if(t.config.hostEnv===t.envList[e].value){t.toggleEnv(t.envList[e]);break}}else t.toggleEnv(t.envList[0]);this.config.stateful||(this.imageList?this.formartContainerDrafts():(this.loadingIns.startLoading("dockerImage"),i.getDockerImage().then(function(e){var n,o,i=e.data.result||[];for(n=0;n<i.length;n++){var r=[];if(i[n].envConfigs)for(o=0;o<i[n].envConfigs.length;o++)r.push({key:i[n].envConfigs[o].envKey,value:i[n].envConfigs[o].envValue,description:i[n].envConfigs[o].description});i[n].envConfigs=r}t.imageList=i,t.formartContainerDrafts()})["finally"](function(){t.loadingIns.finishLoading("dockerImage")})))},freshDeploy:function(){var e=this;u(this.config.deployId).then(function(t){var n=t.data.result;n&&(e.config.lastUpdateTime=n.lastUpdateTime,e.config.deploymentStatus=n.deploymentStatus,e.config.currentVersions=n.currentVersions,e.config.currentReplicas=n.currentReplicas)})},freshVersionList:function(){var e=this;e.loadingIns.startLoading("versionList"),p(e.config.deployId).then(function(t){e.versionList=t.data.result||[]})["finally"](function(){e.loadingIns.finishLoading("versionList")})},toggleCluster:function(e){var n,o=this,i=0,r=!1;if(void 0===e){for(n=o.clusterListIns.clusterList,i=0;i<n.length;i++)if(n[i].name===o.config.clusterName){r=!0,e=i;break}if(!r){if(0===o.clusterListIns.clusterList.length)return;e=0}}o.clusterListIns.toggleCluster(e);var s=o.clusterListIns.cluster.id;o.loadingIns.startLoading("nodelist"),t.getNodeList(s).then(function(e){if(o.nodeListIns.init(e.data.result,o.config.stateful),o.initSelectedLabels(),o.nodeListIns.toggleEnv(o.config.hostEnv),o.config.stateful&&o.config.replicas&&o.nodeListIns.nodeList)for(i=0;i<o.nodeListIns.nodeList.length&&i<o.config.replicas;i++)o.nodeListIns.nodeList[i].isSelected=!0,o.nodeListIns.toggleNodeCheck(o.nodeListIns.nodeList[i])},function(){o.nodeListIns.init()})["finally"](function(){o.loadingIns.finishLoading("nodelist")}),o.loadingIns.startLoading("namespace"),t.getNamespace(s).then(function(e){for(o.namespaceList=e.data.result||[],o.isNewNamespace=!1,o.config.namespace=o.namespaceList[0].name||void 0,i=0;i<o.namespaceList.length;i++)if("default"==o.namespaceList[i].name){o.config.namespace=o.namespaceList[i].name;break}},function(){o.isNewNamespace=!1,o.namespaceList=[],o.config.namespace=void 0})["finally"](function(){o.loadingIns.finishLoading("namespace")})},initSelectedLabels:function(){var e=this;if(e.nodeListIns.initLabelsInfo(),e.config.labelSelectors)for(var t=0;t<e.config.labelSelectors.length;t++){var n=e.config.labelSelectors[t].name;"kubernetes.io/hostname"!=n&&"TESTENV"!=n&&"PRODENV"!=n&&e.nodeListIns.toggleLabel(n,!0)}},toggleVersion:function(e){var t=this;g(this.config.deployId,e).then(function(e){e.data.result&&($.extend(t.config,e.data.result),t.initData())})},formartContainerDrafts:function(){function e(e){s.loadingIns.startLoading("tag"),i.getDockerImageTags(e.image,e.registry).then(function(t){e.tagList=t.data.result||[]})["finally"](function(){s.loadingIns.finishLoading("tag")})}var t,n,o,r,s=this,a=s.config.containerDrafts;for(t=0;t<a.length;t++){a[t].oldEnv=[],a[t].newEnv=[],e(a[t]);var l=[];for(n=0;n<s.imageList.length;n++)if(s.imageList[n].imageName===a[t].image){l=s.imageList[n].envConfigs;break}if(a[t].envs)for(o=0;o<a[t].envs.length;o++){var c=!1;for(r=0;r<l.length;r++)if(l[r].key===a[t].envs[o].key){c=!0;break}c?a[t].oldEnv.push(a[t].envs[o]):a[t].newEnv.push(a[t].envs[o])}else a[t].oldEnv=angular.copy(l)}},toggleNamespace:function(e){this.config.namespace=e},toggleIsNewNamespace:function(){this.isNewNamespace=!this.isNewNamespace,this.config.namespace=void 0},toggleEnv:function(e){this.config.hostEnv=e.value,this.envText=e.text,this.nodeListIns.toggleEnv(e.value)},toggleImageTag:function(e,t){this.config.containerDrafts[e].tag=t},addImage:function(e){var t=this;t.loadingIns.startLoading("addImage"),i.getDockerImageTags(e.imageName,e.registry).then(function(n){var o=n.data.result;t.config.containerDrafts.push({image:e.imageName,registry:e.registry,cpu:.5,mem:1024,tag:o&&o[0]?o[0].tag:void 0,tagList:o?o:[],oldEnv:e.envConfigs?e.envConfigs:[],newEnv:[]})})["finally"](function(){t.loadingIns.finishLoading("addImage")})},addOtherImage:function(){var e=this,t=s.open({animation:!0,templateUrl:"/index/tpl/modal/otherImageModal/otherImageModal.html",controller:"otherImageModalCtr",size:"md"});t.result.then(function(t){e.config.containerDrafts.push({image:t.name,registry:t.registry,cpu:.5,mem:1024,tag:t.tag,tagList:[{tag:t.tag}],oldEnv:[],newEnv:[]})})},deleteImage:function(e){this.config.containerDrafts.splice(e,1)},addImageEnv:function(e){this.config.containerDrafts[e].newEnv.push({key:"",value:"",description:""})},deleteImageEnv:function(e,t){this.config.containerDrafts[e].newEnv.splice(t,1)},addLoadBalance:function(){this.config.loadBalanceDrafts.push({port:"",targetPort:"",externalIPs:[{ip:""}]})},addExternalIPs:function(e){this.config.loadBalanceDrafts[e].externalIPs.push({ip:""})},deleteExternalIPs:function(e,t){this.config.loadBalanceDrafts[e].externalIPs.splice(t,1)},addLogDraft:function(){this.config.logDraft.logItemDrafts.push({logPath:"",autoCollect:!1,autoDelete:!1})},deleteLogDraft:function(e){this.config.logDraft.logItemDrafts.splice(e,1)},deleteArrItem:function(e,t){this.config[e].splice(t,1)},changeNetworkmode:function(){if("HOST"==this.config.networkMode)for(var e=0;e<this.config.loadBalanceDrafts.length;e++)this.config.loadBalanceDrafts[e].port=this.config.loadBalanceDrafts[e].targetPort},changeTargetPort:function(e){this.config.loadBalanceDrafts[e].port=this.config.loadBalanceDrafts[e].targetPort},_formartDeploy:function(){var e=angular.copy(this.config),t=0,n=0,o=[],i=[],r=[],s=this,a={type:e.healthCheckerDraft.type};for("TCP"!=a.type&&"HTTP"!=a.type||(a.port=e.healthCheckerDraft.port,a.timeout=e.healthCheckerDraft.timeout),"HTTP"==a.type&&(a.url=e.healthCheckerDraft.url),e.healthCheckerDraft=a,"HOST"==e.networkMode?(e.loadBalanceDrafts=[],e.accessType="DIY",e.innerServiceDrafts=[],"noAccess"==e.visitMode&&(e.exposePortNum=0)):(e.exposePortNum=0,"noAccess"==e.visitMode?(e.accessType="DIY",e.loadBalanceDrafts=[],e.innerServiceDrafts=[]):"internal"==e.visitMode?(e.accessType="K8S_SERVICE",e.innerServiceDrafts[0].targetPort=e.innerServiceDrafts[0].port,e.loadBalanceDrafts=[]):(e.accessType="K8S_SERVICE",e.innerServiceDrafts=[])),t=0;t<e.loadBalanceDrafts.length;t++)if(e.loadBalanceDrafts[t].port&&""!==e.loadBalanceDrafts[t].port){var l=e.loadBalanceDrafts[t].externalIPs,c=[];for(n=0;n<l.length;n++)""!==l[n].ip&&c.push(l[n].ip);e.loadBalanceDrafts[t].externalIPs=c,r.push(e.loadBalanceDrafts[t])}for(e.loadBalanceDrafts=r,e.stateful?e.hostList=s.nodeListIns.getSelectedNodes():e.labelSelectors=s.nodeListIns.getFormartSelectedLabels(),e.clusterName=s.clusterListIns.cluster.name,s.userGroupListIns.userGroup.id&&(e.creator={creatorId:s.userGroupListIns.userGroup.id,creatorName:s.userGroupListIns.userGroup.name,creatorType:s.userGroupListIns.userGroup.type}),t=0;t<e.logDraft.logItemDrafts.length;t++){var u=e.logDraft.logItemDrafts[t];if(""!==u.logPath){var d={logPath:u.logPath,autoCollect:u.autoCollect,autoDelete:u.autoDelete};u.autoCollect&&(d.logTopic=u.logTopic,d.processCmd=u.processCmd),u.autoDelete&&(d.logExpired=u.logExpired),o.push(d)}}if(e.logDraft.logItemDrafts=o,!e.stateful&&e.containerDrafts){for(t=0;t<e.containerDrafts.length;t++){var f=e.containerDrafts[t],p=f.oldEnv;for(n=0;n<f.newEnv.length;n++)""!==f.newEnv[n].key&&p.push(f.newEnv[n]);i.push({image:f.image,registry:f.registry,tag:f.tag,cpu:f.cpu,mem:f.mem,envs:p})}e.containerDrafts=i}return e},createVersion:function(){var e=a.defer(),t=this,n=this._formartDeploy(),o={deployId:n.deployId,containerDrafts:n.containerDrafts,logDraft:n.logDraft,labelSelectors:n.labelSelectors};return m(o).then(function(n){"RUNNING"!=t.config.deploymentStatus&&"STOP"!=t.config.deploymentStatus?(r.openPrompt("新建部署版本成功,当前状态不能升级。"),e.resolve("create")):r.openConfirm("成功新建部署版本，是否继续升级？").then(function(){I(t.config.deployId,n.data.result).then(function(){r.openPrompt("已提交，正在升级！"),e.resolve("update")},function(t){r.openWarning({title:"升级失败！",msg:t.data.resultMsg}),e.resolve("updateFailed")})},function(){e.resolve("dismiss")})},function(t){r.openWarning({title:"创建版本失败！",msg:t.data.resultMsg}),e.reject("create")}),e.promise},stop:function(){return e.post("/api/deploy/action/stop?deployId="+this.config.deployId)},scale:function(){var t=this,n=a.defer(),o=s.open({animation:!0,templateUrl:"scaleModal.html",controller:"scaleModalCtr",size:"md",resolve:{oldReplicas:function(){return t.config.currentReplicas}}});return o.result.then(function(o){o=parseInt(o);var i="",s=t.config.currentVersions[0].version;o>t.config.currentReplicas?i="api/deploy/action/scaleup":o<t.config.currentReplicas&&(i="api/deploy/action/scaledown"),e.post(i+"?deployId="+t.config.deployId+"&replicas="+o+"&version="+s).then(function(e){r.openPrompt("操作成功！"),n.resolve(e.data.result)},function(){r.openWarning("请求失败！"),n.reject("requestError")})},function(){n.reject("dismiss")}),n.promise},recoverVersion:function(){var e=a.defer(),t=this,n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"versionListModalCtr",size:"md",resolve:{deployInfo:function(){return t.config}}});return n.result.then(function(n){var o=!1;if(t.config.currentVersions)for(var i=0;i<t.config.currentVersions.length;i++)if(t.config.currentVersions[i].version===n.versionId){o=!0,r.openWarning("您不能选择当前版本！"),e.reject("dismiss");break}o||h(t.config.deployId,n.versionId,n.replicas).then(function(t){e.resolve(t.data.result)},function(){e.reject()})},function(){e.reject("dismiss")}),e.promise},updateVersion:function(){var e=a.defer(),t=this,n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"versionListModalCtr",size:"md",resolve:{deployInfo:function(){return t.config}}});return n.result.then(function(n){var o=t.config.currentVersions[0].version;o===n.versionId?(r.openWarning("您不能选择当前版本！"),e.reject("dismiss")):o>n.versionId?h(t.config.deployId,n.versionId,n.replicas).then(function(t){r.openPrompt("已提交，正在回滚！"),e.resolve(t.data.result)},function(){r.openWarning("回滚失败，请重试！"),e.reject()}):I(t.config.deployId,n.versionId,n.replicas).then(function(t){r.openPrompt("已提交，正在升级！"),e.resolve(t.data.result)},function(){r.openPrompt("升级失败，请重试！"),e.reject()})},function(){e.reject("dismiss")}),e.promise},startVersion:function(){var e=a.defer(),t=this,n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"versionListModalCtr",size:"md",resolve:{deployInfo:function(){return t.config}}});return n.result.then(function(n){v(t.config.deployId,n.versionId,n.replicas).then(function(t){e.resolve(t.data.result)},function(){e.reject()})},function(){e.reject("dismiss")}),e.promise},"delete":function(){return e["delete"]("/api/deploy/id/"+this.config.deployId)},create:function(){function n(){e.post("api/deploy/create",angular.toJson(i)).then(function(e){o.resolve()},function(e){o.reject({type:"create",msg:e.data.resultMsg})})}var o=a.defer(),i=this._formartDeploy(),r=this;if(this.isNewNamespace){var s=this.config.namespace,l=[s];t.createNamespace(this.clusterListIns.cluster.id,l).then(function(e){r.toggleIsNewNamespace(),r.namespaceList.push(s),r.toggleNamespace(s),n()},function(e){o.reject({type:"namespace",msg:e.data.resultMsg})})}else n();return o.promise}};var L=function(){this.isCheckAll=!1,this.isCheckAllContainer=!1,this.containerList=[],this.selectedCount=0,this.selectedContainerCount=0};L.prototype={init:function(e){this.isCheckAll=!1,this.isCheckAllContainer=!1,this.instanceList=function(e){e=e||[];for(var t=0;t<e.length;t++)if(e[t].isSelected=!1,e[t].keyFilter=!0,e[t].containers)for(var n=0;n<e[t].containers.length;n++)e[t].containers[n].shortContainerId=e[t].containers[n].containerId.substring(0,12);return e}(e)},toggleContainerList:function(e){this.isCheckAllContainer=!1,this.selectedContainerCount=0,this.containerList=e.containers||[];for(var t=0;t<this.containerList.length;t++)this.containerList[t].isSelected=!1},filterWithKey:function(e){this.isCheckAll=!1,this.selectedCount=0;for(var t=0;t<this.instanceList.length;t++)this.instanceList[t].isSelected=!1,this.instanceList[t].keyFilter=-1!==this.instanceList[t].instanceName.indexOf(e)},toggleContainerCheck:function(e){var t=!0;if(e.isSelected){this.selectedContainerCount++;for(var n=0;n<this.containerList.length;n++)if(!this.containerList[n].isSelected){t=!1;break}t&&(this.isCheckAllContainer=!0)}else this.selectedContainerCount--,this.isCheckAllContainer=!1},checkAllContainer:function(e){this.isCheckAllContainer=void 0===e?!this.isCheckAllContainer:e,this.isCheckAllContainer?this.selectedContainerCount=this.containerList.length:this.selectedContainerCount=0;for(var t=0;t<this.containerList.length;t++)this.containerList[t].isSelected=this.isCheckAllContainer},toggleCheck:function(e){var t=!0;if(e.isSelected){this.selectedCount++;for(var n=0;n<this.instanceList.length;n++)if(this.instanceList[n].keyFilter&&!this.instanceList[n].isSelected){t=!1;break}t&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1},checkAllInstance:function(e){this.isCheckAll=void 0===e?this.isCheckAll:e,this.selectedCount=0;for(var t=0;t<this.instanceList.length;t++)this.instanceList[t].keyFilter&&this.isCheckAll?(this.instanceList[t].isSelected=!0,this.selectedCount++):this.instanceList[t].isSelected=!1}};var b=function(){this.deploy={},this.isLoading=!1,this.deployInstanceListIns=new L};b.prototype={init:function(e){this.deployList=function(e){return e=e||[]}(e)},toggleDeploy:function(e,t){var n=this,o=a.defer();return e?(n.deploy.id=e,n.deploy.name=t,n.isLoading=!0,f(e).then(function(e){n.deployInstanceListIns.init(e.data.result),o.resolve()})["finally"](function(e){o.reject(),n.isLoading=!1})):(n.deploy.id=void 0,n.deploy.name=void 0,n.deployInstanceListIns.init(),o.reject()),o.promise},filterDeploy:function(e,t){for(var n=-1,o=0;o<this.deployList.length;o++)if(e&&this.deployList[o].clusterName===e?this.deployList[o].clusterFilter=!0:this.deployList[o].clusterFilter=!1,t&&this.deployList[o].hostEnv===t?this.deployList[o].hostFilter=!0:this.deployList[o].hostFilter=!1,-1===n&&this.deployList[o].clusterFilter&&this.deployList[o].hostFilter)return n=o,this.toggleDeploy(this.deployList[o].deployId,this.deployList[o].deployName);return-1===n?this.toggleDeploy():void 0}};var C=function(e,t){var n;switch(e){case"DeployList":n=new b;break;case"EditDeploy":n=new y;break;default:n={},n.init=function(){console.log("error:there is no "+e)}}return n.init(t),n};return{getDeployList:c,getDeloyNamespace:l,getDeployInfo:u,getDeployEvents:d,getDeployInsList:f,createVersion:m,getVersionList:p,getVersionDetail:g,startVersion:v,getInstance:C}}]);var imageModule=angular.module("imageModule",[]);imageModule.factory("$domeImage",["$http",function(e){"use strict";var t=function(){return e.get("/api/ci/baseimage")},n=function(){return e.get("/api/dockerimage")},o=function(t,n){return e.get("/api/dockerimage/detail?name="+t+"&registry="+n)},i=function(t){return e.get("/api/global/dockerimages/detail?name="+t)},r=function(){return e.get("/api/global/dockerimages")},s=function(t){return e.post("/api/ci/baseimage",angular.toJson(t))},a=function(){return e.get("/api/ci/custom")},l=function(t){return e.get("/api/ci/custom/"+t)},c=function(t,n){return e.post("/api/ci/custom/validate?imageName="+t+"&imageTag="+n)},u=function(t){return e.post("/api/ci/custom",angular.toJson(t))},d=function(t){return e.post("/api/ci/custom/build/"+t)},f=function(t){return e["delete"]("/api/ci/custom/"+t)},p=function(t){return e.get("/api/ci/custom/download/"+t)},g=function(){};g.prototype={constructor:g,init:function(){var e={};e.autoCustom=0,e.imageName="",e.imageTag="",e.description="",e.dockerfileContent="",e.files=[{fileName:"",filePath:"",content:""}],e.envConfigs=[{envKey:"",envValue:"",description:""}],e.sourceImage={thirdParty:0,imageName:"",imageTag:"",registryUrl:""},e.publish=1,this.config=e},addEnvConfDefault:function(){this.config.envConfigs.push({envKey:"",envValue:"",description:""})},deleteArrItem:function(e,t){this.config.envConfigs.splice(t,1)},addFileDefault:function(){this.config.files.push({fileName:"",filePath:"",content:""})},deleteFileDefault:function(e,t){this.config.files.splice(t,1)},clearFileWrite:function(e,t){this.config.files[t].content=""}};var m=function(){var e=new g;return e.init(),e};return{getBaseImageList:t,getDockerImage:n,getDockerImageTags:o,getGlobalImageInfo:i,getAllImages:r,createBaseImage:s,getCustomInfo:a,monitorName:c,Mirror:g,getMirrorInstance:m,createCustomize:u,startBuild:d,getCustomDetail:l,deleteBuild:f,getLogFile:p}}]);var projectModule=angular.module("projectModule",[]);projectModule.factory("$domeProject",["$http","$util","$state","$domePublic","$q","$modal",function(e,t,n,o,i,r){"use strict";var s=function(){return e.get("/api/project")},a=function(t){return e.get("/api/project/"+t)},l=function(t,n){return e.get("/api/project/readme/"+t+"/"+n)},c=function(t){return e.get("/api/ci/build/"+t)},u=function(t){return e.post("/api/ci/build/start",angular.toJson(t),{notIntercept:!0})},d=function(t,n){return e.get("/api/ci/build/download/"+t+"/"+n)},f=function(t){return e.get("/api/project/branches/"+t)},p=function(){return e.get("/api/project/git/gitlabinfo")},g=function(t,n){return e.get("/api/ci/build/dockerfile/"+t+"/"+n)},m=function(e,t){var n,o,i={},r=0,s={},a=[],l=[],c={};for(t=angular.copy(t),r=0;r<t.envConfDefault.length;r++)n=t.envConfDefault[r],n.key&&n.value&&""!==n.key&&""!==n.value&&a.push({key:n.key,value:n.value,description:n.description});if(t.envConfDefault=a,t.codeInfo?(o={tag:t.autoBuildInfo.tag,branches:[]},t.autoBuildInfo.other&&(o.branches=t.autoBuildInfo.branches.split(",")),t.autoBuildInfo.master&&o.branches.push("master"),t.autoBuildInfo=o):t.autoBuildInfo=null,t.type||(t.type="USER"),e)i.projectName=t.projectName,i.id=t.id,i.type=t.type,t.codeInfo&&(i.codeInfo=t.codeInfo,i.autoBuildInfo=t.autoBuildInfo),i.dockerfileInfo=t.dockerfileInfo,i.authority=t.authority,i.envConfDefault=t.envConfDefault;else{for(t.dockerfileInfo&&(t.dockerfileInfo=null),r=0;r<t.confFiles.length;r++){var u=t.confFiles[r];u.tplDir&&u.originDir&&""!==u.tplDir&&""!==u.originDir&&(s[u.tplDir]=u.originDir)}for(t.confFiles=s,r=0;r<t.dockerfileConfig.compileEnv.length;r++){var d=t.dockerfileConfig.compileEnv[r];""!==d.envName&&""!==d.envValue&&l.push(d.envName+"="+d.envValue)}if(t.dockerfileConfig.compileEnv=l.join(","),t.uploadFile&&0!==t.uploadFile.length)for(r=0;r<t.uploadFile.length;r++)c[t.uploadFile[r].location]=t.uploadFile[r].md5;t.uploadFile=c,i=t}return i},h=function(e,t){var n=r.open({animation:!0,templateUrl:"/index/tpl/modal/buildModal/buildModal.html",controller:"buildModalCtr",size:"md",resolve:{projectInfo:function(){return{projectId:e,hasCodeInfo:t}}}});return n.result},I=function(){};I.prototype={constructor:I,init:function(e){var n,o,i,r=0,s=[],a=[];if(e||(e={}),e.dockerfileInfo&&e.dockerfileInfo.dockerfilePath?this.useDockerfile=!0:this.useDockerfile=!1,e.autoBuildInfo){if(i={tag:e.autoBuildInfo.tag||0,master:!1,other:!1,branches:""},e.autoBuildInfo.branches){for(r=0;r<e.autoBuildInfo.branches.length;r++)"master"===e.autoBuildInfo.branches[r]?i.master=!0:i.branches+=e.autoBuildInfo.branches[r]+",";""!==i.branches&&(i.other=!0)}e.autoBuildInfo=i}else e.autoBuildInfo={tag:0,master:!1,other:!1,branches:""};if(t.isNullorEmpty(e.confFiles))e.confFiles=[{tplDir:"",originDir:""}];else{n=[];for(var l in e.confFiles)n.push({tplDir:l,originDir:e.confFiles[l]});e.confFiles=n}if(e.dockerfileConfig||(e.dockerfileConfig={}),e.envConfDefault&&0!==e.envConfDefault.length||(e.envConfDefault=[{key:"",value:"",description:""}]),e.dockerfileInfo||(e.dockerfileInfo={}),e.dockerfileConfig.compileEnv&&""===e.dockerfileConfig.compileEnv)for(o=e.dockerfileConfig.compileEnv.split(","),r=0;r<o.length;r++){var c=o[r].split("=");s.push({envName:c[0],envValue:c[1]})}else s.push({envName:"",envValue:""});if(e.dockerfileConfig.compileEnv=s,e.uploadFile){for(var u in e.uploadFile)a.push({md5:e.uploadFile[u],location:u});0!==a.length&&(e.uploadFile=a)}else e.uploadFile=[];this.config=e},deleteArrItem:function(e,t){this.config[e].splice(t,1)},deleteCompileEnv:function(e){this.config.dockerfileConfig.compileEnv.splice(e,1)},addEnvConfDefault:function(){this.config.envConfDefault.push({key:"",value:"",description:""})},toggleBaseImage:function(e,t,n){this.config.dockerfileConfig.baseImageName=e,this.config.dockerfileConfig.baseImageTag=t,this.config.dockerfileConfig.baseImageRegistry=n},addCompileEnv:function(){this.config.dockerfileConfig.compileEnv.push({envName:"",envValue:""})},addConfFiles:function(){this.config.confFiles.push({tplDir:"",originDir:""})},modify:function(){var t=angular.copy(this.config);return e.put("/api/project",angular.toJson(m(this.useDockerfile,t)))},getDockerfile:function(){return e.post("/api/ci/build/dockerfile",angular.toJson(m(this.useDockerfile,this.config)),{notIntercept:!0})},create:function(){var t=angular.copy(this.config);return e.post("/api/project",angular.toJson(m(this.useDockerfile,t)));
}};var v=function(e){var t=new I;return t.init(e),t};return{getProjectList:s,getProjectInfo:a,getBuildList:c,getFinishBuildLog:d,toBuild:u,getReadMe:l,getBranchList:f,getGitLabInfo:p,getBuildDockerfile:g,getProjectInstance:v,buildProject:h}}]);var userModule=angular.module("userModule",[]);userModule.controller("modifyPwModalCtr",["$scope","loginUser","$modalInstance","$domePublic","$domeUser",function(e,t,n,o,i){"use strict";e.pwObj={username:t.username,oldpassword:"",newpassword:""},e.newPwAgain="",e.modiftPw=function(){i.userModifyPw(e.pwObj).then(function(){o.openPrompt("修改成功，请重新登录！")["finally"](function(){location.href="/login/login.html?redirect="+encodeURIComponent(location.href)})},function(){o.openWarning("修改失败，请重试！")})},e.cancel=function(){n.dismiss("cancel")}}]),userModule.factory("$domeUser",["$http","$q","$domePublic","$domeGlobal",function(e,t,n,o){"use strict";var i=function(i){var r=t.defer(),s=o.getGloabalInstance("git");return s.getData().then(function(t){if(t[0].url&&""!==t[0].url){var o=t[0].url;e.post(o+"/api/v3/session",angular.toJson(i)).then(function(e){var t=e.data,n={name:t.username,token:t.private_token};return n},function(){r.reject()}).then(function(t){e.post("/api/project/git/gitlabinfo",angular.toJson(t)).then(function(e){r.resolve(e.data.result)},function(){r.reject()})},function(){r.reject()})}else n.openWarning("未配置代码仓库地址！"),r.reject()},function(){r.reject()}),r.promise},r=function(){return e.get("/api/user/get")},s=function(){return e.get("/api/user/list")},a=function(t,n){return e.post("/api/user/modify?username="+t+"&email="+n)},l=function(t){return e.post("/api/user/adminChangePassword",angular.toJson(t))},c=function(t){return e.post("/api/user/changePassword",angular.toJson(t))},u=function(t){return e["delete"]("/api/user/delete/"+t)},d=function(t){return e.post("/api/user/create",angular.toJson(t))},f=function(){return e.get(" /api/namespace/list")},p=function(t,n){return e.get("/api/resource/"+t+"/"+n)},g=function(t){return e.get("/api/resource/"+t+"/useronly")},m=function(){return e.get("/api/group/list")},h=function(t){return e.get("/api/group/get/"+t)},I=function(t){return e["delete"]("/api/group/delete/"+t)},v=function(t){return e.post("/api/group/create",angular.toJson(t))},y=function(t,n){return e.post("/api/group_members/"+t,angular.toJson(n))},L=function(t,n){return e["delete"]("/api/group_members/"+t+"/"+n)},b=function(t){return e.get("/api/group_members/"+t)},C=function(t){return e.put("/api/resource",angular.toJson(t))},D=function(t,n,o,i){return e["delete"]("/api/resource/"+t+"/"+n+"/"+o+"/"+i)},k=function(){return e.get("/api/user/logout")},$=function(){};$.prototype={constructor:$,init:function(e){var t;for(e.userInfos=e.userInfos||[],e.groupInfo=e.groupInfo||[],t=0;t<e.userInfos.length;t++)e.userInfos[t].isDirty=!1,e.userInfos[t].newRole=e.userInfos[t].role;this.resourceInfo=e},toggleRole:function(e,t){e.newRole!==t&&(e.newRole=t),e.newRole===e.role?e.isDirty=!1:e.isDirty=!0},saveRole:function(e){var t;"group"==this.resourceInfo.resourceType?(t={members:[{user_id:e.user_id,role:e.newRole}]},y(this.resourceInfo.resourceId,t).then(function(t){e.isDirty=!1,e.role=e.newRole},function(){n.openWarning("修改失败！")})):(t={resource_id:this.resourceInfo.resourceId,resource_type:this.resourceInfo.resourceType,ownerInfos:[{owner_id:e.user_id,owner_type:e.owner_type,role:e.newRole}]},C(t).then(function(t){e.isDirty=!1,e.role=e.newRole},function(){n.openWarning("修改失败！")}))},deleteUser:function(e){function t(){for(var t=0;t<o.resourceInfo.userInfos.length;t++)if(o.resourceInfo.userInfos[t].user_id===e.user_id){o.resourceInfo.userInfos.splice(t,1);break}}var o=this;"group"==o.resourceInfo.resourceType?L(o.resourceInfo.resourceId,e.user_id).then(function(e){t()},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})}):n.openDelete().then(function(){D(o.resourceInfo.resourceType,o.resourceInfo.resourceId,e.owner_type,e.user_id).then(function(e){t()},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})}};var M=function(){this.userGroup={}};M.prototype={init:function(e){var t=this;t.userGroupList=e||[],t.userGroupList[0]&&t.toggle(0)},toggle:function(e){this.userGroup=this.userGroupList[e]}};var E=function(e,t){var n;switch(e){case"UserGroupList":n=new M;break;case"ResourceUser":n=new $;break;default:n={},n.init=function(){console.log("error:there is no "+e)}}return n.init(t),n};return{relatedGitLab:i,getCurrentUser:r,getUserList:s,modifyUserInfo:a,modifyPw:l,userModifyPw:c,deleteUser:u,createUser:d,getGroupList:f,getSigResourceUser:p,getResourceUser:g,modifyResourceUser:C,getGroup:m,getGroupInfo:h,deleteGroup:I,createGroup:v,modifyGroupUsers:y,getGroupUser:b,logout:k,getInstance:E}}]);var domeApp=angular.module("domeApp",["ui.router","ncy-angular-breadcrumb","oc.lazyLoad","ngAnimate","pasvaz.bindonce","ngLocale","ui.bootstrap","angularFileUpload","ngScrollbar","publicModule","domeModule","deployModule","imageModule","userModule","projectModule"]);domeApp.run(["$rootScope",function(e){e.$on("pageTitle",function(e,t){t.title&&""!==t.title&&$("title").html("DomeOS-"+t.title)})}]),domeApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("","/projectManage"),e.state("projectManage",{url:"/projectManage",templateUrl:"index/tpl/projectManage/projectManage.html",controller:"projectManageCtr",ncyBreadcrumb:{label:"项目管理"}}).state("createProject/1",{url:"/createProject/1",templateUrl:"index/tpl/createProject1/createProject1.html",controller:"createProjectCtr1",ncyBreadcrumb:{label:"新建项目",parent:"projectManage"}}).state("createProject/2",{url:"/createProject/2",templateUrl:"index/tpl/createProject2/createProject2.html",controller:"createProjectCtr2",ncyBreadcrumb:{label:"新建项目",parent:"projectManage"}}).state("projectDetail",{url:"/projectDetail/:project",templateUrl:"index/tpl/projectDetail/projectDetail.html",controller:"projectDetailCtr",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"},resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("/lib/js/jquery-a482e1500f.zclip.js")}]}}).state("deployManage",{url:"/deployManage",templateUrl:"index/tpl/deployManage/deployManage.html",controller:"deployManageCtr",ncyBreadcrumb:{label:"部署"}}).state("createDeploy/1",{url:"/createDeploy/1",templateUrl:"index/tpl/createDeploy1/createDeploy1.html",controller:"createDeployCtr1",ncyBreadcrumb:{label:"新建部署",parent:"deployManage"}}).state("createDeploy/2",{url:"/createDeploy/2",templateUrl:"index/tpl/createDeploy2/createDeploy2.html",controller:"createDeployCtr2",ncyBreadcrumb:{label:"新建部署",parent:"deployManage"}}).state("deployDetail",{url:"/deployDetail/:id",templateUrl:"index/tpl/deployDetail/deployDetail.html",controller:"deployDetailCtr",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("groupManage",{url:"/groupManage",templateUrl:"index/tpl/groupManage/groupManage.html",controller:"groupManageCtr",ncyBreadcrumb:{label:"组管理"}}).state("createGroup",{url:"/createGroup",templateUrl:"index/tpl/createGroup/createGroup.html",controller:"createGroupCtr",ncyBreadcrumb:{label:"新建组",parent:"groupManage"}}).state("groupDetail",{url:"/groupDetail/:id",templateUrl:"index/tpl/groupDetail/groupDetail.html",controller:"groupDetailCtr",ncyBreadcrumb:{label:"组详情",parent:"groupManage"}}).state("clusterManage",{url:"/clusterManage",templateUrl:"index/tpl/clusterManage/clusterManage.html",controller:"clusterManageCtr",ncyBreadcrumb:{label:"集群管理"}}).state("createCluster",{url:"/createCluster",templateUrl:"index/tpl/createCluster/createCluster.html",controller:"createClusterCtr",ncyBreadcrumb:{label:"新建集群",parent:"clusterManage"}}).state("clusterDetail",{url:"/clusterDetail/:id",templateUrl:"index/tpl/clusterDetail/clusterDetail.html",controller:"clusterDetailCtr",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("hostDetail",{url:"/hostDetail/:clusterId/:name",templateUrl:"index/tpl/hostDetail/hostDetail.html",controller:"hostDetailCtr",ncyBreadcrumb:{label:"主机详情",parent:function(e){return e.parentState}}}).state("monitor",{url:"/monitor",templateUrl:"index/tpl/monitor/monitor.html",controller:"monitorCtr",ncyBreadcrumb:{label:"监控"}}).state("imageManage",{url:"/image",templateUrl:"index/tpl/imageManage/imageManage.html",controller:"imageManageCtr",ncyBreadcrumb:{label:"镜像管理"}}).state("mirrorCustom",{url:"/mirrorCustom",templateUrl:"index/tpl/mirrorCustom/mirrorCustom.html",controller:"mirrorCustomCtr",ncyBreadcrumb:{label:"镜像定制",parent:"imageManage"}}).state("globalSetting",{url:"/globalSetting",templateUrl:"index/tpl/globalSetting/globalSetting.html",controller:"globalSettingCtr",ncyBreadcrumb:{label:"全局配置"}}).state("addHost",{url:"/addHost/:id",templateUrl:"index/tpl/addHost/addHost.html",controller:"addHostCtr",ncyBreadcrumb:{label:"添加主机",parent:function(e){return e.parentState}}}).state("createAppDeploy",{url:"/createDeploy/app/:appName",templateUrl:"index/tpl/createAppDeploy/createAppDeploy.html",controller:"createAppDeployCtr",ncyBreadcrumb:{label:"应用部署",parent:"appStore"}}).state("appStore",{url:"/appStore",templateUrl:"index/tpl/appStore/appStore.html",controller:"appStoreCtr",ncyBreadcrumb:{label:"应用商店"}})}]).config(["$compileProvider",function(e){e.debugInfoEnabled(!1)}]),domeApp.filter("listPage",function(){return function(e,t,n){return e?(n=parseInt(n),e.slice(t*(n-1),t*n)):[]}}).filter("deployOptions",function(){return function(e,t,n,o,i){for(var r=[],s=0;s<e.length;s++)(t.ALL||t[e[s].hostEnv])&&(n.ALL||n[e[s].namespace])&&(o.ALL||o[e[s].clusterName])&&(i.ALL||i[e[s].deploymentStatus])&&r.push(e[s]);return r}}).filter("search",function(){return function(e,t,n){var o={};return angular.forEach(e,function(e,i){-1!==e[t].toString().indexOf(n)&&(o[i]=e)}),o}}).filter("searchKey",function(){return function(e,t){var n={};return t?(angular.forEach(e,function(e,o){-1!==o.toString().indexOf(t)&&(n[o]=e)}),n):e}}).filter("mirrorOptions",function(){return function(e,t,n,o,i){for(var r=[],s=0;s<e.length;s++){var a=0===e[s].autoCustom?"dockerfile":"configfile";(t.All||t[e[s].status])&&(n.All||n.own&&e[s].username==i)&&(o.All||o[a])&&r.push(e[s])}return r}}),domeApp.factory("$domeAppStore",["$http","$domeDeploy",function(e,t){var n=function(){return e.get("http://app-domeos.bjctc.scs.sohucs.com/apps-test.json",{notIntercept:!0})},o=function(){};o.prototype={init:function(e){this.config=e,this.formartToDeploy()},formartToDeploy:function(){var e={};e=angular.copy(this.config.deploymentTemplate),e.deployName=this.config.appName+parseInt(1e4*Math.random()),this.deployIns=t.getInstance("EditDeploy",e)}};var i=function(e,t){var n;switch(e){case"AppInfo":n=new o;break;default:n={},n.init=function(){console.log("error:there is no "+e)}}return n.init(t),n};return{getStoreApps:n,getInstance:i}}]).factory("$domeGlobal",["$http","$domePublic","$q",function(e,t,n){var o=function(o){var i=function(){var e;switch(o){case"ldap":e="/api/global/ldapconfig";break;case"server":e="/api/global/serverconfig";break;case"git":e="/api/global/gitconfig";break;case"registry":e="/api/global/registry/private";break;case"monitor":e="/api/global/monitor";break;case"ssh":e="/api/global/webssh";break;case"cluster":e="/api/global/ci/cluster";break;default:e=""}return e}(o),r=!0;this.getData=function(){var t=n.defer();return e.get(i).then(function(e){!e.data.result||"git"==o&&0===e.data.result.length?t.reject():(r=!1,t.resolve(e.data.result))},function(){t.reject()}),t.promise},this.modifyData=function(s){var a=n.defer(),l=function(){t.openPrompt("设置成功！")},c=function(){t.openWarning("操作失败！")};return r||"registry"===o?(r=!1,e.post(i,angular.toJson(s)).then(function(e){l(),a.resolve(e.data.result)},function(){c(),a.reject()})):e.put(i,angular.toJson(s)).then(function(e){l(),a.resolve(e.data.result)},function(){c(),a.reject()}),a.promise}},i=function(e){return new o(e)};return{getGloabalInstance:i}}]),domeApp.factory("$domeCluster",["$http","$domeUser","$q","$modal",function(e,t,n,o){var i=function(){return e.get("/api/cluster")},r=function(t){return e.get("/api/cluster/"+t)},s=function(t){return e.get("/api/cluster/"+t+"/nodelist")},a=function(t,n){return e.get("/api/cluster/"+t+"/node/"+n)},l=function(t){return e.get("/api/cluster/"+t+"/namespace")},c=function(t,n){return e.post("/api/cluster/"+t+"/namespace",angular.toJson(n))},u=function(t,n){return e.get("/api/cluster/"+t+"/nodelist/"+n)},d=function(t,n,o){return e.post("/api/cluster/"+t+"/"+n+"/disk?path="+o)},f=function(t,n){return e.post("/api/cluster/"+t+"/nodelabels",angular.toJson(n))},p=function(t,n,o){return e["delete"]("/api/cluster/"+t+"/"+n+"/"+o)},g=function(){this.isCheckAll=!1,this.nodeList=[],this.selectedCount=0,this.labelsInfo={}};g.prototype={init:function(e,t){var n=this;t!==!0&&(t=!1),n.nodeList=function(e,t){e=e?e:[];for(var n=0;n<e.length;n++)!t||e[n].diskInfo&&""!==e[n].diskInfo?(e[n].keyFilter=!0,e[n].labelFilter=!0,e[n].isSelected=!1):(e.splice(n,1),n--);return e}(e,t),n.labelsInfo=function(){var e={},t=n.nodeList,o=0,i=0;for(o=0;o<t.length;o++)for(var r in t[o].labels)if(t[o].labels.hasOwnProperty(r)&&"kubernetes.io/hostname"!=r&&"hostEnv"!=r)if(e[r]){var s=!1;for(i=0;i<e[r].contents.length;i++)if(e[r].contents[i]===t[o].labels[r]){s=!0;break}s||e[r].contents.push(t[o].labels[r])}else e[r]={contents:[t[o].labels[r]],isSelected:!1,isShow:!0};return e.PRODENV?e.PRODENV.isShow=!1:e.PRODENV={isShow:!1,contents:[],isSelected:!1},e.TESTENV?e.TESTENV.isShow=!1:e.TESTENV={isShow:!1,contents:[],isSelected:!1},e.BUILDENV?e.BUILDENV.isShow=!1:e.BUILDENV={isShow:!1,contents:[],isSelected:!1},e}()},initLabelsInfo:function(){for(var e in this.labelsInfo)this.labelsInfo[e].isSelected&&(this.labelsInfo[e].isSelected=!1);this.toggleLabelNodes()},toggleEnv:function(e){"PROD"==e?(this.labelsInfo.TESTENV.isSelected=!1,this.labelsInfo.PRODENV.isSelected=!0):"TEST"==e&&(this.labelsInfo.TESTENV.isSelected=!0,this.labelsInfo.PRODENV.isSelected=!1),this.toggleLabelNodes()},toggleNodeCheck:function(e){var t=!0;if(e.isSelected){this.selectedCount++;for(var n=0;n<this.nodeList.length;n++)if(this.nodeList[n].keyFilter&&this.nodeList[n].labelFilter&&!this.nodeList[n].isSelected){t=!1;break}t&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1},filterWithKey:function(e){this.isCheckAll=!1,this.selectedCount=0;for(var t=0;t<this.nodeList.length;t++)this.nodeList[t].isSelected=!1,this.nodeList[t].keyFilter=-1!==this.nodeList[t].name.indexOf(e)},checkAllNode:function(e){this.isCheckAll=void 0===e?this.isCheckAll:e,this.selectedCount=0;for(var t=0;t<this.nodeList.length;t++)this.nodeList[t].keyFilter&&this.nodeList[t].labelFilter&&this.isCheckAll?(this.nodeList[t].isSelected=!0,this.selectedCount++):this.nodeList[t].isSelected=!1},toggleLabel:function(e,t){var n=this;if(n.labelsInfo[e]){if(void 0!==t){if(n.labelsInfo[e].isSelected===t)return;n.labelsInfo[e].isSelected=t}else n.labelsInfo[e].isSelected=!n.labelsInfo[e].isSelected;n.toggleLabelNodes()}},toggleLabelNodes:function(){var e=this,t=!1,n=0;if(e.isCheckAll=!1,this.selectedCount=0,angular.forEach(e.labelsInfo,function(e,n){!t&&e.isSelected&&(t=!0)}),t)for(n=0;n<e.nodeList.length;n++){var o=!0;e.nodeList[n].isSelected=!1;for(var i in e.labelsInfo)if(e.labelsInfo.hasOwnProperty(i)&&e.labelsInfo[i].isSelected&&void 0===e.nodeList[n].labels[i]){o=!1;break}e.nodeList[n].labelFilter=o}else for(n=0;n<e.nodeList.length;n++)e.nodeList[n].isSelected=!1,e.nodeList[n].labelFilter=!0},showHost:function(){var e=this,t=o.open({animation:!0,templateUrl:"/index/tpl/modal/hostListModal/hostListModal.html",controller:"hostListModalCtr",size:"lg",resolve:{hostList:function(){return e.nodeList}}});return t.result},getFormartSelectedLabels:function(){var e=[],t=0;return angular.forEach(this.labelsInfo,function(n,o){if(n.isSelected)for(t=0;t<n.contents.length;t++)e.push({name:o,content:n.contents[t]})}),e},getSelectedNodes:function(){for(var e=[],t=0;t<this.nodeList.length;t++)this.nodeList[t].isSelected&&e.push(this.nodeList[t].name);return e}};var m=function(){this.userList=[],this.etcdValid=!0,this.zookeeperValid=!0,this.kafkaValid=!0,this.config={}};m.prototype={init:function(e){var n,o,i,r,s=[],a=[],l=[],c=this;if(e||(e={}),e.etcd)for(n=e.etcd.split(","),r=0;r<n.length;r++)""!==n[r]&&s.push({name:n[r]});if(s.push({name:""}),e.etcd=s,e.clusterLog||(e.clusterLog={}),e.clusterLog.zookeeper)for(o=e.clusterLog.zookeeper.split(","),r=0;r<o.length;r++)""!==o[r]&&a.push({name:o[r]});if(a.push({name:""}),e.clusterLog.zookeeper=a,e.clusterLog.kafka)for(i=e.clusterLog.kafka.split(","),r=0;r<i.length;r++)""!==i[r]&&l.push({name:i[r]});l.push({name:""}),e.clusterLog.kafka=l,e.logConfig||(e.logConfig=0),t.getGroupList().then(function(t){c.userList=t.data.result||[],e.ownerName||c.toggleUser(c.userList[0])}),this.config=e},addEtcd:function(){this.config.etcd.push({name:""})},addKafka:function(){this.config.clusterLog.kafka.push({name:""})},addZookeeper:function(){this.config.clusterLog.zookeeper.push({name:""})},deleteArrItem:function(e,t){this.config[e].splice(t,1)},deleteLogArrItem:function(e,t){this.config.clusterLog[e].splice(t,1)},toggleUser:function(e){this.config.ownerName=e.name,this.config.ownerType=e.type},toggleLogConfig:function(){this.config.logConfig=1===this.config.logConfig?0:1},validItem:function(e){var t=0,n=[],o=!1;if(n="etcd"==e?this.config.etcd:this.config.clusterLog[e],"etcd"!=e&&0===this.config.logConfig)o=!0;else for(t=0;t<n.length;t++)if(n[t].name&&""!==n[t].name){o=!0;break}switch(e){case"etcd":this.etcdValid=o;break;case"zookeeper":this.zookeeperValid=o;break;case"kafka":this.kafkaValid=o}return o},modify:function(){return e.put("/api/cluster",angular.toJson(this._formartCluster()))},_formartCluster:function(){var e,t,n=angular.copy(this.config),o="",i="",r="";for(e=0;e<n.etcd.length;e++)t=n.etcd[e].name,t&&""!==t&&(o+=t+",");if(n.etcd=o,0===n.logConfig)n.clusterLog=null;else{for(e=0;e<n.clusterLog.zookeeper.length;e++)t=n.clusterLog.zookeeper[e].name,t&&""!==t&&(i+=t+",");for(n.clusterLog.zookeeper=i,e=0;e<n.clusterLog.kafka.length;e++)t=n.clusterLog.kafka[e].name,t&&""!==t&&(r+=t+",");n.clusterLog.kafka=r}return n},create:function(){var t=this._formartCluster();return e.post("/api/cluster",angular.toJson(t))}};var h=function(){this.cluster={}};h.prototype={init:function(e){this.clusterList=e?e:[]},toggleCluster:function(e){var t=this;t.cluster.id=t.clusterList[e].id,t.cluster.name=t.clusterList[e].name}};var I=function(e,t){var n;switch(e){case"ClusterList":n=new h;break;case"Cluster":n=new m;break;case"NodeList":n=new g;break;default:n={},n.init=function(){console.log("error:there is no "+e)}}return n.init(t),n};return{getClusterList:i,getClusterDetail:r,getNodeList:s,getNodeInfo:a,getNamespace:l,createNamespace:c,getHostInstance:u,modifyDisk:d,addLabel:f,deleteLabel:p,getInstance:I}}]),domeApp.factory("$domeMonitor",["$http","$q","$util",function(e,t,n){var o=function(){return e.get("/api/global/monitor/info")},i=function(t){return e.post("/api/monitor/target",angular.toJson(t))},r=function(t){return e.get("/api/monitor/target/"+t)},s=function(t){return e.post("/api/monitor/data",angular.toJson(t))},a=function(e,t,n){var o=window.open("","_blank");i(n).then(function(n){var i=n.data.result;return void 0===i?void $domePublic.openWarning("请求错误！"):void setTimeout(function(){o.location="/monitor/monitor.html?cid="+e+"&cname="+t+"&id="+i},0)})},l=function(e,o,i){function r(e,t,n){return null===e||isNaN(e)?"——":(n||(n=""),e=parseFloat(e.toFixed(t)),n&&(e+=n),e)}function a(e,t){return e=n.formartBytesData(e,t),null===e||void 0===e?"——":parseFloat(e.toFixed(2))}var l=t.defer(),c={startTime:(new Date).getTime()-3e5,endTime:(new Date).getTime(),dataSpec:"AVERAGE",targetType:e,targetInfos:o};return s(c).then(function(t){function n(e,t,n,o){var i=e+"Data",s=e+"Count";angular.forEach(n,function(e,n){for(var l in e)if(e.hasOwnProperty(l)&&"timeStamp"!==l&&d[l]){var c;if(void 0!==o&&(c="%"==o?r(e[l],2,o):a(e[l],o)),d[l][i].push({item:n,value:c}),null===d[l][s]&&!e[l])continue;"MAX"==t?e[l]>d[l][s]&&(d[l][s]=e[l]):"SUM"==t&&(d[l][s]+=e[l])}}),void 0!==o&&angular.forEach(d,function(e,t){"%"==o?e[s]=r(e[s],2):e[s]=a(e[s],o)})}var o,s,c,u=t.data.result,d={},f={};if("node"==e){for(o=u.counterResults["cpu.busy"].slice(-3,-2)[0],s=u.counterResults["mem.memused.percent"].slice(-3,-2)[0],f={diskUsedMap:{},diskReadMap:{},diskWriteMap:{},netInMap:{},netOutMap:{}},c=0;c<i.length;c++)d[i[c]]={diskUsedData:[],diskUsedCount:0,diskReadData:[],diskReadCount:0,diskWriteData:[],diskWriteCount:0,netInData:[],netInCount:0,netOutData:[],netOutCount:0,cpuBusyCount:r(o[i[c]],2),memPercentCount:r(s[i[c]],2)};angular.forEach(u.counterResults,function(e,t){var n=t.split("=")[1];-1!==t.indexOf("df.bytes.used.percent")?f.diskUsedMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("disk.io.read_bytes")?f.diskReadMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("disk.io.write_bytes")?f.diskWriteMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("net.if.in.bytes")?f.netInMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("net.if.out.bytes")&&(f.netOutMap[n]=e.slice(-3,-2)[0])}),n("diskUsed","MAX",f.diskUsedMap,"%"),n("diskRead","SUM",f.diskReadMap,"KB"),n("diskWrite","SUM",f.diskWriteMap,"KB"),n("netIn","SUM",f.netInMap,"KB"),n("netOut","SUM",f.netOutMap,"KB")}else if("pod"==e||"container"==e)for(o=u.counterResults["container.cpu.usage.busy"].slice(-3,-2)[0],s=u.counterResults["container.mem.usage.percent"].slice(-3,-2)[0],f={netIn:u.counterResults["container.net.if.in.bytes"].slice(-3,-2)[0],netOut:u.counterResults["container.net.if.out.bytes"].slice(-3,-2)[0]},c=0;c<i.length;c++)d[i[c]]={netInCount:a(f.netIn[i[c]],"KB"),netOutCount:a(f.netOut[i[c]],"KB"),cpuBusyCount:r(o[i[c]],2),memPercentCount:r(s[i[c]],2)};l.resolve(d)},function(){l.reject()}),l.promise};return{getMonitorInfo:o,getMonitorStatistical:l,storeMonitorTarget:i,getMonitorTarget:r,getMonitorData:s,toMonitorPage:a}}]),domeApp.directive("domeNav",["$compile",function(e){return{restrict:"AE",scope:{currentMod:"=",loginUser:"="},link:function(t,n,o){t.currentNav="",t.toggle=function(e){t.currentNav=e},t.$watch("currentMod",function(e){e&&t.toggle(e)}),o.$$element.find("li").each(function(e,t){var n=angular.element(this),o=n.data("info");o&&n.attr({"ng-click":"toggle('"+o+"')","ng-class":"{'on':currentNav==='"+o+"'}"})}),n.html(e(n.html())(t))}}}]).directive("listScroll",["$window","$document",function(e,t){return{restrict:"A",template:'<div class="com-tabset-scroll"><div class="list-back"><ul class="com-list-tab list-scroll" ng-transclude></ul></div></div>',replace:!0,transclude:!0,link:function(n,o,i){var r=angular.element(e),s=angular.element(t),a=o.find("ul"),l=o.find(".nav-option"),c=o.find(".icon-next"),u=o.find(".icon-last"),d=0,f=1,p=0,g=parseInt(i.widthOffset||0);c.bind("click",function(){1>=f||d===f-1||a.stop().animate({marginLeft:(p-48)*-++d},600)}),u.bind("click",function(){0!==d&&a.stop().animate({marginLeft:(p-48)*- --d},600)}),n.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)},n.$on("changeScrollList",function(e,t){n.fresh()}),n.fresh=function(){setTimeout(function(){n.safeApply()},100)},n.$watch(function(){return{windowWidth:r.width(),listWidth:a.width()}},function(e,t){1===o.find("li").length?o.height(0):o.height("auto"),p=s.width()-g,f=Math.ceil(e.listWidth/(p-48)),d+1>f&&u.trigger("click"),1>=f?l.hide():l.show(),o.css("max-width",(p>e.listWidth?e.listWidth:p)+"px"),t.windowWidth!==e.windowWidth&&(d=0,a.css("margin-left",0))},!0),r.bind("resize",function(){n.$apply()})}}}]).directive("logInfo",function(){return{restrict:"A",link:function(e,t,n){var o=0,i=!0;t.bind("scroll",function(e){if(i){var n=t.find(".log").position().top;n>o&&(i=!1),o=n}}),e.$watch("log",function(e,n){i&&t.scrollTop(t.find(".log").height())})}}}).directive("domeToggle",function(){return{restrict:"AE",template:'<button class="ui-toggle"></button>',replace:!0}}).directive("markdown",["$q","$domeProject","$util",function(e,t,n){return{restrict:"AE",scope:{projectid:"=",branch:"="},link:function(e,o,i){n.loadJs("/lib/js/showdown-ca46797abd.min.js").then(function(){t.getReadMe(e.projectid,e.branch).then(function(e){var t=new showdown.Converter,n=e.data.result;n?o.html(t.makeHtml(n)):o.html("该项目没有简介")})})}}}]).directive("loglist",["$util","$domeProject",function(e,t){return{restrict:"AE",template:"<div ng-transclude></div>",transclude:!0,link:function(n,o){n.currentIndex=-1;var i=function(t){var o=[];return o.push('<tr class="log-detail">'),o.push('	<td colspan="7">'),o.push('		<ul class="detail-list">'),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">镜像大小</span>'),o.push('				<span class="detail-content">{#imageSize}MB</span>'),o.push("			</li>"),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">拉取命令</span>'),o.push('				<span class="detail-content">'),o.push('					<input class="cmd-txt ui-input-white" disabled="true" value="docker pull {#registry}/{#imageName}:{#imageTag}"/><a class="link-safe link-copy" data-text="docker pull {#registry}/{#imageName}:{#imageTag}">复制</a>'),o.push('					<p class="cmd-prompt"> 拉取镜像前请登录：docker login domeos.io</p>'),o.push("				</span>"),o.push("			</li>"),n.buildList[t].codeBranch&&(o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">Branch名称</span>'),o.push('				<span class="detail-content">{#codeBranch}</span>'),o.push("			</li>"),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">author</span>'),o.push('				<span class="detail-content">{#cmtAuthorName}</span>'),o.push("			</li>"),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">committer</span>'),o.push('				<span class="detail-content">{#cmtCommitterName}</span>'),o.push("			</li>"),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">commit info</span>'),o.push('				<span class="detail-content">{#cmtMessage}</span>'),o.push("			</li>")),o.push('			<li class="detail-row">'),o.push('				<span class="detail-title">Dockerfile</span>'),o.push('				<span id="dockerfile" class="detail-content">加载中……</span>'),o.push("			</li>"),o.push("		</ul>"),o.push("	</td>"),o.push("</tr>"),e.parseTpl(o.join(""),n.buildList[t])};n.showDetail=function(e){e!=n.currentIndex?(o.find(".log-detail").remove(),o.find("tr:eq("+e+")").after(i(e)),o.find(".link-copy").zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return angular.element(this).data("text")}}),t.getBuildDockerfile(n.buildList[e].projectId,n.buildList[e].id).then(function(e){var t=e.data.result;t?(t=t.replace(/[\n\r]/g,"<br/>"),o.find("#dockerfile").html(t)):o.find("#dockerfile").html("无")}),n.currentIndex=e):(0!==o.find(".log-detail").length&&o.find(".log-detail").remove(),n.currentIndex=-1)},n.parseDate=function(t){return e.getPageDate(t)},n.getInterval=function(t){return e.getPageInterval(n.buildList[t].createTime,n.buildList[t].finishTime)},n.isNull=function(e){var t=e;return e||(t="无"),t}}}}]).directive("btnCopy",["$util",function(e){return{restrict:"A",scope:{btnCopy:"="},link:function(t,n){e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){n.zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return t.btnCopy}})})}}}]).directive("mirrorCollapse",function(){return{restrict:"A",link:function(e,t,n){e.isCollapse=!0,e.toggleCollapse=function(){e.isCollapse=!e.isCollapse}}}}).directive("listNo",function(){return{restrict:"AE",scope:{listLen:"=length",pageno:"=",size:"@"},link:function(e,t,n){var o,i,r;e.$watch(function(){return e.listLen},function(n){if(i=[],n){for(o=Math.ceil(n/parseInt(e.size)),i.push('<span class="pageno last"><i class="icon-last"></i></span>'),i.push('<span class="pageno turn on">1</span>'),r=2;o>=r&&10>=r;r++)i.push('<span class="pageno turn">'+r+"</span>");i.push('<span class="pageno next"><i class="icon-next"></i></span>'),t.html(i.join(""))}}),t.delegate(".pageno","click",function(t){var n=angular.element(this);n.hasClass("turn")?(e.pageno=angular.element(this).html(),angular.element(".pageno.on").removeClass("on"),n.addClass("on")):n.hasClass("last")?1!==e.pageno&&"1"!==e.pageno&&(e.pageno=parseInt(e.pageno)-1,angular.element(".pageno.on").removeClass("on").prev(".pageno").addClass("on")):n.hasClass("next")&&e.pageno<o&&parseInt(e.pageno)<o&&(e.pageno=parseInt(e.pageno)+1,angular.element(".pageno.on").removeClass("on").next(".pageno").addClass("on")),angular.element(".current-page").html(e.pageno),e.$apply()})}}}).directive("fileCollapse",function(){return{restrict:"A",link:function(e,t,n){e.showFile=!1,e.showContent=!1,e.toggleFile=function(){e.showFile=!0},e.toggleContent=function(){e.showContent=!e.showContent,e.showFile=!0,e.showContent||""!==e.fileInfo.fileName||""!==e.fileInfo.filePath||(e.showFile=!1)}}}}).directive("customlist",["$util","$domeProject","$domeImage",function(e,t,n){return{restrict:"AE",template:"<div ng-transclude></div>",transclude:!0,link:function(t,o){var i=!1;t.currentIndex=-1;var r=function(n){var o=[],i=0===t.customDetailInfo.autoCustom?"Dockerfile":"配置文件",r=0===t.customDetailInfo.publish?"否":"是";o.push('<tr class="custom-detail">'),o.push('	<td colspan="9" class="td-detail">'),o.push('		<ul class="com-list-info detail-list">'),o.push("			<li>"),o.push('				<span class="info-name">定制详情</span>'),o.push('				<span class="info-simple">'+i+"</span>"),o.push("			</li>"),"Success"==t.customDetailInfo.status&&(o.push("			<li>"),o.push('				<span class="info-name">镜像大小</span>'),o.push('				<span class="info-simple">{#imageSize}MB</span>'),o.push("			</li>"),o.push("			<li>"),o.push('				<span class="info-name">拉取命令</span>'),o.push('				<div class="info-content cmd-wrap">'),o.push('					<input class="ui-input-fill" disabled="true" value="docker pull {#registry}/{#imageName}:{#imageTag}"/><button class="ui-btn ui-btn-sm ui-btn-active link-copy" data-text="docker pull {#registry}/{#imageName}:{#imageTag}">复制</button>'),o.push('					<p class="txt-prompt"> 拉取镜像前请登录：docker login domeos.io</p>'),o.push("				</div>"),o.push("			</li>")),o.push("			<li>"),o.push('				<span class="info-name">环境变量</span>');var s=t.customDetailInfo.envConfigs,a=s.length;if(0===a)o.push('				<span class="info-simple">无</span>');else{o.push('				<div class="info-content">'),o.push('					<table class="ui-table-primary">'),o.push("						<tr>"),o.push("							<td>名称</td>"),o.push("							<td>值</td>"),o.push("							<td>描述</td>"),o.push("						</tr>");for(var l=0;a>l;l++)o.push("						<tr>"),o.push("							<td>"+s[l].envKey+"</td>"),o.push("							<td>"+s[l].envValue+"</td>"),o.push("							<td>"+s[l].description+"</td>"),o.push("						</tr>");o.push("					</table>"),o.push("				</div>")}if(o.push("			</li>"),o.push("			<li>"),o.push('				<span class="info-name">定制镜像是否作为基础镜像</span>'),o.push('				<span class="info-simple">'+r+"</span>"),o.push("			</li>"),o.push("			<li>"),o.push('				<span class="info-name">定制镜像描述</span>'),null===t.customDetailInfo.description||""===t.customDetailInfo.description?o.push('				<span class="info-simple">无</span>'):o.push('				<span class="info-simple">{#description}</span>'),o.push("			</li>"),o.push("			<li>"),o.push('				<span class="info-name">Dockerfile</span>'),null===t.customDetailInfo.dockerfileContent||""===t.customDetailInfo.dockerfileContent?o.push('				<span class="info-simple">无</span>'):(o.push('				<div class="info-content">'),o.push('					<textarea readonly="true" class="ui-input-fill file-txt">{#dockerfileContent}</textarea>'),o.push("				</div>")),o.push("			</li>"),1===t.customDetailInfo.autoCustom&&t.customDetailInfo.files){o.push("			<li>"),o.push('				<span class="info-name">配置文件</span>');var c=t.customDetailInfo.files,u=c.length;if(u&&0!==u){o.push('				<div class="info-content">');for(var d=0;u>d;d++)o.push('					<div class="line-long">'),o.push('						<p class="con-num">'+(d+1)+"</p>"),o.push('						<span class="config-title">名称:'+c[d].fileName+"</span>"),o.push('						<span class="config-title">容器内路径:'+c[d].filePath+"</span>"),o.push("					</div>"),o.push('					<textarea readonly="true" class="ui-input-fill file-txt">'+c[d].content+"</textarea>");
o.push("				</div>")}else o.push('					<span class="info-simple">无</span>');o.push("			</li>")}return o.push("			<li>"),o.push('				<button class="ui-btn ui-btn-none btn-pack" >收起<i class="icon-down top"></i></button>'),o.push("			</li>"),o.push("		</ul>"),o.push("	</td>"),o.push("</tr>"),e.parseTpl(o.join(""),t.customDetailInfo)};e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){i=!0});var s=function(){o.find(".link-copy").zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return angular.element(this).data("text")}})},a=function(){o.find(".btn-pack").click(function(e){t.$apply(function(){t.currentIndex=-1,o.find(".custom-detail").remove()})})};t.showDetail=function(l,c){l!==t.currentIndex?(n.getCustomDetail(c).then(function(n){t.customDetailInfo=n.data.result||{},o.find(".custom-detail").remove(),o.find("tr:eq("+l+")").after(r(l)),a(),i?s():e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){i=!0,s()})}),t.currentIndex=l):(0!==o.find(".custom-detail").length&&o.find(".custom-detail").remove(),t.currentIndex=-1)},t.getInterval=function(n){return e.getPageInterval(t.customList[n].createTime,t.customList[n].finishTime)},t.parseDate=function(t){return e.getPageDate(t)}}}}]),domeApp.directive("isOver",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,o){e.$watch(function(){return{max:n.max,min:n.min,model:o.$modelValue}},function(e,t){var n=e.max,i=e.min,r=!1,s=!1;(isNaN(n)||!isNaN(n)&&parseFloat(e.model)<=parseFloat(n))&&(r=!0),(isNaN(i)||!isNaN(i)&&parseFloat(e.model)>=parseFloat(i))&&(s=!0),r&&s?o.$setValidity("isOver",!0):o.$setValidity("isOver",!1)},!0)}}}).directive("isProjectExist",["$domeProject",function(e){return{require:"ngModel",link:function(t,n,o,i){var r={};e.getProjectList().then(function(e){for(var n=e.data.result||[],s=o.groupName,a=0;a<n.length;a++)r[n[a].projectName]=1;t.$watch(function(){return o.groupName},function(e){e&&(s=e)}),i.$parsers.unshift(function(e){var t=s+"/"+e;return 1===r[t]?i.$setValidity("isProjectExist",!1):i.$setValidity("isProjectExist",!0),e})})}}}]).directive("isUserExist",function(){return{require:"ngModel",scope:{userList:"=isUserExist"},link:function(e,t,n,o){o.$parsers.unshift(function(t){if(e.userList)for(var n=0;n<e.userList.length;n++)if(e.userList[n].username===t)return void o.$setValidity("isUserExist",!1);return o.$setValidity("isUserExist",!0),t})}}}).directive("isClusterExist",function(){return{require:"ngModel",scope:{clusterList:"="},link:function(e,t,n,o){o.$parsers.unshift(function(t){if(e.clusterList)for(var n=0;n<e.clusterList.length;n++)if(e.clusterList[n].name===t)return void o.$setValidity("isClusterExist",!1);return o.$setValidity("isClusterExist",!0),t})}}}).directive("isApiServerExist",function(){return{require:"ngModel",scope:{clusterList:"=",currentCluster:"@"},link:function(e,t,n,o){o.$parsers.unshift(function(t){if(e.clusterList)for(var n=0;n<e.clusterList.length;n++)if(e.currentCluster!==e.clusterList[n].name&&e.clusterList[n].api===t)return void o.$setValidity("isApiServerExist",!1);return o.$setValidity("isApiServerExist",!0),t})}}}).directive("isDeployExist",["$domeDeploy",function(e){return{require:"ngModel",link:function(t,n,o,i){function r(e){for(var t=0;t<s.length;t++)if(s[t].clusterName===l&&s[t].namespace===a&&s[t].deployName===e)return i.$setValidity("isDeployExist",!1),e;return i.$setValidity("isDeployExist",!0),e}var s=[],a=o.namespace,l=o.clustername;e.getDeployList().then(function(e){s=e.data.result||[]}),t.$watch(function(){return{namespace:o.namespace,clustername:o.clustername}},function(e){a=e.namespace,l=e.clustername,r(i.$modelValue)},!0),i.$parsers.unshift(r)}}}]).directive("isNamespaceExist",["$domeCluster",function(e){return{require:"ngModel",link:function(t,n,o,i){var r=[];t.$watch(function(){return o.clusterid},function(t){e.getNamespace(t).then(function(e){r=e.data.result||[]})}),i.$parsers.unshift(function(e){for(var t=0;t<r.length;t++)if(r[t].name===e)return i.$setValidity("isNamespaceExist",!1),e;return i.$setValidity("isNamespaceExist",!0),e})}}}]).directive("isGroupExist",["$domeUser",function(e){return{require:"ngModel",link:function(t,n,o,i){var r={};e.getGroup().then(function(e){for(var t=e.data.result||[],n=0;n<t.length;n++)r[t[n].name]=1}),i.$parsers.unshift(function(e){return r[e]?i.$setValidity("isGroupExist",!1):i.$setValidity("isGroupExist",!0),e})}}}]).directive("isTagExist",function(){return{require:"ngModel",scope:{baseImages:"=baseimages",imageName:"=imagename"},link:function(e,t,n,o){e.$watch(function(){return e.imageName},function(e){o.$parsers[0]()}),o.$parsers.unshift(function(t){var n=!1;if(e.imageName&&""!==e.imageName&&e.baseImages)for(var i=0;i<e.baseImages.length;i++)if(e.baseImages[i].imageName===e.imageName&&e.baseImages[i].imageTag===t){n=!0;break}return o.$setValidity("isTagExist",!n),t})}}}).directive("diyPattern",function(){return{restrict:"A",require:"ngModel",scope:{pattern:"=diyPattern"},link:function(e,t,n,o){o.$parsers.unshift(function(t){if(t=t||"",e.pattern&&""!==e.pattern){var n=new RegExp(e.pattern);return o.$setValidity("diyPattern",n.test(t)),t}return o.$setValidity("diyPattern",!0),t}),e.$watch(function(){return e.pattern},function(e){o.$parsers[0]&&"function"==typeof o.$parsers[0]&&o.$parsers[0]()})}}}).directive("isRequired",[function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,o){var i=[],r=!1;angular.forEach(n,function(e,t){-1!==t.indexOf("param")&&i.push(t)}),e.$watch(function(){for(var e={},t=0;t<i.length;t++)e[i[t]]=n[i[t]];return{watchParams:e,model:o.$modelValue}},function(e,t){r=!1,angular.forEach(e.watchParams,function(e,t){e&&""!==e&&"false"!==e&&(r=!0)}),!r||r&&""!==e.model?o.$setValidity("isRequired",!0):o.$setValidity("isRequired",!1)},!0)}}}]),domeApp.controller("domeCtr",["$scope","$modal","$util","$domeUser","$q",function(e,t,n,o,i){e.currentMod={mod:""},e.$on("pageTitle",function(t,n){e.title=n.title,e.descrition=n.descrition,e.currentMod.mod=n.mod}),e.loginUser={},e.getLoginUser=function(){var t=i.defer();return e.loginUser.id?t.resolve(e.loginUser):o.getCurrentUser().then(function(n){e.loginUser=n.data.result,t.resolve(e.loginUser)}),t.promise},e.getLoginUser(),e.parseDate=function(e){return n.getPageDate(e)},e.objLength=n.objLength,e.logout=function(){o.logout()},e.modifyPw=function(){t.open({animate:!0,templateUrl:"modifyPwModal.html",controller:"modifyPwModalCtr",size:"md",resolve:{loginUser:function(){return e.loginUser}}})},e.isStrNull=function(e){var t=e;return e||(t="未设置"),t}}]).controller("sureDeleteCtrl",["$scope","$modalInstance",function(e,t){e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]).controller("promptModalCtrl",["$scope","$modalInstance","promptTxt","$timeout",function(e,t,n,o){e.promptTxt=n,o(function(){t.dismiss("cancel")},1e3),e.cancel=function(){t.dismiss("cancel")}}]).controller("warningModalCtrl",["$scope","$modalInstance","promptTxt",function(e,t,n){"string"==typeof n?e.titleInfo=n:(e.titleInfo=n.title,e.detailInfo=n.msg),e.cancel=function(){t.dismiss("cancel")}}]).controller("confirmModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n,e.cancel=function(){t.dismiss("cancel")},e.sure=function(){t.close()}}]).controller("deleteModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n||"确定要删除吗？",e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]),domeApp.controller("projectManageCtr",["$scope","$modal","$domeProject","$domePublic","$interval",function(e,t,n,o,i){"use strict";e.projectList=[],e.isLoading=!0,e.$emit("pageTitle",{title:"项目管理",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"});var r=function(){n.getProjectList().then(function(t){e.projectList=t.data.result})["finally"](function(){e.isLoading=!1})};r();var s=i(function(){-1===location.href.indexOf("projectManage")&&i.cancel(s),r()},4e3);e.openBuild=function(e,t){n.buildProject(e,t)}}]),domeApp.controller("deployManageCtr",["$scope","$domeDeploy","$domeCluster","$interval",function(e,t,n,o){"use strict";e.$emit("pageTitle",{title:"部署",descrition:"在这里您可以把项目镜像部署到运行环境中。此外，您还可以对现有部署进行监控和管理。",mod:"deployManage"}),e.showSelect=!0,e.isLoading=!0;var i=[];e.selectOption={},e.selectOption.status={ALL:!0,DEPLOYING:!1,RUNNING:!1,AB_TEST:!1,STOP:!1,ERROR:!1},e.selectOption.env={ALL:!0,PROD:!1,TEST:!1};var r=0;e.selectOption.namespace={ALL:!0},e.selectOption.cluster={ALL:!0},e.deloyList=[];var s=function(){t.getDeployList().then(function(t){var n,o,i;if(t.data.result)for(e.deloyList=t.data.result,r=0;r<e.deloyList.length;r++)n=e.deloyList[r],o=n.cpuTotal>0?(n.cpuUsed/n.cpuTotal*100).toFixed(2):"0.00",i=n.memoryTotal>0?(n.memoryUsed/n.memoryTotal*100).toFixed(2):"0.00",n.serviceDnsName&&""!==n.serviceDnsName?n.dnsName=n.serviceDnsName:n.dnsName="无",o>i?(n.compare="cpu",n.comparePercent=o):(n.compare="memory",n.comparePercent=i)})["finally"](function(){e.isLoading=!1,e.$digest()})};s();var a=o(function(){-1===location.href.indexOf("deployManage")&&o.cancel(a),s()},4e3),l=function(t){n.getNamespace(t).then(function(t){for(var n=t.data.result,o=0;o<n.length;o++)e.selectOption.namespace[n[o].name]||(e.selectOption.namespace[n[o].name]=!1)})},c=function(){if(e.selectOption.namespace={ALL:!0},e.selectOption.cluster.ALL)for(r=0;r<i.length;r++)l(i[r].id);else angular.forEach(e.selectOption.cluster,function(e,t){if("ALL"!==t&&e)for(r=0;r<i.length;r++)if(i[r].name===t){l(i[r].id);break}})};n.getClusterList().then(function(t){i=t.data.result||[],c("all");for(var n=0;n<i.length;n++)e.selectOption.cluster[i[n].name]=!1}),e.toggleShowSelect=function(){e.showSelect=!e.showSelect},e.toggleAll=function(t){angular.forEach(e.selectOption[t],function(n,o){e.selectOption[t][o]=!1}),e.selectOption[t].ALL=!0,"cluster"===t&&c("all")},e.toggleSelect=function(t,n){var o=!0;e.selectOption[t][n]=!e.selectOption[t][n],e.selectOption[t][n]?e.selectOption[t].ALL&&(e.selectOption[t].ALL=!1):(angular.forEach(e.selectOption[t],function(n,i){"ALL"!==i&&e.selectOption[t][i]&&o&&(o=!1)}),o&&e.toggleAll(t)),"cluster"===t&&c(n)}}]),domeApp.controller("groupManageCtr",["$scope","$domeUser",function(e,t){"use strict";e.$emit("pageTitle",{title:"组管理",descrition:"在这里您可以看到所有的组。您可以选择某个组查看详细信息或新建一个组。",mod:"user"}),e.isLoading=!0,t.getGroup().then(function(t){e.groupList=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("clusterManageCtr",["$scope","$domeCluster",function(e,t){"use strict";e.$emit("pageTitle",{title:"集群管理",descrition:"在这里您可以查看和管理自己的物理集群，并随时添加主机到集群中。",mod:"cluster"}),e.isLoading=!0,t.getClusterList().then(function(t){e.clusterList=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("appStoreCtr",["$scope","$domeAppStore",function(e,t){"use strict";e.$emit("pageTitle",{title:"欢迎来到应用商店！",descrition:"在这里您可以选择需要的应用并快速部署。部署后请到部署模块查询您的应用。",mod:"appStore"}),t.getStoreApps().then(function(t){e.appList=t.data||[]})}]),domeApp.controller("imageManageCtr",["$scope","$domeImage","$domePublic","$modal",function(e,t,n,o){"use strict";e.$emit("pageTitle",{title:"镜像管理",descrition:"在这里您可以查看并管理您的镜像仓库。",mod:"image"}),e.isLoading=!0,e.needValid={value:!1},e.isShowAdd=!1,e.newImageInfo={},e.projectRegistry="",t.getAllImages().then(function(t){var n=t.data.result||{},o=0;for(e.baseImages=n.baseImages||[],e.projectImages=n.projectImages||[],e.otherImages=n.otherImages||[],o=0;o<e.baseImages.length;o++)e.baseImages[o].description&&""!==e.baseImages[o].description||(e.baseImages[o].description="无");0!==e.projectImages.length&&(e.projectRegistry=e.projectImages[0].registry)})["finally"](function(){e.isLoading=!1}),e.toggleShowAdd=function(t){e.isShowAdd=t},e.openTagModal=function(e){o.open({animation:!0,templateUrl:"imageTagModal.html",controller:"imageTagModalCtr",size:"lg",resolve:{imageName:function(){return e}}})},e.createImage=function(o){e.isLoading=!0,t.createBaseImage(e.newImageInfo).then(function(t){n.openPrompt("添加成功！"),e.newImageInfo={},t.data.result&&e.baseImages.push(t.data.result),e.needValid=!1,o.$setPristine()},function(){n.openWarning("添加失败,请重试！")})["finally"](function(){e.isLoading=!1})}}]).controller("imageTagModalCtr",["$scope","imageName","$modalInstance","$domeImage","$util",function(e,t,n,o,i){e.imageName=t,e.tagInfo=[],e.isLoading=!0,e.parseDate=i.getPageDate,o.getGlobalImageInfo(t).then(function(t){e.tagInfo=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("globalSettingCtr",["$scope","$domeGlobal","$state","$domeUser","$modal","$domePublic","$q",function(e,t,n,o,i,r,s){"use strict";function a(){}function l(){}e.$emit("pageTitle",{title:"全局配置",descrition:"在这里您可以进行一些全局配置，保证domeos能够正常运行和使用。",mod:"global"}),e.getLoginUser().then(function(e){"admin"!==e.username&&n.go("projectManage")});var c=t.getGloabalInstance("ldap"),u=t.getGloabalInstance("server"),d=t.getGloabalInstance("registry"),f=t.getGloabalInstance("git"),p=t.getGloabalInstance("monitor"),g=t.getGloabalInstance("ssh"),m=t.getGloabalInstance("cluster");e.serverInfo={},e.ldapInfo={},e.registryInfo={},e.gitInfo={},e.sshInfo={},e.clusterInfo={},e.newUser={},e.needValidUser={valid:!1},e.userKey={key:""},e.isShowAdd=!1,e.currentUserType="USER",e.userList=[],a.prototype={init:function(e){for(var t=0;t<e.length;t++)e[t].newEmail=e[t].email,e[t].isEdit=!1;this.userList=e},saveSingle:function(e){o.modifyUserInfo(e.username,e.newEmail).then(function(t){e.isEdit=!1,e.email=e.newEmail},function(){r.openWarning("修改失败！")})},toggleEdit:function(e,t){e.isEdit=t,t||(e.newEmail=e.email)},addUser:function(e){var t=s.defer(),n=this;return o.createUser(e).then(function(){r.openPrompt("创建成功！");var o=angular.copy(e);o.newEmail=o.email,o.isEdit=!1,n.userList.push(o),t.resolve()},function(){r.openWarning("创建失败！"),t.reject()}),t.promise},modifyPw:function(e){i.open({templateUrl:"newPasswdModal.html",controller:"newPasswdModalCtr",size:"md",resolve:{username:function(){return e.username}}})},deleteUser:function(e){var t=this,n=e.username;r.openDelete().then(function(){o.deleteUser(n).then(function(){for(var e=0;e<t.userList.length;e++)if(t.userList[e].username===n){t.userList.splice(e,1);break}},function(){r.openWarning("删除失败！")})})}},l.prototype={init:function(e){function t(e){var t=[],n=[];if(!e||""===e)return[{text:""}];n=e.split(",");for(var o=0;o<n.length;o++)t.push({text:n[o]});return t.push({text:""}),t}this.config=e||{},this.config.transfer=t(this.config.transfer),this.config.graph=t(this.config.graph)},addItem:function(e){this.config[e].push({text:""})},deleteArrItem:function(e,t){this.config[e].splice(t,1)},formartMonitor:function(){function e(e){for(var t=[],n=0;n<e.length;n++)e[n].text&&""!==e[n].text&&t.push(e[n].text);return t.join(",")}var t=angular.copy(this.config);return t.transfer=e(this.config.transfer),t.graph=e(this.config.graph),t}},o.getUserList().then(function(t){for(var n=t.data.result||[],o=0;o<n.length;o++)"LDAP"==n[o].login_type&&(e.userList.push(n[o]),n.splice(o,1),o--);e.userListIns=new a,e.userListIns.init(n)}),e.toggleUserType=function(t){t!==e.currentUserType&&(e.currentUserType=t,e.isShowAdd=!1,e.userKey.key="")},e.toggleShowAdd=function(){e.isShowAdd=!e.isShowAdd},e.getLdap=function(){e.ldapInfo.id||c.getData().then(function(t){var n=/(.*):([^:]+)/g;e.ldapInfo=t,e.ldapInfo.url=e.ldapInfo.server.replace(n,"$1"),e.ldapInfo.port=e.ldapInfo.server.replace(n,"$2")})},e.getGitInfo=function(){e.gitInfo.id||f.getData().then(function(t){e.gitInfo=t[0]})},e.getRegistryInfo=function(){e.registryInfo.id||d.getData().then(function(t){e.registryInfo=t})},e.getServerInfo=function(){e.serverInfo.id||u.getData().then(function(t){e.serverInfo=t})},e.getMonitorInfo=function(){function t(t){e.monitorIns=new l,e.monitorIns.init(t),e.monitorConfig=e.monitorIns.config}e.monitorConfig||p.getData().then(function(e){t(e)},t())},e.getWebSsh=function(){e.sshInfo.id||g.getData().then(function(t){e.sshInfo=t})},e.getClusterInfo=function(){e.clusterInfo.id||m.getData().then(function(t){e.clusterInfo=t})},e.addUser=function(t){var n=angular.copy(e.newUser);delete n.rePassword,e.userListIns.addUser(n).then(function(){e.newUser={},e.needValidUser.valid=!1,t.$setPristine()})},e.saveLdap=function(){var t=angular.copy(e.ldapInfo);t.server=t.url+":"+t.port,delete t.url,delete t.port,c.modifyData(t).then(function(t){e.getLdap()})},e.saveGit=function(){e.gitInfo.id||(e.gitInfo.type="GITLAB"),f.modifyData(e.gitInfo).then(function(t){t&&(e.gitInfo=t)})},e.saveRegistry=function(){e.registryInfo.id&&(delete e.registryInfo.id,delete e.registryInfo.createTime);var t=angular.copy(e.registryInfo);0===t.status&&delete t.certification,d.modifyData(t).then(function(t){t&&(e.registryInfo=t)})},e.saveServer=function(){u.modifyData(e.serverInfo).then(function(t){t&&(e.serverInfo=t)})},e.saveMonitor=function(){p.modifyData(e.monitorIns.formartMonitor()).then(function(t){t&&e.monitorIns.init(t)})},e.saveSsh=function(){g.modifyData(e.sshInfo).then(function(t){t&&(e.sshInfo=t)})},e.saveCluster=function(){e.registryInfo.id&&(delete e.clusterInfo.createTime,delete e.clusterInfo.lastUpdate),m.modifyData(e.clusterInfo).then(function(t){t&&(e.clusterInfo=t)})}}]).controller("newPasswdModalCtr",["$scope","username","$domeUser","$modalInstance","$domePublic",function(e,t,n,o,i){e.cancel=function(){o.dismiss()},e.subPw=function(){var r={username:t,password:e.passwd};n.modifyPw(r).then(function(){i.openPrompt("修改成功！"),o.close()},function(e){i.openWarning("修改失败！")})}}]),domeApp.controller("createProjectCtr1",["$scope","$state","$domeData","$modal","$domeProject","$domeUser","$domePublic",function(e,t,n,o,i,r,s){"use strict";e.$emit("pageTitle",{title:"新建项目",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"}),e.pageNo=1,e.pageSize=8,e.projectList=[],e.codeManager="gitlab",e.useDockerFile=!1,e.autoBuildInfo={tag:0,master:!1,other:!1,branches:""},e.groupList=[],e.currentGroup={},e.currentProject={};var a=angular.copy(n.getData("createProjectInfo1"));a&&(n.delData("createProjectInfo1"),e.projectName=a.info.projectName,a.info.autoBuildInfo?e.autoBuildInfo=a.info.autoBuildInfo:e.autoBuildInfo={tag:0,master:!1,other:!1,branches:""},a.info.codeInfo?e.codeManager=a.info.codeInfo.codeManager:e.codeManager=null,e.useDockerFile=a.useDockerFile),e.setProjectList=function(t){e.pageNo=1,e.currentUserId=t.id,e.projectList=t.projectInfos};var l=function(){e.isLoading=!0,i.getGitLabInfo().then(function(t){e.gitLabInfo=t.data.result;var o=!1;if(n.getData("projectInfo")&&n.getData("projectInfo").info.codeInfo)for(var i=n.getData("projectInfo").info.codeInfo,r=0;r<e.gitLabInfo.length;r++)if(e.gitLabInfo[r].id===i.userInfo){e.setProjectList(e.gitLabInfo[r]);for(var s=0;s<e.projectList.length;s++)if(e.projectList[s].projectId===i.codeId){e.setCurrentProject(e.projectList[s]);break}o=!0;break}o||e.gitLabInfo[0]&&e.setProjectList(e.gitLabInfo[0])})["finally"](function(){e.isLoading=!1})};l(),e.toggleDockerFile=function(){e.useDockerFile=!e.useDockerFile},e.toggleGroup=function(t){e.currentGroup.projectBelong=t.name,e.currentGroup.type=t.type},e.toggleCodeManager=function(t){e.codeManager=t,e.$broadcast("changeScrollList",new Date)},r.getGroupList().then(function(t){if(e.groupList=t.data.result?t.data.result:[],a)for(var n=0;n<e.groupList.length;n++)a.info.projectBelong===e.groupList[n].name&&e.toggleGroup(e.groupList[n]);else e.toggleGroup(e.groupList[0])}),e.toRelated=function(){var e=o.open({templateUrl:"loginModal.html",controller:"loginModalCtr",size:"md"});e.result.then(function(){s.openPrompt("关联成功！"),l()})},e.toNext=function(){if(e.codeManager&&!e.currentProject.projectId)return void s.openWarning("请选择一个项目！");var o={projectName:e.projectName,projectBelong:e.currentGroup.projectBelong,type:e.currentGroup.type};e.codeManager?(o.autoBuildInfo=e.autoBuildInfo,o.codeInfo={codeManager:e.codeManager,codeSource:e.currentProject.nameWithNamespace,codeSshUrl:e.currentProject.sshUrl,codeHttpUrl:e.currentProject.httpUrl,codeId:e.currentProject.projectId,userInfo:e.currentUserId}):e.useDockerFile&&(e.useDockerFile=!1),n.setData("projectInfo",{info:o,useDockerFile:e.useDockerFile}),t.go("createProject/2")},e.isDescriptionNull=function(e){var t=e;return e&&""!==e||(t="无描述信息"),t},e.setCurrentProject=function(t){e.currentProject=t}}]).controller("loginModalCtr",["$scope","$http","$modalInstance","$domeUser","$domePublic",function(e,t,n,o,i){e.toLogin=function(){e.errorTxt="",e.isWaiting=!0;var t=e.username.indexOf("@"),i=e.username;-1!==t&&(i=i.substring(0,t));var r={login:i,password:e.password};o.relatedGitLab(r).then(function(e){n.close()},function(){e.errorTxt="关联失败，请重试！",e.isWaiting=!1})},e.close=function(){n.dismiss("cancel")}}]),domeApp.controller("createProjectCtr2",["$scope","$modal","FileUploader","$domeProject","$domeImage","$domeData","$domePublic","$state",function(e,t,n,o,i,r,s,a){"use strict";e.$emit("pageTitle",{title:"新建项目",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"});var l=angular.copy(r.getData("projectInfo"));if(r.delData("projectInfo"),!l)return void a.go("createProject/1");e.showMoreInfo=!1,e.uploader=new n({url:"/api/project/upload/file"}),e.useDockerFile=l.useDockerFile,e.project=o.getProjectInstance(),e.config=e.project.config,e.config.dockerfileInfo.buildPath="/",e.config.dockerfileInfo.dockerfilePath="/Dockerfile";var c={},u=function(){e.project.create().then(function(){s.openPrompt("新建成功！"),a.go("projectManage")},function(e){s.openWarning({title:"新建失败！",msg:"Message:"+e.data.resultMsg})})};i.getBaseImageList().then(function(t){e.imageList=t.data.result}),e.uploader.onCompleteItem=function(t,n,o,i){var r=n.result;for(var s in r)e.config.uploadFile.push({md5:r[s],location:c[s]});console.info("onCompleteItem",e.config.uploadFile)},e.uploader.onCompleteAll=function(){u(),e.uploader.queue=[],console.info("onCompleteAll")},e.changeDockerfilePath=function(t){"/"==t?e.config.dockerfileInfo.dockerfilePath="/Dockerfile":e.config.dockerfileInfo.dockerfilePath=t+"/Dockerfile"},e.toCopy=function(){var n=t.open({animation:!0,templateUrl:"projectListModal.html",controller:"projectListModalCtr",size:"lg"});n.result.then(function(t){o.getProjectInfo(t).then(function(t){var n=t.data.result;delete n.id,e.project=o.getProjectInstance(n),e.config=e.project.config},function(){})})},e.toLastPage=function(){r.setData("createProjectInfo1",l),a.go("createProject/1")},e.createProject=function(){if(e.config.projectName=l.info.projectBelong+"/"+l.info.projectName,e.config.codeInfo=l.info.codeInfo,e.config.autoBuildInfo=l.info.autoBuildInfo,e.config.type=l.info.type,e.project.useDockerfile=e.useDockerFile,e.uploader.queue&&0!==e.uploader.queue.length){for(var t=0;t<e.uploader.queue.length;t++){var n=e.uploader.queue[t].file.location;n="/"===n.substr(-1)?n:n+"/",c[e.uploader.queue[t].file.name]=n+e.uploader.queue[t].file.name}e.uploader.uploadAll()}else u()}}]).controller("projectListModalCtr",["$scope","$modalInstance","$domeProject",function(e,t,n){n.getProjectList().then(function(t){e.projectList=t.data.result}),e.cancel=function(){t.dismiss("cancel")},e.copy=function(e){t.close(e)}}]),domeApp.controller("projectDetailCtr",["$scope","$stateParams","$domeProject","$domePublic","$domeImage","FileUploader","$modal","$interval",function(e,t,n,o,i,r,s,a){"use strict";e.projectId=t.project,e.branch="master",e.needValid=!1,e.edit=!1,e.isWaitingForModify=!1,e.statusKey="",e.autoBuildKey="",e.resourceType="PROJECT",e.resourceId=e.projectId,e.$on("memberPermisson",function(t,n){e.hasMemberPermisson=n}),e.tabActive=[{active:!0},{active:!1},{active:!1},{active:!1},{active:!1}];var l,c,u={},d=function(){n.getProjectInfo(e.projectId).then(function(t){c=e.project=n.getProjectInstance(t.data.result),l=angular.copy(c),e.config=e.project.config,e.$emit("pageTitle",{title:e.config.projectName,descrition:"更新于"+e.parseDate(e.config.lastModify),mod:"projectManage"})})};d();var f=function(){e.isWaitingForModify=!0,e.project.modify().then(function(){o.openPrompt("修改成功！"),e.checkEdit(),d(),e.needValid=!1},function(e){o.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaitingForModify=!1})},p=function(){function t(){s.open({animation:!0,templateUrl:"dockerfileModal.html",controller:"dockerfileModalCtr",size:"md",resolve:{project:function(){return e.project}}})}if(e.project.useDockerfile){var n=s.open({templateUrl:"branchCheckModal.html",controller:"branchCheckModalCtr",size:"md",resolve:{projectId:function(){return e.config.id}}});n.result.then(function(n){e.config.dockerfileInfo.branch=n,t()})}else t()},g=function(){if(u={},e.uploader.queue&&0!==e.uploader.queue.length)for(var t=0;t<e.uploader.queue.length;t++){var n=e.uploader.queue[t].file.location;n="/"===n.substr(-1)?n:n+"/",u[e.uploader.queue[t].file.name]=n+e.uploader.queue[t].file.name}};i.getBaseImageList().then(function(t){e.imageList=t.data.result}),e.uploader=new r({url:"/api/project/upload/file"}),e.uploader.onCompleteItem=function(t,n,o,i){var r=n.result;for(var s in r)e.config.uploadFile.push({md5:r[s],location:u[s]})},e.uploader.onCompleteAll=function(t){"getDockerfile"==e.currentOptions?p():"modify"==e.currentOptions&&f(),e.uploader.queue=[],e.currentOptions=null},e.checkEdit=function(){if(e.edit=!e.edit,e.edit){e.project=l;var t=e.project.config.dockerfileInfo.buildPath,n=e.project.config.dockerfileInfo.dockerfilePath;t&&""!==t||(e.project.config.dockerfileInfo.buildPath="/"),n&&""!==n||(e.project.config.dockerfileInfo.dockerfilePath="/Dockerfile")}else l=angular.copy(c),e.project=c,e.uploader.queue=[];e.config=e.project.config},e.getBuildList=function(){n.getBuildList(e.projectId).then(function(t){e.buildList=t.data.result})},e.changeDockerfilePath=function(t){e.config.dockerfileInfo.dockerfilePath=t+"/Dockerfile"},e.startEdit=function(){e.edit=!e.edit},e.isNoSet=function(e){return e||(e="未设置"),e},e.submitModify=function(){e.uploader.queue&&0!==e.uploader.queue.length?(e.currentOptions="modify",g(),e.uploader.uploadAll()):f()},e.toggleStatus=function(t){t===e.statusKey?e.statusKey="":e.statusKey=t},e.toggleAutoBuild=function(t){t===e.autoBuildKey?e.autoBuildKey="":e.autoBuildKey=t},e.modifyCI=function(){e.isWaitingForModify=!0,f()},e.openBuild=function(){n.buildProject(e.config.id,!!e.config.codeInfo).then(function(){e.getBuildList()})},e.getBuildLog=function(e,t,n){s.open({animation:!0,templateUrl:"logInfoModal.html",controller:"logInfoModalCtr",size:"lg",resolve:{params:function(){return{projectId:e,buildId:t,status:n}}}})},e.getDockerfile=function(){return e.edit&&0!==e.uploader.queue.length?(e.currentOptions="getDockerfile",e.uploader.uploadAll(),void g()):void p()}}]).controller("logInfoModalCtr",["$scope","params","$domeProject","$sce","$location",function(e,t,n,o,i){var r,s="",a="ws://"+i.host();if(i.port()&&(a+=":"+i.port()),"Success"===t.status||"Fail"===t.status)n.getFinishBuildLog(t.projectId,t.buildId).then(function(t){if(t.data.result){var n=t.data.result.replace(/[\n\r]/g,"<br>");e.log=o.trustAsHtml(n)}else e.log=o.trustAsHtml('<p class="nolog">无日志信息</p>')});else if("Building"===t.status){r=new WebSocket(a+"/api/ci/build/log/realtime?buildId="+t.buildId);var l=function(t){s=(s+t.data).replace(/[\n]/g,"<br>"),e.$apply(function(){e.log=o.trustAsHtml(s)})},c=function(e){console.log("连接打开！")};r.onopen=function(e){c(e)},r.onmessage=function(e){l(e)},r.onclose=function(){console.log("连接被关闭！")}}else e.log=o.trustAsHtml('<p class="nolog">无日志信息</p>');e.$on("$destroy",function(){return r?(r.close(),!1):void 0})}]).controller("dockerfileModalCtr",["$scope","$modalInstance","project","$domeProject","$sce",function(e,t,n,o,i){n.getDockerfile().then(function(t){200==t.data.resultCode?t.data.result?e.dockerfileTxt=i.trustAsHtml(t.data.result.replace(/[\n\r]/g,"<br/>")):e.dockerfileTxt=i.trustAsHtml("无数据！"):e.dockerfileTxt=i.trustAsHtml('<h4 class="txt-error">请求失败！</h4><p class="txt-error">错误信息：'+t.data.resultMsg+"</p>")},function(){e.dockerfileTxt=i.trustAsHtml('<p class="txt-error">请求失败！</p>')}),e.cancel=function(){t.dismiss("cancel")}}]).controller("branchCheckModalCtr",["$scope","$modalInstance","$domeProject","projectId",function(e,t,n,o){n.getBranchList(o).then(function(t){e.branches=t.data.result,e.selectedBranch=e.branches[0]}),e.cancel=function(){t.dismiss("cancel")},e.submitBranch=function(){t.close(e.selectedBranch)},e.toggleBranch=function(t){e.selectedBranch=t}}]),domeApp.controller("createDeployCtr1",["$scope","$state","$domeData","$domeDeploy","$domePublic",function(e,t,n,o,i){"use strict";e.$emit("pageTitle",{title:"新建部署",descrition:"在这里您可以选择一个或多个项目镜像同时部署。",mod:"deployManage"}),n.getData("createDeployInfo1")?(e.deployEditIns=n.getData("createDeployInfo1"),n.delData("createDeployInfo1")):e.deployEditIns=o.getInstance("EditDeploy"),e.editConfig=e.deployEditIns.config,e.currentContainerDraft={index:0},e.needValid={valid:!1},e.deleteImage=function(t){e.deployEditIns.deleteImage(t),e.currentContainerDraft.index>e.editConfig.containerDrafts.length-1&&(e.currentContainerDraft.index=0)},e.toNext=function(){0===e.editConfig.containerDrafts.length?i.openWarning("请至少选择一个镜像！"):(n.setData("createDeployInfo",e.deployEditIns),t.go("createDeploy/2"))}}]),domeApp.controller("createDeployCtr2",["$scope","$state","$domeData","$modal","$domeDeploy","$domeCluster","$domePublic","$domeUser",function(e,t,n,o,i,r,s,a){"use strict";e.$emit("pageTitle",{title:"新建部署",descrition:"在这里您可以选择一个或多个项目镜像同时部署。",mod:"deployManage"});var l=n.getData("createDeployInfo");if(!l)return void t.go("createDeploy/1");e.isExternalIPsValid=!0,e.deployIns=angular.copy(l),n.delData("createDeployInfo"),e.config=e.deployIns.config,e.externalIsnull={date:!0},e.labelKey={key:""};var c=e.loadingsIns=s.getLoadingInstance();c.startLoading("cluster"),c.startLoading("userGroup"),r.getClusterList().then(function(t){e.deployIns.clusterListIns.init(t.data.result),e.deployIns.toggleCluster()})["finally"](function(){c.finishLoading("cluster")}),a.getGroupList().then(function(t){e.deployIns.userGroupListIns.init(t.data.result)})["finally"](function(){c.finishLoading("userGroup")}),e.toLastStep=function(){n.setData("createDeployInfo1",l),t.go("createDeploy/1")},e.selectFocus=function(){e.validHost=!0},e.$watch("config.loadBalanceDrafts[0].externalIPs",function(t,n){for(var o=t.length,i=o,r=0;o>r;r++)t[r].ip&&""!==t[r].ip&&(e.externalIsnull.date=!1,i--);o==i&&(e.externalIsnull.date=!0)},!0),e.labelKeyDown=function(t,n,o){var i,r=e.deployIns.nodeListIns.labelsInfo,s=!1;13==t.keyCode&&o?angular.forEach(o,function(t,n){s||t.isSelected||(e.deployIns.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),s=!0}):n&&""!==n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(i=t)}),i&&e.deployIns.nodeListIns.toggleLabel(i,!1))},e.toCreate=function(){c.startLoading("create"),e.deployIns.create().then(function(){s.openPrompt("创建成功！"),t.go("deployManage")},function(e){"namespace"==e.type?s.openWarning({title:"创建namespace失败！",msg:"Message:"+e.msg}):s.openWarning({title:"创建失败！",msg:"Message:"+e.msg})})["finally"](function(){c.finishLoading("create")})}}]),domeApp.controller("createAppDeployCtr",["$scope","$domeAppStore","$domeCluster","$domeUser","$state","$stateParams","$domePublic",function(e,t,n,o,i,r,s){"use strict";r.appName||i.go("appStore"),e.$emit("pageTitle",{title:r.appName,descrition:"",mod:"appStore"});var a;t.getStoreApps().then(function(l){var c=!1;if(l.data){for(var u=0;u<l.data.length;u++)if(l.data[u].appName===r.appName){c=!0,a=l.data[u];break}if(c){var d={logItemDrafts:[]},f=a.deploymentTemplate.logPathList;f||(f=[]);for(var p=0;p<f.length;p++)d.logItemDrafts.push({logPath:f[p],autoCollect:!1,autoDelete:!1});delete a.deploymentTemplate.logPathList,a.deploymentTemplate.logDraft=d,a.deploymentTemplate.networkMode="DEFAULT",e.appInfoIns=t.getInstance("AppInfo",a),e.config=e.appInfoIns.config,e.deployIns=e.appInfoIns.deployIns,e.deployConfig=e.deployIns.config,n.getClusterList().then(function(t){e.deployIns.clusterListIns.init(t.data.result),e.deployIns.toggleCluster();
}),o.getGroupList().then(function(t){e.deployIns.userGroupListIns.init(t.data.result)})["finally"](function(){})}else s.openWarning("无相关应用数据"),i.go("appStore")}else s.openWarning("请求失败！"),i.go("appStore")},function(){s.openWarning("请求失败！"),i.go("appStore")}),e.createDeploy=function(){e.isLoading=!0,e.deployIns.create().then(function(){s.openPrompt("创建成功！"),i.go("deployManage")},function(e){"namespace"==e.type?s.openWarning({title:"创建namespace失败！",msg:"Msg:"+e.msg}):s.openWarning({title:"创建失败！",msg:"Msg:"+e.msg})})["finally"](function(){e.isLoading=!1})}}]),domeApp.controller("monitorCtr",["$scope","$domeCluster","$domeDeploy","$domeMonitor","$domePublic","$modal","$q","$sce",function(e,t,n,o,i,r,s,a){"use strict";e.$emit("pageTitle",{title:"监控",descrition:"在这里您可以对主机、实例和容器进行多维度的实时监控。",mod:"monitor"});var l=e.loadingIns=i.getLoadingInstance();e.monitorType="主机",e.currentEnv={text:"生产",value:"PROD"},e.labelKey={key:""},e.keywords={node:"",instance:""},e.orderBy={node:"",pod:"",isReverse:!1},l.startLoading("loadingCluster"),t.getClusterList().then(function(n){e.clusterListIns=t.getInstance("ClusterList",n.data.result),e.clusterListIns.clusterList[0]&&e.toggleCluster(0)})["finally"](function(e){l.finishLoading("loadingCluster")});var c=function(){l.startLoading("loadingNode"),t.getNodeList(e.clusterListIns.cluster.id).then(function(n){var i=n.data.result||[];if(e.nodeListIns=t.getInstance("NodeList",i),e.toggleEnv("生产"),0!==i.length){for(var r=[],s=[],a=0;a<i.length;a++)r[a]={node:i[a].name},s.push(i[a].name);o.getMonitorStatistical("node",r,s).then(function(t){var n=e.nodeListIns.nodeList;for(a=0;a<n.length;a++)angular.extend(n[a],t[n[a].name]);console.log(n)})}},function(){e.nodeListIns=t.getInstance("NodeList")})["finally"](function(){l.finishLoading("loadingNode")})},u=function(){var t=e.deployListIns.deployInstanceListIns.instanceList;if(t&&0!==t.length){for(var n=[],i=[],r=0;r<t.length;r++){var s=[];if(t[r].containers)for(var a=0;a<t[r].containers.length;a++)s.push({hostname:t[r].hostName,containerId:t[r].containers[a].containerId});n.push({pod:{podName:t[r].instanceName,containers:s}}),i.push(t[r].instanceName)}o.getMonitorStatistical("pod",n,i).then(function(t){var n=e.deployListIns.deployInstanceListIns.instanceList;for(r=0;r<n.length;r++)angular.extend(n[r],t[n[r].instanceName]);console.log(n)})}};e.modifyTooltip=function(t,n){if(n){var o=[];switch(o.push('<div class="table-detail-wrap"><table class="table-detail">'),o.push("<thead><tr>"),t){case"diskUsed":o.push("<th>设备</th><th>磁盘占用率</th>");break;case"diskRead":o.push("<th>设备</th><th>磁盘读取(KB/s)</th>");break;case"diskWrite":o.push("<th>设备</th><th>磁盘写入(KB/s)</th>");break;case"netIn":o.push("<th>网卡</th><th>流入数据(KB/s)</th>");break;case"netOut":o.push("<th>网卡</th><th>流出数据(KB/s)</th>")}o.push("</tr></thead>"),o.push("<tbody>");for(var i=0;i<n.length;i++)o.push("<tr><td>"+n[i].item+"</td><td>"+n[i].value+"</td>");o.push("</tbody>"),o.push("</table></div>"),e.toolTipText=a.trustAsHtml(o.join(""))}},e.toggleEnv=function(t){var n="生产"===t?"PROD":"TEST";e.currentEnv={text:t,value:n},"主机"==e.monitorType?e.nodeListIns.toggleEnv(n):e.deployListIns.filterDeploy(e.clusterListIns.cluster.name,n)["finally"](function(){u()})},e.toggleCluster=function(t){e.clusterListIns.toggleCluster(t),"主机"==e.monitorType?c():"实例"==e.monitorType&&(e.deployListIns.filterCluster(e.clusterListIns.cluster.name),e.toggleDeploy(e.deployListIns.deploy.id,e.deployListIns.deploy.name))},e.toggleDeploy=function(t,n){e.deployListIns.toggleDeploy(t,n)["finally"](function(){u()})},e.toggleMonitorType=function(t){function o(){e.clusterListIns.cluster.name&&e.deployListIns.filterDeploy(e.clusterListIns.cluster.name,e.currentEnv.value)["finally"](function(){u()})}t!==e.monitorType&&(e.monitorType=t,"主机"==t?c():e.deployListIns?o():n.getDeployList().then(function(t){e.deployListIns=n.getInstance("DeployList",t.data.result),o()}))},e.toggleOrderBy=function(t,n){e.orderBy[t]===n?e.orderBy.isReverse=!e.orderBy.isReverse:(e.orderBy[t]=n,e.orderBy.isReverse=!1)},e.showContainer=function(t){e.deployListIns.deployInstanceListIns.toggleContainerList(t);var n,i=[],s=[],a=t.hostName,l=e.deployListIns.deployInstanceListIns.containerList;for(n=0;n<l.length;n++)i.push({container:{hostname:a,containerId:l[n].containerId}}),s.push(l[n].containerId);o.getMonitorStatistical("container",i,s).then(function(t){for(n=0;n<l.length;n++)angular.extend(l[n],t[l[n].containerId]);r.open({templateUrl:"containersModal.html",controller:"containersModalCtr",size:"lg",resolve:{monitorParams:function(){return{clusterId:e.clusterListIns.cluster.id,clusterName:e.clusterListIns.cluster.name,hostname:a}},instanceIns:function(){return e.deployListIns.deployInstanceListIns}}})})},e.toMonitorDetail=function(t,n){function r(e){for(var t=e.containers||[],n=[],o=0;o<t.length;o++)n.push({hostname:e.hostName,containerId:t[o].containerId});return n}var s,a,l={targetType:t,targetInfos:[]};if("node"==t)if(void 0!==n)l.targetInfos.push({node:n.name});else for(s=0;s<e.nodeListIns.nodeList.length;s++)e.nodeListIns.nodeList[s].isSelected&&l.targetInfos.push({node:e.nodeListIns.nodeList[s].name});else if("pod"==t)if(void 0!==n)l.targetInfos.push({pod:{podName:n.instanceName,containers:r(n)}});else for(a=e.deployListIns.deployInstanceListIns.instanceList,s=0;s<a.length;s++)a[s].isSelected&&l.targetInfos.push({pod:{podName:a[s].instanceName,containers:r(a[s])}});0===l.targetInfos.length?i.openWarning("请至少选择一项监控"):o.toMonitorPage(e.clusterListIns.cluster.id,e.clusterListIns.cluster.name,l)},e.labelKeyDown=function(t,n,o){var i,r=e.nodeListIns.labelsInfo,s=!1;13==t.keyCode&&o?angular.forEach(o,function(t,n){s||t.isSelected||(e.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),s=!0}):n&&""!==n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(i=t)}),i&&e.nodeListIns.toggleLabel(i,!1))}}]).controller("containersModalCtr",["$scope","instanceIns","monitorParams","$domeMonitor",function(e,t,n,o){t.checkAllContainer(!0),e.instanceIns=t;var i;for(e.orderBy={container:"",isReverse:!1},i=0;i<t.containerList.length;i++){var r=t.containerList[i].imageName,s=r.lastIndexOf(":");t.containerList[i].shortContainerId=t.containerList[i].containerId.substring(0,12),-1!==s&&(t.containerList[i].image=r.substring(0,s),t.containerList[i].imageTag=r.substring(s+1))}e.toggleOrderBy=function(t){e.orderBy.container===t?e.orderBy.isReverse=!e.orderBy.isReverse:(e.orderBy.container=t,e.orderBy.isReverse=!1)},e.toMonitorDetail=function(e){var i={targetType:"container",targetInfos:[]};if(e)i.targetInfos.push({container:{hostname:n.hostname,containerId:e.containerId}});else for(var r=0;r<t.containerList.length;r++)t.containerList[r].isSelected&&i.targetInfos.push({container:{hostname:n.hostname,containerId:t.containerList[r].containerId}});0===i.targetInfos.length?$domePublic.openWarning("请至少选择一项监控"):o.toMonitorPage(n.clusterId,n.clusterName,i)}}]),domeApp.controller("deployDetailCtr",["$scope","$domeDeploy","$domeCluster","$domePublic","$stateParams","$state","$modal","$interval",function(e,t,n,o,i,r,s,a){"use strict";e.$emit("pageTitle",{title:"部署",descrition:"",mod:"deployManage"}),i.id||r.go("deployManage"),e.needValid=!1;var l=parseInt(i.id),c=[];e.resourceType="DEPLOY",e.resourceId=l,e.tabActive=[{active:!0},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}],e.labelKey={key:""},e.$on("memberPermisson",function(t,n){e.hasMemberPermisson=n});var u=e.loadingsIns=o.getLoadingInstance(),d=function(){t.getDeployEvents(l).then(function(t){function n(e){var t=[];if(!e||0===e.length)return[{version:"无状态",replicas:"0实例"}];for(var n=0;n<e.length;n++)t.push({version:"version"+e[n].version,replicas:e[n].replicas+"实例"});return t}e.eventsList=t.data.result||[];for(var o=0;o<e.eventsList.length;o++){var i=e.eventsList[o];switch(i.date=e.parseDate(i.startTime),i.primarySnapshot=n(i.primarySnapshot),i.targetSnapshot=n(i.targetSnapshot),i.currentSnapshot=n(i.currentSnapshot),i.operation){case"UPDATE":i.optTxt="升级";break;case"ROLLBACK":i.optTxt="回滚";break;case"SCALE_UP":i.optTxt="扩容";break;case"SCALE_DOWN":i.optTxt="缩容";break;case"CREATE":i.optTxt="创建";break;case"START":i.optTxt="启动";break;case"STOP":i.optTxt="停止";break;case"DELETE":i.optTxt="删除"}switch(i.eventStatus){case"START":i.statusTxt="开始";break;case"PROCESSING":i.statusTxt="处理中";break;case"SUCCESS":i.statusTxt="成功";break;case"FAILED":i.statusTxt="失败"}}})},f=function(){t.getDeployInsList(l).then(function(t){e.instanceList=t.data.result})},p=a(function(){-1===location.href.indexOf("deployDetail")&&a.cancel(p),e.deployIns&&e.deployIns.freshDeploy()},4e3),g=function(){u.startLoading("fresh"),d(),f(),t.getDeployInfo(l).then(function(n){var o=n.data.result;e.$emit("pageTitle",{title:o.deployName,descrition:o.serviceDnsName,mod:"deployManage"}),e.deployIns=t.getInstance("EditDeploy",angular.copy(n.data.result)),e.config=e.deployIns.config,e.deployIns.clusterListIns.init(angular.copy(c)),e.deployIns.toggleCluster(),e.deployEditIns=t.getInstance("EditDeploy",angular.copy(n.data.result)),e.editConfig=e.deployEditIns.config,e.deployEditIns.clusterListIns.init(angular.copy(c)),e.deployEditIns.toggleCluster(),e.showdeploy=angular.copy(o),"HOST"===e.showdeploy.networkMode?(e.showdeploy.serviceDnsName="Host网络下没有内网域名",0!==e.showdeploy.exposePortNum?e.showdeploy.visitSet="允许访问":e.showdeploy.visitSet="禁止访问"):e.showdeploy.loadBalanceDrafts&&0!==e.showdeploy.loadBalanceDrafts.length?e.showdeploy.visitSet="对外服务开启":e.showdeploy.innerServiceDrafts&&0!==e.showdeploy.innerServiceDrafts.length?e.showdeploy.visitSet="对内服务开启":(e.showdeploy.visitSet="禁止访问",e.showdeploy.serviceDnsName="未开启访问设置，不提供内网域名")},function(){o.openWarning("请求失败！"),r.go("deployManage")})["finally"](function(){u.finishLoading("fresh"),u.finishLoading("init")})};u.startLoading("init"),n.getClusterList().then(function(e){c=e.data.result||[],g()}),e.labelKeyDown=function(t,n,o){var i,r=e.deployEditIns.nodeListIns.labelsInfo,s=!1;13==t.keyCode&&o?angular.forEach(o,function(t,n){s||t.isSelected||(e.deployEditIns.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),s=!0}):n&&""!==n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(i=t)}),i&&e.deployEditIns.nodeListIns.toggleLabel(i,!1))},e.toggleVersion=function(t){e.deployIns.toggleVersion(t)},e.recover=function(){e.isWaitingRecover=!0,e.deployIns.recoverVersion().then(function(){o.openPrompt("已提交，正在恢复。"),g()},function(e){"dismiss"!=e&&o.openWarning("恢复失败！")})["finally"](function(){e.isWaitingRecover=!1})},e.startVersion=function(){e.isWaitingStart=!0,e.deployIns.startVersion().then(function(){g()},function(e){"dismiss"!=e&&o.openWarning("启动失败！")})["finally"](function(){e.isWaitingStart=!1})},e.stopVersion=function(){e.isWaitingStop=!0,e.deployIns.stop().then(function(){o.openPrompt("已发送，正在停止！"),g()},function(){o.openWarning("停止失败！")})["finally"](function(){e.isWaitingStop=!1})},e.showLog=function(t,n){s.open({templateUrl:"index/tpl/modal/instanceLogModal/instanceLogModal.html",controller:"instanceLogModalCtr",size:"md",resolve:{instanceInfo:function(){return{clusterId:e.deployIns.config.clusterId,namespace:e.deployIns.config.namespace,instanceName:t,containers:n}}}})},e.toUpdate=function(){0===e.editConfig.containerDrafts.length?o.openWarning("请至少选择一个镜像！"):(e.isWaitingUpdate=!0,e.deployEditIns.createVersion().then(function(t){e.deployIns.freshVersionList(),"update"==t&&g()})["finally"](function(){e.isWaitingUpdate=!1}))},e.scaleVersion=function(){e.isWaitingScale=!0,e.deployIns.scale().then(function(){g()})["finally"](function(){e.isWaitingScale=!1})},e.updateVersion=function(){e.isWaitingUpVersion=!0,e.deployIns.updateVersion().then(function(){g()},function(e){"dismiss"!=e&&o.openWarning("升级失败！")})["finally"](function(){e.isWaitingUpVersion=!1})},e.deleteDeploy=function(){o.openDelete().then(function(){e.deployIns["delete"]().then(function(){o.openPrompt("删除成功！"),r.go("deployManage")},function(e){o.openWarning("删除失败！")})})},e.toConsole=function(t){s.open({templateUrl:"index/tpl/modal/selectContainerModal/selectContainerModal.html",controller:"selectContainerModalCtr",size:"md",resolve:{containerList:function(){return e.instanceList[t].containers},hostIp:function(){return e.instanceList[t].hostIp}}})}}]).controller("versionListModalCtr",["$scope","$domeDeploy","deployInfo","$modalInstance",function(e,t,n,o){var i=n.deployId;e.stateful=n.stateful,e.versionData={replicas:n.defaultReplicas},t.getVersionList(i).then(function(t){e.versionList=t.data.result||[],e.versionList[0]&&e.checkVersion(e.versionList[0].version)}),e.checkVersion=function(t){e.versionData.versionId=t},e.submit=function(){e.stateful&&delete e.versionData.replicas,o.close(e.versionData)}}]).controller("scaleModalCtr",["$scope","oldReplicas","$modalInstance",function(e,t,n){e.oldReplicas=t,e.submitScale=function(){n.close(e.replicas)}}]),domeApp.controller("createGroupCtr",["$scope","$domeUser","$domePublic","$state",function(e,t,n,o){"use strict";e.$emit("pageTitle",{title:"新建组",descrition:"在这里您可以新建一个组。",mod:"user"}),e.selectedUsers=[],e.userList=[],e.role="reporter",e.selectedUsersList=[],e.group={},e.userKey={key:""},e.isWaitingCreate=!1,t.getCurrentUser().then(function(n){var o=n.data.result;e.myself={user_id:o.id,username:o.username,role:"master"},t.getUserList().then(function(t){e.userList=t.data.result||[];for(var n=0;n<e.userList.length;n++)if(e.userList[n].id===e.myself.user_id){e.userList.splice(n,1);break}})}),e.selectUser=function(t,n){var o=0;for(o=0;o<e.selectedUsers.length;o++)if(e.selectedUsers[o].user_id===t)return;for(o=0;o<e.selectedUsersList.length;o++)if(e.selectedUsersList[o].user_id===t)return;e.selectedUsers.push({user_id:t,username:n}),e.userKey.key=""},e.cancelUser=function(t){e.selectedUsers.splice(t,1)},e.addUser=function(){for(var t=0;t<e.selectedUsers.length;t++)e.selectedUsersList.push({user_id:e.selectedUsers[t].user_id,username:e.selectedUsers[t].username,role:e.role});e.selectedUsers=[]},e.deleteUser=function(t){e.selectedUsersList.splice(t,1)},e.toggleRole=function(t){e.role=t},e.userKeyDown=function(t,n,o){13==t.keyCode&&o&&e.selectUser(o.id,o.username),n&&""!==n||8!=t.keyCode||e.selectedUsers.pop()},e.createGroup=function(){e.isWaitingCreate=!0;for(var i=[],r=0;r<e.selectedUsersList.length;r++)i.push({user_id:e.selectedUsersList[r].user_id,role:e.selectedUsersList[r].role});i.push({user_id:e.myself.user_id,role:e.myself.role}),t.createGroup(e.group).then(function(r){var s=r.data.result.id;t.modifyGroupUsers(s,{members:i}).then(function(e){n.openPrompt("创建成功！"),o.go("groupManage")},function(t){e.isWaitingCreate=!1,n.openWarning("创建成功，添加用户失败！"),o.go("groupManage")})},function(){e.isWaitingCreate=!1,n.openWarning("创建失败，请重试！")})}}]),domeApp.controller("groupDetailCtr",["$scope","$stateParams","$state","$domeUser","$domePublic",function(e,t,n,o,i){"use strict";t.id||n.go("groupManage");var r=t.id;e.resourceType="group",e.resourceId=r,o.getGroupInfo(r).then(function(t){e.groupInfo=t.data.result,e.$emit("pageTitle",{title:e.groupInfo.name,descrition:"",mod:"user"}),e.groupInfo.description=e.groupInfo.description||"无描述信息"},function(e){i.openWarning("请求失败！"),n.go("groupManage")}),e.deleteGroup=function(){i.openDelete().then(function(e){o.deleteGroup(r).then(function(e){i.openPrompt("删除成功！"),n.go("groupManage")},function(e){i.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})}}]),domeApp.controller("clusterDetailCtr",["$scope","$domeCluster","$stateParams","$state","$domePublic",function(e,t,n,o,i){"use strict";n.id||o.go("clusterManage");var r=e.clusterId=n.id;e.resourceType="CLUSTER",e.resourceId=r;var s;e.isWaitingHost=!0,e.isWaitingNamespace=!0,e.isWaitingModify=!1,e.namespaceTxt={namespace:""},e.isEdit=!1,e.$on("memberPermisson",function(t,n){e.hasMemberPermisson=n}),t.getClusterList().then(function(t){e.clusterList=t.data.result||[]}),t.getNodeList(r).then(function(t){for(var n=t.data.result||[],o=0;o<n.length;o++)n[o].capacity&&(n[o].capacity.memory=(n[o].capacity.memory/1024/1024).toFixed(2));e.nodeList=n})["finally"](function(){e.isWaitingHost=!1});var a=function(){t.getClusterDetail(r).then(function(n){s=t.getInstance("Cluster",n.data.result),e.clusterIns=angular.copy(s),e.config=e.clusterIns.config,e.$emit("pageTitle",{title:e.config.name,descrition:"",mod:"cluster"})},function(){i.openWarning("请求失败！"),o.go("clusterManage")})};a(),e.getNamespace=function(){t.getNamespace(r).then(function(t){var n=t.data.result||[];e.namespaceList=[];for(var o=0;o<n.length;o++)e.namespaceList.push(n[o].name)},function(){e.namespaceList=[]})["finally"](function(){e.isWaitingNamespace=!1})},e.addNamespace=function(){e.isLoadingNamespace=!0;var n=e.namespaceTxt.namespace;if(n&&""!==n){for(var o=0;o<e.namespaceList.length;o++)if(e.namespaceList[o]===n)return i.openWarning("已存在！"),void(e.isLoadingNamespace=!1);t.createNamespace(r,[n]).then(function(t){e.namespaceList.push(n),e.namespaceTxt.namespace=""},function(){i.openWarning("添加失败！")})["finally"](function(){e.isLoadingNamespace=!1})}},e.checkEdit=function(){e.isEdit=!e.isEdit,e.isEdit||(e.clusterIns=angular.copy(s),e.config=e.clusterIns.config)},e.modifyCluster=function(){var t=e.clusterIns.validItem("etcd"),n=e.clusterIns.validItem("kafka"),o=e.clusterIns.validItem("zookeeper");t&&n&&o&&(e.isWaitingModify=!0,e.clusterIns.modify().then(function(t){i.openPrompt("修改成功！"),a(),e.checkEdit()},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaitingModify=!1}))}}]),domeApp.controller("createClusterCtr",["$scope","$domeCluster","$domePublic","$state",function(e,t,n,o){"use strict";e.$emit("pageTitle",{title:"新建集群",descrition:"在这里您可以将一个部署好的Kubernetes集群添加到控制台进行管理。",mod:"cluster"}),e.creatCluster=!0,e.clusterIns=t.getInstance("Cluster"),e.config=e.clusterIns.config,e.createCluster=function(){var t=e.clusterIns.validItem("etcd"),i=e.clusterIns.validItem("kafka"),r=e.clusterIns.validItem("zookeeper");t&&i&&r&&(e.isWaingCreate=!0,e.clusterIns.create().then(function(){n.openPrompt("创建成功！"),o.go("clusterManage")},function(e){n.openWarning({title:"创建失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaingCreate=!1}))},t.getClusterList().then(function(t){e.clusterList=t.data.result||[]})}]),domeApp.controller("hostDetailCtr",["$scope","$stateParams","$domeCluster","$domePublic","$modal","$state",function(e,t,n,o,i,r){"use strict";e.loading=!0;var s={host:!0,instance:!0};t.name&&t.clusterId||r.go("clusterManage");var a=t.name,l=t.clusterId,c={testEnv:!1,prodEnv:!1};e.hostSetting={labelTxt:"",diskTxt:"",isUsedToBuild:!1},e.$emit("pageTitle",{title:a,descrition:"",mod:"cluster"}),e.parentState='clusterDetail({id:"'+l+'"})',n.getNodeInfo(l,a).then(function(t){var n=t.data.result;e.hostSetting.diskTxt=n.diskInfo,n.capacity.memory=(n.capacity.memory/1024/1024).toFixed(2),n.statusTxt="Ready"==n.status?"在线":"离线",n.labels&&(n.labels.TESTENV&&(c.testEnv=!0),n.labels.PRODENV&&(c.prodEnv=!0),e.envData=angular.copy(c),delete n.labels["kubernetes.io/hostname"],delete n.labels.TESTENV,delete n.labels.PRODENV,delete n.labels.hostEnv,n.labels.BUILDENV&&(e.hostSetting.isUsedToBuild=!0,delete n.labels.BUILDENV),e.labelsList=n.labels),e.node=n},function(){o.openWarning("请求失败！"),r.go("clusterManage")})["finally"](function(){s.host=!1,!s.instance&&e.loading&&(e.loading=!1)}),n.getHostInstance(l,a).then(function(t){e.instanceList=t.data.result||[]})["finally"](function(){s.instance=!1,!s.host&&e.loading&&(e.loading=!1)}),e.showLog=function(e,t,n){i.open({templateUrl:"index/tpl/modal/instanceLogModal/instanceLogModal.html",controller:"instanceLogModalCtr",size:"md",resolve:{instanceInfo:function(){return{clusterId:l,namespace:n,instanceName:e,containers:t}}}})},e.toggleBuildEnv=function(){if(e.hostSetting.isUsedToBuild)n.deleteLabel(l,a,"BUILDENV").then(function(t){e.hostSetting.isUsedToBuild=!1},function(){o.openWarning("修改失败！")});else{var t={node:a,labels:{BUILDENV:"HOSTENVTYPE"}};n.addLabel(l,t).then(function(){e.hostSetting.isUsedToBuild=!0},function(){o.openWarning("添加失败！")})}e.hostSetting.isUsedToBuild=!e.hostSetting.isUsedToBuild},e.modifyEnv=function(){function t(e){n.deleteLabel(l,a,e).then(function(t){"TESTENV"===e?c.testEnv=!1:"PRODENV"===e&&(c.prodEnv=!1)},function(){o.openWarning("修改失败！")})}function i(){!e.envData.testEnv&&c.testEnv&&t("TESTENV"),!e.envData.prodEnv&&c.prodEnv&&t("PRODENV")}if(!e.envData.testEnv&&!e.envData.prodEnv)return void o.openWarning("请至少选中一个工作场景！");var r={},s=!1;e.envData.testEnv&&!c.testEnv&&(r.TESTENV="HOSTENVTYPE",s=!0),e.envData.prodEnv&&!c.prodEnv&&(r.PRODENV="HOSTENVTYPE",s=!0);var u={node:a,labels:r};s?n.addLabel(l,u).then(function(){u.labels.TESTENV&&(c.testEnv=!0),u.labels.PRODENV&&(c.prodEnv=!0)},function(){o.openWarning("修改失败！")})["finally"](function(){i()}):i()},e.addLabel=function(){if(e.hostSetting.labelTxt&&""!==e.hostSetting.labelTxt){var t={node:a,labels:{}};t.labels[e.hostSetting.labelTxt]="USER_LABEL_VALUE",n.addLabel(l,t).then(function(){e.labelsList[e.hostSetting.labelTxt]="USER_LABEL_VALUE",e.hostSetting.labelTxt=""},function(){o.openWarning("添加失败！")})}},e.deleteLable=function(t){o.openConfirm("删除主机标签可能会影响部署，是否继续？").then(function(){n.deleteLabel(l,a,t).then(function(n){delete e.labelsList[t]},function(){o.openWarning("删除失败！")})})},e.saveDisk=function(){n.modifyDisk(l,a,e.hostSetting.diskTxt).then(function(){o.openPrompt("修改成功！")},function(){o.openWarning("修改失败！")})},e.toConsole=function(t){i.open({templateUrl:"index/tpl/modal/selectContainerModal/selectContainerModal.html",controller:"selectContainerModalCtr",size:"md",resolve:{containerList:function(){return e.instanceList[t].containers},hostIp:function(){return e.instanceList[t].hostIp}}})}}]),domeApp.controller("addHostCtr",["$scope","$state","$stateParams","$domeCluster","$domeMonitor","$domeGlobal","$domePublic",function(e,t,n,o,i,r,s){"use strict";function a(){var t=["curl -o start_node_centos.sh http://deploy-domeos.bjcnc.scs.sohucs.com/start_node_centos.sh && sudo sh start_node_centos.sh"];l.api_servers&&t.push(" --api-server "+l.api_servers),l.cluster_dns&&t.push(" --cluster-dns "+l.cluster_dns),l.cluster_domain&&t.push(" --cluster-domain "+l.cluster_domain),l.monitor_transfer&&t.push(" --monitor-transfer "+l.monitor_transfer),l.registry_type&&t.push(" --registry-type "+l.registry_type),l.registry_arg&&t.push(" --registry-arg "+l.registry_arg),l.domeos_server&&t.push(" --domeos-server "+l.domeos_server),l.etcd_server&&t.push(" --etcd-server "+l.etcd_server),t.push(" --node-labels "+l.node_labels),e.hostCmd=t.join("")}e.$emit("pageTitle",{title:"添加主机",descrition:"请按照步骤操作，将您的主机添加到DomeOS上。",mod:"cluster"}),void 0!==n.id&&""!==n.id||t.go("clusterManage"),e.parentState='clusterDetail({"id":'+n.id+"})",e.isLoading=!0,e.hostInfo={labels:"",env:{test:!1,prod:!1}};var l={},c=r.getGloabalInstance("registry"),u=r.getGloabalInstance("server");e.getCmdLabels=function(){for(var t=e.hostInfo.labels.split(" "),n=[],o=0;o<t.length;o++)""!==t[o]&&n.push(t[o]+"=USER_LABEL_VALUE,");e.hostInfo.env.test&&n.push("TESTENV=HOSTENVTYPE,"),e.hostInfo.env.prod&&n.push("PRODENV=HOSTENVTYPE,"),n.push("BUILDENV=HOSTENVTYPE"),l.node_labels=n.join(""),a()},o.getClusterDetail(n.id).then(function(t){var n=t.data.result;l.api_servers=n.api,l.cluster_dns=n.dns,l.cluster_domain=n.domain,l.etcd_server=n.etcd,l.etcd_server&&","==l.etcd_server.slice(-1)&&(l.etcd_server=l.etcd_server.slice(0,-1)),e.getCmdLabels(),i.getMonitorInfo().then(function(e){var t=e.data.result;t&&t.transfer&&""!==t.transfer&&(l.monitor_transfer=t.transfer),a()}),c.getData().then(function(e){1===e.status?l.registry_type="https":l.registry_type="http",e.url&&(e.url=e.url.replace("http://",""),e.url=e.url.replace("https://","")),l.registry_arg=e.url,a()}),u.getData().then(function(e){l.domeos_server=e.url,a()})},function(){s.openWarning("请求失败！"),t.go("clusterManage")})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("buildModalCtr",["$scope","projectInfo","$domeProject","$domePublic","$modalInstance",function(e,t,n,o,i){"use strict";e.projectInfo=t,e.buildInfo={selectedBranch:"",imageTag:""},e.projectInfo.hasCodeInfo&&(e.isModalLoading=!0,n.getBranchList(e.projectInfo.projectId).then(function(t){e.branches=t.data.result,e.buildInfo.selectedBranch=e.branches[0]})["finally"](function(){e.isModalLoading=!1})),e.toggleBranch=function(t){e.buildInfo.selectedBranch=t},e.close=function(){i.dismiss("cancel")},e.toBuild=function(){var t={projectId:e.projectInfo.projectId};e.projectInfo.hasCodeInfo&&(t.codeBranch=e.buildInfo.selectedBranch),e.buildInfo.imageTag&&(t.imageTag=e.buildInfo.imageTag),n.toBuild(t).then(function(e){200==e.data.resultCode?(i.close(),o.openPrompt("成功，正在构建！")):(i.close(),o.openWarning("构建失败！错误信息："+e.data.resultMsg))},function(){o.openWarning("构建失败，请重试！")})}}]),domeApp.controller("hostListModalCtr",["$scope","hostList","$modalInstance","filterFilter",function(e,t,n,o){"use strict";e.hostList=o(t,{labelFilter:!0})}]),domeApp.controller("otherImageModalCtr",["$scope","$modalInstance",function(e,t){"use strict";e.imageInfo={name:"",tag:"",registry:""},e.submitImage=function(){t.close(e.imageInfo)}}]),domeApp.controller("instanceLogModalCtr",["$scope","$sce","instanceInfo","$location","$interval",function(e,t,n,o,i){"use strict";function r(){s&&(e.log=t.trustAsHtml(""),l="",s.close()),s=new WebSocket(u+"/api/deploy/instance/log/realtime?clusterid="+n.clusterId+"&namespace="+n.namespace+"&instancename="+n.instanceName+"&containername="+e.currentContainer.containerName),s.onopen=function(e){p(e)},s.onmessage=function(e){f(e)},s.onclose=function(){console.log("连接被关闭！")}}var s,a,l="",c=!1,u="ws://"+o.host();o.port()&&(u+=":"+o.port()),n.containers||(n.containers=[]);for(var d=0;d<n.containers.length;d++)n.containers[d].pageTxt=n.containers[d].containerId.substring(0,12)+"("+n.containers[d].imageName+")";if(e.instanceInfo=n,e.instanceInfo.containers[0]){e.currentContainer=e.instanceInfo.containers[0],r(),a=i(function(){c&&(e.log=t.trustAsHtml(l),c=!1)},1500);var f=function(e){c=!0,l=(l+e.data).replace(/[\n]/g,"<br>")},p=function(e){console.log("连接打开！")};e.toggleContainer=function(t){e.instanceInfo.containers[t].containerId!==e.currentContainer.containerId&&(e.currentContainer=e.instanceInfo.containers[t],r())},e.$on("$destroy",function(){return i.cancel(a),s?(s.close(),!1):void 0})}}]),domeApp.controller("selectContainerModalCtr",["$scope","containerList","hostIp","$modalInstance",function(e,t,n,o){"use strict";e.containerList=t||[],e.hostIp=n;for(var i=0;i<e.containerList.length;i++)e.containerList[i].shortContainerId=e.containerList[i].containerId.substring(0,12),e.containerList[i].pageContainer=e.containerList[i].shortContainerId+" ("+e.containerList[i].imageName+")";e.toggleCurrentContainer=function(t){e.currentContainer=e.containerList[t]},e.containerList[0]&&e.toggleCurrentContainer(0),e.cancel=function(){o.dismiss("")}}]),domeApp.controller("tplUserListCtr",["$scope","$domeUser","$domePublic",function(e,t,n){function o(){for(var t=0,n=0;n<e.userInfos.length&&!("master"==e.userInfos[n].role&&(t++,t>1));n++);return t}switch(e.resourceType){case"PROJECT":e.resourceName="项目";break;case"DEPLOY":e.resourceName="部署";break;case"group":e.resourceName="组";break;case"CLUSTER":e.resourceName="集群";break;default:e.resourceName=""}e.isEdit=!1,e.selectWay="member",e.selectedRole="reporter",e.userKey={key:""};var i=function(){e.selectedGroup={},e.selectedUsers=[],e.selectResource={},t.getUserList().then(function(t){e.userList=t.data.result||[]}),"group"!==e.resourceType?(t.getSigResourceUser(e.resourceType,e.resourceId).then(function(n){e.resourceInfo=t.getInstance("ResourceUser",n.data.result),e.userInfos=e.resourceInfo.resourceInfo.userInfos,e.groupInfo=e.resourceInfo.resourceInfo.groupInfo,e.$emit("memberPermisson",!0)},function(t){e.$emit("memberPermisson",!1)}),t.getGroup().then(function(t){e.groupList=t.data.result||[]}),t.getResourceUser(e.resourceType).then(function(t){e.projectResourceUser=t.data.result?t.data.result:[],e.selectResourceUser=e.projectResourceUser})):t.getGroupUser(e.resourceId).then(function(n){var o={resourceId:e.resourceId,resourceType:"group",userInfos:n.data.result||[]};e.resourceInfo=t.getInstance("ResourceUser",o),e.userInfos=e.resourceInfo.resourceInfo.userInfos,e.groupInfo=e.resourceInfo.resourceInfo.groupInfo})};i(),e.checkUser=function(t){for(var n=!1,o=0;o<e.selectedUsers.length;o++)if(e.selectedUsers[o].username===t.username){n=!0;break}n||e.selectedUsers.push({username:t.username,owner_id:t.id,owner_type:"USER"}),e.userKey.key=""},e.cancelUser=function(t){e.selectedUsers.splice(t,1)},e.userKeyUp=function(t,n,o){13==t.keyCode&&o&&e.checkUser(o),n&&""!==n||8!=t.keyCode||e.selectedUsers.pop()},e.toggleRole=function(t){"oldRole"==t?"group"==e.selectWay?e.selectedRole="保留原有组权限":e.selectedRole="保留原有"+e.resourceName+"权限":e.selectedRole=t},e.toggleWay=function(t){t!==e.selectWay&&(e.selectResource={},e.selectWay=t,"member"==t?e.toggleRole("reporter"):e.toggleRole("oldRole"))},e.toggleResource=function(t){e.selectResource=e.selectResourceUser[t]},e.toggleGroup=function(t,n){e.selectedGroup.name=t,e.selectedGroup.id=n},e.saveRole=function(t){e.getLoginUser().then(function(i){i.username===t.user_name&&"master"==t.role&&o()<=1?n.openWarning("您是最后一个master，不能降低权限！"):e.resourceInfo.saveRole(t)})},e.addMember=function(){var o={resource_id:e.resourceInfo.resourceInfo.resourceId,resource_type:e.resourceInfo.resourceInfo.resourceType},r=[],s=0,a=function(e){n.openConfirm("会覆盖已有项目成员的权限，是否继续？").then(function(){t.modifyResourceUser(e).then(function(e){n.openPrompt("添加成功！"),i()})})};if("group"==e.selectWay){if(!e.selectedGroup.id)return void n.openWarning("请选择组！");t.getGroupUser(e.selectedGroup.id).then(function(t){var i=t.data.result;if(!i||0===i)return void n.openWarning("该组没有成员！");for(s=0;s<i.length;s++)r.push({owner_id:i[s].user_id,owner_type:"USER",role:"保留原有组权限"==e.selectedRole?i[s].role:e.selectedRole});o.ownerInfos=r,a(o)})}else if("member"==e.selectWay){if(0===e.selectedUsers.length)return void n.openWarning("请选择成员！");if("group"==e.resourceType){var l=[];for(s=0;s<e.selectedUsers.length;s++)l.push({user_id:e.selectedUsers[s].owner_id,role:e.selectedRole});t.modifyGroupUsers(e.resourceId,{members:l}).then(function(e){n.openPrompt("添加成功！"),i()},function(e){n.openWarning({title:"添加失败！",msg:"Message:"+e.data.resultMsg})})}else{for(s=0;s<e.selectedUsers.length;s++)r.push({owner_id:e.selectedUsers[s].owner_id,owner_type:"USER",role:e.selectedRole});o.ownerInfos=r,a(o)}}else{if(void 0===e.selectResource.userInfos)return void n.openWarning("请选择"+e.resourceName+"！");if(e.selectResource.userInfos=e.selectResource.userInfos||[],0===e.selectResource.userInfos.length)return void n.openWarning("当前"+e.resourceName+"无成员！");for(s=0;s<e.selectResource.userInfos.length;s++){var c=e.selectResource.userInfos[s];r.push({owner_id:c.user_id,owner_type:"USER",role:e.selectedRole=="保留原有"+e.resourceName+"权限"?c.role:e.selectedRole})}o.ownerInfos=r,a(o)}},e.deleteUser=function(t){"group"==e.resourceType?e.getLoginUser().then(function(i){t.user_id===i.id?o()>1?n.openDelete("确定要离开该组吗？").then(function(n){e.resourceInfo.deleteUser(t)}):n.openWarning("您是组中唯一的master，不能离开该组！"):n.openDelete().then(function(n){e.resourceInfo.deleteUser(t)})}):e.resourceInfo.deleteUser(t)}}]),domeApp.controller("mirrorCustomCtr",["$scope","$domeImage","$domePublic","$modal","$q",function(e,t,n,o,i){e.$emit("pageTitle",{title:"镜像定制",descrition:"在这里您可以定制满足个性化需求的镜像。",mod:"image"}),e.specificImg={language:"java",imgType:"compileimage",isSelected:!1},e.customtype="dockerfile",e.mirror=t.getMirrorInstance(),e.config=e.mirror.config,e.toggleCustomType=function(t){e.customtype=t,e.config.autoCustom="dockerfile"==t?0:1,e.config.envConfigs=[{envKey:"",envValue:"",description:""}],e.config.publish=1,e.config.imageName="",e.config.imageTag="",e.config.description="",e.specificImg={language:"java",imgType:"compileimage",isSelected:!1}},e.flag=-1;var r=function(){var n=i.defer();e.isLoading=!0;var o=e.config.imageName,r=e.config.imageTag;
return t.monitorName(o,r).then(function(t){var o=t.data.result;"PROJECT"==o?e.flag=1:"BASEIMAGE"==o?e.flag=2:"NEITHER"==o&&(e.flag=0),n.resolve(e.flag)},function(e){n.reject(-1)}),n.promise},s=function(o){t.startBuild(o).then(function(e){200===e.data.resultCode?n.openPrompt("成功，正在构建！"):(n.openWarning("启动构建失败，请重试！"),t.deleteBuild(o))},function(e){n.openWarning({title:"启动构建失败",msg:"Message:"+e.msg}),t.deleteBuild(o)})["finally"](function(){e.isLoading=!1})},a=function(){t.createCustomize(e.config).then(function(e){var t=e.data.result||{};200===e.data.resultCode?s(t.id):n.openWarning("创建定制失败，请重试！")},function(e){n.openWarning({title:"创建失败",msg:"Message:"+e.msg})})["finally"](function(){e.isLoading=!1})};e.nameTest=function(){r().then(function(t){1===e.flag?n.openWarning("该镜像名已存在，如继续构建会覆盖原镜像！"):2==e.flag?n.openWarning("该镜像已存在，如继续构建会覆盖原镜像！"):0===e.flag&&n.openPrompt("不存在同名镜像，可继续构建。"),e.flag=-1},function(e){n.openWarning({title:"检测失败",msg:"Message:"+e.msg})}),e.isLoading=!1},e.creatBuild=function(){r().then(function(t){0===e.flag?a():n.openConfirm("该镜像名已存在，如继续构建会覆盖原镜像！").then(function(){a()},function(e){}),e.flag=-1},function(e){n.openWarning({title:"检测失败",msg:"Message:"+e.msg})}),e.isLoading=!1},e.assigImgName=function(t){t?e.config.imageName=e.specificImg.imgType+"-"+e.specificImg.language:e.config.imageName=""},e.selectMirror=function(t){e.img.mirrorNameList=[],e.img.type=t;var n,o,i,r=e.img[t],s=r.length;if("baseImages"==t||"projectImages"==t){for(e.img.mirror="baseImages"==t?"基础镜像":"项目镜像",n=0;s>n;n++)for(o=n+1;s>o;o++)r[n].imageName==r[o].imageName&&(r.splice(o,1),s--,o--);var a=r.length;for(i=0;a>i;i++)e.img.mirrorNameList.push({imageName:r[i].imageName,registry:r[i].registry});e.config.sourceImage.imageName=e.img.mirrorNameList[0].imageName,e.config.sourceImage.registryUrl=e.img.mirrorNameList[0].registry}else if("otherImages"==t){for(e.img.mirror="非项目镜像",n=0;s>n;n++)e.img.mirrorNameList.push({imageName:r[n],registry:""});e.config.sourceImage.imageName=e.img.mirrorNameList[0].imageName}},e.selectMirrorName=function(n,o){e.config.sourceImage.imageName=n,e.config.sourceImage.registryUrl=o,e.img.mirrorTagList=[];var i,r=e.img[e.img.type],s=r.length,a=0;if("baseImages"==e.img.type){for(i=0;s>i;i++)r[i].imageName==n&&(e.img.mirrorTagList[a++]=r[i].imageTag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||""}else"projectImages"==e.img.type?(e.isLoading=!0,t.getDockerImageTags(n,o).then(function(t){for(var n=t.data.result||[],o=n.length,i=0;o>i;i++)e.img.mirrorTagList.push(n[i].tag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||""},function(e){}),e.isLoading=!1):"otherImages"==e.img.type&&(e.isLoading=!0,t.getGlobalImageInfo(n).then(function(t){for(var n=t.data.result||[],o=n.length,i=0;o>i;i++)e.img.mirrorTagList.push(n[i].tag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||"",e.config.sourceImage.registryUrl=n[0].registry},function(e){}),e.isLoading=!1)};var l=function(){e.isLoading=!0,t.getAllImages().then(function(t){var n=t.data.result||{};e.img=n,e.img.baseImages=n.baseImages||[],e.img.projectImages=n.projectImages||[],e.img.otherImages=n.otherImages||[],0!==e.img.baseImages.length?(e.img.type="baseImages",e.img.mirror="基础镜像",e.selectMirror("baseImages"),e.selectMirrorName(e.img.baseImages[0].imageName,e.img.baseImages[0].registry)):0!==e.img.projectImages.length?(e.img.type="projectImages",e.img.mirror="项目镜像",e.selectMirror("projectImages"),e.selectMirrorName(e.img.projectImages[0].imageName,e.img.projectImages[0].registry)):0!==e.img.otherImages&&(e.img.type="otherImages",e.img.mirror="其他镜像",e.selectMirror("otherImages"),e.selectMirrorName(e.img.otherImages[0],""))})["finally"](function(){e.isLoading=!1})};l(),e.toggleMirrorHub=function(t){e.config.sourceImage.thirdParty=t,0===t?l():(e.config.sourceImage.registryUrl="",e.config.sourceImage.imageName="",e.config.sourceImage.imageTag="")},e.customList=[];var c=function(){t.getCustomInfo().then(function(t){e.customList=t.data.result||[];for(var n=0;n<e.customList.length;n++){var o=e.customList[n];0===o.autoCustom?o.type="Dockerfile":o.type="配置文件"}})["finally"](function(){e.isLoading=!1})};e.selectImgList=function(){c()},e.selectOption={status:{All:!0,Preparing:!1,Building:!1,Success:!1,Fail:!1},builduser:{All:!0,own:!1},type:{All:!0,dockerfile:!1,configfile:!1}},e.toggleAll=function(t){angular.forEach(e.selectOption[t],function(n,o){e.selectOption[t][o]=!1}),e.selectOption[t].All=!0},e.toggleSelect=function(t,n){var o=!0;e.selectOption[t][n]=!e.selectOption[t][n],e.selectOption[t][n]?e.selectOption[t].All&&(e.selectOption[t].All=!1):(angular.forEach(e.selectOption[t],function(n,i){"All"!==i&&e.selectOption[t][i]&&o&&(o=!1)}),o&&e.toggleAll(t))},e.toggleShowDetail=function(){e.selectOption.isshowmore=!e.selectOption.isshowmore},e.getBuildLog=function(e,t){o.open({animation:!0,templateUrl:"mirrorDairyModal.html",controller:"mirrorDairyModalCtr",size:"lg",resolve:{params:function(){return{imageId:e,status:t}}}})}}]).controller("mirrorDairyModalCtr",["$scope","params","$sce","$domeImage","$location",function(e,t,n,o,i){var r,s="",a="ws://"+i.host();if(i.port()&&(a+=":"+i.port()),"Building"==t.status){r=new WebSocket(a+"/api/ci/build/log/realtime?buildId="+t.imageId+"&type=baseimage");var l=function(t){s=(s+t.data).replace(/[\n]/g,"<br>"),e.$apply(function(){e.log=n.trustAsHtml(s)})},c=function(e){console.log("连接打开！")};r.onopen=function(e){c(e)},r.onmessage=function(e){l(e)},r.onclose=function(){console.log("连接被关闭！")}}else"Success"===t.status||"Fail"===t.status?o.getLogFile(t.imageId).then(function(t){if(t.data.result){var o=t.data.result.replace(/[\n\r]/g,"<br>");e.log=n.trustAsHtml(o)}else e.log=n.trustAsHtml('<p class="nolog">无日志信息</p>')},function(t){e.log=n.trustAsHtml('<p class="nolog">无日志信息</p>')}):e.log=n.trustAsHtml('<p class="nolog">无日志信息</p>');e.$on("$destroy",function(){return r?(r.close(),!1):void 0})}]);