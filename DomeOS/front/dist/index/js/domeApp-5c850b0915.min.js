"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),publicModule=angular.module("publicModule",[]);publicModule.service("$util",["$q",function(e){var t=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},n=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!==n?unescape(n[2]):null},i=function(e,t){return null===e||void 0===e||isNaN(e)?e:"number"!=typeof e?parseFloat(parseFloat(e).toFixed(t)):parseFloat(e.toFixed(t))},o=function(e,t){if(void 0!==e&&null!==e&&!isNaN(e)){switch(t){case"MB":e=(+e/1024/1024).toFixed(2);break;case"GB":e=(+e/1024/1024/1024).toFixed(2);break;case"KB":e=(+e/1024).toFixed(2);break;default:e=+e.toFixed(2)}return+e}},r=function(e,t){for(var n,i=new RegExp("{#([a-zA-z0-9]+)}");null!==(n=i.exec(e));){var o=0===t[n[1]]?"0":t[n[1]]||"";e=e.replace(new RegExp(n[0],"g"),o)}return e},a=function(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n},s=function(e){return!!(!e||e&&t(e))},l=function(e,t){e=new Date(e),e.setDate(e.getDate()+t);var n=e.getFullYear(),i=e.getMonth()+1;10>i&&(i="0"+i);var o=e.getDate();return 10>o&&(o="0"+o),n+"-"+i+"-"+o},c=function(e,t,n){var i={};void 0===t&&(t=(new Date).getTime());var o=t-e;return i.day=Math.floor(o/864e5),o-=24*i.day*3600*1e3,i.hours=Math.floor(o/36e5),o-=3600*i.hours*1e3,i.mimutes=Math.floor(o/6e4),n&&(o-=60*i.mimutes*1e3,i.seconds=Math.floor(o/1e3)),i},u=function(e,t){var n,i="";return!e||!t||0>=t-e?i="0秒":(n=c(e,t,!0),0!==n.day&&(i+=n.day+"天"),0!==n.hours&&(i+=n.hours+"小时"),0!==n.mimutes&&(i+=n.mimutes+"分钟"),0!==n.seconds&&(i+=n.seconds+"秒"),""===i&&(i="0秒")),i},d=function(e,t,n){if(!e&&!t||0>=e-t)return"无";var i,o=c(e,t,n),r=o.day,a=o.hours,s=o.mimutes;return i=0>r||0>a||0>s?"刚刚":r>60?"更早":r>30?"一个月前":r>3?r+"天前":3==r?"三天前":2==r?"两天前":1==r?"昨天":a>=1?a+"小时前":0===s?"刚刚":s+"分钟前"},f=function(t){var n=e.defer();return $.getScript(t,function(){n.resolve()}),n.promise};return{isEmptyObject:t,parseTpl:r,toDecimal:i,formartBytesData:o,getQueryString:n,objLength:a,isNullorEmpty:s,calculateDate:l,getPageInterval:u,getDateInterval:c,getPageDate:d,loadJs:f}}]).factory("$domeModel",["$http",function(e){var t=function(e,t){var n,i=e;for(n=0;n<t.length;n++)i+="/"+t[n];return i},n=function(){function e(t){_classCallCheck(this,e),this.selectListName=t?t:"selectList",this.isCheckAll=!1,this.selectedCount=0,this[this.selectListName]=[]}return _createClass(e,[{key:"init",value:function(e,t){var n=this;this.isCheckAll=!1,this.selectedCount=0,this[this.selectListName]=function(){if(e&&0!==e.length){if("object"===_typeof(e[0]))for(var i=0;i<e.length;i++)e[i].keyFilter=!0,void 0!==t&&(e[i].isSelected=t),e[i].isSelected&&n.selectedCount++;else for(var o=0;o<e.length;o++)e[o]={item:e[o],keyFilter:!0,isSelected:t},void 0!==t&&(e[o].isSelected=t),e[o].isSelected&&n.selectedCount++;return n.selectedCount===e.length&&(n.isCheckAll=!0),e}return[]}()}},{key:"toggleCheck",value:function(e,t){var n=!0;if(e.isSelected=t,t){this.selectedCount++;var i=this[this.selectListName],o=!0,r=!1,a=void 0;try{for(var s,l=i[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;if(c.keyFilter&&!c.isSelected){n=!1;break}}}catch(u){r=!0,a=u}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw a}}n&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1}},{key:"checkAllItem",value:function(e){this.isCheckAll=void 0===e?this.isCheckAll:e,this.selectedCount=0;var t=this[this.selectListName],n=!0,i=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;s.keyFilter&&this.isCheckAll?(s.isSelected=!0,this.selectedCount++):s.isSelected=!1}}catch(l){i=!0,o=l}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}}},{key:"filterWithKey",value:function(e,t){this.isCheckAll=!1,this.selectedCount=0,void 0===t&&(t="item");var n=this[this.selectListName];if(void 0!==n[0][t]){var i=!0,o=!1,r=void 0;try{for(var a,s=n[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;l.isSelected=!1,l.keyFilter=-1!==l[t].indexOf(e)}}catch(c){o=!0,r=c}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw r}}}}}]),e}(),i=function(n){var i=this;i.getData=function(){return e.get(t(n,arguments))},i.setData=function(t,i){return e.post(n,t,i)},i.updateData=function(t){return e.put(n,t)},i.deleteData=function(){return e["delete"](t(n,arguments))}},o=function(e){return e||(e={}),function(t){for(var n=arguments.length,i=Array(n>1?n-1:0),o=1;n>o;o++)i[o-1]=arguments[o];return function(){var n,o=e[t];return o&&"function"==typeof o?n=new(Function.prototype.bind.apply(o,[null].concat(i))):(n={},console.log("error:there is no "+t)),n}()}};return{SelectListModel:n,ServiceModel:i,instancesCreator:o}}]).provider("$domeData",function(){var e={},t=function(t,n){e[t]=n},n=function(t){return e[t]},i=function(t){e[t]&&(e[t]=null)};return{setData:t,$get:function(){return{setData:t,getData:n,delData:i}}}}),publicModule.directive("selectCon",function(){return{restrict:"AEC",scope:!0,transclude:!0,replace:!0,template:"<div ng-transclude></div>",controller:["$scope",function(e){this.hideSelect=function(){e.hideSelect()}}],link:function(e,t,n){var i=t.find(".select-list"),o=t.find(".ui-btn-select"),r=t.find(".drop"),a=!1;if(0!==o.length){i.hide(),o.on("blur",l);var s=function(e){a=void 0!==e?e:!a,a===!0?(i.show(),r.removeClass("up")):a===!1&&(i.hide(),r.addClass("up"))},l=function(e){return s(!1),e.stopPropagation()};o.on("blur",l),i.on("mouseenter",function(){o.off("blur",l)}).on("mouseleave",function(){o.on("blur",l)}),"INPUT"===o[0].tagName?o.on("focus",function(){s(!0)}):o.on("click",function(){s()}),"true"==n.label&&(t.on("click",function(){o.focus()}),o.bind("focus",function(e){o.width(t.width()-20-o.position().left),e.stopPropagation()}).bind("blur",function(){o.width(120)})),e.hideSelect=function(){s(!1)}}}}}).directive("selectItem",["$compile",function(e){return{restrict:"AEC",require:"^?selectCon",link:function(t,n,i,o){t.hideSelect=function(){o.hideSelect()};var r=angular.element(i.$$element.find(">a")[0]),a=r.attr("ng-click");a?a+=";hideSelect($event.stopPropagation());":a="hideSelect($event.stopPropagation())",r.attr("ng-click",a),n.html(e(n.html())(t))}}}]).directive("loading",function(){return{restrict:"AE",template:'<div class="com-loading"><div class="dot1"></div><div class="dot2"></div></div>',replace:!0}}).directive("domeRadio",function(){return{restrict:"E",scope:{radioModel:"=dModel",label:"@dLabel",name:"@dName",id:"@dId",disabled:"@dDisabled",value:"@dValue",changeEvent:"&dChange"},replace:!0,template:'<span><input id="{{id}}" type="radio" name="{{name}}" class="ui-radio" ng-value="{{value}}" ng-model="radioModel" ng-change="changeEvent({model:radioModel})" ng-disabled="{{disabled}}"/><label ng-bind="label" for="{{id}}"></label></span>'}}).directive("domeCheck",function(){return{restrict:"E",scope:{checkModel:"=ngModel",label:"@dLabel",name:"@dName",id:"@dId",trueValue:"@dTrueValue",falseValue:"@dFalseValue",changeEvent:"&dChange"},replace:!0,template:'<span><input id="{{id}}" type="checkbox" name="{{name}}" class="ui-check" ng-true-value="{{trueValue||true}}"  ng-false-value="{{falseValue||false}}" ng-model="checkModel" ng-change="changeEvent({model:checkModel})" /><label ng-bind="label" for="{{id}}"></label></span>'}}),publicModule.directive("notEqual",function(){return{restrict:"A",require:"ngModel",scope:{notEqual:"=notEqual"},link:function(e,t,n,i){i.$parsers.unshift(function(t){var n=void 0===e.notEqual?!1:e.notEqual.toString()===t;return i.$setValidity("notEqual",!n),t})}}}).directive("equal",function(){return{restrict:"A",require:"ngModel",scope:{equal:"=equal"},link:function(e,t,n,i){i.$parsers.unshift(function(t){var n=void 0===e.equal?!0:e.equal.toString()===t;return i.$setValidity("equal",n),t})}}}),function(){var e=angular.module("domeModule",[]);e.config(["$httpProvider",function(e){e.defaults.headers.post["Content-Type"]="application/json;charset=UTF-8",e.interceptors.push(["$rootScope","$q",function(e,t){return{response:function(e){return"string"==typeof e.data&&e.data.indexOf('<html ng-app="loginApp">')>=0&&(-1!==e.config.url.indexOf("api/user/logout")?location.href="/login/login.html":location.href="/login/login.html?redirect="+encodeURIComponent(location.href)),e.config.notIntercept?e:e.data.resultCode&&200!=e.data.resultCode?t.reject(e):e||t.resolve(e)}}}])}]),e.controller("PromptModalCtrl",["$scope","$modalInstance","promptTxt","$timeout",function(e,t,n,i){e.promptTxt=n,i(function(){t.dismiss("cancel")},1e3),e.cancel=function(){t.dismiss("cancel")}}]).controller("WarningModalCtrl",["$scope","$modalInstance","promptTxt",function(e,t,n){"string"==typeof n?e.titleInfo=n:(e.titleInfo=n.title,e.detailInfo=n.msg),e.cancel=function(){t.dismiss("cancel")}}]).controller("ConfirmModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n,e.cancel=function(){t.dismiss("cancel")},e.sure=function(){t.close()}}]).controller("DeleteModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n||"确定要删除吗？",e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]).controller("ModifyUserInfoCtr",["$scope","user","$publicApi","$modalInstance","$domePublic",function(e,t,n,i,o){e.user=t,e.cancel=function(){i.dismiss()},e.submit=function(){var e={id:t.id,username:t.username,email:t.email,phone:t.phone};n.modifyUserInfo(e).then(function(){o.openPrompt("修改成功！"),i.close(e)},function(e){o.openWarning({title:"修改失败！",msg:e.data.resultMsg})})}}]),e.factory("$domePublic",["$modal",function(e){var t={};t.openWarning=function(t){e.open({animation:!0,templateUrl:"warningModal.html",controller:"WarningModalCtrl",size:"sm",resolve:{promptTxt:function(){return t}}})},t.openPrompt=function(t){var n=e.open({animation:!0,templateUrl:"promptModal.html",controller:"PromptModalCtrl",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result},t.openConfirm=function(t){var n=e.open({animation:!0,templateUrl:"confirmModal.html",controller:"ConfirmModalCtr",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result},t.openDelete=function(t){var n=e.open({animation:!0,templateUrl:"deleteModal.html",controller:"DeleteModalCtr",size:"sm",resolve:{promptTxt:function(){return t}}});return n.result};var n=function(){this.isLoading=!1,this.loadingItems={}};return n.prototype={startLoading:function(e){this.loadingItems[e]=!0,this.isLoading||(this.isLoading=!0)},finishLoading:function(e){var t=this,n=!1;t.loadingItems[e]=!1,angular.forEach(t.loadingItems,function(e){e&&!n&&(n=!0)}),t.isLoading=n}},t.getLoadingInstance=function(){return new n},t}]).factory("$publicApi",["$http",function(e){var t={};return t.getDomeVersion=function(){return e.get("/api/global/version")},t.getDbConfig=function(){return e.get("/api/global/database")},t.getCurrentUser=function(){return e.get("/api/user/get")},t.modifyUserInfo=function(t){return e.post("/api/user/modify",angular.toJson(t))},t.logout=function(){return e.get("/api/user/logout")},t}]),window.domeModule=e}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){function e(e,t,n,i,o,r,a,s,l){var c=t.getInstance("NodeService"),u=function(){var t="/api/deploy",n="/api/version";this.getList=function(){return e.get(t+"/list")},this.getSingle=function(n){return e.get(t+"/id/"+n)},this.getEvents=function(n){return e.get(t+"/event/list?deployId="+n)},this.getInstances=function(n){return e.get(t+"/"+n+"/instance")},this.getVersions=function(t){return e.get(n+"/list?deployId="+t)},this.getSingleVersion=function(t,i){return e.get(n+"/id/"+t+"/"+i)},this.createVersion=function(t){return e.post(n+"/create?deployId="+t.deployId,angular.toJson(t))},this.rollbackDeploy=function(t,n,i){return i?e.post("/api/deploy/action/rollback?deployId="+t+"&version="+n+"&replicas="+i):e.post("/api/deploy/action/rollback?deployId="+t+"&version="+n)},this.updateDeploy=function(t,n,i){return i?e.post("/api/deploy/action/update?deployId="+t+"&version="+n+"&replicas="+i):e.post("/api/deploy/action/update?deployId="+t+"&version="+n)},this.startDeploy=function(t,n,i){return i?e.post("/api/deploy/action/start?deployId="+t+"&version="+n+"&replicas="+i):e.post("/api/deploy/action/start?deployId="+t+"&version="+n)}},d=new u,f=function(){function n(e){_classCallCheck(this,n),this.namespaceList=[],this.isNewNamespace=!1,this.imageList=void 0,this.envList=[{value:"TEST",text:"测试环境"},{value:"PROD",text:"生产环境"}],this.valid={ips:!1},this.logConfig=void 0,this.envText="请选择部署环境",this.versionList=void 0,this.nodeListIns=t.getInstance("NodeList"),this.nodeListForIps=[],this.clusterListIns=t.getInstance("ClusterList"),this.loadingIns=r.getLoadingInstance(),this.creator={id:null,name:null,type:null},this.visitMode="noAccess",this.config={},this.init(e)}return _createClass(n,[{key:"init",value:function(e){var t=this,n=void 0,i=void 0,o=void 0,r=void 0,a=-1;for(e||(e={}),void 0===e.replicas&&(e.replicas=3),void 0===e.exposePortNum&&(e.exposePortNum=""),e.loadBalanceDrafts||(e.loadBalanceDrafts=[]),e.innerServiceDrafts||(e.innerServiceDrafts=[]),i=0;i<e.loadBalanceDrafts.length;i++){e.loadBalanceDrafts[i].externalIPs||(e.loadBalanceDrafts[i].externalIPs=[]);var s=e.loadBalanceDrafts[i].externalIPs,l=[];for(o=0;o<s.length;o++)l.push({ip:s[o]});l.push({ip:""}),e.loadBalanceDrafts[i].externalIPs=l}if(this.config=e,this.addLoadBalance(),this.addInnerService(),this.config.networkMode||(this.config.networkMode="DEFAULT"),this.config.accessType||(this.config.accessType="K8S_SERVICE"),n=this.config.currentVersions,this.config.deployId){if(this.versionList||d.getVersions(this.config.deployId).then(function(e){t.versionList=e.data.result||[],n&&0!==n.length||t.toggleVersion(t.versionList[0].version)}),n&&0!==n.length){for(i=0;i<n.length;i++)n[i].createTime>a&&(a=n[i].createTime,r=n[i].version);this.toggleVersion(r)}}else this.initData()}},{key:"initData",value:function(){var e=this;if(this.config.logDraft||(this.config.logDraft={}),this.config.logDraft.logItemDrafts||(this.config.logDraft.logItemDrafts=[]),this.config.logDraft.logItemDrafts.push({logPath:"",autoCollect:!1,autoDelete:!1}),this.config.containerDrafts||(this.config.containerDrafts=[]),this.config.labelSelectors||(this.config.labelSelectors=[]),this.initSelectedLabels(),this.config.hostEnv){for(var t=0;t<this.envList.length;t++)if(this.config.hostEnv===this.envList[t].value){this.toggleEnv(this.envList[t]);break}}else this.toggleEnv(this.envList[0]);this.config.stateful||(this.imageList?this.formartContainerDrafts():(this.loadingIns.startLoading("dockerImage"),o.imageService.getProjectImages().then(function(t){for(var n=t.data.result||[],i=0;i<n.length;i++){var o=[];if(n[i].envSettings)for(var r=0;r<n[i].envSettings.length;r++)o.push({key:n[i].envSettings[r].key,value:n[i].envSettings[r].value,description:n[i].envSettings[r].description});n[i].envSettings=o}e.imageList=n,e.formartContainerDrafts()})["finally"](function(){e.loadingIns.finishLoading("dockerImage")})))}},{key:"initCluster",value:function(){var e=this;return this.loadingIns.startLoading("cluster"),c.getData().then(function(t){e.clusterListIns.init(t.data.result),e.toggleCluster()})["finally"](function(){e.loadingIns.finishLoading("cluster")})}},{key:"freshDeploy",value:function(e){e&&(this.config.lastUpdateTime=e.lastUpdateTime,this.config.deploymentStatus=e.deploymentStatus,this.config.currentVersions=e.currentVersions,this.config.currentReplicas=e.currentReplicas)}},{key:"freshVersionList",value:function(){var e=this;this.loadingIns.startLoading("versionList"),d.getVersions(this.config.deployId).then(function(t){e.versionList=t.data.result||[]})["finally"](function(){e.loadingIns.finishLoading("versionList")})}},{key:"toggleCluster",value:function(e){var t=this,n=void 0;if(void 0===e){for(var i=!1,o=this.clusterListIns.clusterList,r=0;r<o.length;r++)if(o[r].id===this.config.clusterId){i=!0,e=r;break}if(!i){if(0===this.clusterListIns.clusterList.length)return;e=0}}this.clusterListIns.toggleCluster(e),this.logConfig=this.clusterListIns.clusterList[e].logConfig,n=this.clusterListIns.cluster.id,1!==this.logConfig&&(this.config.logDraft={logItemDrafts:[{logPath:"",autoCollect:!1,autoDelete:!1}]}),this.loadingIns.startLoading("nodelist"),c.getNodeList(n).then(function(e){var n=e.data.result||[];t.nodeListForIps=angular.copy(n);for(var i=0;i<t.nodeListForIps.length;i++){var o=t.nodeListForIps[i];if("Ready"==o.status){var r=t.config.loadBalanceDrafts[0].externalIPs,a=!0,s=!1,l=void 0;try{for(var c,u=r[Symbol.iterator]();!(a=(c=u.next()).done);a=!0){var d=c.value;if(d===o.ip){o.isSelected=!0;break}}}catch(f){s=!0,l=f}finally{try{!a&&u["return"]&&u["return"]()}finally{if(s)throw l}}void 0===o.isSelected&&(o.isSelected=!1)}else t.nodeListForIps.splice(i,1),i--}if(t.nodeListIns.init(n,t.config.stateful),t.initSelectedLabels(),t.nodeListIns.toggleEnv(t.config.hostEnv),t.config.stateful&&t.config.replicas&&t.nodeListIns.nodeList)for(var p=0;p<t.nodeListIns.nodeList.length&&p<t.config.replicas;p++)t.nodeListIns.nodeList[p].isSelected=!0,t.nodeListIns.toggleNodeCheck(t.nodeListIns.nodeList[p])},function(){t.nodeListIns.init()})["finally"](function(){t.loadingIns.finishLoading("nodelist")}),void 0===this.config.deployId&&(this.loadingIns.startLoading("namespace"),c.getNamespace(n).then(function(e){t.namespaceList=e.data.result||[],t.isNewNamespace=!1,t.config.namespace=t.namespaceList[0].name||void 0;for(var n=0;n<t.namespaceList.length;n++)if("default"==t.namespaceList[n].name){t.config.namespace=t.namespaceList[n].name;break}},function(){t.isNewNamespace=!1,t.namespaceList=[],t.config.namespace=void 0})["finally"](function(){t.loadingIns.finishLoading("namespace")}))}},{key:"initSelectedLabels",value:function(){if(this.nodeListIns.initLabelsInfo(),this.config.labelSelectors){var e=this.config.labelSelectors,t=!0,n=!1,i=void 0;try{for(var o,r=e[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value,s=a.name;"kubernetes.io/hostname"!=s&&"TESTENV"!=s&&"PRODENV"!=s&&this.nodeListIns.toggleLabel(s,!0)}}catch(l){n=!0,i=l}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw i}}}}},{key:"validIps",value:function(){if("foreign"===this.visitMode){var e=!0,t=!1,n=void 0;try{for(var i,o=this.nodeListForIps[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value;if(r.isSelected)return void(this.valid.ips=!0)}}catch(a){t=!0,n=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw n}}this.valid.ips=!1}else this.valid.ips=!0}},{key:"toggleVersion",value:function(e){var t=this;d.getSingleVersion(this.config.deployId,e).then(function(e){e.data.result&&($.extend(t.config,e.data.result),t.initData())})}},{key:"formartContainerDrafts",value:function(){for(var e=this,t=this.config.containerDrafts,n=function(t){e.loadingIns.startLoading("tag"),o.imageService.getImageTags(t.image,t.registry).then(function(e){t.tagList=e.data.result||[]})["finally"](function(){e.loadingIns.finishLoading("tag")})},i=0;i<t.length;i++){t[i].oldEnv=[],t[i].newEnv=[],n(t[i]);for(var r=[],a=0;a<this.imageList.length;a++)if(this.imageList[a].imageName===t[i].image){r=this.imageList[a].envSettings;break}if(t[i].envs)for(var s=0;s<t[i].envs.length;s++){for(var l=!1,c=0;c<r.length;c++)if(r[c].key===t[i].envs[s].key){l=!0;break}l?t[i].oldEnv.push(t[i].envs[s]):t[i].newEnv.push(t[i].envs[s])}else t[i].oldEnv=angular.copy(r)}}},{key:"toggleNamespace",value:function(e){this.config.namespace=e}},{key:"toggleIsNewNamespace",value:function(){this.isNewNamespace=!this.isNewNamespace,this.config.namespace=void 0}},{key:"toggleEnv",value:function(e){this.config.hostEnv=e.value,this.envText=e.text,this.nodeListIns.toggleEnv(e.value)}},{key:"toggleCreator",value:function(e){this.creator=e}},{key:"toggleImageTag",value:function(e,t){this.config.containerDrafts[e].tag=t}},{key:"addImage",value:function(e){var t=this;this.loadingIns.startLoading("addImage"),o.imageService.getImageTags(e.imageName,e.registry).then(function(n){var i=n.data.result;t.config.containerDrafts.push({image:e.imageName,registry:e.registry,cpu:.5,mem:1024,tag:i&&i[0]?i[0].tag:void 0,tagList:i?i:[],oldEnv:e.envSettings?e.envSettings:[],newEnv:[],healthChecker:{type:"NONE"}})})["finally"](function(){t.loadingIns.finishLoading("addImage")})}},{key:"addOtherImage",value:function(){var e=this,t=s.open({animation:!0,templateUrl:"/index/tpl/modal/otherImageModal/otherImageModal.html",controller:"OtherImageModalCtr",size:"md"});t.result.then(function(t){e.config.containerDrafts.push({image:t.name,registry:t.registry,cpu:.5,mem:1024,tag:t.tag,tagList:[{tag:t.tag}],oldEnv:[],newEnv:[]})})}},{key:"deleteImage",value:function(e){this.config.containerDrafts.splice(e,1)}},{key:"addImageEnv",value:function(e){this.config.containerDrafts[e].newEnv.push({key:"",value:"",description:""})}},{key:"deleteImageEnv",value:function(e,t){this.config.containerDrafts[e].newEnv.splice(t,1)}},{key:"addLoadBalance",value:function(){this.config.loadBalanceDrafts.push({port:"",targetPort:"",externalIPs:[{ip:""}]})}},{key:"addInnerService",value:function(){this.config.innerServiceDrafts.push({port:"",targetPort:""})}},{key:"addExternalIPs",value:function(e){this.config.loadBalanceDrafts[e].externalIPs.push({ip:""})}},{key:"deleteExternalIPs",value:function(e,t){this.config.loadBalanceDrafts[e].externalIPs.splice(t,1)}},{key:"addLogDraft",value:function(){this.config.logDraft.logItemDrafts.push({logPath:"",autoCollect:!1,autoDelete:!1})}},{key:"deleteLogDraft",value:function(e){this.config.logDraft.logItemDrafts.splice(e,1)}},{key:"deleteArrItem",value:function(e,t){this.config[e].splice(t,1)}},{key:"formartHealthChecker",value:function(){if("HOST"==this.config.networkMode){var e=!0,t=!1,n=void 0;try{for(var i,o=this.config.containerDrafts[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value;r.healthChecker={type:"NONE"}}}catch(a){t=!0,n=a}finally{try{!e&&o["return"]&&o["return"]()}finally{if(t)throw n}}}}},{key:"changeNetworkmode",value:function(){if("HOST"==this.config.networkMode)for(var e=0;e<this.config.loadBalanceDrafts.length;e++)this.config.loadBalanceDrafts[e].port=this.config.loadBalanceDrafts[e].targetPort}},{key:"changeTargetPort",value:function(e){this.config.loadBalanceDrafts[e].port=this.config.loadBalanceDrafts[e].targetPort}},{key:"_formartDeploy",value:function(){var e=this,t=angular.copy(this.config);return"HOST"==t.networkMode?(t.loadBalanceDrafts=[],t.accessType="DIY",t.innerServiceDrafts=[],"noAccess"==this.visitMode&&(t.exposePortNum=0)):(t.exposePortNum=0,"noAccess"==this.visitMode?(t.accessType="DIY",t.loadBalanceDrafts=[],t.innerServiceDrafts=[]):"internal"==this.visitMode?(t.accessType="K8S_SERVICE",t.innerServiceDrafts[0].targetPort=t.innerServiceDrafts[0].port,t.loadBalanceDrafts=[]):(t.accessType="K8S_SERVICE",t.innerServiceDrafts=[])),t.loadBalanceDrafts=function(){var n=[],i=[],o=!0,r=!1,a=void 0;try{for(var s,l=e.nodeListForIps[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;c.isSelected&&n.push(c.ip)}}catch(u){r=!0,a=u}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw a}}var d=!0,f=!1,p=void 0;try{for(var g,m=t.loadBalanceDrafts[Symbol.iterator]();!(d=(g=m.next()).done);d=!0){var h=g.value;h.port&&(h.externalIPs=n,i.push(h))}}catch(u){f=!0,p=u}finally{try{!d&&m["return"]&&m["return"]()}finally{if(f)throw p}}return i}(),t.stateful?t.hostList=this.nodeListIns.getSelectedNodes():t.labelSelectors=this.nodeListIns.getFormartSelectedLabels(),t.clusterId=this.clusterListIns.cluster.id,this.creator.id&&(t.creator={creatorId:this.creator.id,creatorName:this.creator.name,creatorType:this.creator.type}),t.logDraft=function(){var e=[],n=!0,i=!1,o=void 0;try{for(var r,a=t.logDraft.logItemDrafts[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;if(""!==s.logPath){var l={logPath:s.logPath,autoCollect:s.autoCollect,autoDelete:s.autoDelete};s.autoCollect&&(l.logTopic=s.logTopic,l.processCmd=s.processCmd),s.autoDelete&&(l.logExpired=s.logExpired),e.push(l)}}}catch(c){i=!0,o=c}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}return 0===e.length?null:{logItemDrafts:e}}(),t.containerDrafts=function(){if(t.stateful)return t.containerDrafts;if(t.containerDrafts){var e=void 0,n=[],i=void 0,o=!0,r=!1,a=void 0;try{for(var s,l=t.containerDrafts[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;e=c.oldEnv,c.healthChecker||(c.healthChecker={type:"NONE"}),i={type:c.healthChecker.type},"HOST"!=t.networkMode?("TCP"!=i.type&&"HTTP"!=i.type||(i.port=c.healthChecker.port,i.timeout=c.healthChecker.timeout,i.delay=c.healthChecker.delay),"HTTP"==i.type&&(i.url=c.healthChecker.url)):i.type="NONE";var u=!0,d=!1,f=void 0;try{for(var p,g=c.newEnv[Symbol.iterator]();!(u=(p=g.next()).done);u=!0){var m=p.value;""!==m.key&&e.push(m)}}catch(h){d=!0,f=h}finally{try{!u&&g["return"]&&g["return"]()}finally{if(d)throw f}}n.push({image:c.image,registry:c.registry,tag:c.tag,cpu:c.cpu,mem:c.mem,envs:e,healthChecker:i})}}catch(h){r=!0,a=h}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw a}}return n}}(),t}},{key:"createVersion",value:function(){var e=this,t=l.defer(),n=this._formartDeploy(),i={deployId:n.deployId,containerDrafts:n.containerDrafts,logDraft:n.logDraft,labelSelectors:n.labelSelectors};return d.createVersion(i).then(function(n){"RUNNING"!=e.config.deploymentStatus?(r.openPrompt("新建部署版本成功,当前状态不能升级。"),t.resolve("create")):r.openConfirm("成功新建部署版本，是否继续升级？").then(function(){d.updateDeploy(e.config.deployId,n.data.result).then(function(){r.openPrompt("已提交，正在升级！"),t.resolve("update")},function(e){r.openWarning({title:"升级失败！",msg:e.data.resultMsg}),t.resolve("updateFailed")})},function(){t.resolve("dismiss")})},function(e){r.openWarning({title:"创建版本失败！",msg:e.data.resultMsg}),t.reject("create")}),t.promise}},{key:"stop",value:function(){return e.post("/api/deploy/action/stop?deployId="+this.config.deployId)}},{key:"abort",value:function(){return e.post("/api/deploy/action/abort?deployId="+this.config.deployId)}},{key:"scale",value:function(){var t=this,n=l.defer(),i=s.open({animation:!0,templateUrl:"scaleModal.html",controller:"ScaleModalCtr",size:"md",resolve:{oldReplicas:function(){return t.config.currentReplicas}}});return i.result.then(function(i){i=parseInt(i);var o="",a=t.config.currentVersions[0].version;i>t.config.currentReplicas?o="api/deploy/action/scaleup":i<t.config.currentReplicas&&(o="api/deploy/action/scaledown"),e.post(o+"?deployId="+t.config.deployId+"&replicas="+i+"&version="+a).then(function(e){r.openPrompt("操作成功！"),n.resolve(e.data.result)},function(){r.openWarning("请求失败！"),n.reject("requestError")})},function(){n.reject("dismiss")}),n.promise}},{key:"recoverVersion",value:function(){var e=this,t=l.defer(),n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"VersionListModalCtr",size:"md",resolve:{deployInfo:function(){return e.config}}});return n.result.then(function(n){d.rollbackDeploy(e.config.deployId,n.versionId,n.replicas).then(function(e){t.resolve(e.data.result)},function(){t.reject()})},function(){t.reject("dismiss")}),t.promise}},{key:"updateVersion",value:function(){var e=this,t=l.defer(),n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"VersionListModalCtr",size:"md",resolve:{deployInfo:function(){return e.config}}});return n.result.then(function(n){var i=e.config.currentVersions[0].version;i===n.versionId?(r.openWarning("您不能选择当前版本！"),t.reject("dismiss")):i>n.versionId?d.rollbackDeploy(e.config.deployId,n.versionId,n.replicas).then(function(e){r.openPrompt("已提交，正在回滚！"),t.resolve(e.data.result)},function(){r.openWarning("回滚失败，请重试！"),t.reject()}):d.updateDeploy(e.config.deployId,n.versionId,n.replicas).then(function(e){r.openPrompt("已提交，正在升级！"),t.resolve(e.data.result)},function(){r.openPrompt("升级失败，请重试！"),t.reject()})},function(){t.reject("dismiss")}),t.promise}},{key:"startVersion",value:function(){var e=this,t=l.defer(),n=s.open({animation:!0,templateUrl:"versionListModal.html",controller:"VersionListModalCtr",size:"md",resolve:{deployInfo:function(){return e.config}}});return n.result.then(function(n){d.startDeploy(e.config.deployId,n.versionId,n.replicas).then(function(e){t.resolve(e.data.result)},function(){t.reject()})},function(){t.reject("dismiss")}),t.promise}},{key:"delete",value:function(){return e["delete"]("/api/deploy/id/"+this.config.deployId)}},{key:"create",value:function(){function t(){e.post("api/deploy/create",angular.toJson(o)).then(function(){i.resolve()},function(e){i.reject({type:"create",msg:e.data.resultMsg})})}var n=this,i=l.defer(),o=this._formartDeploy();return this.isNewNamespace?!function(){var e=n.config.namespace,o=[e];c.setNamespace(n.clusterListIns.cluster.id,o).then(function(){n.toggleIsNewNamespace(),n.namespaceList.push(e),n.toggleNamespace(e),t()},function(e){i.reject({type:"namespace",msg:e.data.resultMsg})})}():t(),i.promise}}]),n}(),p=function(){function e(t){_classCallCheck(this,e),this.isCheckAll=!1,this.isCheckAllContainer=!1,this.containerList=[],this.selectedCount=0,this.selectedContainerCount=0,this.init(t)}return _createClass(e,[{key:"init",value:function(e){this.isCheckAll=!1,this.isCheckAllContainer=!1,this.instanceList=function(e){e=e||[];for(var t=0;t<e.length;t++)if(e[t].isSelected=!1,e[t].keyFilter=!0,e[t].containers)for(var n=0;n<e[t].containers.length;n++)e[t].containers[n].shortContainerId=e[t].containers[n].containerId.substring(0,12);return e}(e)}},{key:"toggleContainerList",value:function(e){this.isCheckAllContainer=!1,this.selectedContainerCount=0,this.containerList=e.containers||[];for(var t=0;t<this.containerList.length;t++)this.containerList[t].isSelected=!1}},{key:"filterWithKey",value:function(e){this.isCheckAll=!1,this.selectedCount=0;for(var t=0;t<this.instanceList.length;t++)this.instanceList[t].isSelected=!1,this.instanceList[t].keyFilter=-1!==this.instanceList[t].instanceName.indexOf(e)}},{key:"toggleContainerCheck",value:function(e){var t=!0;if(e.isSelected){this.selectedContainerCount++;for(var n=0;n<this.containerList.length;n++)if(!this.containerList[n].isSelected){t=!1;break}t&&(this.isCheckAllContainer=!0)}else this.selectedContainerCount--,
this.isCheckAllContainer=!1}},{key:"checkAllContainer",value:function(e){this.isCheckAllContainer=void 0===e?!this.isCheckAllContainer:e,this.isCheckAllContainer?this.selectedContainerCount=this.containerList.length:this.selectedContainerCount=0;for(var t=0;t<this.containerList.length;t++)this.containerList[t].isSelected=this.isCheckAllContainer}},{key:"toggleCheck",value:function(e){var t=!0;if(e.isSelected){this.selectedCount++;for(var n=0;n<this.instanceList.length;n++)if(this.instanceList[n].keyFilter&&!this.instanceList[n].isSelected){t=!1;break}t&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1}},{key:"checkAllInstance",value:function(e){this.isCheckAll=void 0===e?this.isCheckAll:e,this.selectedCount=0;for(var t=0;t<this.instanceList.length;t++)this.instanceList[t].keyFilter&&this.isCheckAll?(this.instanceList[t].isSelected=!0,this.selectedCount++):this.instanceList[t].isSelected=!1}}]),e}(),g=function(){function e(t){_classCallCheck(this,e),this.deploy={},this.isLoading=!1,this.deployInstanceListIns=new p,this.init(t)}return _createClass(e,[{key:"init",value:function(e){this.deployList=e||[]}},{key:"toggleDeploy",value:function(e,t,n,i){var o=this,r=l.defer();return e?(this.deploy.id=e,this.deploy.name=t,this.deploy.namespace=n,this.isLoading=!0,i||d.getInstances(e).then(function(e){o.deployInstanceListIns.init(e.data.result),r.resolve()})["finally"](function(){r.reject(),this.isLoading=!1})):(this.deploy.id=void 0,this.deploy.name=void 0,this.deploy.namespace=void 0,this.deployInstanceListIns.init(),r.reject()),r.promise}},{key:"filterDeploy",value:function(e,t){for(var n=-1,i=void 0,o=void 0,r=void 0,a=0;a<this.deployList.length;a++)e?this.deployList[a].clusterFilter=this.deployList[a].clusterName===e:this.deployList[a].clusterFilter=!0,t?this.deployList[a].hostFilter=this.deployList[a].hostEnv===t:this.deployList[a].hostFilter=!0,-1===n&&this.deployList[a].clusterFilter&&this.deployList[a].hostFilter&&(n=a,i=this.deployList[a].deployId,o=this.deployList[a].deployName,r=this.deployList[a].namespace);return-1===n?this.toggleDeploy():this.toggleDeploy(i,o,r)}}]),e}(),m=a.instancesCreator({DeployList:g,Deploy:f});return{deployService:d,getInstance:m}}var t=angular.module("deployModule",[]);e.$inject=["$http","$domeCluster","$domeUser","$domeProject","$domeImage","$domePublic","$domeModel","$modal","$q"],t.factory("$domeDeploy",e),window.deployModule=t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){function e(e,t,n){function i(){var t=this;this._url="/api/image",this.getBaseImages=function(){return e.get(t._url+"/base")},this.getProjectImages=function(){return e.get(t._url)},this.getAllImages=function(){return e.get(t._url+"/all")},this.getImageInfo=function(n){return e.get(t._url+"/all/detail?name="+n)},this.getImageTags=function(n,i){return e.get(t._url+"/detail?name="+n+"&registry="+i)},this.getCustomImages=function(){return e.get(t._url+"/custom")},this.getCustomImageInfo=function(n){return e.get(t._url+"/custom/"+n)},this.createCustomImage=function(n){return e.post(t._url+"/custom",angular.toJson(n))},this.buildCustomImage=function(n){return e.post(t._url+"/custom/build/"+n)},this.deleteCustomImage=function(n){return e["delete"](t._url+"/custom/"+n)},this.validImageName=function(n,i){return e.post(t._url+"/custom/validate?imageName="+n+"&imageTag="+i)},this.createBaseImage=function(n){return e.post(t._url+"/base",angular.toJson(n))},this.deleteBaseImage=function(n){return e["delete"](t._url+"/base/"+n)},this.getExclusiveImages=function(t){return e.get("/api/image/exclusive/"+t)}}var o=new i,r=function(e){var i=t.defer();return n.openDelete().then(function(){o.deleteBaseImage.then(function(){i.resolve()},function(){i.reject(),n.openWarning("删除失败！")})},function(){i.reject()}),i.promise},a=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"init",value:function(){this.config={autoCustom:0,imageName:"",imageTag:"",description:"",dockerfileContent:"",files:[{fileName:"",filePath:"",content:""}],envSettings:[{key:"",value:"",description:""}],sourceImage:{thirdParty:0,imageName:"",imageTag:"",registryUrl:""},publish:1}}},{key:"addEnvConfDefault",value:function(){this.config.envSettings.push({key:"",value:"",description:""})}},{key:"deleteArrItem",value:function(e,t){this.config[e].splice(t,1)}},{key:"addFileDefault",value:function(){this.config.files.push({fileName:"",filePath:"",content:""})}},{key:"clearFileWrite",value:function(e){this.config.files[e].content=""}}]),e}(),s=function(){var e=new a;return e.init(),e};return{imageService:o,Mirror:a,deleteBaseImage:r,getMirrorInstance:s}}var t=angular.module("imageModule",[]);e.$inject=["$http","$q","$domePublic"],t.factory("$domeImage",e),window.imageModule=t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){function e(e,t,n,i,o,r,a){var s=function(){var t=this;this.url="api/project",o.ServiceModel.call(this,this.url),this.getReadMe=function(n,i){return e.get(t.url+"/readme/"+n+"/"+i)},this.getBuildList=function(t){return e.get("/api/ci/build/"+t)},this.getBranches=function(n){return e.get(t.url+"/branches/"+n)},this.getBranchesWithoutId=function(n,i,o){return e.get(t.url+"/branches/"+o+"/"+n+"/"+i)},this.getTags=function(n){return e.get(t.url+"/tags/"+n)},this.getTagsWithoutId=function(n,i,o){return e.get(t.url+"/tags/"+o+"/"+n+"/"+i)},this.getGitLabInfo=function(){return e.get(t.url+"/git/gitlabinfo")},this.getBuildDockerfile=function(t,n){return e.get("/api/ci/build/dockerfile/"+t+"/"+n)},this.previewDockerfile=function(t){return e.post("/api/ci/build/dockerfile",angular.toJson(t),{notIntercept:!0})},this.build=function(t){return e.post("/api/ci/build/start",angular.toJson(t),{notIntercept:!0})}},l=new s,c=function(e,t){var n=a.open({animation:!0,templateUrl:"/index/tpl/modal/buildModal/buildModal.html",controller:"BuildModalCtr as vm",size:"md",resolve:{projectInfo:{projectId:e,hasCodeInfo:t}}});return n.result},u=function(){function e(){_classCallCheck(this,e),this.imageInfo={compileIsPublic:1,runIsPublic:1},this.selectedCompileImage={},this.selectedRunImage={},this.currentCompileList=[],this.currentRunList=[],this.projectImagesInfo={compilePublicImageList:[],compilePrivateImageList:[],runPublicImageList:[],runPrivateImageList:[]}}return _createClass(e,[{key:"init",value:function(e){e||(e={}),e.compilePublicImageList||(e.compilePublicImageList=[]),e.compilePrivateImageList||(e.compilePrivateImageList=[]),e.runPublicImageList||(e.runPublicImageList=[]),e.runPrivateImageList||(e.runPrivateImageList=[]),angular.forEach(e,function(e,n){for(var i=0;i<e.length;i++)e[i].createDate=t.getPageDate(e[i].createTime),e[i].imageTxt=e[i].imageName,e[i].imageTag&&(e[i].imageTxt+=":"+e[i].imageTag)}),this.projectImagesInfo=e,0===Object.keys(this.selectedCompileImage).length&&(this.toggleIsPublicImage("compile"),this.toggleIsPublicImage("run"))}},{key:"toggleIsPublicImage",value:function(e,t){void 0===t&&(t="compile"==e?this.imageInfo.compileIsPublic:this.imageInfo.runIsPublic),"compile"==e?(this.currentCompileList=1===t?this.projectImagesInfo.compilePublicImageList:this.projectImagesInfo.compilePrivateImageList,this.toggleImage("compile",0)):(this.currentRunList=1===t?this.projectImagesInfo.runPublicImageList:this.projectImagesInfo.runPrivateImageList,this.toggleImage("run",0))}},{key:"toggleImage",value:function(e,t){"compile"===e?this.selectedCompileImage=this.currentCompileList[t]:"run"===e&&(this.selectedRunImage=angular.copy(this.currentRunList[t]))}},{key:"toggleSpecifiedImage",value:function(e,t){var n="";t?(n=t.imageName,t.imageTag&&(n+=":"+t.imageTag)):t={},"compile"==e?(this.selectedCompileImage=t,this.selectedCompileImage.imageTxt=n,void 0!==t.registryType?this.imageInfo.compileIsPublic=t.registryType:this.imageInfo.compileIsPublic=1,this.currentCompileList=1===t.registryType?this.projectImagesInfo.compilePublicImageList:this.projectImagesInfo.compilePrivateImageList):(this.selectedRunImage=t,this.selectedRunImage.imageTxt=n,void 0!==t.registryType?this.imageInfo.runIsPublic=t.registryType:this.imageInfo.runIsPublic=1,this.currentRunList=1===t.registryType?this.projectImagesInfo.runPublicImageList:this.projectImagesInfo.runPrivateImageList)}}]),e}(),d=function(){function t(e){_classCallCheck(this,t),this.config={},this.customConfig={},this.isUseCustom=!1,this.projectImagesIns=new u,this.init(e)}return _createClass(t,[{key:"init",value:function(e){e||(e={}),this.customConfig={},e.dockerfileInfo||(e.dockerfileInfo={}),e.dockerfileConfig||(e.dockerfileConfig={}),e.userDefineDockerfile||(this.customConfig=e.exclusiveBuild?e.exclusiveBuild:e.dockerfileConfig),this.autoBuildInfo=angular.copy(e.autoBuildInfo),e.autoBuildInfo=function(){var t=e.autoBuildInfo,n=void 0,i=void 0;if(!t)return{tag:0,master:!1,other:!1,branches:""};if(i=e.autoBuildInfo.branches,n={tag:t.tag||0,master:!1,other:!1,branches:""},i){for(var o=0;o<i.length;o++)"master"==i[o]&&(n.master=!0,i.splice(o,1),o--);0!==i.length&&(n.other=!0,n.branches=i.join(","))}return n}(),e.confFiles=function(){var t=e.confFiles,n=[];if(!t||0===t.length)return[{tplDir:"",originDir:""}];var i=!0,o=!1,r=void 0;try{for(var a,s=Object.keys(t)[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;n.push({tplDir:l,originDir:t[l]})}}catch(c){o=!0,r=c}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw r}}return n.push({tplDir:"",originDir:""}),n}(),this.isUseCustom=!!this.customConfig.customType,e.envConfDefault||(e.envConfDefault=[]),e.envConfDefault.push({key:"",value:"",description:""}),this.customConfig.compileEnv=function(){var e=this.customConfig.compileEnv;if(!e)return[{envName:"",envValue:""}];var t=e.split(","),n=t.map(function(e){var t=e.split("=");return{envName:t[0],envValue:t[1]}});return n.push({envName:"",envValue:""}),n}.bind(this)(),this.customConfig.createdFileStoragePath=function(){var e=this.customConfig.createdFileStoragePath;if(!e||0===e.length)return[{name:""}];var t=e.map(function(e){return{name:e}});return t.push({name:""}),t}.bind(this)(),this.config=e,this.creatorDraft={},e=null}},{key:"resetConfig",value:function(){this.config.dockerfileConfig=null,this.config.dockerfileInfo=null,this.config.exclusiveBuild=null,this.config.dockerfileInfo=null,this.config.confFiles=null,this.config.envConfDefault=null,this.config.autoBuildInfo=this.autoBuildInfo,this.init(this.config)}},{key:"deleteArrItem",value:function(e,t){this.config[e].splice(t,1)}},{key:"deleteCompileEnv",value:function(e){this.customConfig.compileEnv.splice(e,1)}},{key:"deleteCreatedFileStoragePath",value:function(e){this.customConfig.createdFileStoragePath.splice(e,1)}},{key:"addEnvConfDefault",value:function(){this.config.envConfDefault.push({key:"",value:"",description:""})}},{key:"toggleBaseImage",value:function(e,t,n){this.customConfig.baseImageName=e,this.customConfig.baseImageTag=t,this.customConfig.baseImageRegistry=n}},{key:"addCreatedFileStoragePath",value:function(){this.customConfig.createdFileStoragePath.push({name:""})}},{key:"addCompileEnv",value:function(){this.customConfig.compileEnv.push({envName:"",envValue:""})}},{key:"addConfFiles",value:function(){this.config.confFiles.push({tplDir:"",originDir:""})}},{key:"modify",value:function(){var t=this._formartProject();return console.log(t),e.put("/api/project",angular.toJson(t))}},{key:"delete",value:function(){var e=this,t=r.defer();return i.openDelete().then(function(){l.deleteData(e.config.id).then(function(){i.openPrompt("删除成功！"),t.resolve()},function(e){i.openWarning({title:"删除失败！",msg:e.data.resultMsg}),t.reject("fail")})},function(){t.reject("dismiss")}),t.promise}},{key:"getDockerfile",value:function(){var e=this,t=function(){a.open({animation:!0,templateUrl:"/index/tpl/modal/dockerfileModal/dockerfileModal.html",controller:"DockerfileModalCtr as vm",size:"md",resolve:{project:e}})};if(this.config.userDefineDockerfile){var n=a.open({templateUrl:"/index/tpl/modal/branchCheckModal/branchCheckModal.html",controller:"BranchCheckModalCtr as vm",size:"md",resolve:{codeInfo:function(){return e.config.codeInfo},projectId:function(){return e.config.id}}});n.result.then(function(n){e.config.dockerfileInfo.branch=e.config.dockerfileInfo.tag=null,e.config.dockerfileInfo[n.type]=n.value,t()})}else t()}},{key:"_formartCreateProject",value:function(e,t){return{project:e,creatorDraft:t}}},{key:"_formartProject",value:function(){var e={},t="",n=[],i=angular.copy(this.config),o=angular.copy(this.customConfig);return i.envConfDefault=function(){var e=[],t=!0,n=!1,o=void 0;try{for(var r,a=i.envConfDefault[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;s.key&&s.value&&e.push({key:s.key,value:s.value,description:s.description})}}catch(l){n=!0,o=l}finally{try{!t&&a["return"]&&a["return"]()}finally{if(n)throw o}}return e}(),i.autoBuildInfo=function(){var e=i.autoBuildInfo,t=void 0;return i.codeInfo&&(e.other||e.master||e.tag)?(t={tag:e.tag,branches:[]},e.other&&(t.branches=e.branches.split(",")),e.master&&t.branches.push("master"),t):null}(),i.userDefineDockerfile?(e.name=i.name,e.id=i.id,i.codeInfo&&(e.codeInfo=i.codeInfo,e.autoBuildInfo=i.autoBuildInfo),e.exclusiveBuild=null,e.userDefineDockerfile=i.userDefineDockerfile,e.dockerfileInfo=i.dockerfileInfo,e.authority=i.authority,e.envConfDefault=i.envConfDefault):(i.dockerfileInfo&&(i.dockerfileInfo=null),i.confFiles=function(){var e={},t=!0,n=!1,o=void 0;try{for(var r,a=i.confFiles[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;s.tplDir&&s.originDir&&(e[s.tplDir]=s.originDir)}}catch(l){n=!0,o=l}finally{try{!t&&a["return"]&&a["return"]()}finally{if(n)throw o}}return e}(),t=function(){var e=[],t=!0,n=!1,i=void 0;try{for(var r,a=o.compileEnv[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;s.envName&&s.envValue&&e.push(s.envName+"="+s.envValue)}}catch(l){n=!0,i=l}finally{try{!t&&a["return"]&&a["return"]()}finally{if(n)throw i}}return e.join(",")}(),n=function(){var e=[],t=!0,n=!1,i=void 0;try{for(var r,a=o.createdFileStoragePath[Symbol.iterator]();!(t=(r=a.next()).done);t=!0){var s=r.value;s.name&&e.push(s.name)}}catch(l){n=!0,i=l}finally{try{!t&&a["return"]&&a["return"]()}finally{if(n)throw i}}return e}(),this.isUseCustom?(i.dockerfileConfig=null,i.exclusiveBuild={customType:o.customType,compileImage:this.projectImagesIns.selectedCompileImage,runImage:this.projectImagesIns.selectedRunImage,codeStoragePath:o.codeStoragePath,compileEnv:t,compileCmd:o.compileCmd,createdFileStoragePath:n,workDir:o.workDir,user:o.user,runFileStoragePath:this.projectImagesIns.selectedRunImage.runFileStoragePath,startCmd:this.projectImagesIns.selectedRunImage.startCommand},this.projectImagesIns.selectedCompileImage.imageName||(i.exclusiveBuild.compileImage=this.customConfig.compileImage,i.exclusiveBuild.runImage=this.customConfig.runImage,i.exclusiveBuild.runFileStoragePath=this.customConfig.runFileStoragePath,i.exclusiveBuild.startCmd=this.customConfig.startCmd)):(i.exclusiveBuild=null,i.dockerfileConfig={baseImageName:o.baseImageName,baseImageTag:o.baseImageTag,baseImageRegistry:o.baseImageRegistry,installCmd:o.installCmd,codeStoragePath:o.codeStoragePath,compileEnv:t,compileCmd:o.compileCmd,workDir:o.workDir,startCmd:o.startCmd,user:o.user}),e=i),e}},{key:"create",value:function(){var t=this._formartProject(),n=angular.copy(this.creatorDraft);return console.log(t),e.post("/api/project",angular.toJson(this._formartCreateProject(t,n)))}}]),t}(),f=o.instancesCreator({Project:d,ProjectImages:u});return{projectService:l,getInstance:f,buildProject:c}}var t=angular.module("projectModule",[]);e.$inject=["$http","$util","$state","$domePublic","$domeModel","$q","$modal"],t.factory("$domeProject",e),window.projectModule=t}();var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){var e=angular.module("userModule",[]);e.controller("ModifyPwModalCtr",["$scope","loginUser","$modalInstance","$domePublic","$domeUser",function(e,t,n,i,o){e.pwObj={username:t.username,oldpassword:"",newpassword:""},e.newPwAgain="",e.modiftPw=function(){o.userService.userModifyPw(e.pwObj).then(function(){i.openPrompt("修改成功，请重新登录！")["finally"](function(){location.href="/login/login.html?redirect="+encodeURIComponent(location.href)})},function(){i.openWarning("修改失败，请重试！")})},e.cancel=function(){n.dismiss("cancel")}}]).controller("ModifyUserInfoCtr",["$scope","user","$publicApi","$modalInstance","$domePublic",function(e,t,n,i,o){e.user=t,e.cancel=function(){i.dismiss()},e.submit=function(){var e={id:t.id,username:t.username,email:t.email,phone:t.phone};n.modifyUserInfo(e).then(function(){o.openPrompt("修改成功！"),i.close(e)},function(e){o.openWarning({title:"修改失败！",msg:e.data.resultMsg})})}}]),e.factory("$domeUser",["$http","$q","$domePublic","$domeGlobal","$domeModel",function(e,t,n,i,o){var r={},a=function(o){var r=t.defer(),a=i.getGloabalInstance("git");return a.getData().then(function(t){if(t[0].url){var i=t[0].url;e.post(i+"/api/v3/session",angular.toJson(o)).then(function(e){var t=e.data,n={name:t.username,token:t.private_token};return n},function(){r.reject()}).then(function(t){e.post("/api/project/git/gitlabinfo",angular.toJson(t)).then(function(e){r.resolve(e.data.result)},function(){r.reject()})},function(){r.reject()})}else n.openWarning("未配置代码仓库地址！"),r.reject()},function(){r.reject()}),r.promise},s=function(){var e=function(){o.ServiceModel.call(this,"/api/alarm/group")};return new e}(),l={getCurrentUser:function(){return e.get("/api/user/get")},getUserList:function(){return e.get("/api/user/list")},modifyUserInfo:function(t){return e.post("/api/user/modify",angular.toJson(t))},modifyPw:function(t){return e.post("/api/user/adminChangePassword",angular.toJson(t))},userModifyPw:function(t){return e.post("/api/user/changePassword",angular.toJson(t))},deleteUser:function(t){return e["delete"]("/api/user/delete/"+t)},createUser:function(t){return e.post("/api/user/create",angular.toJson(t))},getSigResourceUser:function(t,n){return e.get("/api/resource/"+t+"/"+n)},getResourceUser:function(t){return e.get("/api/resource/"+t+"/useronly")},modifyResourceUser:function(t){return e.put("/api/resource",angular.toJson(t))},deleteResourceUser:function(t,n,i,o){return e["delete"]("/api/resource/"+t+"/"+n+"/"+i+"/"+o)},getGroupList:function(){return e.get(" /api/namespace/list")},getGroup:function(){return e.get("/api/group/list")},getGroupInfo:function(t){return e.get("/api/group/get/"+t)},deleteGroup:function(t){return e["delete"]("/api/group/delete/"+t)},createGroup:function(t){return e.post("/api/group/create",angular.toJson(t))},modifyGroupUsers:function(t,n){return e.post("/api/group_members/"+t,angular.toJson(n))},deleteGroupUser:function(t,n){return e["delete"]("/api/group_members/"+t+"/"+n)},getGroupUser:function(t){return e.get("/api/group_members/"+t)},logout:function(){return e.get("/api/user/logout")}},c=function(){var e=t.defer();return r.id?e.resolve(r):l.getCurrentUser().then(function(t){r=t.data.result,e.resolve(r)}),e.promise},u=function(){function e(t){_classCallCheck(this,e),this.init(t)}return _createClass(e,[{key:"init",value:function(e){e.userInfos=e.userInfos||[],e.groupInfo=e.groupInfo||[];var t=!0,n=!1,i=void 0;try{for(var o,r=e.userInfos[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;a.isDirty=!1,a.newRole=a.role}}catch(s){n=!0,i=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw i}}this.resourceInfo=e}},{key:"toggleRole",value:function(e,t){e.newRole!==t&&(e.newRole=t),e.isDirty=e.newRole!==e.role}},{key:"saveRole",value:function(e){var i=void 0,o=t.defer();return"alarm"==this.resourceInfo.resourceType?(i=[{userId:e.userId,role:e.newRole,username:e.username}],s.setData(i).then(function(){e.isDirty=!1,e.role=e.newRole,o.resolve()},function(){o.reject(),n.openWarning("修改失败！")})):"group"==this.resourceInfo.resourceType?(i={members:[{userId:e.userId,role:e.newRole}]},l.modifyGroupUsers(this.resourceInfo.resourceId,i).then(function(){e.isDirty=!1,e.role=e.newRole,o.resolve()},function(){o.reject(),n.openWarning("修改失败！")})):(i={resourceId:this.resourceInfo.resourceId,resourceType:this.resourceInfo.resourceType,ownerInfos:[{ownerId:e.userId,ownerType:e.ownerType,role:e.newRole}]},l.modifyResourceUser(i).then(function(){e.isDirty=!1,e.role=e.newRole,o.resolve()},function(){o.reject(),n.openWarning("修改失败！")})),o.promise}},{key:"deleteUser",value:function(e,i){var o=this,r=t.defer(),a=function(){for(var t=0;t<o.resourceInfo.userInfos.length;t++)if(o.resourceInfo.userInfos[t].userId===e.userId){o.resourceInfo.userInfos.splice(t,1);break}};if("group"==this.resourceInfo.resourceType)l.deleteGroupUser(this.resourceInfo.resourceId,e.userId).then(function(){a(),r.resolve()},function(e){r.reject(),n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})});else{var c=void 0;i&&"alarm"==this.resourceInfo.resourceType&&(c="您确定要离开报警组吗？"),n.openDelete(c).then(function(){var t=function(){return"alarm"==o.resourceInfo.resourceType?s.deleteData(e.userId):l.deleteResourceUser(o.resourceInfo.resourceType,o.resourceInfo.resourceId,e.ownerType,e.userId)};t().then(function(){r.resolve(),a()},function(e){r.reject(),n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})},function(){r.reject()})}return r.promise}}]),e}(),d=function(){function e(t){_classCallCheck(this,e),this.userGroup={},this.init(t)}return _createClass(e,[{key:"init",value:function(e){this.userGroupList=e||[],this.userGroupList[0]&&this.toggle(0)}},{key:"toggle",value:function(e){this.userGroup=this.userGroupList[e]}}]),e}(),f=o.instancesCreator({UserGroupList:d,ResourceUser:u});return{alarmGroupService:s,userService:l,relatedGitLab:a,getLoginUser:c,getInstance:f}}]),window.userModule=e}();var domeApp=angular.module("domeApp",["ui.router","ncy-angular-breadcrumb","oc.lazyLoad","ngAnimate","pasvaz.bindonce","ngLocale","ui.bootstrap","ngScrollbar","publicModule","domeModule","deployModule","imageModule","userModule","projectModule"]);domeApp.run(["$rootScope","$document",function(e,t){e.$on("pageTitle",function(e,t){t.title&&""!==t.title&&$("title").html("DomeOS-"+t.title)}),e.$on("$stateChangeStart",function(){angular.element(t).scrollTop(0)})}]),domeApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("","/projectManage"),e.state("projectManage",{url:"/projectManage",templateUrl:"index/tpl/projectManage/projectManage.html",controller:"ProjectManageCtr",ncyBreadcrumb:{label:"项目管理"}}).state("createProject/1",{url:"/createProject/1",templateUrl:"index/tpl/createProject1/createProject1.html",controller:"CreateProjectCtr1",ncyBreadcrumb:{label:"新建项目",parent:"projectManage"}}).state("createProject/2",{url:"/createProject/2",templateUrl:"index/tpl/createProject2/createProject2.html",controller:"CreateProjectCtr2",ncyBreadcrumb:{label:"新建项目",parent:"projectManage"}}).state("projectDetail",{url:"/projectDetail/:project",templateUrl:"index/tpl/projectDetail/projectDetail.html",controller:"ProjectDetailCtr",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"},resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("/lib/js/jquery-a482e1500f.zclip.js")}]}}).state("projectDetail.info",{url:"/info",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"}}).state("projectDetail.config",{url:"/config",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"}}).state("projectDetail.autobuild",{url:"/autobuild",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"}}).state("projectDetail.buildlog",{url:"/buildlog",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"}}).state("projectDetail.user",{url:"/user",ncyBreadcrumb:{label:"项目详情",parent:"projectManage"}}).state("deployManage",{url:"/deployManage",templateUrl:"index/tpl/deployManage/deployManage.html",controller:"DeployManageCtr",ncyBreadcrumb:{label:"部署"}}).state("createDeploy/1",{url:"/createDeploy/1",templateUrl:"index/tpl/createDeploy1/createDeploy1.html",controller:"CreateDeployCtr1",ncyBreadcrumb:{label:"新建部署",parent:"deployManage"}}).state("createDeploy/2",{url:"/createDeploy/2",templateUrl:"index/tpl/createDeploy2/createDeploy2.html",controller:"CreateDeployCtr2",ncyBreadcrumb:{label:"新建部署",parent:"deployManage"}}).state("deployDetail",{url:"/deployDetail/:id",templateUrl:"index/tpl/deployDetail/deployDetail.html",controller:"DeployDetailCtr",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.detail",{url:"/detail",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.update",{url:"/update",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.event",{url:"/event",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.instance",{url:"/instance",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.network",{url:"/network",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("deployDetail.user",{url:"/user",ncyBreadcrumb:{label:"部署详情",parent:"deployManage"}}).state("groupManage",{url:"/groupManage",templateUrl:"index/tpl/groupManage/groupManage.html",controller:"GroupManageCtr",ncyBreadcrumb:{label:"组管理"}}).state("createGroup",{url:"/createGroup",templateUrl:"index/tpl/createGroup/createGroup.html",controller:"CreateGroupCtr",ncyBreadcrumb:{label:"新建组",parent:"groupManage"}}).state("groupDetail",{url:"/groupDetail/:id",templateUrl:"index/tpl/groupDetail/groupDetail.html",controller:"GroupDetailCtr",ncyBreadcrumb:{label:"组详情",parent:"groupManage"}}).state("clusterManage",{url:"/clusterManage",templateUrl:"index/tpl/clusterManage/clusterManage.html",controller:"ClusterManageCtr",ncyBreadcrumb:{label:"集群管理"}}).state("createCluster",{url:"/createCluster",templateUrl:"index/tpl/createCluster/createCluster.html",controller:"CreateClusterCtr",ncyBreadcrumb:{label:"新建集群",parent:"clusterManage"}}).state("clusterDetail",{url:"/clusterDetail/:id",templateUrl:"index/tpl/clusterDetail/clusterDetail.html",controller:"ClusterDetailCtr",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("clusterDetail.hostlist",{url:"/hostlist",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("clusterDetail.info",{url:"/info",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("clusterDetail.namespace",{url:"/namespace",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("clusterDetail.users",{url:"/users",ncyBreadcrumb:{label:"集群详情",parent:"clusterManage"}}).state("hostDetail",{url:"/hostDetail/:clusterId/:name",templateUrl:"index/tpl/hostDetail/hostDetail.html",controller:"HostDetailCtr",ncyBreadcrumb:{label:"主机详情",parent:function(e){return e.parentState}}}).state("hostDetail.instancelist",{url:"/instancelist",ncyBreadcrumb:{label:"主机详情",parent:function(e){return e.parentState}}}).state("hostDetail.info",{url:"/info",ncyBreadcrumb:{label:"主机详情",parent:function(e){return e.parentState}}}).state("monitor",{url:"/monitor",templateUrl:"index/tpl/monitor/monitor.html",controller:"MonitorCtr",ncyBreadcrumb:{label:"监控"}}).state("imageManage",{url:"/image",templateUrl:"index/tpl/imageManage/imageManage.html",controller:"ImageManageCtr",ncyBreadcrumb:{label:"镜像管理"}}).state("imageManage.baseimages",{url:"/baseimages",templateUrl:"index/tpl/imageManage/imageManage.html",ncyBreadcrumb:{label:"镜像管理"}}).state("imageManage.projectimages",{url:"/projectimages",templateUrl:"index/tpl/imageManage/imageManage.html",ncyBreadcrumb:{label:"镜像管理"}}).state("imageManage.otherimages",{url:"/otherimages",ncyBreadcrumb:{label:"镜像管理"}}).state("mirrorCustom",{url:"/mirrorCustom",templateUrl:"index/tpl/mirrorCustom/mirrorCustom.html",controller:"MirrorCustomCtr",ncyBreadcrumb:{label:"镜像定制",parent:"imageManage"}}).state("mirrorCustom.log",{url:"/log",ncyBreadcrumb:{label:"镜像定制",parent:"imageManage"}}).state("globalSetting",{url:"/globalSetting",templateUrl:"index/tpl/globalSetting/globalSetting.html",controller:"GlobalSettingCtr as vm",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.userinfo",{url:"/userinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.ldapinfo",{url:"/ldapinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.gitinfo",{url:"/gitinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.registryinfo",{url:"/registryinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.serverinfo",{url:"/serverinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.monitorinfo",{url:"/monitorinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.sshinfo",{url:"/sshinfo",ncyBreadcrumb:{label:"全局配置"}}).state("globalSetting.clusterinfo",{url:"/clusterinfo",ncyBreadcrumb:{label:"全局配置"}}).state("addHost",{url:"/addHost/:id",templateUrl:"index/tpl/addHost/addHost.html",controller:"AddHostCtr",ncyBreadcrumb:{label:"添加主机",parent:function(e){return e.parentState}}}).state("createAppDeploy",{url:"/createDeploy/app/:appName",templateUrl:"index/tpl/createAppDeploy/createAppDeploy.html",controller:"CreateAppDeployCtr",ncyBreadcrumb:{label:"应用部署",parent:"appStore"}}).state("appStore",{url:"/appStore",templateUrl:"index/tpl/appStore/appStore.html",controller:"AppStoreCtr",ncyBreadcrumb:{label:"应用商店"}}).state("alarm",{url:"/alarm",templateUrl:"index/tpl/alarm/alarm.html",controller:"AlarmCtr as vm",ncyBreadcrumb:{label:"报警",parent:"monitor"}}).state("alarm.templates",{url:"/templates",templateUrl:"index/tpl/alarm/tabTemplates/tabTemplates.html",controller:"TabAlarmTemplatesCtr as vmTemplate",ncyBreadcrumb:{label:"报警",parent:"monitor"}}).state("alarm.hostgroups",{url:"/hostgroups",templateUrl:"index/tpl/alarm/tabHostGroups/tabHostGroups.html",controller:"TabHostGroupsCtr as vmHostGroup",ncyBreadcrumb:{label:"报警",parent:"monitor"}}).state("alarm.currentAlarms",{url:"/currentAlarms",templateUrl:"index/tpl/alarm/tabCurrentAlarms/tabCurrentAlarms.html",controller:"TabAlarmCurrentAlarmsCtr as vmAlarm",ncyBreadcrumb:{label:"报警",parent:"monitor"}}).state("alarm.group",{url:"/group",templateUrl:"index/tpl/alarm/tabGroup/tabGroup.html",controller:"TabGroupCtr as vmGroup",ncyBreadcrumb:{label:"报警",parent:"monitor"}}).state("createAlarmTemplate",{url:"/createAlarmTemplate",templateUrl:"index/tpl/createAlarmTemplate/createAlarmTemplate.html",controller:"CreateAlarmTemplateCtr",ncyBreadcrumb:{label:"新建模板",parent:"alarm.templates"}}).state("alarmTemplateDetail",{url:"/template/:id",templateUrl:"index/tpl/alarmTemplateDetail/alarmTemplateDetail.html",controller:"AlarmTemplateDetailCtr",ncyBreadcrumb:{label:"模板详情",parent:"alarm.templates"}}).state("alarmAddHosts",{url:"/alarmAddHosts/:id/:name",templateUrl:"index/tpl/alarmAddHosts/alarmAddHosts.html",controller:"AlarmAddHostsCtr as vm",ncyBreadcrumb:{label:"添加主机",parent:"alarm.templates"}})}]).config(["$compileProvider",function(e){e.debugInfoEnabled(!1)}]),domeApp.filter("listPage",function(){return function(e,t,n){return e?(n=parseInt(n),e.slice(t*(n-1),t*n)):[]}}).filter("deployOptions",function(){return function(e,t,n,i,o){for(var r=[],a=0;a<e.length;a++)(t.ALL||t[e[a].hostEnv])&&(n.ALL||n[e[a].namespace])&&(i.ALL||i[e[a].clusterName])&&(o.ALL||o[e[a].deploymentStatus])&&r.push(e[a]);return r}}).filter("search",function(){return function(e,t,n){var i={};return angular.forEach(e,function(e,o){-1!==e[t].toString().indexOf(n)&&(i[o]=e)}),i}}).filter("searchKey",function(){return function(e,t){var n={};return t?(angular.forEach(e,function(e,i){-1!==i.toString().indexOf(t)&&(n[i]=e)}),n):e}}).filter("dynamicKey",function(){return function(e,t,n){var i=[];if(!n)return e;for(var o=0;o<e.length;o++)-1!==e[o][t].toString().indexOf(n)&&i.push(e[o]);return i}}).filter("mirrorOptions",function(){
return function(e,t,n,i,o){for(var r=[],a=0;a<e.length;a++){var s=0===e[a].autoCustom?"dockerfile":"configfile";(t.All||t[e[a].state])&&(n.All||n.own&&e[a].username==o)&&(i.All||i[s])&&r.push(e[a])}return r}}).filter("alarmFilter",["$filter",function(e){return function(t,n){if(t){for(var i,o,r=[],a=0;a<t.length;a++)i=t[a],o=e("date")(i.timeStamp,"yyyy-MM-dd HH:mm:ss"),-1===i.alarmObject.indexOf(n)&&-1===i.templateTypeName.indexOf(n)&&-1===i.metricName.indexOf(n)&&-1===i.alarmNum.indexOf(n)&&-1===i.alarmTimes.indexOf(n)&&-1===o.indexOf(n)||r.push(i);return r}}}]),domeApp.factory("$domeAppStore",["$http","$domeDeploy",function(e,t){var n=function(){return e.get("http://app-domeos.bjctc.scs.sohucs.com/apps.json",{notIntercept:!0})},i=function(){};i.prototype={init:function(e){this.config=e,this.formartToDeploy()},formartToDeploy:function(){var e={};e=angular.copy(this.config.deploymentTemplate),e.deployName=this.config.appName+parseInt(1e4*Math.random()),this.deployIns=t.getInstance("Deploy",e)}};var o=function(e,t){var n;switch(e){case"AppInfo":n=new i;break;default:n={},n.init=function(){console.log("error:there is no "+e)}}return n.init(t),n};return{getStoreApps:n,getInstance:o}}]).factory("$domeGlobal",["$http","$domePublic","$q",function(e,t,n){var i=function(i){var o=function(){var e;switch(i){case"ldap":e="/api/global/ldapconfig";break;case"server":e="/api/global/serverconfig";break;case"git":e="/api/global/gitconfig";break;case"registry":e="/api/global/registry/private";break;case"monitor":e="/api/global/monitor";break;case"ssh":e="/api/global/webssh";break;case"cluster":e="/api/global/ci/cluster";break;default:e=""}return e}(),r=!0;this.getData=function(){var t=n.defer();return e.get(o).then(function(e){!e.data.result||"git"==i&&0===e.data.result.length?t.reject():(r=!1,t.resolve(e.data.result))},function(e){t.reject(e.data.resultMsg)}),t.promise},this.modifyData=function(a){var s=n.defer(),l=function(){"cluster"!==i&&t.openPrompt("设置成功！")},c=function(e){t.openWarning({title:"保存失败！",msg:"Message:"+e})};return r||"registry"===i?e.post(o,angular.toJson(a)).then(function(e){r=!1,l(),s.resolve(e.data.result)},function(e){c(e.data.resultMsg),s.reject()}):e.put(o,angular.toJson(a)).then(function(e){l(),s.resolve(e.data.result)},function(e){c(e.data.resultMsg),s.reject()}),s.promise}},o=function(e){return new i(e)};return{getGloabalInstance:o}}]),domeApp.factory("$domeCluster",["$http","$domeUser","$q","$modal","$domePublic","$domeModel",function(e,t,n,i,o,r){var a=function(){var t=this;this.url="/api/cluster",r.ServiceModel.call(this,this.url);var i=this.deleteData;this.getNamespace=function(n){return e.get(t.url+"/"+n+"/namespace")},this.setNamespace=function(n,i){return e.post(t.url+"/"+n+"/namespace",angular.toJson(i))},this.deleteData=function(e){var t=n.defer();return o.openDelete().then(function(){i(e).then(function(){o.openPrompt("删除成功！"),t.resolve()},function(e){o.openWarning({title:"删除失败！",msg:e.data.resultMsg}),t.reject()})},function(){t.reject()}),t.promise}},s=function(){var t=this;a.call(this),this.getNodeList=function(n){return e.get(t.url+"/"+n+"/nodelist")},this.getNodeInfo=function(n,i){return e.get(t.url+"/"+n+"/node/"+i)},this.getHostInstances=function(n,i){return e.get(t.url+"/"+n+"/nodelist/"+i)},this.updateDisk=function(n,i,o){return e.post(t.url+"/"+n+"/"+i+"/disk?path="+o)},this.addLabel=function(n,i){return e.post(t.url+"/"+n+"/nodelabels/add",angular.toJson(i))},this.deleteLabel=function(n,i){return e.post(t.url+"/"+n+"/nodelabels/delete",angular.toJson(i))},this.modifyNodeDisk=function(t,n,i){return e.post("/api/cluster/"+t+"/"+n+"/disk?path="+i)}},l=function(e,t){this.isCheckAll=!1,this.nodeList=[],this.selectedCount=0,this.labelsInfo={},this.init(e,t)};l.prototype={init:function(e,t){var n=this;t!==!0&&(t=!1),this.nodeList=function(e,t){e=e?e:[];for(var n=0;n<e.length;n++)!t||e[n].diskInfo?(e[n].keyFilter=!0,e[n].labelFilter=!0,e[n].isSelected=!1):(e.splice(n,1),n--);return e}(e,t),this.labelsInfo=function(){for(var e={},t=n.nodeList,i=0;i<t.length;i++)for(var o in t[i].labels)if(t[i].labels.hasOwnProperty(o)&&"kubernetes.io/hostname"!=o&&"hostEnv"!=o)if(e[o]){for(var r=!1,a=0;a<e[o].contents.length;a++)if(e[o].contents[a]===t[i].labels[o]){r=!0;break}r||e[o].contents.push(t[i].labels[o])}else e[o]={contents:[t[i].labels[o]],isSelected:!1,isShow:!0};return e.PRODENV?e.PRODENV.isShow=!1:e.PRODENV={isShow:!1,contents:[],isSelected:!1},e.TESTENV?e.TESTENV.isShow=!1:e.TESTENV={isShow:!1,contents:[],isSelected:!1},e.BUILDENV?e.BUILDENV.isShow=!1:e.BUILDENV={isShow:!1,contents:[],isSelected:!1},e}()},initLabelsInfo:function(){for(var e in this.labelsInfo)this.labelsInfo[e].isSelected&&(this.labelsInfo[e].isSelected=!1);this.toggleLabelNodes()},toggleEnv:function(e){"PROD"==e?(this.labelsInfo.TESTENV.isSelected=!1,this.labelsInfo.PRODENV.isSelected=!0):"TEST"==e&&(this.labelsInfo.TESTENV.isSelected=!0,this.labelsInfo.PRODENV.isSelected=!1),this.toggleLabelNodes()},toggleNodeCheck:function(e){var t=!0;if(e.isSelected){this.selectedCount++;for(var n=0;n<this.nodeList.length;n++)if(this.nodeList[n].keyFilter&&this.nodeList[n].labelFilter&&!this.nodeList[n].isSelected){t=!1;break}t&&(this.isCheckAll=!0)}else this.selectedCount--,this.isCheckAll=!1},filterWithKey:function(e){this.isCheckAll=!1,this.selectedCount=0;for(var t=0;t<this.nodeList.length;t++)this.nodeList[t].isSelected=!1,this.nodeList[t].keyFilter=-1!==this.nodeList[t].name.indexOf(e)},checkAllNode:function(e){this.isCheckAll=void 0===e?this.isCheckAll:e,this.selectedCount=0;for(var t=0;t<this.nodeList.length;t++)this.nodeList[t].keyFilter&&this.nodeList[t].labelFilter&&this.isCheckAll?(this.nodeList[t].isSelected=!0,this.selectedCount++):this.nodeList[t].isSelected=!1},toggleLabel:function(e,t){if(this.labelsInfo[e]){if(void 0!==t){if(this.labelsInfo[e].isSelected===t)return;this.labelsInfo[e].isSelected=t}else this.labelsInfo[e].isSelected=!this.labelsInfo[e].isSelected;this.toggleLabelNodes()}},toggleLabelNodes:function(){var e=!1;if(this.isCheckAll=!1,this.selectedCount=0,angular.forEach(this.labelsInfo,function(t){!e&&t.isSelected&&(e=!0)}),e)for(var t=0;t<this.nodeList.length;t++){var n=!0;this.nodeList[t].isSelected=!1;for(var i in this.labelsInfo)if(this.labelsInfo.hasOwnProperty(i)&&this.labelsInfo[i].isSelected&&void 0===this.nodeList[t].labels[i]){n=!1;break}this.nodeList[t].labelFilter=n}else{var o=!0,r=!1,a=void 0;try{for(var s,l=this.nodeList[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;c.isSelected=!1,c.labelFilter=!0}}catch(u){r=!0,a=u}finally{try{!o&&l["return"]&&l["return"]()}finally{if(r)throw a}}}},showHost:function(){var e=this,t=i.open({animation:!0,templateUrl:"/index/tpl/modal/hostListModal/hostListModal.html",controller:"HostListModalCtr",size:"lg",resolve:{hostList:function(){return e.nodeList}}});return t.result},getFormartSelectedLabels:function(){var e=[];return angular.forEach(this.labelsInfo,function(t,n){if(t.isSelected)for(var i=0;i<t.contents.length;i++)e.push({name:n,content:t.contents[i]})}),e},getSelectedNodes:function(){for(var e=[],t=0;t<this.nodeList.length;t++)this.nodeList[t].isSelected&&e.push(this.nodeList[t].name);return e}};var c=function(e){this.etcdValid=!0,this.zookeeperValid=!0,this.kafkaValid=!0,this.config={},this.init(e)};c.prototype={init:function(e){var t=[],n=void 0,i=[],o=void 0,r=[],a=void 0,s=void 0;if(e||(e={}),e.etcd)for(n=e.etcd.split(","),s=0;s<n.length;s++)""!==n[s]&&t.push({name:n[s]});if(t.push({name:""}),e.etcd=t,e.clusterLog||(e.clusterLog={}),e.clusterLog.zookeeper)for(o=e.clusterLog.zookeeper.split(","),s=0;s<o.length;s++)""!==o[s]&&i.push({name:o[s]});if(i.push({name:""}),e.clusterLog.zookeeper=i,e.clusterLog.kafka)for(a=e.clusterLog.kafka.split(","),s=0;s<a.length;s++)""!==a[s]&&r.push({name:a[s]});r.push({name:""}),e.clusterLog.kafka=r,e.logConfig||(e.logConfig=0),this.config=e},addEtcd:function(){this.config.etcd.push({name:""})},addKafka:function(){this.config.clusterLog.kafka.push({name:""})},addZookeeper:function(){this.config.clusterLog.zookeeper.push({name:""})},deleteArrItem:function(e,t){this.config[e].splice(t,1)},deleteLogArrItem:function(e,t){this.config.clusterLog[e].splice(t,1)},toggleUser:function(e){this.config.ownerName=e.name,this.creatorDraft={creatorType:e.type,creatorId:e.id}},toggleLogConfig:function(){this.config.logConfig=1===this.config.logConfig?0:1},validItem:function(e){var t=[],n=!1;if(t="etcd"==e?this.config.etcd:this.config.clusterLog[e],"etcd"!=e&&0===this.config.logConfig)n=!0;else for(var i=0;i<t.length;i++)if(t[i].name&&""!==t[i].name){n=!0;break}switch(e){case"etcd":this.etcdValid=n;break;case"zookeeper":this.zookeeperValid=n;break;case"kafka":this.kafkaValid=n}return n},modify:function(){return e.put("/api/cluster",angular.toJson(this._formartCluster()))},_formartCluster:function(){for(var e=angular.copy(this.config),t="",n="",i="",o=void 0,r=0;r<e.etcd.length;r++)o=e.etcd[r].name,o&&(t+=o+",");if(e.etcd=t,0===e.logConfig)e.clusterLog=null;else{for(var a=0;a<e.clusterLog.zookeeper.length;a++)o=e.clusterLog.zookeeper[a].name,o&&(n+=o+",");e.clusterLog.zookeeper=n;for(var s=0;s<e.clusterLog.kafka.length;s++)o=e.clusterLog.kafka[s].name,o&&(i+=o+",");e.clusterLog.kafka=i}return e},_formartNewCluster:function(e){var t={};return t.clusterInfo=e,t.creatorDraft=this.creatorDraft,t},create:function(){var t=this._formartCluster(),n=this._formartNewCluster(t);return e.post("/api/cluster",angular.toJson(n))}};var u=function(e){this.cluster={},this.init(e)};u.prototype={init:function(e){this.clusterList=e||[]},toggleCluster:function(e){this.cluster.id=this.clusterList[e].id,this.cluster.name=this.clusterList[e].name}};var d=r.instancesCreator({ClusterList:u,Cluster:c,NodeList:l,ClusterService:a,NodeService:s});return{getInstance:d}}]),domeApp.factory("$domeMonitor",["$http","$q","$util","$domePublic",function(e,t,n,i){var o=function(){return e.get("/api/global/monitor/info")},r=function(t){return e.post("/api/monitor/target",angular.toJson(t))},a=function(t){return e.get("/api/monitor/target/"+t)},s=function(t,n,i,o,r){return e.get("/api/monitor/data/"+t+"?start="+n+"&end="+i+"&dataSpec="+o+"&cid="+r)},l=function(e,t,n){var o=window.open("","_blank"),a=n.targetType;r(n).then(function(n){var r=n.data.result;return void 0===r?void i.openWarning("请求错误！"):void setTimeout(function(){o.location="/monitor/monitor.html?cid="+e+"&cname="+t+"&id="+r+"&type="+a},0)})},c=function(e,i,o,a){function l(e,t,n){return null===e||isNaN(e)?"——":(n||(n=""),e=+e.toFixed(t),n&&(e+=n),e)}function c(e,t){return e=n.formartBytesData(e,t),null===e||void 0===e?"——":+e.toFixed(2)}var u=t.defer();return r({clusterId:i,targetType:e,targetInfos:o}).then(function(e){return s(e.data.result,(new Date).getTime()-3e5,(new Date).getTime(),"AVERAGE",i)}).then(function(t){function n(e,t,n,i){var o=e+"Data",r=e+"Count";angular.forEach(n,function(e,n){for(var a in e)if(e.hasOwnProperty(a)&&"timeStamp"!==a&&d[a]){var s;if(void 0!==i&&(s="%"==i?l(e[a],2,i):c(e[a],i)),d[a][o].push({item:n,value:s}),null===d[a][r]&&!e[a])continue;"MAX"==t?e[a]>d[a][r]&&(d[a][r]=e[a]):"SUM"==t&&(d[a][r]+=e[a])}}),void 0!==i&&angular.forEach(d,function(e){"%"==i?e[r]=l(e[r],2):e[r]=c(e[r],i)})}var i,o,r,s=t.data.result,d={},f={};if("node"==e){for(i=s.counterResults["cpu.busy"].slice(-3,-2)[0],o=s.counterResults["mem.memused.percent"].slice(-3,-2)[0],f={diskUsedMap:{},diskReadMap:{},diskWriteMap:{},netInMap:{},netOutMap:{}},r=0;r<a.length;r++)d[a[r]]={diskUsedData:[],diskUsedCount:0,diskReadData:[],diskReadCount:0,diskWriteData:[],diskWriteCount:0,netInData:[],netInCount:0,netOutData:[],netOutCount:0,cpuBusyCount:l(i[a[r]],2),memPercentCount:l(o[a[r]],2)};angular.forEach(s.counterResults,function(e,t){var n=t.split("=")[1];-1!==t.indexOf("df.bytes.used.percent")?f.diskUsedMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("disk.io.read_bytes")?f.diskReadMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("disk.io.write_bytes")?f.diskWriteMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("net.if.in.bytes")?f.netInMap[n]=e.slice(-3,-2)[0]:-1!==t.indexOf("net.if.out.bytes")&&(f.netOutMap[n]=e.slice(-3,-2)[0])}),n("diskUsed","MAX",f.diskUsedMap,"%"),n("diskRead","SUM",f.diskReadMap,"KB"),n("diskWrite","SUM",f.diskWriteMap,"KB"),n("netIn","SUM",f.netInMap,"KB"),n("netOut","SUM",f.netOutMap,"KB")}else if("pod"==e||"container"==e)for(i=s.counterResults["container.cpu.usage.busy"].slice(-3,-2)[0],o=s.counterResults["container.mem.usage.percent"].slice(-3,-2)[0],f={netIn:s.counterResults["container.net.if.in.bytes"].slice(-3,-2)[0],netOut:s.counterResults["container.net.if.out.bytes"].slice(-3,-2)[0]},r=0;r<a.length;r++)d[a[r]]={netInCount:c(f.netIn[a[r]],"KB"),netOutCount:c(f.netOut[a[r]],"KB"),cpuBusyCount:l(i[a[r]],2),memPercentCount:l(o[a[r]],2)};u.resolve(d)},function(){u.reject()}),u.promise};return{getMonitorInfo:o,getMonitorStatistical:c,storeMonitorTarget:r,getMonitorTarget:a,getMonitorData:s,toMonitorPage:l}}]);var _get=function e(t,n,i){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,i)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(i)},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();domeApp.factory("$domeAlarm",["$domeModel","$domeUser","$domeDeploy","$domeCluster","$http","$domePublic","$q",function(e,t,n,i,o,r,a){var s=function(){e.ServiceModel.call(this,"/api/alarm/template")},l=function(){e.ServiceModel.call(this,"/api/alarm/hostgroup"),this.addHost=function(e,t){return o.post("/api/alarm/hostgroup/bind/"+e,angular.toJson(t))},this.deleteHost=function(e,t){return o["delete"]("/api/alarm/hostgroup/bind/"+e+"/"+t)}},c=i.getInstance("ClusterService"),u=new s,d={metric:{cpu_percent:{text:"CPU占用率",unit:"%",belong:"all"},memory_percent:{text:"内存占用率",unit:"%",belong:"all"},disk_percent:{text:"磁盘占用率",tagName:"分区",unit:"%",belong:"host"},disk_read:{text:"磁盘读取",tagName:"设备",unit:"KB/s",belong:"host"},disk_write:{text:"磁盘写入",tagName:"设备",unit:"KB/s",belong:"host"},network_in:{text:"网络流入",tagName:"网卡",unit:"KB/s",belong:"all"},network_out:{text:"网络流出",tagName:"网卡",unit:"KB/s",belong:"all"},agent_alive:{text:"agent存活",belong:"host"}},aggregateType:{avg:"平均值",max:"最大值",min:"最小值",sum:"和值"},aggregateTypeAgent:{max:"全部",min:"至少一次"}},f=function(){function e(t){_classCallCheck(this,e),this.config={},this.hostGroupList=[],this.keyMaps=d,this.groupList=[],this.deployListIns=n.getInstance("DeployList"),this.loadingIns=r.getLoadingInstance(),this.clusterList=[],this.init(t)}return _createClass(e,[{key:"init",value:function(e){e||(e={templateType:"host"}),e.deploymentInfo||(e.deploymentInfo={}),e.strategyList||(e.strategyList=[]),e.callback||(e.callback={}),e.hostGroupList||(e.hostGroupList=[]);for(var t=0;t<e.strategyList.length;t++){var n=e.strategyList[t];"disk_percent"==n.metric?n.tag=n.tag.substring(6):-1!==n.metric.indexOf("disk")?n.tag=n.tag.substring(7):-1!==n.metric.indexOf("network")&&(n.tag=n.tag.substring(6))}this.config=e,void 0===this.config.id&&(this.config.deploymentInfo.hostEnv||(this.config.deploymentInfo.hostEnv="PROD"),this.addStrategy())}},{key:"initHostGroupList",value:function(){var e=this,t=void 0,n=function(){var t=e.config.hostGroupList,n=0,i=0,o=void 0;if(t&&0===t.length)for(n=0;n<e.hostGroupList.length;n++)e.hostGroupList[n].isSelected=!1;else for(n=0;n<e.hostGroupList.length;n++){for(o=!1,i=0;i<t.length;i++)if(t[i].id===e.hostGroupList[n].id){o=!0;break}e.hostGroupList[n].isSelected=o}};0===this.hostGroupList.length?(this.loadingIns.startLoading("hostgroup"),t=new l,t.getData().then(function(t){e.hostGroupList=t.data.result||[],n()},function(){r.openWarning("获取主机组信息失败！")})["finally"](function(){e.loadingIns.finishLoading("hostgroup")})):n()}},{key:"initGroupList",value:function(){var e=this,n=this.config.userGroupList,i=function(){var t=0,i=0,o=void 0;if(n&&0!==n.length)for(t=0;t<e.groupList.length;t++){for(o=!1,i=0;i<n.length;i++)if(e.groupList[t].id===n[i].id){o=!0;break}e.groupList[t].isSelected=o}else for(t=0;t<e.groupList.length;t++)e.groupList[t].isSelected=!1};0===this.groupList.length?(this.loadingIns.startLoading("groupList"),t.userService.getGroup().then(function(t){e.groupList=t.data.result||[],i()},function(){r.openWarning("获取组信息失败！")})["finally"](function(){e.loadingIns.finishLoading("groupList")})):i()}},{key:"initDeployAndClusterList",value:function(){var e=this,t=this.config.deploymentInfo;0===this.deployListIns.deployList.length?(this.loadingIns.startLoading("deploy"),a.all([n.deployService.getList(),c.getData()]).then(function(n){e.deployListIns.init(n[0].data.result),e.clusterList=n[1].data.result||[],t.clusterName?(e.toggleHostEnv(t.hostEnv),e.deployListIns.deploy.id=t.id,e.deployListIns.deploy.name=t.deploymentName):(t.clusterName=e.clusterList[0].name,e.toggleCluster(e.clusterList[0].name))},function(){r.openWarning("获取信息失败！")})["finally"](function(){e.loadingIns.finishLoading("deploy")})):(this.toggleHostEnv(t.hostEnv),this.deployListIns.deploy.id=t.id,this.deployListIns.deploy.name=t.deploymentName)}},{key:"toggleTemplateType",value:function(e){e!=this.config.templateType&&(this.config.templateType=e,this.config.strategyList=[],this.addStrategy())}},{key:"addStrategy",value:function(){this.config.strategyList.push({metric:"cpu_percent",tag:"",pointNum:3,aggregateType:"avg",operator:"==",rightValue:null,note:"",maxStep:3})}},{key:"deleteStrategy",value:function(e){this.config.strategyList.splice(e,1)}},{key:"toggleStrategyMetric",value:function(e,t){var n=this.config.strategyList[e];n.metric!==t&&("agent_alive"===t&&(n.aggregateType="max"),n.metric=t,n.tag="")}},{key:"toggleHostEnv",value:function(e){this.config.deploymentInfo.hostEnv=e,this.deployListIns.filterDeploy(this.config.deploymentInfo.clusterName,e)}},{key:"toggleCluster",value:function(e){this.config.deploymentInfo.clusterName=e,this.deployListIns.filterDeploy(e,this.config.deploymentInfo.hostEnv)}},{key:"getFormartConfig",value:function(){var e={},t=0,n=void 0;if(e.templateName=this.config.templateName,e.templateType=this.config.templateType,e.id=this.config.id,"host"==e.templateType)for(e.templateType=this.config.templateType,e.hostGroupList=[],t=0;t<this.hostGroupList.length;t++)this.hostGroupList[t].isSelected&&e.hostGroupList.push({id:this.hostGroupList[t].id});else"deploy"==e.templateType&&(e.deploymentInfo={id:this.deployListIns.deploy.id,clusterName:this.config.deploymentInfo.clusterName,deploymentName:this.deployListIns.deploy.name,hostEnv:this.config.deploymentInfo.hostEnv});for(e.strategyList=[],t=0;t<this.config.strategyList.length;t++)n=angular.copy(this.config.strategyList[t]),"agent_alive"==n.metric&&(n.rightValue=1,n.operator="<"),n.tag&&("disk_percent"==n.metric?n.tag="mount="+n.tag:-1!==n.metric.indexOf("disk")?n.tag="device="+n.tag:-1!==n.metric.indexOf("network")&&(n.tag="iface="+n.tag)),e.strategyList.push(n);for(e.userGroupList=[],t=0;t<this.groupList.length;t++)this.groupList[t].isSelected&&e.userGroupList.push({id:this.groupList[t].id});return e.callback=angular.copy(this.config.callback),console.log(e),e}},{key:"create",value:function(){return u.setData(this.getFormartConfig())}},{key:"modify",value:function(){return u.updateData(this.getFormartConfig())}}]),e}(),p=function(e){function t(e,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,"nodeList"));return i.selectedList=[],i.init(e,n),i}return _inherits(t,e),_createClass(t,[{key:"init",value:function(e,n){if(e||(e=this.nodeList),n||(n=this.clusterName),e&&n){this.clusterName=n;var i=!0,o=!1,r=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value,c=!0,u=!1,d=void 0;try{for(var f,p=this.selectedList[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var g=f.value;if(g.cluster===n&&g.name===l.name){l.isSelected=!0;break}}}catch(m){u=!0,d=m}finally{try{!c&&p["return"]&&p["return"]()}finally{if(u)throw d}}l.isSelected||(l.isSelected=!1)}}catch(m){o=!0,r=m}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw r}}_get(Object.getPrototypeOf(t.prototype),"init",this).call(this,e)}}},{key:"initSelectedList",value:function(){this.selectedList=[],this.checkAllItem(!1)}},{key:"checkAllItem",value:function(e){if(_get(Object.getPrototypeOf(t.prototype),"checkAllItem",this).call(this,e),e){var n=!0,i=!1,o=void 0;try{for(var r,a=this.nodeList[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;if(s.isSelected){var l=!1,c=!0,u=!1,d=void 0;try{for(var f,p=this.selectedList[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var g=f.value;if(this.clusterName===g.cluster&&s.name===g.name){l=!0;break}}}catch(m){u=!0,d=m}finally{try{!c&&p["return"]&&p["return"]()}finally{if(u)throw d}}l||this.selectedList.push({name:s.name,ip:s.ip,cluster:this.clusterName})}}}catch(m){i=!0,o=m}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}}else{var h=!0,v=!1,y=void 0;try{for(var I,b=this.nodeList[Symbol.iterator]();!(h=(I=b.next()).done);h=!0)for(var L=I.value,C=0;C<this.selectedList.length;C++){var k=this.selectedList[C];if(this.clusterName===k.cluster&&L.name===k.name){this.selectedList.splice(C,1),C--;break}}}catch(m){v=!0,y=m}finally{try{!h&&b["return"]&&b["return"]()}finally{if(v)throw y}}}}},{key:"toggleCheck",value:function(e,n){if(_get(Object.getPrototypeOf(t.prototype),"toggleCheck",this).call(this,e,n),n)e.cluster=this.clusterName,this.selectedList.push({name:e.name,ip:e.ip,cluster:e.cluster});else for(var i=0;i<this.selectedList.length;i++)if(this.selectedList[i].name===e.name&&this.selectedList[i].cluster===this.clusterName){this.selectedList.splice(i,1);break}}},{key:"deleteSelectedNode",value:function(e){if(e.cluster===this.clusterName){var n=!0,i=!1,o=void 0;try{for(var r,a=this.nodeList[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;if(s.name===e.name){_get(Object.getPrototypeOf(t.prototype),"toggleCheck",this).call(this,s,!1);break}}}catch(l){i=!0,o=l}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}}for(var c=0;c<this.selectedList.length;c++)if(this.selectedList[c].name===e.name&&this.selectedList[c].cluster===e.cluster){this.selectedList.splice(c,1);break}}},{key:"filterWithKey",value:function(e){this.selectedCount=0,this.isCheckAll=!0;var t=!0,n=!1,i=void 0;try{for(var o,r=this.nodeList[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;if(a.keyFilter=-1!==a.name.indexOf(e),a.keyFilter){var s=!0,l=!1,c=void 0;try{for(var u,d=this.selectedList[Symbol.iterator]();!(s=(u=d.next()).done);s=!0){var f=u.value;if(f.name===a.name&&f.cluster===this.clusterName){a.isSelected=!0,this.selectedCount++;break}}}catch(p){l=!0,c=p}finally{try{!s&&d["return"]&&d["return"]()}finally{if(l)throw c}}a.isSelected||(a.isSelected=!1,this.isCheckAll&&(this.isCheckAll=!1))}else a.isSelected=!1}}catch(p){n=!0,i=p}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw i}}0===this.selectedCount&&(this.isCheckAll=!1)}}]),t}(e.SelectListModel),g=e.instancesCreator({NodeList:p,AlarmService:s,HostGroupService:l,AlarmTemplate:f}),m={getData:function(){return o.get("/api/alarm/event")},ignore:function(e){return o.post("/api/alarm/event/ignore",e)}};return{getInstance:g,alarmEventService:m,keyMaps:d}}]),domeApp.directive("domeNav",["$compile",function(e){return{restrict:"AE",scope:{currentMod:"=",loginUser:"="},link:function(t,n,i){t.currentNav="",t.toggle=function(e){t.currentNav=e},t.$watch("currentMod",function(e){e&&t.toggle(e)}),i.$$element.find("li").each(function(){var e=angular.element(this),t=e.data("info");t&&e.attr({"ng-click":"toggle('"+t+"')","ng-class":"{'on':currentNav==='"+t+"'}"})}),n.html(e(n.html())(t))}}}]).directive("creatorSelection",["$domeUser",function(e){var t=[];return t.push('  <div class="com-creator-selection">'),t.push('       <div select-con="select-con" class="com-select-con role-select">'),t.push("      <button ng-cloak=\"ng-cloak\" class=\"ui-btn ui-btn-white ui-btn-select\">{{userType=='USER'?'个人':'组'}}<i class=\"icon-down\"></i></button>"),t.push('      <ul class="select-list">'),t.push('        <li class="select-item"><a ng-click="toggleUserType(\'USER\')">个人</a></li>'),t.push('        <li class="select-item"><a ng-click="toggleUserType(\'GROUP\')">组</a></li>'),t.push("      </ul>"),t.push("    </div>"),t.push("    <em ng-show=\"userType=='USER'\" ng-bind=\"'当前用户：'+currentUser.name\"></em>"),t.push('    <div select-con="select-con" class="com-select-con group-select" ng-show="userType==\'GROUP\'">'),t.push('      <button class="ui-btn ui-btn-white ui-btn-select" ng-cloak>{{currentGroup.name}}<i class="icon-down"></i></button>'),t.push('      <ul class="select-list">'),t.push('        <li ng-if="roleList.length===0" class="select-item"><a>无组信息</a></li>'),t.push('        <li ng-repeat="group in roleList" class="select-item"><a ng-bind="group.name" ng-click="toggleGroup(group)"></a></li>'),t.push("      </ul>"),t.push("    </div>"),t.push("  </div>"),{restrict:"AE",template:t.join(""),replace:!0,scope:{defaultUserType:"@",defaultUserId:"=",changeEvent:"&"},link:function(t,n,i){t.userType=t.defaultUserType||"USER",t.currentGroup={},t.currentUser={},t.toggleGroup=function(e){t.currentGroup=e,t.changeEvent({user:e})},t.toggleUserType=function(e){t.userType=e,"USER"==e?t.changeEvent({user:t.currentUser}):t.changeEvent({user:t.currentGroup})},e.userService.getGroupList().then(function(e){t.roleList=e.data.result||[];for(var n=0;n<t.roleList.length;n++)t.defaultUserId&&t.defaultUserType&&t.defaultUserId===t.roleList[n].id&&t.defaultUserType===t.roleList[n].type&&"GROUP"==t.defaultUserType&&(t.currentGroup=t.roleList[n],t.toggleGroup(t.roleList[n])),"USER"===t.roleList[n].type&&(t.currentUser=t.roleList[n],t.roleList.splice(n,1),n--);t.currentGroup.id||t.toggleGroup(t.roleList[0]),t.toggleUserType(t.userType)})}}}]).directive("listScroll",["$window","$document",function(e,t){return{restrict:"A",template:'<div class="com-tabset-scroll"><div class="list-back"><ul class="com-list-tab list-scroll" style="display:inline-block;padding-left:0;" ng-transclude></ul></div></div>',replace:!0,transclude:!0,link:function(n,i,o){var r=angular.element(e),a=angular.element(t),s=i.find("ul"),l=i.find(".nav-option"),c=i.find(".icon-next"),u=i.find(".icon-last"),d=0,f=1,p=0,g=parseInt(o.widthOffset||0);c.bind("click",function(){1>=f||d===f-1||s.stop().animate({marginLeft:(p-48)*-++d},600)}),u.bind("click",function(){0!==d&&(--d,s.stop().animate({marginLeft:(p-48)*-d},600))}),n.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)},n.$on("changeScrollList",function(){n.fresh()}),n.fresh=function(){setTimeout(function(){n.safeApply()},100)},n.$watch(function(){return{windowWidth:r.width(),listWidth:s.width()}},function(e,t){1===i.find("li").length?i.height(0):i.height("auto"),p=a.width()-g,f=Math.ceil(e.listWidth/(p-48)),d+1>f&&u.trigger("click"),1>=f?l.hide():l.show(),i.css("max-width",(p>e.listWidth?e.listWidth:p)+"px"),t.windowWidth!==e.windowWidth&&(d=0,s.css("margin-left",0))},!0),r.bind("resize",function(){n.$apply()})}}}]).directive("selectInput",function(){var e=[];return e.push('       <div><div select-con label="true" class="com-select-con">'),e.push('        <ul class="selected-labels">'),e.push('          <li ng-repeat="item in selectedList=(optionList|filter:{isSelected:true})" ng-cloak="ng-cloak" class="select-label"><a ng-click="toggleSelect(item);itemClick()" class="icon-cancel"></a>{{item[showKey]}}</li>'),e.push('          <li class="select-input">'),e.push('            <input placeholder="{{placeholder}}" ng-model="keywords.key" ng-keydown="keyDown($event,selectedList,optionListFiltered[0])" class="ui-btn-select"/>'),e.push("          </li>"),e.push("        </ul>"),e.push('        <ul class="select-list">'),e.push('          <li ng-show="optionListFiltered.length===0" class="select-item"><a>无相关信息</a></li>'),e.push('          <li ng-repeat="item in optionListFiltered=(optionList|dynamicKey:showKey:keywords.key|filter:{isSelected:false})" class="select-item" select-input-item ><a ng-click="toggleSelect(item);itemClick()"></a></li>'),e.push("        </ul>"),e.push("      </div></div>"),{restrict:"AE",template:e.join(""),replace:!0,scope:{showKey:"@",optionList:"=",placeholder:"@dPlaceholder",itemClick:"&dClick"},transclude:!0,controller:["$scope","$transclude",function(e,t){this.renderItem=t}],link:function(e){e.optionList||(e.optionList=[]),e.keywords={key:""},e.toggleSelect=function(e){e.isSelected=!e.isSelected},e.keyDown=function(t,n,i){!e.keywords.key&&8==t.keyCode&&n.length>0?e.toggleSelect(n[n.length-1]):13==t.keyCode&&i&&e.toggleSelect(i)}}}}).directive("selectInputItem",function(){return{require:"^selectInput",link:function(e,t,n,i){i.renderItem(e,function(e){t.find("a").append(e)})}}}).directive("domeToggle",function(){return{restrict:"AE",template:'<button class="ui-toggle"></button>',replace:!0}}).directive("markdown",["$q","$domeProject","$util",function(e,t,n){return{restrict:"AE",scope:{projectid:"=",branch:"="},link:function(e,i){n.loadJs("/lib/js/showdown-ca46797abd.min.js").then(function(){t.projectService.getReadMe(e.projectid,e.branch).then(function(e){var t=new showdown.Converter,n=e.data.result;n?i.html(t.makeHtml(n)):i.html("该项目没有简介")})})}}}]).directive("loglist",["$util","$domeProject",function(e,t){return{restrict:"AE",template:"<div ng-transclude></div>",transclude:!0,link:function(n,i){n.currentIndex=-1;var o=function(t){var i=n.buildList[t],o=[];return o.push('<tr class="log-detail">'),o.push('   <td colspan="7">'),o.push('       <ul class="detail-list">'),o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">镜像大小</span>'),o.push('               <span class="detail-content">'+i.imageInfo.imageSize+"MB</span>"),o.push("           </li>"),"Success"==i.state&&(o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">拉取命令</span>'),o.push('               <span class="detail-content">'),o.push('                   <input class="cmd-txt ui-input-white" disabled="true" value="docker pull '+i.imageInfo.registry+"/"+i.imageInfo.imageName+":"+i.imageInfo.imageTag+'"/><a class="link-safe link-copy" data-text="docker pull '+i.imageInfo.registry+"/"+i.imageInfo.imageName+":"+i.imageInfo.imageTag+'">复制</a>'),o.push('                   <p class="cmd-prompt"> 拉取镜像前请登录：docker login domeos.io</p>'),o.push("               </span>"),o.push("           </li>")),i.codeInfo&&i.commitInfo&&(o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">Branch名称</span>'),o.push('               <span class="detail-content">'+i.codeInfo.codeBranch+"</span>"),o.push("           </li>"),o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">author</span>'),o.push('               <span class="detail-content">'+i.commitInfo.authorName+"</span>"),o.push("           </li>"),o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">committer</span>'),o.push('               <span class="detail-content">'+i.commitInfo.committerName+"</span>"),o.push("           </li>"),o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">commit info</span>'),o.push('               <span class="detail-content">'+i.commitInfo.message+"</span>"),o.push("           </li>")),o.push('           <li class="detail-row">'),o.push('               <span class="detail-title">Dockerfile</span>'),o.push('               <span id="dockerfile" class="detail-content">加载中……</span>'),o.push("           </li>"),o.push("       </ul>"),o.push("   </td>"),o.push("</tr>"),e.parseTpl(o.join(""),n.buildList[t])};n.showDetail=function(e){
e!=n.currentIndex?(i.find(".log-detail").remove(),i.find("tr:eq("+e+")").after(o(e)),i.find(".link-copy").zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return angular.element(this).data("text")}}),t.projectService.getBuildDockerfile(n.buildList[e].projectId,n.buildList[e].id).then(function(e){var t=e.data.result;t?(t=t.replace(/[\n\r]/g,"<br/>"),i.find("#dockerfile").html(t)):i.find("#dockerfile").html("无")}),n.currentIndex=e):(0!==i.find(".log-detail").length&&i.find(".log-detail").remove(),n.currentIndex=-1)},n.isNull=function(e){var t=e;return e||(t="无"),t}}}}]).directive("btnCopy",["$util",function(e){return{restrict:"A",scope:{btnCopy:"="},link:function(t,n){e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){n.zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return t.btnCopy}})})}}}]).directive("mirrorCollapse",function(){return{restrict:"A",link:function(e){e.isCollapse=!0,e.toggleCollapse=function(){e.isCollapse=!e.isCollapse}}}}).directive("listNo",function(){return{restrict:"AE",scope:{listLen:"=length",pageno:"=",size:"@"},link:function(e,t){var n,i,o;e.$watch(function(){return e.listLen},function(r){if(i=[],r){for(n=Math.ceil(r/parseInt(e.size)),i.push('<span class="pageno last"><i class="icon-last"></i></span>'),i.push('<span class="pageno turn on">1</span>'),o=2;n>=o&&10>=o;o++)i.push('<span class="pageno turn">'+o+"</span>");i.push('<span class="pageno next"><i class="icon-next"></i></span>'),t.html(i.join(""))}}),t.delegate(".pageno","click",function(){var t=angular.element(this);t.hasClass("turn")?(e.pageno=angular.element(this).html(),angular.element(".pageno.on").removeClass("on"),t.addClass("on")):t.hasClass("last")?1!==e.pageno&&"1"!==e.pageno&&(e.pageno=parseInt(e.pageno)-1,angular.element(".pageno.on").removeClass("on").prev(".pageno").addClass("on")):t.hasClass("next")&&e.pageno<n&&parseInt(e.pageno)<n&&(e.pageno=parseInt(e.pageno)+1,angular.element(".pageno.on").removeClass("on").next(".pageno").addClass("on")),angular.element(".current-page").html(e.pageno),e.$apply()})}}}).directive("fileCollapse",function(){return{restrict:"A",link:function(e){e.showFile=!1,e.showContent=!1,e.toggleFile=function(){e.showFile=!0},e.toggleContent=function(){e.showContent=!e.showContent,e.showFile=!0,e.showContent||""!==e.fileInfo.fileName||""!==e.fileInfo.filePath||(e.showFile=!1)}}}}).directive("customlist",["$util","$domeProject","$domeImage",function(e,t,n){return{restrict:"AE",template:"<div ng-transclude></div>",transclude:!0,link:function(t,i){var o=!1;t.currentIndex=-1;var r=function(){var n=[],i=0===t.customDetailInfo.autoCustom?"Dockerfile":"配置文件",o=0===t.customDetailInfo.publish?"否":"是";if(n.push('<tr class="custom-detail">'),n.push('   <td colspan="9" class="td-detail">'),n.push('       <ul class="com-list-info detail-list">'),n.push("           <li>"),n.push('               <span class="info-name">定制详情</span>'),n.push('               <span class="info-simple">'+i+"</span>"),n.push("           </li>"),"Success"==t.customDetailInfo.state&&(n.push("           <li>"),n.push('               <span class="info-name">镜像大小</span>'),n.push('               <span class="info-simple">{#imageSize}MB</span>'),n.push("           </li>"),n.push("           <li>"),n.push('               <span class="info-name">拉取命令</span>'),n.push('               <div class="info-content cmd-wrap">'),n.push('                   <input class="ui-input-fill" disabled="true" value="docker pull {#registry}/{#imageName}:{#imageTag}"/><button class="ui-btn ui-btn-sm ui-btn-active link-copy" data-text="docker pull {#registry}/{#imageName}:{#imageTag}">复制</button>'),n.push('                   <p class="txt-prompt"> 拉取镜像前请登录：docker login domeos.io</p>'),n.push("               </div>"),n.push("           </li>")),1===t.customDetailInfo.autoCustom){n.push("           <li>"),n.push('               <span class="info-name">环境变量</span>');var r=t.customDetailInfo.envSettings,a=r.length;if(0===a)n.push('               <span class="info-simple">无</span>');else{n.push('               <div class="info-content">'),n.push('                   <table class="ui-table-primary">'),n.push("                       <tr>"),n.push("                           <td>名称</td>"),n.push("                           <td>值</td>"),n.push("                           <td>描述</td>"),n.push("                       </tr>");for(var s=0;a>s;s++)n.push("                       <tr>"),n.push("                           <td>"+r[s].key+"</td>"),n.push("                           <td>"+r[s].value+"</td>"),n.push("                           <td>"+r[s].description+"</td>"),n.push("                       </tr>");n.push("                   </table>"),n.push("               </div>")}n.push("           </li>")}if(n.push("           <li>"),n.push('               <span class="info-name">定制镜像是否作为基础镜像</span>'),n.push('               <span class="info-simple">'+o+"</span>"),n.push("           </li>"),n.push("           <li>"),n.push('               <span class="info-name">定制镜像描述</span>'),null===t.customDetailInfo.description||""===t.customDetailInfo.description?n.push('               <span class="info-simple">无</span>'):n.push('               <span class="info-simple">{#description}</span>'),n.push("           </li>"),n.push("           <li>"),n.push('               <span class="info-name">Dockerfile</span>'),null===t.customDetailInfo.dockerfileContent||""===t.customDetailInfo.dockerfileContent?n.push('               <span class="info-simple">无</span>'):(n.push('               <div class="info-content">'),n.push('                   <textarea readonly="true" class="ui-input-fill file-txt">{#dockerfileContent}</textarea>'),n.push("               </div>")),n.push("           </li>"),1===t.customDetailInfo.autoCustom&&t.customDetailInfo.files){n.push("           <li>"),n.push('               <span class="info-name">配置文件</span>');var l=t.customDetailInfo.files,c=l.length;if(c&&0!==c){n.push('               <div class="info-content">');for(var u=0;c>u;u++)n.push('                   <div class="line-long">'),n.push('                       <p class="con-num">'+(u+1)+"</p>"),n.push('                       <span class="config-title">名称:'+l[u].fileName+"</span>"),n.push('                       <span class="config-title">容器内路径:'+l[u].filePath+"</span>"),n.push("                   </div>"),n.push('                   <textarea readonly="true" class="ui-input-fill file-txt">'+l[u].content+"</textarea>");n.push("               </div>")}else n.push('                   <span class="info-simple">无</span>');n.push("           </li>")}return n.push("           <li>"),n.push('               <button class="ui-btn ui-btn-none btn-pack" >收起<i class="icon-down top"></i></button>'),n.push("           </li>"),n.push("       </ul>"),n.push("   </td>"),n.push("</tr>"),e.parseTpl(n.join(""),t.customDetailInfo)};e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){o=!0});var a=function(){i.find(".link-copy").zclip({path:"/lib/media/ZeroClipboard.swf",copy:function(){return angular.element(this).data("text")}})},s=function(){i.find(".btn-pack").click(function(){t.$apply(function(){t.currentIndex=-1,i.find(".custom-detail").remove()})})};t.showDetail=function(l,c){l!==t.currentIndex?(n.imageService.getCustomImageInfo(c).then(function(n){t.customDetailInfo=n.data.result||{},i.find(".custom-detail").remove(),i.find("tr:eq("+l+")").after(r()),s(),o?a():e.loadJs("/lib/js/jquery-a482e1500f.zclip.js").then(function(){o=!0,a()})}),t.currentIndex=l):(0!==i.find(".custom-detail").length&&i.find(".custom-detail").remove(),t.currentIndex=-1)}}}}]),domeApp.directive("isOver",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,i){e.$watch(function(){return{max:n.max,min:n.min,model:i.$modelValue}},function(e){var t=e.max,n=e.min,o=!1,r=!1;(isNaN(t)||!isNaN(t)&&parseFloat(e.model)<=parseFloat(t))&&(o=!0),(isNaN(n)||!isNaN(n)&&parseFloat(e.model)>=parseFloat(n))&&(r=!0),o&&r?i.$setValidity("isOver",!0):i.$setValidity("isOver",!1)},!0)}}}).directive("isProjectExist",["$domeProject",function(e){return{require:"ngModel",link:function(t,n,i,o){var r={};e.projectService.getData().then(function(e){function n(e){var t=s+"/"+e;return 1===r[t]?o.$setValidity("isProjectExist",!1):o.$setValidity("isProjectExist",!0),e}for(var a=e.data.result||[],s=i.groupName,l=0;l<a.length;l++)r[a[l].name]=1;t.$watch(function(){return i.groupName},function(e){e&&(s=e),n(o.$modelValue)}),o.$parsers.unshift(n)})}}}]).directive("isUserExist",function(){return{require:"ngModel",scope:{userList:"=isUserExist"},link:function(e,t,n,i){i.$parsers.unshift(function(t){if(e.userList)for(var n=0;n<e.userList.length;n++)if(e.userList[n].username===t)return void i.$setValidity("isUserExist",!1);return i.$setValidity("isUserExist",!0),t})}}}).directive("isClusterExist",function(){return{require:"ngModel",scope:{clusterList:"="},link:function(e,t,n,i){i.$parsers.unshift(function(t){if(e.clusterList)for(var n=0;n<e.clusterList.length;n++)if(e.clusterList[n].name===t)return void i.$setValidity("isClusterExist",!1);return i.$setValidity("isClusterExist",!0),t})}}}).directive("isApiServerExist",function(){return{require:"ngModel",scope:{clusterList:"=",currentCluster:"@"},link:function(e,t,n,i){i.$parsers.unshift(function(t){if(e.clusterList)for(var n=0;n<e.clusterList.length;n++)if(e.currentCluster!==e.clusterList[n].name&&e.clusterList[n].api===t)return void i.$setValidity("isApiServerExist",!1);return i.$setValidity("isApiServerExist",!0),t})}}}).directive("isDeployExist",["$domeDeploy",function(e){return{require:"ngModel",link:function(t,n,i,o){function r(e){for(var t=0;t<a.length;t++)if(a[t].clusterName===l&&a[t].namespace===s&&a[t].deployName===e)return o.$setValidity("isDeployExist",!1),e;return o.$setValidity("isDeployExist",!0),e}var a=[],s=i.namespace,l=i.clustername;e.deployService.getList().then(function(e){a=e.data.result||[]}),t.$watch(function(){return{namespace:i.namespace,clustername:i.clustername}},function(e){s=e.namespace,l=e.clustername,r(o.$modelValue)},!0),o.$parsers.unshift(r)}}}]).directive("isNamespaceExist",["$domeCluster",function(e){return{require:"ngModel",link:function(t,n,i,o){var r=[],a=e.getInstance("ClusterService").getNamespace;t.$watch(function(){return i.clusterid},function(e){a(e).then(function(e){r=e.data.result||[]})}),o.$parsers.unshift(function(e){for(var t=0;t<r.length;t++)if(r[t].name===e)return o.$setValidity("isNamespaceExist",!1),e;return o.$setValidity("isNamespaceExist",!0),e})}}}]).directive("isGroupExist",["$domeUser",function(e){return{require:"ngModel",link:function(t,n,i,o){var r={};e.userService.getGroup().then(function(e){for(var t=e.data.result||[],n=0;n<t.length;n++)r[t[n].name]=1}),o.$parsers.unshift(function(e){return r[e]?o.$setValidity("isGroupExist",!1):o.$setValidity("isGroupExist",!0),e})}}}]).directive("isAlarmTemplateExist",["$domeAlarm",function(e){return{require:"ngModel",scope:{selfName:"@"},link:function(t,n,i,o){var r={},a=e.getInstance("AlarmService");a.getData().then(function(e){for(var t=e.data.result||[],n=0;n<t.length;n++)r[t[n].templateName]=1}),o.$parsers.unshift(function(e){return t.selfName&&t.selfName===e?o.$setValidity("isAlarmTemplateExist",!0):r[e]?o.$setValidity("isAlarmTemplateExist",!1):o.$setValidity("isAlarmTemplateExist",!0),e})}}}]).directive("isTagExist",function(){return{require:"ngModel",scope:{baseImages:"=baseimages",imageName:"=imagename"},link:function(e,t,n,i){function o(t){var n=!1;if(e.imageName&&""!==e.imageName&&e.baseImages)for(var o=0;o<e.baseImages.length;o++)if(e.baseImages[o].imageName===e.imageName&&e.baseImages[o].imageTag===t){n=!0;break}return i.$setValidity("isTagExist",!n),t}e.$watch(function(){return e.imageName},function(){o(i.$modelValue)}),i.$parsers.unshift(o)}}}).directive("isHostgroupExist",function(){return{require:"ngModel",scope:{hostgroupList:"="},link:function(e,t,n,i){i.$parsers.unshift(function(t){for(var n=0;n<e.hostgroupList.length;n++)if(t===e.hostgroupList[n].hostGroupName)return i.$setValidity("isHostgroupExist",!1),t;return i.$setValidity("isHostgroupExist",!0),t})}}}).directive("diyPattern",function(){return{restrict:"A",require:"ngModel",scope:{pattern:"=diyPattern"},link:function(e,t,n,i){function o(t){if(t=t||"",e.pattern&&""!==e.pattern){var n=new RegExp(e.pattern);return i.$setValidity("diyPattern",n.test(t)),t}return i.$setValidity("diyPattern",!0),t}i.$parsers.unshift(o),e.$watch(function(){return e.pattern},function(){o(i.$modelValue)})}}}).directive("isRequired",[function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,i){var o=[],r=!1;angular.forEach(n,function(e,t){-1!==t.indexOf("param")&&o.push(t)}),e.$watch(function(){for(var e={},t=0;t<o.length;t++)e[o[t]]=n[o[t]];return{watchParams:e,model:i.$modelValue}},function(e){r=!1,angular.forEach(e.watchParams,function(e){e&&""!==e&&"false"!==e&&(r=!0)}),!r||r&&e.model?i.$setValidity("isRequired",!0):i.$setValidity("isRequired",!1)},!0)}}}]),function(){function e(e,t,n,i,o,r){var a=this;a.currentMod={mod:""},a.loginUser={},a.showPrompt=!1,e.$on("pageTitle",function(e,t){a.title=t.title,a.descrition=t.descrition,a.currentMod.mod=t.mod}),o.getDbConfig().then(function(e){a.showPrompt="H2"==e.data.result}),a.getLoginUser=function(){var e=r.defer();return a.loginUser.id?e.resolve(a.loginUser):i.userService.getCurrentUser().then(function(t){a.loginUser=t.data.result,e.resolve(a.loginUser)}),e.promise},a.getLoginUser(),a.parseDate=function(e){return n.getPageDate(e)},a.objLength=n.objLength,a.logout=function(){i.userService.logout()},a.modifyPw=function(){t.open({animate:!0,templateUrl:"modifyPwModal.html",controller:"ModifyPwModalCtr",size:"md",resolve:{loginUser:function(){return a.loginUser}}})},a.modifySelfInfo=function(){i.getLoginUser().then(function(e){var n=t.open({templateUrl:"modifyUserInfoModal.html",controller:"ModifyUserInfoCtr",size:"md",resolve:{user:function(){return angular.copy(e)}}});n.result.then(function(t){angular.extend(e,t)})})},a.isStrNull=function(e){var t=e;return e||(t="未设置"),t},a.stopPropagation=function(e){return e.stopPropagation()}}domeApp.controller("DomeCtr",e),e.$inject=["$scope","$modal","$util","$domeUser","$publicApi","$q"],domeApp.controller("PromptModalCtrl",["$scope","$modalInstance","promptTxt","$timeout",function(e,t,n,i){e.promptTxt=n,i(function(){t.dismiss("cancel")},1e3),e.cancel=function(){t.dismiss("cancel")}}]).controller("WarningModalCtrl",["$scope","$modalInstance","promptTxt",function(e,t,n){"string"==typeof n?e.titleInfo=n:(e.titleInfo=n.title,e.detailInfo=n.msg),e.cancel=function(){t.dismiss("cancel")}}]).controller("ConfirmModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n,e.cancel=function(){t.dismiss("cancel")},e.sure=function(){t.close()}}]).controller("DeleteModalCtr",["$scope","$modalInstance","promptTxt",function(e,t,n){e.promptTxt=n||"确定要删除吗？",e["delete"]=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}])}(),domeApp.controller("ProjectManageCtr",["$scope","$domeProject","$timeout",function(e,t,n){e.projectList=[],e.isLoading=!0,e.$emit("pageTitle",{title:"项目管理",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"});var i,o=function(){t.projectService.getData().then(function(t){e.projectList=t.data.result||[]})["finally"](function(){e.isLoading=!1,i&&n.cancel(i),i=n(o,4e3)})};o(),e.openBuild=function(e,n){t.buildProject(e,n)},e.$on("$destroy",function(e){i&&n.cancel(i)})}]),domeApp.controller("DeployManageCtr",["$scope","$domeDeploy","$domeCluster","$timeout","$state",function(e,t,n,i,o){e.$emit("pageTitle",{title:"部署",descrition:"在这里您可以把项目镜像部署到运行环境中。此外，您还可以对现有部署进行监控和管理。",mod:"deployManage"}),e.showSelect=!0,e.isLoading=!0;var r,a=[],s=n.getInstance("ClusterService");e.selectOption={},e.selectOption.status={ALL:!0,DEPLOYING:!1,RUNNING:!1,STOP:!1,ERROR:!1,STOPPING:!1,BACKROLLING:!1,UPDATING:!1,UPSCALING:!1,DOWNSCALING:!1,ABORTING:!1,BACKROLL_ABORTED:!1,UPDATE_ABORTED:!1},e.selectOption.env={ALL:!0,PROD:!1,TEST:!1};var l=0;e.selectOption.namespace={ALL:!0},e.selectOption.cluster={ALL:!0},e.deloyList=[];var c=function(){"deployManage"==o.current.name&&t.deployService.getList().then(function(t){var n,i,o;if(t.data.result)for(e.deloyList=t.data.result,l=0;l<e.deloyList.length;l++)n=e.deloyList[l],i=n.cpuTotal>0?(n.cpuUsed/n.cpuTotal*100).toFixed(2):"0.00",o=n.memoryTotal>0?(n.memoryUsed/n.memoryTotal*100).toFixed(2):"0.00",n.serviceDnsName?n.dnsName=n.serviceDnsName:n.dnsName="无",i>o?(n.compare="cpu",n.comparePercent=i):(n.compare="memory",n.comparePercent=o)})["finally"](function(){e.isLoading=!1,r&&i.cancel(r),r=i(c,4e3)})};c();var u=function(t){s.getNamespace(t).then(function(t){for(var n=t.data.result||[],i=0;i<n.length;i++)e.selectOption.namespace[n[i].name]||(e.selectOption.namespace[n[i].name]=!1)})},d=function(){if(e.selectOption.namespace={ALL:!0},e.selectOption.cluster.ALL)for(l=0;l<a.length;l++)u(a[l].id);else angular.forEach(e.selectOption.cluster,function(e,t){if("ALL"!==t&&e)for(l=0;l<a.length;l++)if(a[l].name===t){u(a[l].id);break}})};s.getData().then(function(t){a=t.data.result||[],d("all");for(var n=0;n<a.length;n++)e.selectOption.cluster[a[n].name]=!1}),e.toggleShowSelect=function(){e.showSelect=!e.showSelect},e.toggleAll=function(t){angular.forEach(e.selectOption[t],function(n,i){e.selectOption[t][i]=!1}),e.selectOption[t].ALL=!0,"cluster"===t&&d("all")},e.toggleSelect=function(t,n){var i=!0;e.selectOption[t][n]=!e.selectOption[t][n],e.selectOption[t][n]?e.selectOption[t].ALL&&(e.selectOption[t].ALL=!1):(angular.forEach(e.selectOption[t],function(n,o){"ALL"!==o&&e.selectOption[t][o]&&i&&(i=!1)}),i&&e.toggleAll(t)),"cluster"===t&&d(n)},e.$on("$destroy",function(e){r&&i.cancel(r)})}]),domeApp.controller("GroupManageCtr",["$scope","$domeUser",function(e,t){e.$emit("pageTitle",{title:"组管理",descrition:"在这里您可以看到所有的组。您可以选择某个组查看详细信息或新建一个组。",mod:"user"}),e.isLoading=!0,t.userService.getGroup().then(function(t){e.groupList=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("ClusterManageCtr",["$scope","$domeCluster",function(e,t){e.$emit("pageTitle",{title:"集群管理",descrition:"在这里您可以查看和管理自己的物理集群，并随时添加主机到集群中。",mod:"cluster"}),e.isLoading=!0;var n=t.getInstance("ClusterService");n.getData().then(function(t){e.clusterList=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]),domeApp.controller("AppStoreCtr",["$scope","$domeAppStore",function(e,t){e.$emit("pageTitle",{title:"欢迎来到应用商店！",descrition:"在这里您可以选择需要的应用并快速部署。部署后请到部署模块查询您的应用。",mod:"appStore"}),t.getStoreApps().then(function(t){e.appList=t.data||[]})}]),domeApp.controller("ImageManageCtr",["$scope","$state","$domeImage","$domePublic","$modal",function(e,t,n,i,o){e.$emit("pageTitle",{title:"镜像管理",descrition:"在这里您可以查看并管理您的镜像仓库。",mod:"image"}),e.isLoading=!0,e.needValid={value:!1},e.isShowAdd=!1,e.newImageInfo={},e.projectRegistry="",e.tabActive=[{active:!1},{active:!1},{active:!1}];var r=t.$current.name,a=n.imageService;-1!==r.indexOf("projectimages")?e.tabActive[1].active=!0:-1!==r.indexOf("otherimages")?e.tabActive[2].active=!0:e.tabActive[0].active=!0,a.getAllImages().then(function(t){var n=t.data.result||{},i=0;for(e.baseImages=n.baseImages||[],e.projectImages=n.projectImages||[],e.otherImages=n.otherImages||[],i=0;i<e.baseImages.length;i++)e.baseImages[i].description||(e.baseImages[i].description="无");0!==e.projectImages.length&&(e.projectRegistry=e.projectImages[0].registry)})["finally"](function(){e.isLoading=!1}),e.toggleShowAdd=function(t){e.isShowAdd=t},e.openTagModal=function(e){o.open({animation:!0,templateUrl:"imageTagModal.html",controller:"ImageTagModalCtr",size:"lg",resolve:{imageName:function(){return e}}})},e.deleteBaseImage=function(t){n.deleteBaseImage(t).then(function(){for(var n=0;n<e.baseImages.length;n++)if(e.baseImages[n].id===t){e.baseImages.splice(n,1);break}})},e.createImage=function(t){e.isLoading=!0,a.createBaseImage(e.newImageInfo).then(function(n){i.openPrompt("添加成功！"),e.newImageInfo={},n.data.result&&e.baseImages.push(n.data.result),e.needValid=!1,t.$setPristine()},function(){i.openWarning("添加失败,请重试！")})["finally"](function(){e.isLoading=!1})}}]).controller("ImageTagModalCtr",["$scope","imageName","$modalInstance","$domeImage","$util",function(e,t,n,i,o){e.imageName=t,e.tagInfo=[],e.isLoading=!0,e.parseDate=o.getPageDate,i.imageService.getImageInfo(t).then(function(t){e.tagInfo=t.data.result||[]})["finally"](function(){e.isLoading=!1})}]);var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();!function(){function e(e,t,n,i,o,r,a,s){var l=this;e.$emit("pageTitle",{title:"全局配置",descrition:"在这里您可以进行一些全局配置，保证domeos能够正常运行和使用。",mod:"global"}),i.getLoginUser().then(function(e){"admin"!==e.username&&n.go("projectManage")});var c=t.getGloabalInstance("ldap"),u=t.getGloabalInstance("server"),d=t.getGloabalInstance("registry"),f=t.getGloabalInstance("git"),p=t.getGloabalInstance("monitor"),g=t.getGloabalInstance("ssh"),m=t.getGloabalInstance("cluster"),h=o.getInstance("NodeService");l.serverInfo={},l.ldapInfo={},l.registryInfo={},l.gitInfo={},l.sshInfo={},l.clusterInfo={},l.newUser={},l.needValidUser={valid:!1},l.key={userKey:"",nodeKey:""},l.isShowAdd=!1,l.currentUserType={type:"USER"},l.userList=[],l.ldapUserList=[],l.clusterLoadingIns=a.getLoadingInstance(),l.tabActive=[{active:!1},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}];var v=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"init",value:function(e){function t(e){var t=[],n=[];if(!e)return[{text:""}];n=e.split(",");for(var i=0;i<n.length;i++)t.push({text:n[i]});return t.push({text:""}),t}this.config=e||{},this.config.transfer=t(this.config.transfer),this.config.graph=t(this.config.graph),this.config.judge=t(this.config.judge)}},{key:"addItem",value:function(e){this.config[e].push({text:""})}},{key:"deleteArrItem",value:function(e,t){this.config[e].splice(t,1)}},{key:"formartMonitor",value:function(){var e=angular.copy(this.config),t=function(e){for(var t=[],n=0;n<e.length;n++)e[n].text&&t.push(e[n].text);return t.join(",")};return e.transfer=t(this.config.transfer),e.graph=t(this.config.graph),e.judge=t(this.config.judge),e}}]),e}();i.userService.getUserList().then(function(e){l.userList=e.data.result||[]});var y=function(){return l.clusterList?void s.when(l.clusterList):h.getData().then(function(e){return l.clusterList=e.data.result||[],l.clusterList})};l.toggleUserType=function(e){e!==l.currentUserType&&(l.currentUserType.type=e,l.isShowAdd=!1,l.key.userKey="")},l.toggleShowAdd=function(){l.isShowAdd=!l.isShowAdd},l.modifyPw=function(e){r.open({templateUrl:"newPasswdModal.html",controller:"NewPasswdModalCtr as vmPw",size:"md",resolve:{username:function(){return e.username}}})},l.modifyUserInfo=function(e){i.getLoginUser().then(function(t){var n=t.id===e.id?angular.copy(t):angular.copy(e),o=r.open({templateUrl:"modifyUserInfoModal.html",controller:"ModifyUserInfoCtr",size:"md",resolve:{user:function(){return n}}});o.result.then(function(t){angular.extend(e,t),i.getLoginUser().then(function(n){n.id===e.id&&angular.extend(n,t)})})})},l.deleteUser=function(e){var t=e.id;a.openDelete().then(function(){i.userService.deleteUser(t).then(function(){for(var e=0;e<l.userList.length;e++)if(l.userList[e].id===t){l.userList.splice(e,1);break}},function(){a.openWarning("删除失败！")})})},l.getLdap=function(){l.ldapInfo.id||c.getData().then(function(e){var t=/(.*):([^:]+)/g;l.ldapInfo=e,l.ldapInfo.url=l.ldapInfo.server.replace(t,"$1"),l.ldapInfo.port=l.ldapInfo.server.replace(t,"$2")})},l.getGitInfo=function(){l.gitInfo.id||f.getData().then(function(e){l.gitInfo=e[0]})},l.getRegistryInfo=function(){l.registryInfo.id||d.getData().then(function(e){l.registryInfo=e})},l.getServerInfo=function(){l.serverInfo.id||u.getData().then(function(e){l.serverInfo=e})},l.getMonitorInfo=function(){function e(e){l.monitorIns=new v,l.monitorIns.init(e),l.monitorConfig=l.monitorIns.config}l.monitorConfig||p.getData().then(function(t){e(t)},e())},l.getWebSsh=function(){l.sshInfo.id||g.getData().then(function(e){l.sshInfo=e})},l.toggleCluster=function(e,t){l.clusterInfo.clusterId=e.id,l.clusterInfo.clusterName=e.name,l.clusterInfo.host=e.api,l.key.nodeKey="",l.clusterLoadingIns.startLoading("namespace"),l.clusterLoadingIns.startLoading("nodeList"),h.getNamespace(e.id,e.name).then(function(e){if(l.namespaceList=e.data.result||[],t)l.clusterInfo.namespace=t;else{var n=!0,i=!1,o=void 0;try{for(var r,a=l.namespaceList[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;if("default"==s.name)return void(l.clusterInfo.namespace="default")}}catch(c){i=!0,o=c}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}l.clusterInfo.namespace=l.namespaceList[0]&&l.namespaceList[0].name}},function(){l.namespaceList=[],l.clusterInfo.namespace=null})["finally"](function(){l.clusterLoadingIns.finishLoading("namespace")}),h.getNodeList(e.id).then(function(e){var t=e.data.result||[],n=!0,i=!1,o=void 0;try{for(var r,a=t[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var s=r.value;s.capacity&&(s.capacity.memory=(s.capacity.memory/1024/1024).toFixed(2)),s.labels||(s.labels={}),s.isUsedByBuild=!!s.labels.BUILDENV}}catch(c){i=!0,o=c}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw o}}l.nodeList=t})["finally"](function(){l.clusterLoadingIns.finishLoading("nodeList")})};var I=function(e){l.clusterInfo=e||{};var t=!0,n=!1,i=void 0;try{for(var o,r=l.clusterList[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;if(a.api===l.clusterInfo.host)return void l.toggleCluster(a,l.clusterInfo.namespace)}}catch(s){n=!0,i=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw i}}};l.initClusterInfo=function(){l.clusterInfo.id||(l.clusterLoadingIns.startLoading("cluster"),s.all([y(),m.getData()]).then(function(e){I(e[1])})["finally"](function(){l.clusterLoadingIns.finishLoading("cluster")}))},l.addUser=function(e){var t=angular.copy(l.newUser);delete t.rePassword,i.userService.createUser(t).then(function(n){a.openPrompt("创建成功！");angular.copy(t);n.data.result&&l.userList.push(n.data.result),l.newUser={},l.needValidUser.valid=!1,e.$setPristine()},function(){a.openWarning("创建失败！")})},l.saveLdap=function(){var e=angular.copy(l.ldapInfo);e.server=e.url+":"+e.port,delete e.url,delete e.port,c.modifyData(e).then(function(){l.getLdap()})},l.saveGit=function(){l.gitInfo.id||(l.gitInfo.type="GITLAB"),f.modifyData(l.gitInfo).then(function(e){e&&(l.gitInfo=e)})},l.saveRegistry=function(){l.registryInfo.id&&(delete l.registryInfo.id,delete l.registryInfo.createTime);var e=angular.copy(l.registryInfo);0===e.status&&delete e.certification,d.modifyData(e).then(function(e){e&&(l.registryInfo=e)})},l.saveServer=function(){u.modifyData(l.serverInfo).then(function(e){e&&(l.serverInfo=e)})},l.saveMonitor=function(){p.modifyData(l.monitorIns.formartMonitor()).then(function(e){e&&(l.monitorIns.init(e),l.monitorConfig=l.monitorIns.config)})},l.saveSsh=function(){g.modifyData(l.sshInfo).then(function(e){e&&(l.sshInfo=e)})},l.saveCluster=function(){var e=void 0,t=l.nodeList,n=[],i=[],o=!0,r=!1,c=void 0;try{for(var u,d=t[Symbol.iterator]();!(o=(u=d.next()).done);o=!0){var f=u.value;f.isUsedByBuild?n.push({node:f.name,labels:{BUILDENV:"HOSTENVTYPE"}}):i.push({node:f.name,labels:{BUILDENV:null}})}}catch(p){r=!0,c=p}finally{try{!o&&d["return"]&&d["return"]()}finally{if(r)throw c}}return 0===n.length?void a.openWarning("请至少设置一台用于构建的主机！"):(l.clusterLoadingIns.startLoading("submitCluster"),void m.modifyData(l.clusterInfo).then(function(t){e=t}).then(function(){return h.addLabel(l.clusterInfo.clusterId,n).then(function(){return!0},function(e){return a.openWarning({title:"错误！",msg:e.data.resultMsg}),s.reject()})}).then(function(){return 0!==i.length?h.deleteLabel(l.clusterInfo.clusterId,i)["catch"](function(e){return a.openWarning({title:"错误！",msg:e.data.resultMsg}),s.reject()}):void 0})["finally"](function(){I(e),l.clusterLoadingIns.finishLoading("submitCluster")}))};var b=n.$current.name;-1!==b.indexOf("ldapinfo")?(l.tabActive[1].active=!0,l.getLdap()):-1!==b.indexOf("gitinfo")?(l.tabActive[2].active=!0,l.getGitInfo()):-1!==b.indexOf("registryinfo")?(l.tabActive[3].active=!0,l.getRegistryInfo()):-1!==b.indexOf("serverinfo")?(l.tabActive[4].active=!0,l.getServerInfo()):-1!==b.indexOf("monitorinfo")?(l.tabActive[5].active=!0,l.getMonitorInfo()):-1!==b.indexOf("sshinfo")?(l.tabActive[6].active=!0,l.getWebSsh()):-1!==b.indexOf("clusterinfo")?(l.tabActive[7].active=!0,l.initClusterInfo()):l.tabActive[0].active=!0}function t(e,t,n,i){var o=this;o.cancel=function(){n.dismiss()},o.subPw=function(){var r={username:e,password:o.passwd};t.userService.modifyPw(r).then(function(){i.openPrompt("修改成功！"),n.close()},function(){i.openWarning("修改失败！")})}}domeApp.controller("GlobalSettingCtr",e).controller("NewPasswdModalCtr",t),e.$inject=["$scope","$domeGlobal","$state","$domeUser","$domeCluster","$modal","$domePublic","$q"],t.$inject=["username","$domeUser","$modalInstance","$domePublic"]}(),domeApp.controller("CreateProjectCtr1",["$scope","$state","$domeData","$modal","$domeProject","$domePublic",function(e,t,n,i,o,r){e.$emit("pageTitle",{title:"新建项目",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"}),e.pageNo=1,e.pageSize=8,e.projectList=[],e.creator={},e.codeManager="gitlab",e.autoBuildInfo={tag:0,master:!1,other:!1,branches:""},e.role="user",e.projectType="common",e.currentProject={};var a=angular.copy(n.getData("createProjectInfo1"));a&&(n.delData("createProjectInfo1"),a.info.codeInfo&&(e.currentProject=function(){var e=a.info.codeInfo;return{nameWithNamespace:e.nameWithNamespace,sshUrl:e.codeSshUrl,httpUrl:e.codeHttpUrl,projectId:e.codeId}}(),e.currentUserId=a.info.codeInfo.codeManagerUserId),e.codeManager=a.codeManager,e.creator={id:a.creatorDraft.creatorId,type:a.creatorDraft.creatorType},e.projectName=a.info.name,a.info.autoBuildInfo?e.autoBuildInfo=a.info.autoBuildInfo:e.autoBuildInfo={tag:0,master:!1,other:!1,branches:""},e.projectType=a.projectType),e.setProjectList=function(t){e.pageNo=1,e.currentUserId=t.id,e.projectList=t.projectInfos};var s=function(){e.isLoading=!0,o.projectService.getGitLabInfo().then(function(t){if(e.gitLabInfo=t.data.result,e.currentUserId&&e.currentProject){for(var n=0;n<e.gitLabInfo.length;n++)if(e.gitLabInfo[n].id===e.currentUserId){e.setProjectList(e.gitLabInfo[n]);for(var i=0;i<e.projectList.length;i++)if(e.projectList[i].projectId===e.currentProject.projectId){e.setCurrentProject(e.projectList[i]);break}break}}else e.gitLabInfo[0]&&e.setProjectList(e.gitLabInfo[0])})["finally"](function(){e.isLoading=!1})};s(),e.toggleCodeManager=function(t){e.codeManager=t,t||"dockerfile"!=e.projectType&&"custom"!=e.projectType||(e.projectType="common"),e.$broadcast("changeScrollList",new Date)},e.toRelated=function(){var e=i.open({templateUrl:"loginModal.html",controller:"LoginModalCtr",size:"md"});e.result.then(function(){r.openPrompt("关联成功！"),s()})},e.changeCreator=function(t){e.creator=t},e.toNext=function(){if(e.codeManager&&!e.currentProject.projectId)return void r.openWarning("请选择一个项目！");var i={creatorType:e.creator.type,creatorId:e.creator.id},o={name:e.projectName,projectBelong:e.creator.name};e.codeManager&&(o.autoBuildInfo=e.autoBuildInfo,o.codeInfo={codeManager:e.codeManager,nameWithNamespace:e.currentProject.nameWithNamespace,codeSshUrl:e.currentProject.sshUrl,codeHttpUrl:e.currentProject.httpUrl,codeId:e.currentProject.projectId,codeManagerUserId:e.currentUserId}),n.setData("projectInfo",{creatorDraft:i,codeManager:e.codeManager,info:o,projectType:e.projectType}),t.go("createProject/2")},e.isDescriptionNull=function(e){var t=e;return e||(t="无描述信息"),t},e.setCurrentProject=function(t){e.currentProject=t}}]).controller("LoginModalCtr",["$scope","$http","$modalInstance","$domeUser",function(e,t,n,i){
e.toLogin=function(){e.errorTxt="",e.isWaiting=!0;var t=e.username.indexOf("@"),o=e.username;-1!==t&&(o=o.substring(0,t));var r={login:o,password:e.password};i.relatedGitLab(r).then(function(){n.close()},function(){e.errorTxt="关联失败，请重试！",e.isWaiting=!1})},e.close=function(){n.dismiss("cancel")}}]),domeApp.controller("CreateProjectCtr2",["$scope","$modal","$domeProject","$domeImage","$domeData","$domePublic","$state",function(e,t,n,i,o,r,a){e.$emit("pageTitle",{title:"新建项目",descrition:"在这里把您的代码仓库和DomeOS对接即可创建新项目。此外，您还可以对现有项目进行查询和管理。",mod:"projectManage"});var s=angular.copy(o.getData("projectInfo"));if(o.delData("projectInfo"),!s)return void a.go("createProject/1");e.valid={needValid:!1,createdFileStoragePath:!1};var l=function(){e.config=e.project.config,e.project.customConfig.buildPath="/",e.project.customConfig.dockerfilePath="/Dockerfile",e.config.authority=0};e.project=n.getInstance("Project",{userDefineDockerfile:"dockerfile"==s.projectType,exclusiveBuild:{customType:"custom"==s.projectType?"java":null}}),l();var c=function(){e.project.create().then(function(){r.openPrompt("新建成功！"),a.go("projectManage")},function(e){r.openWarning({title:"新建失败！",msg:"Message:"+e.data.resultMsg})})};e.config.userDefineDockerfile||(i.imageService.getExclusiveImages("java").then(function(t){e.project.projectImagesIns.init(t.data.result),console.log(e.project)}),i.imageService.getBaseImages().then(function(t){e.imageList=t.data.result})),e.toggleProjectType=function(t){"allType"==t&&!e.project.isUseCustom||t===e.project.isUseCustom&&e.project.customConfig.customType||(e.project.init(),l(),"allType"==t?e.project.isUseCustom=!1:(e.project.isUseCustom=!0,e.project.customConfig.customType=t))},e.validCreatedFileStoragePath=function(){if(!e.project.isUseCustom)return void(e.valid.createdFileStoragePath=!0);for(var t=e.project.customConfig.createdFileStoragePath,n=0;n<t.length;n++)if(t[n].name)return void(e.valid.createdFileStoragePath=!0);e.valid.createdFileStoragePath=!1},e.changeDockerfilePath=function(t){"/"==t?e.config.dockerfileInfo.dockerfilePath="/Dockerfile":e.config.dockerfileInfo.dockerfilePath=t+"/Dockerfile"},e.getDockerfile=function(){e.config.name=s.info.projectBelong+"/"+s.info.name,e.config.codeInfo=s.info.codeInfo,e.config.autoBuildInfo=s.info.autoBuildInfo,e.project.getDockerfile()},e.toCopy=function(){var i=t.open({animation:!0,templateUrl:"projectListModal.html",controller:"ProjectListModalCtr",size:"lg",resolve:{isUseDefineDockerfile:e.config.userDefineDockerfile,customType:function(){return e.project.customConfig.customType}}});i.result.then(function(t){n.projectService.getData(t).then(function(t){var n=t.data.result;e.project.customConfig;delete n.id,e.project.init(n),!n.userDefineDockerfile&&n.exclusiveBuild&&n.exclusiveBuild.customType&&(e.project.projectImagesIns.toggleSpecifiedImage("compile",n.exclusiveBuild.compileImage),e.project.projectImagesIns.toggleSpecifiedImage("run",n.exclusiveBuild.runImage)),e.config=e.project.config,e.validCreatedFileStoragePath()})})},e.toLastPage=function(){o.setData("createProjectInfo1",s),a.go("createProject/1")},e.createProject=function(){e.config.name=s.info.projectBelong+"/"+s.info.name,e.config.codeInfo=s.info.codeInfo,e.config.autoBuildInfo=s.info.autoBuildInfo,e.project.creatorDraft=s.creatorDraft,c()}}]).controller("ProjectListModalCtr",["$scope","$modalInstance","$domeProject","isUseDefineDockerfile","customType",function(e,t,n,i,o){e.loading=!0,e.key={searchKey:""},n.projectService.getData().then(function(t){for(var n=t.data.result||[],r=0;r<n.length;r++)i?n[r].userDefineDockerfile||(n.splice(r,1),r--):(n[r].userDefineDockerfile||!o&&"simple"!==n[r].projectType||o&&n[r].projectType!==o)&&(n.splice(r,1),r--);e.projectList=n})["finally"](function(){e.loading=!1}),e.cancel=function(){t.dismiss("cancel")},e.copy=function(e){t.close(e)}}]),domeApp.controller("ProjectDetailCtr",["$scope","$state","$stateParams","$domeProject","$domePublic","$domeImage","$timeout","$location","$util",function(e,t,n,i,o,r,a,s,l){if(e.projectId=t.params.project,!e.projectId)return void t.go("projectManage");e.branch="master",e.valid={needValid:!1,createdFileStoragePath:!1},e.edit=!1,e.isWaitingForModify=!1,e.statusKey="",e.autoBuildKey="",e.resourceType="PROJECT",e.resourceId=e.projectId,e.$on("memberPermisson",function(n,i){e.hasMemberPermisson=i,i||-1===v.indexOf("user")||(t.go("projectDetail.info"),e.tabActive[0].active=!0)}),e.isLoading=!0,e.tabActive=[{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}];var c,u,d=function(){var t=e.project.config.dockerfileInfo.buildPath,n=e.project.config.dockerfileInfo.dockerfilePath;t||(e.project.config.dockerfileInfo.buildPath="/"),n||(e.project.config.dockerfileInfo.dockerfilePath="/Dockerfile"),e.config=e.project.config},f=function(t){e.project.projectImagesIns.toggleSpecifiedImage("compile",e.project.customConfig.compileImage),e.project.projectImagesIns.toggleSpecifiedImage("run",e.project.customConfig.runImage),r.imageService.getExclusiveImages(t).then(function(t){e.project.projectImagesIns.init(t.data.result),e.project.projectImagesIns.toggleSpecifiedImage("compile",e.project.customConfig.compileImage),e.project.projectImagesIns.toggleSpecifiedImage("run",e.project.customConfig.runImage)})};e.$on("memberPermisson",function(n,i){e.hasMemberPermisson=i,i||-1===v.indexOf("user")||(t.go("projectDetail.info"),e.tabActive[0].active=!0)});var p=function(){i.projectService.getData(e.projectId).then(function(t){c=i.getInstance("Project",t.data.result),e.project=angular.copy(c),d(),e.$emit("pageTitle",{title:e.config.name,descrition:"更新于"+l.getPageDate(e.config.lastModify),mod:"projectManage"})})["finally"](function(){e.isLoading=!1})};p();var g=function(e,t){var n="";e.interval=l.getPageInterval(e.createTime,e.finishTime),e.createTime=l.getPageDate(e.createTime),n="Success"===e.state||"Fail"===e.state?s.protocol()+"://"+t+"/api/ci/build/download/"+e.projectId+"/"+e.id:"Building"===e.state?"ws://"+t+"/api/ci/build/log/realtime?buildId="+e.id:"",e.logHref="/log/log.html?url="+encodeURIComponent(n)},m=function(){return i.projectService.getBuildList(e.projectId).then(function(t){var n,i,o,r,a=t.data.result||[],l=s.host(),c=0;if(s.port()&&(l+=":"+s.port()),e.buildList&&0!==e.buildList.length){for(i=0;i<a.length;i++){for(r=a[i],n=!1,g(r,l),o=c;o<e.buildList.length;o++)if(r.id===e.buildList[o].id){e.buildList[o].state=r.state,e.buildList[o].interval=r.interval,e.buildList[o].createTime=r.createTime,e.buildList[o].interval=r.interval,e.buildList[o].imageInfo.imageSize=r.imageInfo.imageSize,e.buildList[o].logHref=r.logHref,n=!0;break}n||(e.buildList.splice(c,0,r),c++)}a=null}else{for(i=0;i<a.length;i++)g(a[i],l);e.buildList=a}return!0},function(){return!0})},h=function(){e.isWaitingForModify=!0,e.project.modify().then(function(){o.openPrompt("修改成功！"),e.checkEdit(),p(),e.valid.needValid=!1},function(e){o.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaitingForModify=!1})};r.imageService.getBaseImages().then(function(t){e.imageList=t.data.result}),e.checkEdit=function(){e.edit=!e.edit,e.edit?(e.project.customConfig.customType&&f(e.project.customConfig.customType),d()):(e.project=angular.copy(c),d()),e.config=e.project.config},e.toggleProjectType=function(t){!e.config.userDefineDockerfile&&("allType"==t&&!e.project.isUseCustom||t===e.project.isUseCustom&&e.project.customConfig.customType)||(e.config.userDefineDockerfile=!1,!c.config.userDefineDockerfile&&("allType"==t&&!c.isUseCustom||c.isUseCustom&&t===c.customConfig.customType)?(e.project=angular.copy(c),d()):(e.project.resetConfig(),d()),"allType"==t?e.project.isUseCustom=!1:(e.project.isUseCustom=!0,e.project.customConfig.customType=t,f(t)))},e.toggleUseDockerfile=function(){e.config.userDefineDockerfile||(e.config.userDefineDockerfile=!0,c.config.userDefineDockerfile?e.project=angular.copy(c):e.project.resetConfig(),d())},e.getBuildList=function(){u&&a.cancel(u),e.buildList||m(),u=a(function(){m()["finally"](function(){"projectDetail.buildlog"==t.current.name&&e.getBuildList()})},4e3)},e.changeDockerfilePath=function(t){"/"==t?e.config.dockerfileInfo.dockerfilePath="/Dockerfile":e.config.dockerfileInfo.dockerfilePath=t+"/Dockerfile"},e.validCreatedFileStoragePath=function(){if(!e.project.isUseCustom)return void(e.valid.createdFileStoragePath=!0);for(var t=e.project.customConfig.createdFileStoragePath,n=0;n<t.length;n++)if(t[n].name)return void(e.valid.createdFileStoragePath=!0);e.valid.createdFileStoragePath=!1},e.startEdit=function(){e.edit=!e.edit},e.isNoSet=function(e){return e||(e="未设置"),e},e.submitModify=function(){h()},e.deleteProject=function(){e.project["delete"]().then(function(){t.go("projectManage")})},e.toggleStatus=function(t){t===e.statusKey?e.statusKey="":e.statusKey=t},e.toggleAutoBuild=function(t){t===e.autoBuildKey?e.autoBuildKey="":e.autoBuildKey=t},e.modifyCI=function(){e.isWaitingForModify=!0,h()},e.openBuild=function(){i.buildProject(e.config.id,!!e.config.codeInfo).then(function(){m()})},e.getDockerfile=function(){e.project.getDockerfile()},e.$on("$destroy",function(e){u&&a.cancel(u)});var v=t.$current.name;-1!==v.indexOf("config")?e.tabActive[1].active=!0:-1!==v.indexOf("autobuild")?e.tabActive[2].active=!0:-1!==v.indexOf("buildlog")?(e.tabActive[3].active=!0,e.getBuildList()):-1!==v.indexOf("user")?e.tabActive[4].active=!0:e.tabActive[0].active=!0}]),domeApp.controller("CreateDeployCtr1",["$scope","$state","$domeData","$domeDeploy","$domePublic",function(e,t,n,i,o){e.$emit("pageTitle",{title:"新建部署",descrition:"在这里您可以选择一个或多个项目镜像同时部署。",mod:"deployManage"}),n.getData("createDeployInfo1")?(e.deployEditIns=n.getData("createDeployInfo1"),e.deployEditIns.formartHealthChecker(),n.delData("createDeployInfo1")):e.deployEditIns=i.getInstance("Deploy"),e.editConfig=e.deployEditIns.config,e.currentContainerDraft={index:0},e.needValid={valid:!1},e.deleteImage=function(t){e.deployEditIns.deleteImage(t),e.currentContainerDraft.index>e.editConfig.containerDrafts.length-1&&(e.currentContainerDraft.index=0)},e.toNext=function(){0===e.editConfig.containerDrafts.length?o.openWarning("请至少选择一个镜像！"):(n.setData("createDeployInfo",e.deployEditIns),t.go("createDeploy/2"))}}]),domeApp.controller("CreateDeployCtr2",["$scope","$state","$domeData","$modal","$domeDeploy","$domeCluster","$domePublic","$domeUser",function(e,t,n,i,o,r,a,s){e.$emit("pageTitle",{title:"新建部署",descrition:"在这里您可以选择一个或多个项目镜像同时部署。",mod:"deployManage"});var l=n.getData("createDeployInfo");return l?(e.deployIns=l,n.delData("createDeployInfo"),e.config=e.deployIns.config,e.labelKey={key:""},e.loadingsIns=a.getLoadingInstance(),0===e.deployIns.clusterListIns.clusterList.length&&e.deployIns.initCluster(),e.toLastStep=function(){n.setData("createDeployInfo1",e.deployIns),t.go("createDeploy/1")},e.selectFocus=function(){e.validHost=!0},e.labelKeyDown=function(t,n,i){var o,r=e.deployIns.nodeListIns.labelsInfo,a=!1;13==t.keyCode&&i?angular.forEach(i,function(t,n){a||t.isSelected||(e.deployIns.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),a=!0}):n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(o=t)}),o&&e.deployIns.nodeListIns.toggleLabel(o,!1))},void(e.toCreate=function(){e.loadingsIns.startLoading("create"),e.deployIns.create().then(function(){a.openPrompt("创建成功！"),t.go("deployManage")},function(e){"namespace"==e.type?a.openWarning({title:"创建namespace失败！",msg:"Message:"+e.msg}):a.openWarning({title:"创建失败！",msg:"Message:"+e.msg})})["finally"](function(){e.loadingsIns.finishLoading("create")})})):void t.go("createDeploy/1")}]),domeApp.controller("CreateAppDeployCtr",["$scope","$domeAppStore","$domeCluster","$domeUser","$state","$stateParams","$domePublic",function(e,t,n,i,o,r,a){r.appName||o.go("appStore"),e.$emit("pageTitle",{title:r.appName,descrition:"",mod:"appStore"});var s=void 0,l=n.getInstance("NodeService");t.getStoreApps().then(function(n){var i=!1;if(n.data){for(var c=0;c<n.data.length;c++)if(n.data[c].appName===r.appName){i=!0,s=n.data[c];break}if(i){var u={logItemDrafts:[]},d=s.deploymentTemplate.logPathList;d||(d=[]);for(var f=0;f<d.length;f++)u.logItemDrafts.push({logPath:d[f],autoCollect:!1,autoDelete:!1});delete s.deploymentTemplate.logPathList,s.deploymentTemplate.logDraft=u,s.deploymentTemplate.networkMode="DEFAULT",e.appInfoIns=t.getInstance("AppInfo",s),e.config=e.appInfoIns.config,e.deployIns=e.appInfoIns.deployIns,e.deployConfig=e.deployIns.config,l.getData().then(function(t){e.deployIns.clusterListIns.init(t.data.result),e.deployIns.toggleCluster()})}else a.openWarning("无相关应用数据"),o.go("appStore")}else a.openWarning("请求失败！"),o.go("appStore")},function(){a.openWarning("请求失败！"),o.go("appStore")}),e.createDeploy=function(){e.isLoading=!0,e.deployIns.create().then(function(){a.openPrompt("创建成功！"),o.go("deployManage")},function(e){"namespace"==e.type?a.openWarning({title:"创建namespace失败！",msg:"Msg:"+e.msg}):a.openWarning({title:"创建失败！",msg:"Msg:"+e.msg})})["finally"](function(){e.isLoading=!1})}}]),domeApp.controller("MonitorCtr",["$scope","$domeCluster","$domeDeploy","$domeMonitor","$domePublic","$modal","$domeUser","$q","$sce",function(e,t,n,i,o,r,a,s,l){e.$emit("pageTitle",{title:"监控",descrition:"在这里您可以对主机、实例和容器进行多维度的实时监控。",mod:"monitor"}),e.loadingsIns=o.getLoadingInstance();var c=t.getInstance("NodeService");e.monitorType="主机",e.currentEnv={text:"生产",value:"PROD"},e.labelKey={key:""},e.keywords={node:"",instance:"",deployName:""},e.orderBy={node:"",pod:"",isReverse:!1},e.alarmPermission={},e.loadingsIns.startLoading("loadingCluster"),c.getData().then(function(n){e.clusterListIns=t.getInstance("ClusterList",n.data.result),e.clusterListIns.clusterList[0]&&e.toggleCluster(0)})["finally"](function(){e.loadingsIns.finishLoading("loadingCluster")}),a.getLoginUser().then(function(t){"admin"==t.username?e.alarmPermission={id:t.id,name:"admin"}:a.alarmGroupService.getData().then(function(n){var i=n.data.result;if(i&&0!==i.length)for(var o=0;o<i.length;o++)if(i[o].userId==t.id){e.alarmPermission={id:t.id,name:i[o].username,role:i[o].role};break}})});var u=function(){e.loadingsIns.startLoading("loadingNode"),c.getNodeList(e.clusterListIns.cluster.id).then(function(n){var o=n.data.result||[];if(e.nodeListIns=t.getInstance("NodeList",o),e.toggleEnv("生产"),0!==o.length){for(var r=[],a=[],s=0;s<o.length;s++)r[s]={node:o[s].name},a.push(o[s].name);i.getMonitorStatistical("node",e.clusterListIns.cluster.id,r,a).then(function(t){var n=e.nodeListIns.nodeList;for(s=0;s<n.length;s++)angular.extend(n[s],t[n[s].name])})}},function(){e.nodeListIns=t.getInstance("NodeList")})["finally"](function(){e.loadingsIns.finishLoading("loadingNode")})},d=function(){var t=e.deployListIns.deployInstanceListIns.instanceList;if(t&&0!==t.length){for(var n=[],o=[],r=0;r<t.length;r++){var a=[];if(t[r].containers)for(var s=0;s<t[r].containers.length;s++)a.push({hostname:t[r].hostName,containerId:t[r].containers[s].containerId});n.push({pod:{podName:t[r].instanceName,containers:a}}),o.push(t[r].instanceName)}i.getMonitorStatistical("pod",e.clusterListIns.cluster.id,n,o).then(function(e){for(r=0;r<t.length;r++)angular.extend(t[r],e[t[r].instanceName])})}};e.modifyTooltip=function(t,n){if(n){var i=[];switch(i.push('<div class="table-detail-wrap"><table class="table-detail">'),i.push("<thead><tr>"),t){case"diskUsed":i.push("<th>设备</th><th>磁盘占用率</th>");break;case"diskRead":i.push("<th>设备</th><th>磁盘读取(KB/s)</th>");break;case"diskWrite":i.push("<th>设备</th><th>磁盘写入(KB/s)</th>");break;case"netIn":i.push("<th>网卡</th><th>流入数据(KB/s)</th>");break;case"netOut":i.push("<th>网卡</th><th>流出数据(KB/s)</th>")}i.push("</tr></thead>"),i.push("<tbody>");for(var o=0;o<n.length;o++)i.push("<tr><td>"+n[o].item+"</td><td>"+n[o].value+"</td>");i.push("</tbody>"),i.push("</table></div>"),e.toolTipText=l.trustAsHtml(i.join(""))}},e.toggleEnv=function(t){var n="生产"===t?"PROD":"TEST";e.currentEnv={text:t,value:n},"主机"==e.monitorType?e.nodeListIns.toggleEnv(n):e.deployListIns.filterDeploy(e.clusterListIns.cluster.name,n)["finally"](function(){d()})},e.toggleCluster=function(t){e.clusterListIns.toggleCluster(t),"主机"==e.monitorType?u():"实例"==e.monitorType&&e.deployListIns.filterDeploy(e.clusterListIns.cluster.name,e.currentEnv.value)["finally"](function(){d()})},e.toggleDeploy=function(t,n,i){e.deployListIns.toggleDeploy(t,n,i)["finally"](function(){d()}),e.keywords.deployName=""},e.toggleMonitorType=function(t){function i(){e.clusterListIns.cluster.name&&e.deployListIns.filterDeploy(e.clusterListIns.cluster.name,e.currentEnv.value)["finally"](function(){d()})}t!==e.monitorType&&(e.monitorType=t,"主机"==t?u():e.deployListIns?i():(e.loadingsIns.startLoading("deploy"),n.deployService.getList().then(function(t){e.deployListIns=n.getInstance("DeployList",t.data.result),i()},function(e){o.openWarning({title:"请求失败",msg:e.data.resultMsg})})["finally"](function(){e.loadingsIns.finishLoading("deploy")})))},e.toggleOrderBy=function(t,n){e.orderBy[t]===n?e.orderBy.isReverse=!e.orderBy.isReverse:(e.orderBy[t]=n,e.orderBy.isReverse=!1)},e.showContainer=function(t){e.deployListIns.deployInstanceListIns.toggleContainerList(t);var n,o=[],a=[],s=t.hostName,l=e.deployListIns.deployInstanceListIns.containerList;for(n=0;n<l.length;n++)o.push({container:{hostname:s,containerId:l[n].containerId}}),a.push(l[n].containerId);i.getMonitorStatistical("container",e.clusterListIns.cluster.id,o,a).then(function(t){for(n=0;n<l.length;n++)angular.extend(l[n],t[l[n].containerId]);r.open({templateUrl:"containersModal.html",controller:"ContainersModalCtr",size:"lg",resolve:{monitorParams:function(){return{clusterId:e.clusterListIns.cluster.id,clusterName:e.clusterListIns.cluster.name,hostname:s}},instanceIns:function(){return e.deployListIns.deployInstanceListIns}}})})},e.toMonitorDetail=function(t,n){function r(e){for(var t=e.containers||[],n=[],i=0;i<t.length;i++)n.push({hostname:e.hostName,containerId:t[i].containerId});return n}var a,s,l={clusterId:e.clusterListIns.cluster.id,targetType:t,targetInfos:[]};if("node"==t)if(void 0!==n)l.targetInfos.push({node:n.name});else for(a=0;a<e.nodeListIns.nodeList.length;a++)e.nodeListIns.nodeList[a].isSelected&&l.targetInfos.push({node:e.nodeListIns.nodeList[a].name});else if("pod"==t)if(void 0!==n)l.targetInfos.push({pod:{podName:n.instanceName,containers:r(n)}});else for(s=e.deployListIns.deployInstanceListIns.instanceList,a=0;a<s.length;a++)s[a].isSelected&&l.targetInfos.push({pod:{podName:s[a].instanceName,containers:r(s[a])}});0===l.targetInfos.length?o.openWarning("请至少选择一项监控"):i.toMonitorPage(e.clusterListIns.cluster.id,e.clusterListIns.cluster.name,l)},e.labelKeyDown=function(t,n,i){var o,r=e.nodeListIns.labelsInfo,a=!1;13==t.keyCode&&i?angular.forEach(i,function(t,n){a||t.isSelected||(e.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),a=!0}):n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(o=t)}),o&&e.nodeListIns.toggleLabel(o,!1))}}]).controller("ContainersModalCtr",["$scope","instanceIns","monitorParams","$domeMonitor","$domePublic",function(e,t,n,i,o){t.checkAllContainer(!0),e.instanceIns=t;var r;for(e.orderBy={container:"",isReverse:!1},r=0;r<t.containerList.length;r++){var a=t.containerList[r].imageName,s=a.lastIndexOf(":");t.containerList[r].shortContainerId=t.containerList[r].containerId.substring(0,12),-1!==s&&(t.containerList[r].image=a.substring(0,s),t.containerList[r].imageTag=a.substring(s+1))}e.toggleOrderBy=function(t){e.orderBy.container===t?e.orderBy.isReverse=!e.orderBy.isReverse:(e.orderBy.container=t,e.orderBy.isReverse=!1)},e.toMonitorDetail=function(e){var r={clusterId:n.clusterId,targetType:"container",targetInfos:[]};if(e)r.targetInfos.push({container:{hostname:n.hostname,containerId:e.containerId}});else for(var a=0;a<t.containerList.length;a++)t.containerList[a].isSelected&&r.targetInfos.push({container:{hostname:n.hostname,containerId:t.containerList[a].containerId}});0===r.targetInfos.length?o.openWarning("请至少选择一项监控"):i.toMonitorPage(n.clusterId,n.clusterName,r)}}]),function(){function e(e,t,n){function i(){t.getLoginUser().then(function(i){"admin"==i.username?(o.permission.id=i.id,o.permission.role="ADMIN"):t.alarmGroupService.getData().then(function(t){var r=t.data.result;if(r&&0!==r.length){for(var a=0;a<r.length;a++)if(r[a].userId==i.id){o.permission.id=r[a].userId,o.permission.role=r[a].role;break}if(!o.permission.id)return void n.go("monitor");e.$broadcast("permission",o.permission)}})})}e.$emit("pageTitle",{title:"报警",descrition:"在这里您可以管理主机组和监控模板，并查看未恢复报警",mod:"monitor"});var o=this;o.tabName="templates",e.$on("tabName",function(e,t){o.tabName=t}),o.permission={id:null,username:null,role:null},i(),e.$on("memberPermisson",function(e,t){t||i()})}function t(e,t,n){e.$emit("tabName","templates");var i=t.getInstance("AlarmService"),o=this;o.keywords="",i.getData().then(function(e){for(var t=e.data.result||[],n=0;n<t.length;n++){var i=t[n];"host"==i.templateType?i.templateTypeName="主机":"deploy"==i.templateType&&(i.templateTypeName="容器")}o.templatesList=t},function(){n.openWarning("请求失败！")}),o.deleteTpl=function(e){n.openDelete().then(function(){i.deleteData(e).then(function(){for(var t=0;t<o.templatesList.length;t++)if(o.templatesList[t].id===e)return void o.templatesList.splice(t,1)},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})}}function n(e,t,n,i,o){e.$emit("tabName","currentAlarms");var r=this;r.keywords="",r.loading=!0,t.alarmEventService.getData().then(function(e){for(var n=e.data.result||[],i=t.keyMaps.metric,o=function(e,t){var n=i[e],o=n.text;return t&&("分区"==n.tagName&&0===t.indexOf("mount")?o+="  分区："+t.substring(6):"设备"==n.tagName&&0===t.indexOf("device")?o+="  设备："+t.substring(7):"网卡"==n.tagName&&0===t.indexOf("iface")&&(o+="  网卡："+t.substring(6))),{metricName:o,unit:n.unit}},a=function(e){return null!==e&&void 0!==e&&""!==e},s=0;s<n.length;s++){var l=n[s];"host"==l.templateType?(l.templateTypeName="主机",l.alarmObject=l.hostInfo.hostname):"deploy"==l.templateType&&(l.templateTypeName="部署",l.alarmObject=l.deploymentAlarmInfo.containerId.substring(0,12));var c=o(l.metric,l.tag);a(l.leftValue)&&a(l.operator)&&a(l.rightValue)&&(l.alarmNum=l.leftValue+l.operator+l.rightValue,""!==c.unit&&(l.alarmNum+="("+c.unit+")")),a(l.currentStep)&&a(l.maxStep)&&(l.alarmTimes=l.currentStep+"/"+l.maxStep),l.metricName=c.metricName}r.alarmsList=n},function(){n.openWarning("请求失败！")})["finally"](function(){r.loading=!1}),r.ignoreAlarm=function(e){n.openDelete().then(function(){t.alarmEventService.ignore(e+"").then(function(){for(var t=0;t<r.alarmsList.length;t++)if(r.alarmsList[t].id===e)return void r.alarmsList.splice(t,1)},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})},r.changePopover=function(t){var n,r,a=[];"host"==t.templateType&&t.hostInfo?(a.push("<div>集群: "+t.hostInfo.cluster+"</div>"),a.push("<div>ip: "+t.hostInfo.ip+"</div>")):"deploy"==t.templateType&&t.deploymentAlarmInfo&&(r=t.deploymentAlarmInfo,n="TEST"==r.hostEnv?"测试环境":"PROD"==r.hostEnv?"生产环境":"无",a.push("<div>集群: "+(r.clusterName||"无")+"</div>"),a.push("<div>主机ip: "+(r.instanceHostIp||"无")+"</div>"),a.push("<div>环境: "+n+"</div>"),a.push("<div>namespace: "+(r.namespace||"无")+"</div>"),a.push("<div>部署: "+r.deploymentName||"无</div>"),a.push("<div>实例: "+(r.instanceName||"无")+"</div>"),a.push("<div>启动时间: "+i.getPageDate(r.instanceCreateTime)+"</div>")),e.currentAlarmPopoverHtml=o.trustAsHtml(a.join(""))}}function i(e,t,n,i){function o(){r.getData().then(function(e){a.hostGroupList=e.data.result||[]},function(){n.openWarning("请求失败！")})}e.$emit("tabName","hostgroups");var r=t.getInstance("HostGroupService"),a=this;a.newHostGroup="",a.hostGroupPopover={ip:"",name:""},o(),a.deleteHostGroup=function(e){n.openDelete().then(function(){r.deleteData(e).then(function(){for(var t=0;t<a.hostGroupList.length;t++)if(a.hostGroupList[t].id===e)return void a.hostGroupList.splice(t,1)},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})},a.deleteNode=function(e,t){n.openDelete().then(function(){r.deleteHost(e.id,e.hostList[t].id).then(function(){e.hostList.splice(t,1)},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})},a.addHostGroup=function(){for(var e=0;e<a.hostGroupList.length;e++)if(a.hostGroupList[e].hostGroupName===a.newHostGroup)return void n.openWarning("主机组已存在！");r.setData({hostGroupName:a.newHostGroup}).then(function(e){e.data.result&&a.hostGroupList.unshift(e.data.result),a.newHostGroup=""},function(e){n.openWarning({title:"添加失败！",msg:"Message:"+e.data.resultMsg})})},a.rename=function(e){var t=i.open({templateUrl:"renameHostGroupModal.html",controller:"RenameHostGroupModalCtr as vmRename",size:"md",resolve:{hostGroupList:function(){return a.hostGroupList},hostGroup:function(){return e},renameFuc:function(){return r.updateData}}});t.result.then(function(e){"success"===e&&o()})}}function o(e,t){e.$emit("tabName","group"),e.resourceType="ALARM",e.$on("permission",function(e,n){"MASTER"!==n.role&&t.go("alarm.templates")})}function r(e,t,n,i,o){var r=this;r.hostGroupList=e,r.hostGroup=t,r.hostGroupName="",r.cancel=function(){o.dismiss()},r.submitName=function(){n({id:t.id,hostGroupName:r.hostGroupName}).then(function(){i.openPrompt("修改成功！"),o.close("success")},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})}}domeApp.controller("AlarmCtr",e).controller("TabAlarmTemplatesCtr",t).controller("TabAlarmCurrentAlarmsCtr",n).controller("TabHostGroupsCtr",i).controller("TabGroupCtr",o).controller("RenameHostGroupModalCtr",r),e.$inject=["$scope","$domeUser","$state"],t.$inject=["$scope","$domeAlarm","$domePublic"],n.$inject=["$scope","$domeAlarm","$domePublic","$util","$sce"],i.$inject=["$scope","$domeAlarm","$domePublic","$modal"],o.$inject=["$scope","$state"],r.$inject=["hostGroupList","hostGroup","renameFuc","$domePublic","$modalInstance"]}(),function(){function e(e,t,n,i,o){var r=this,a=+i.params.id,s=i.params.name,l=n.getInstance("HostGroupService"),c=t.getInstance("NodeService");if(!a||!s)return void i.go("alarm.hostgroups");e.$emit("pageTitle",{title:"添加主机—"+s,descrition:"在这里您可以将主机添加到主机组中。",mod:"monitor"});var u=[];r.cluster={},r.variable={nodeKey:"",selectedNodeKey:""},r.toggleCluster=function(e,t){r.cluster.id=e,r.cluster.name=t,c.getNodeList(e).then(function(e){r.nodeListIns.init(e.data.result,t)},function(){r.nodeListIns.init([],t)})},r.cancelModify=function(){r.nodeListIns.initSelectedList(u)},r.saveModify=function(){var e=[],t=!0,n=!1,s=void 0;try{for(var c,u=r.nodeListIns.selectedList[Symbol.iterator]();!(t=(c=u.next()).done);t=!0){var d=c.value;e.push({hostname:d.name,ip:d.ip,id:d.id,cluster:d.cluster})}}catch(f){n=!0,s=f}finally{try{!t&&u["return"]&&u["return"]()}finally{if(n)throw s}}l.addHost(a,e).then(function(){o.openPrompt("添加成功！"),i.go("alarm.hostgroups")},function(e){o.openWarning({title:"添加失败！",msg:"Message:"+e.data.resultMsg})})},c.getData().then(function(e){r.clusterList=e.data.result||[],r.nodeListIns=n.getInstance("NodeList"),r.clusterList[0]&&r.toggleCluster(r.clusterList[0].id,r.clusterList[0].name)})}domeApp.controller("AlarmAddHostsCtr",e),e.$inject=["$scope","$domeCluster","$domeAlarm","$state","$domePublic"]}(),domeApp.controller("AlarmTemplateDetailCtr",["$scope","$domeAlarm","$state","$domePublic","$domeUser",function(e,t,n,i,o){e.isEdit=!1,e.needValid={valid:!1};var r={},a=n.params.id;e.varibles={isLoading:!0},a||n.go("alarm.template");var s=t.getInstance("AlarmService");e.permission={};var l=function(){e.alarmTemplateIns.initHostGroupList(),e.alarmTemplateIns.initGroupList(),e.alarmTemplateIns.initDeployAndClusterList(),e.config=e.alarmTemplateIns.config,r=angular.copy(e.config)};s.getData(a).then(function(n){e.alarmTemplateIns=t.getInstance("AlarmTemplate",n.data.result),l(),e.$emit("pageTitle",{title:r.templateName,descrition:"",mod:"monitor"}),e.varibles.isLoading=!1},function(){i.openWarning("请求错误！"),e.varibles.isLoading=!1}),o.getLoginUser().then(function(t){"admin"==t.username?(e.permission.id=t.id,e.permission.role="ADMIN"):o.alarmGroupService.getData().then(function(i){var o=i.data.result;if(o&&0!==o.length){for(var r=0;r<o.length;r++)if(o[r].userId==t.id){e.permission.id=o[r].userId,e.permission.role=o[r].role;break}e.permission.id||n.go("monitor")}})}),e.saveModify=function(){e.varibles.isLoading=!0,e.alarmTemplateIns.modify().then(function(){i.openPrompt("修改成功"),s.getData(a).then(function(t){e.alarmTemplateIns.init(t.data.result),l(),e.$emit("pageTitle",{title:r.templateName})}),e.isEdit=!1},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.varibles.isLoading=!1})},e.toggleEdit=function(){e.isEdit=!e.isEdit,e.isEdit||(e.config=e.alarmTemplateIns.config=angular.copy(r))}}]),domeApp.controller("CreateAlarmTemplateCtr",["$scope","$domeAlarm","$domePublic","$state",function(e,t,n,i){e.$emit("pageTitle",{title:"新建模板",descrition:"在这里您可以新建报警模板。",mod:"monitor"}),e.keywords={hostgroup:""},e.needValid={valid:!1},e.isLoading=!1,e.alarmTemplateIns=t.getInstance("AlarmTemplate"),e.alarmTemplateIns.initHostGroupList(),e.alarmTemplateIns.initGroupList(),e.alarmTemplateIns.initDeployAndClusterList(),e.config=e.alarmTemplateIns.config,e.toCreate=function(){e.isLoading=!0,e.alarmTemplateIns.create().then(function(){n.openPrompt("新建成功"),i.go("alarm.templates")},function(e){n.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isLoading=!1})}}]),domeApp.controller("DeployDetailCtr",["$scope","$domeDeploy","$domeCluster","$domePublic","$state","$modal","$timeout","$util",function(e,t,n,i,o,r,a,s){function l(e){var t=[];if(!e||0===e.length)return[{version:"无状态",replicas:"0实例"}];for(var n=0;n<e.length;n++)t.push({version:"version"+e[n].version,replicas:e[n].replicas+"实例"});return t}function c(e){i.openWarning({title:"操作失败！",msg:e.data.resultMsg})}function u(){-1!==o.current.name.indexOf("deployDetail")&&t.deployService.getSingle(g).then(function(t){e.deployIns&&(e.deployIns.freshDeploy(t.data.result),e.deployEditIns.freshDeploy(t.data.result))})["finally"](function(){d&&a.cancel(d),d=a(u,4e3)})}e.$emit("pageTitle",{title:"部署",descrition:"",mod:"deployManage"}),o.params.id||o.go("deployManage"),e.valid={needValid:!1};var d,f,p,g=+o.params.id,m=[];e.resourceType="DEPLOY",e.resourceId=g,e.tabActive=[{active:!1},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1},{active:!1}],e.labelKey={key:""},e.$on("memberPermisson",function(t,n){e.hasMemberPermisson=n,n||-1===p.indexOf("user")||(o.go("deployDetail.detail"),e.tabActive[0].active=!0)});var h=e.loadingsIns=i.getLoadingInstance(),v=n.getInstance("ClusterService"),y=function(e){switch(e.date=s.getPageDate(e.startTime),e.primarySnapshot=l(e.primarySnapshot),e.targetSnapshot=l(e.targetSnapshot),e.currentSnapshot=l(e.currentSnapshot),e.operation){case"UPDATE":e.optTxt="升级";break;case"ROLLBACK":e.optTxt="回滚";break;case"SCALE_UP":e.optTxt="扩容";break;case"SCALE_DOWN":e.optTxt="缩容";break;case"CREATE":e.optTxt="创建";break;case"START":e.optTxt="启动";break;case"STOP":e.optTxt="停止";break;case"DELETE":e.optTxt="删除";break;case"ABORT_UPDATE":e.optTxt="中断升级";break;case"ABORT_ROLLBACK":e.optTxt="中断回滚";break;case"ABORT_SCALE_UP":e.optTxt="中断扩容";break;case"ABORT_SCALE_DOWN":e.optTxt="中断缩容";break;case"ABORT_START":e.optTxt="中断启动";break;case"KUBERNETES":e.optTxt="系统操作",e.eventStatus="KUBERNETES"}switch(e.eventStatus){case"START":e.statusTxt="开始";break;case"PROCESSING":e.statusTxt="处理中";break;case"SUCCESS":e.statusTxt="成功";break;case"FAILED":e.statusTxt="失败";break;case"ABORTED":e.statusTxt="已中断"}},I=function(){return t.deployService.getEvents(g).then(function(t){var n,i,o=t.data.result||[],r=0,a=!1;if(!e.eventList||0===e.eventList.length){for(n=0;n<o.length;n++)y(o[n]);return e.eventList=o,o=null,!0}for(n=0;n<o.length;n++){for(y(o[n]),a=!1,i=r;i<e.eventList.length;i++)if(e.eventList[i].eid===o[n].eid){e.eventList[i].eventStatus===o[n].eventStatus?e.eventList[i].date=s.getPageDate(e.eventList[i].startTime):$.extend(e.eventList[i],o[n]),
a=!0;break}a||(e.eventList.splice(r,0,o[n]),r++)}return o=null,!0},function(){return!0})};e.getEvents=function(){e.eventList||I(),f&&a.cancel(f),f=a(function(){I()["finally"](function(){"deployDetail.event"==o.$current.name&&e.getEvents()})},4e3)};var b=function(){t.deployService.getInstances(g).then(function(t){e.instanceList=t.data.result})};u();var L=function(){h.startLoading("fresh"),I(),b(),t.deployService.getSingle(g).then(function(n){var i=n.data.result;e.$emit("pageTitle",{title:i.deployName,descrition:i.serviceDnsName,mod:"deployManage"}),e.deployIns=t.getInstance("Deploy",angular.copy(n.data.result)),e.config=e.deployIns.config,e.deployIns.clusterListIns.init(angular.copy(m)),e.deployIns.toggleCluster(),e.deployEditIns=t.getInstance("Deploy",angular.copy(n.data.result)),e.editConfig=e.deployEditIns.config,e.deployEditIns.clusterListIns.init(angular.copy(m)),e.deployEditIns.toggleCluster(),e.showdeploy=angular.copy(i),"HOST"===e.showdeploy.networkMode?(e.showdeploy.serviceDnsName="Host网络下没有内网域名",0!==e.showdeploy.exposePortNum?e.showdeploy.visitSet="允许访问":e.showdeploy.visitSet="禁止访问"):e.showdeploy.loadBalanceDrafts&&0!==e.showdeploy.loadBalanceDrafts.length?e.showdeploy.visitSet="对外服务开启":e.showdeploy.innerServiceDrafts&&0!==e.showdeploy.innerServiceDrafts.length?e.showdeploy.visitSet="对内服务开启":(e.showdeploy.visitSet="禁止访问",e.showdeploy.serviceDnsName="未开启访问设置，不提供内网域名")},function(){i.openWarning("请求失败！"),o.go("deployManage")})["finally"](function(){h.finishLoading("fresh"),h.finishLoading("init")})};h.startLoading("init"),v.getData().then(function(e){m=e.data.result||[],L()}),e.labelKeyDown=function(t,n,i){var o,r=e.deployEditIns.nodeListIns.labelsInfo,a=!1;13==t.keyCode&&i?angular.forEach(i,function(t,n){a||t.isSelected||(e.deployEditIns.nodeListIns.toggleLabel(n,!0),e.labelKey.key=""),a=!0}):n||8!=t.keyCode||(angular.forEach(r,function(e,t){e.isSelected&&(o=t)}),o&&e.deployEditIns.nodeListIns.toggleLabel(o,!1))},e.toggleVersion=function(t){e.deployIns.toggleVersion(t)},e.recover=function(){e.isWaitingRecover=!0,e.deployIns.recoverVersion().then(function(){i.openPrompt("已提交，正在恢复。"),L()},function(e){"dismiss"!=e&&i.openWarning("恢复失败！")})["finally"](function(){e.isWaitingRecover=!1})},e.startVersion=function(){e.isWaitingStart=!0,e.deployIns.startVersion().then(function(){L()},function(e){"dismiss"!=e&&i.openWarning("启动失败！")})["finally"](function(){e.isWaitingStart=!1})},e.stopVersion=function(){e.isWaitingStop=!0,e.deployIns.stop().then(function(){i.openPrompt("已发送，正在停止！"),L()},function(){i.openWarning("停止失败！")})["finally"](function(){e.isWaitingStop=!1})},e.showLog=function(t,n){r.open({templateUrl:"index/tpl/modal/instanceLogModal/instanceLogModal.html",controller:"InstanceLogModalCtr",size:"md",resolve:{instanceInfo:function(){return{clusterId:e.deployIns.config.clusterId,namespace:e.deployIns.config.namespace,instanceName:t,containers:n}}}})},e.toUpdate=function(){0===e.editConfig.containerDrafts.length?i.openWarning("请至少选择一个镜像！"):(e.isWaitingUpdate=!0,e.valid.needValid=!1,e.deployEditIns.createVersion().then(function(t){e.deployIns.freshVersionList(),"update"==t&&L()})["finally"](function(){e.isWaitingUpdate=!1}))},e.scaleVersion=function(){e.isWaitingScale=!0,e.deployIns.scale().then(function(){L()})["finally"](function(){e.isWaitingScale=!1})},e.updateVersion=function(){e.isWaitingUpVersion=!0,e.deployIns.updateVersion().then(function(){L()},function(e){"dismiss"!=e&&i.openWarning("升级失败！")})["finally"](function(){e.isWaitingUpVersion=!1})},e.abortDeploy=function(t){e.isWaitingOperation=!0;var n="";switch(t){case"DEPLOYING":n="中断启动，部署会处于停止状态，是否继续？";break;case"UPDATING":n="中断升级，部署可能出现两个运行中的版本，是否继续？";break;case"BACKROLLING":n="中断回滚，部署可能出现两个运行中的版本，是否继续？";break;case"UPSCALING":n="中断扩容，部署实例数会处于中断时的个数，是否继续？";break;case"DOWNSCALING":n="中断缩容，部署实例数会处于中断时的个数，是否继续？"}i.openConfirm(n).then(function(){e.deployIns.abort().then(function(){L()},c)["finally"](function(){e.isWaitingOperation=!1})},function(){e.isWaitingOperation=!1})},e.deleteDeploy=function(){i.openDelete().then(function(){e.deployIns["delete"]().then(function(){i.openPrompt("删除成功！"),o.go("deployManage")},c)})},e.toConsole=function(t){r.open({templateUrl:"index/tpl/modal/selectContainerModal/selectContainerModal.html",controller:"SelectContainerModalCtr",size:"md",resolve:{info:function(){return{containerList:e.instanceList[t].containers,hostIp:e.instanceList[t].hostIp,resourceId:g,type:"DEPLOY"}}}})},p=o.$current.name,-1!==p.indexOf("update")?e.tabActive[1].active=!0:-1!==p.indexOf("event")?(e.tabActive[2].active=!0,e.getEvents()):-1!==p.indexOf("instance")?e.tabActive[3].active=!0:-1!==p.indexOf("network")?e.tabActive[4].active=!0:-1!==p.indexOf("user")?e.tabActive[5].active=!0:e.tabActive[0].active=!0,e.$on("$destroy",function(){d&&a.cancel(d),f&&a.cancel(f)})}]).controller("VersionListModalCtr",["$scope","$domeDeploy","deployInfo","$modalInstance",function(e,t,n,i){var o=n.deployId;e.stateful=n.stateful,e.versionData={replicas:n.defaultReplicas},t.deployService.getVersions(o).then(function(t){e.versionList=t.data.result||[],e.versionList[0]&&e.checkVersion(e.versionList[0].version)}),e.checkVersion=function(t){e.versionData.versionId=t},e.submit=function(){e.stateful&&delete e.versionData.replicas,i.close(e.versionData)}}]).controller("ScaleModalCtr",["$scope","oldReplicas","$modalInstance",function(e,t,n){e.oldReplicas=t,e.submitScale=function(){n.close(e.replicas)}}]),domeApp.controller("CreateGroupCtr",["$scope","$domeUser","$domePublic","$state",function(e,t,n,i){e.$emit("pageTitle",{title:"新建组",descrition:"在这里您可以新建一个组。",mod:"user"}),e.selectedUsers=[],e.userList=[],e.role="REPORTER",e.selectedUsersList=[],e.group={},e.userKey={key:""},e.isWaitingCreate=!1;var o=t.userService;o.getCurrentUser().then(function(t){var n=t.data.result;e.myself={userId:n.id,username:n.username,role:"MASTER"},o.getUserList().then(function(t){e.userList=t.data.result||[];for(var n=0;n<e.userList.length;n++)if(e.userList[n].id===e.myself.userId){e.userList.splice(n,1);break}})}),e.selectUser=function(t,n){var i=0;for(i=0;i<e.selectedUsers.length;i++)if(e.selectedUsers[i].userId===t)return;for(i=0;i<e.selectedUsersList.length;i++)if(e.selectedUsersList[i].userId===t)return;e.selectedUsers.push({userId:t,username:n}),e.userKey.key=""},e.cancelUser=function(t){e.selectedUsers.splice(t,1)},e.addUser=function(){for(var t=0;t<e.selectedUsers.length;t++)e.selectedUsersList.push({userId:e.selectedUsers[t].userId,username:e.selectedUsers[t].username,role:e.role});e.selectedUsers=[]},e.deleteUser=function(t){e.selectedUsersList.splice(t,1)},e.toggleRole=function(t){e.role=t},e.userKeyDown=function(t,n,i){13==t.keyCode&&i&&e.selectUser(i.id,i.username),n||8!=t.keyCode||e.selectedUsers.pop()},e.createGroup=function(){e.isWaitingCreate=!0;for(var t=[],r=0;r<e.selectedUsersList.length;r++)t.push({userId:e.selectedUsersList[r].userId,role:e.selectedUsersList[r].role});t.push({userId:e.myself.userId,role:e.myself.role}),o.createGroup(e.group).then(function(r){var a=r.data.result.id;o.modifyGroupUsers(a,{members:t}).then(function(){n.openPrompt("创建成功！"),i.go("groupManage")},function(){e.isWaitingCreate=!1,n.openWarning("创建成功，添加用户失败！"),i.go("groupManage")})},function(){e.isWaitingCreate=!1,n.openWarning("创建失败，请重试！")})}}]),domeApp.controller("GroupDetailCtr",["$scope","$stateParams","$state","$domeUser","$domePublic",function(e,t,n,i,o){t.id||n.go("groupManage");var r=t.id;e.resourceType="group",e.resourceId=r,i.userService.getGroupInfo(r).then(function(t){e.groupInfo=t.data.result,e.$emit("pageTitle",{title:e.groupInfo.name,descrition:"",mod:"user"}),e.groupInfo.description=e.groupInfo.description||"无描述信息"},function(){o.openWarning("请求失败！"),n.go("groupManage")}),e.deleteGroup=function(){o.openDelete().then(function(){i.userService.deleteGroup(r).then(function(){o.openPrompt("删除成功！"),n.go("groupManage")},function(e){o.openWarning({title:"删除失败！",msg:"Message:"+e.data.resultMsg})})})}}]),domeApp.controller("ClusterDetailCtr",["$scope","$domeCluster","$stateParams","$state","$domePublic","$domeModel","$modal",function(e,t,n,i,o,r,a){n.id||i.go("clusterManage");var s=e.clusterId=n.id,l=t.getInstance("NodeService"),c=void 0;e.nodeListIns=new r.SelectListModel("nodeList"),e.resourceType="CLUSTER",e.resourceId=s,e.isWaitingHost=!0,e.isWaitingNamespace=!0,e.isWaitingModify=!1,e.valid={needValid:!1},e.namespaceTxt={namespace:""},e.isEdit=!1,e.tabActive=[{active:!1},{active:!1},{active:!1},{active:!1}],l.getNodeList(s).then(function(t){var n=t.data.result||[],i=!0,o=!1,r=void 0;try{for(var a,s=n[Symbol.iterator]();!(i=(a=s.next()).done);i=!0){var l=a.value;l.capacity&&(l.capacity.memory=(l.capacity.memory/1024/1024).toFixed(2)),l.labels||(l.labels={}),l.isUsedByBuild=!!l.labels.BUILDENV}}catch(c){o=!0,r=c}finally{try{!i&&s["return"]&&s["return"]()}finally{if(o)throw r}}e.nodeListIns.init(n,!1)})["finally"](function(){e.isWaitingHost=!1});var u=function(){l.getData(s).then(function(n){e.clusterIns=t.getInstance("Cluster",n.data.result),c=angular.copy(e.clusterIns.config),e.config=e.clusterIns.config,1===c.buildConfig?e.$emit("pageTitle",{title:e.config.name,descrition:"该集群是构建集群，需要保证集群内主机可用于构建。",mod:"cluster"}):e.$emit("pageTitle",{title:e.config.name,descrition:"",mod:"cluster"}),l.getData().then(function(t){e.clusterList=t.data.result||[];for(var n=0;n<e.clusterList.length;n++)if(e.clusterList[n].name===c.name){e.clusterList.splice(n,1);break}})},function(){o.openWarning("请求失败！"),i.go("clusterManage")})};u(),e.getNamespace=function(){l.getNamespace(s).then(function(t){var n=t.data.result||[];e.namespaceList=[];for(var i=0;i<n.length;i++)e.namespaceList.push(n[i].name)},function(){e.namespaceList=[]})["finally"](function(){e.isWaitingNamespace=!1})},e.addNamespace=function(){e.isLoadingNamespace=!0;var t=e.namespaceTxt.namespace;if(t){for(var n=0;n<e.namespaceList.length;n++)if(e.namespaceList[n]===t)return o.openWarning("已存在！"),void(e.isLoadingNamespace=!1);l.setNamespace(s,[t]).then(function(){e.namespaceList.push(t),e.namespaceTxt.namespace=""},function(){o.openWarning("添加失败！")})["finally"](function(){e.isLoadingNamespace=!1})}},e.checkEdit=function(){e.isEdit=!e.isEdit,e.isEdit||(e.valid.needValid=!1,e.clusterIns.config=angular.copy(c),e.config=e.clusterIns.config)},e.deleteCluster=function(){l.deleteData(s).then(function(){i.go("clusterManage")})},e.modifyCluster=function(){var t=e.clusterIns.validItem("etcd"),n=e.clusterIns.validItem("kafka"),i=e.clusterIns.validItem("zookeeper");t&&n&&i&&(e.isWaitingModify=!0,e.valid.needValid=!1,e.clusterIns.modify().then(function(){o.openPrompt("修改成功！"),u(),e.checkEdit()},function(e){o.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaitingModify=!1}))},e.addLabels=function(){var t=[],n=!0,i=!1,r=void 0;try{for(var l,c=e.nodeListIns.nodeList[Symbol.iterator]();!(n=(l=c.next()).done);n=!0){var u=l.value;u.isSelected&&t.push({node:u.name})}}catch(d){i=!0,r=d}finally{try{!n&&c["return"]&&c["return"]()}finally{if(i)throw r}}return 0===t.length?void o.openWarning("请至少选择一台主机！"):void a.open({templateUrl:"addLabelModal.html",controller:"AddLabelModalCtr",size:"md",resolve:{clusterId:function(){return s},nodeList:function(){return t}}})},e.toggleNodeLabel=function(t){t.isUsedByBuild=!t.isUsedByBuild;var n=!1;if(!t.isUsedByBuild){n=!0;var i=!0,r=!1,a=void 0;try{for(var c,u=e.nodeListIns.nodeList[Symbol.iterator]();!(i=(c=u.next()).done);i=!0){var d=c.value;if(d.isUsedByBuild){n=!1;break}}}catch(f){r=!0,a=f}finally{try{!i&&u["return"]&&u["return"]()}finally{if(r)throw a}}}n&&(o.openWarning("请保证集群内至少有一台用于构建的主机！"),t.isUsedByBuild=!t.isUsedByBuild);var p=[{node:t.name,labels:{BUILDENV:"HOSTENVTYPE"}}];t.isUsedByBuild?l.addLabel(s,p)["catch"](function(e){t.isUsedByBuild=!t.isUsedByBuild,o.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})}):l.deleteLabel(s,p)["catch"](function(e){t.isUsedByBuild=!t.isUsedByBuild,o.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})};var d=i.$current.name;-1!==d.indexOf("info")?e.tabActive[1].active=!0:-1!==d.indexOf("namespace")?(e.tabActive[2].active=!0,e.getNamespace()):-1!==d.indexOf("users")?e.tabActive[3].active=!0:e.tabActive[0].active=!0,e.$on("memberPermisson",function(t,n){e.hasMemberPermisson=n,n||-1===d.indexOf("users")||(i.go("clusterDetail.hostlist"),e.tabActive[0].active=!0)})}]).controller("AddLabelModalCtr",["$scope","clusterId","nodeList","$modalInstance","$domePublic","$domeCluster",function(e,t,n,i,o,r){console.log(n),e.labelList=[],e.newLabel="";var a=r.getInstance("NodeService");e.addLabel=function(){var t=!0,n=!1,i=void 0;try{for(var o,r=e.labelList[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;if(a===e.newLabel)return void(e.newLabel="")}}catch(s){n=!0,i=s}finally{try{!t&&r["return"]&&r["return"]()}finally{if(n)throw i}}e.labelList.push(e.newLabel),e.newLabel=""},e.deleteLabel=function(t){e.labelList.splice(t,1)},e.submitLabels=function(){if(0===e.labelList.length)return void o.openWarning("您尚未添加标签！");var r={},s=!0,l=!1,c=void 0;try{for(var u,d=e.labelList[Symbol.iterator]();!(s=(u=d.next()).done);s=!0){var f=u.value;r[f]="USER_LABEL_VALUE"}}catch(p){l=!0,c=p}finally{try{!s&&d["return"]&&d["return"]()}finally{if(l)throw c}}var g=!0,m=!1,h=void 0;try{for(var v,y=n[Symbol.iterator]();!(g=(v=y.next()).done);g=!0){var I=v.value;I.labels=r}}catch(p){m=!0,h=p}finally{try{!g&&y["return"]&&y["return"]()}finally{if(m)throw h}}a.addLabel(t,n).then(function(){o.openPrompt("添加成功！"),i.close()},function(e){o.openWarning({title:"添加失败！",msg:"Message:"+e.data.resultMsg})})},e.cancel=function(){i.dismiss()}}]),domeApp.controller("CreateClusterCtr",["$scope","$domeCluster","$domePublic","$state",function(e,t,n,i){e.$emit("pageTitle",{title:"新建集群",descrition:"在这里您可以将一个部署好的Kubernetes集群添加到控制台进行管理。",mod:"cluster"}),e.clusterIns=t.getInstance("Cluster"),e.config=e.clusterIns.config,e.createCluster=!0,e.valid={needValid:!1};var o=t.getInstance("ClusterService");e.create=function(){var t=e.clusterIns.validItem("etcd"),o=e.clusterIns.validItem("kafka"),r=e.clusterIns.validItem("zookeeper");t&&o&&r&&(e.isWaingCreate=!0,e.clusterIns.create().then(function(){n.openPrompt("创建成功！"),i.go("clusterManage")},function(e){n.openWarning({title:"创建失败！",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isWaingCreate=!1}))},o.getData().then(function(t){e.clusterList=t.data.result||[]})}]),domeApp.controller("HostDetailCtr",["$scope","$stateParams","$domeCluster","$domePublic","$modal","$state","$q",function(e,t,n,i,o,r,a){e.loading=!0;var s={host:!0,instance:!0},l=n.getInstance("NodeService"),c=t.name,u=t.clusterId;if(!t.name||!t.clusterId)return void r.go("clusterDetail.hostlist",{id:u});var d={testEnv:!1,prodEnv:!1};e.hostSetting={labelTxt:"",diskTxt:"",isUsedToBuild:!1},e.$emit("pageTitle",{title:c,descrition:"",mod:"cluster"}),e.clusterConfig={},e.parentState='clusterDetail({id:"'+u+'"})',e.tabActive=[{active:!1},{active:!1}];var f=r.$current.name;-1!==f.indexOf("info")?e.tabActive[1].active=!0:e.tabActive[0].active=!0,l.getData(u).then(function(t){e.clusterConfig=t.data.result||{}}),l.getNodeInfo(u,c).then(function(t){var n=t.data.result;e.hostSetting.diskTxt=n.diskInfo,n.capacity.memory=(n.capacity.memory/1024/1024).toFixed(2),n.statusTxt="Ready"==n.status?"在线":"离线",n.labels&&(n.labels.TESTENV&&(d.testEnv=!0),n.labels.PRODENV&&(d.prodEnv=!0),e.envData=angular.copy(d),delete n.labels["kubernetes.io/hostname"],delete n.labels.TESTENV,delete n.labels.PRODENV,delete n.labels.hostEnv,n.labels.BUILDENV&&(e.hostSetting.isUsedToBuild=!0,delete n.labels.BUILDENV),e.labelsList=n.labels),e.node=n},function(){i.openWarning("请求失败！"),r.go("clusterDetail.hostlist",{id:u})})["finally"](function(){s.host=!1,!s.instance&&e.loading&&(e.loading=!1)}),l.getHostInstances(u,c).then(function(t){e.instanceList=t.data.result||[]})["finally"](function(){s.instance=!1,!s.host&&e.loading&&(e.loading=!1)}),e.showLog=function(e,t,n){o.open({templateUrl:"index/tpl/modal/instanceLogModal/instanceLogModal.html",controller:"InstanceLogModalCtr",size:"md",resolve:{instanceInfo:function(){return{clusterId:u,namespace:n,instanceName:e,containers:t}}}})},e.toggleBuildEnv=function(){var t=[{node:c,labels:{BUILDENV:"HOSTENVTYPE"}}];e.hostSetting.isUsedToBuild?l.getNodeList(u).then(function(e){for(var t=e.data.result||[],n=0;n<t.length;n++)if(t[n].name!==c&&t[n].labels&&t[n].labels.BUILDENV)return!0;return i.openWarning("构建集群至少需要一台用于构建的主机！"),a.reject()}).then(function(){l.deleteLabel(u,t).then(function(){e.hostSetting.isUsedToBuild=!1},function(){i.openWarning("修改失败！")})}):l.addLabel(u,t).then(function(){e.hostSetting.isUsedToBuild=!0},function(){i.openWarning("添加失败！")})},e.modifyEnv=function(){var t=[],n=[];return e.envData.testEnv||e.envData.prodEnv?(e.envData.testEnv?t.push({node:c,labels:{TESTENV:"HOSTENVTYPE"}}):n.push({node:c,labels:{TESTENV:"HOSTENVTYPE"}}),e.envData.prodEnv?t[0]?t[0].labels.PRODENV="HOSTENVTYPE":t.push({node:c,labels:{PRODENV:"HOSTENVTYPE"}}):n[0]?n[0].labels.PRODENV="HOSTENVTYPE":n.push({node:c,labels:{PRODENV:"HOSTENVTYPE"}}),void(0!==t.length&&0!==n.length?l.addLabel(u,t).then(function(){return!0},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})}).then(function(){l.deleteLabel(u,n).then(function(){i.openPrompt("修改成功！")},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})})}):0!==t.length?l.addLabel(u,t).then(function(){i.openPrompt("修改成功")},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})}):l.deleteLabel(u,n).then(function(){i.openPrompt("修改成功")},function(e){i.openWarning({title:"修改失败！",msg:"Message:"+e.data.resultMsg})}))):void i.openWarning("请至少选中一个工作场景！")},e.addLabel=function(){if(e.hostSetting.labelTxt&&""!==e.hostSetting.labelTxt){var t=[{node:c,labels:{}}];t[0].labels[e.hostSetting.labelTxt]="USER_LABEL_VALUE",l.addLabel(u,t).then(function(){e.labelsList[e.hostSetting.labelTxt]="USER_LABEL_VALUE",e.hostSetting.labelTxt=""},function(){i.openWarning("添加失败！")})}},e.deleteLable=function(t){var n=[{node:c,labels:{}}];n[0].labels[t]=null,i.openConfirm("删除主机标签可能会影响部署，是否继续？").then(function(){l.deleteLabel(u,n).then(function(){delete e.labelsList[t]},function(){i.openWarning("删除失败！")})})},e.toConsole=function(t){o.open({templateUrl:"index/tpl/modal/selectContainerModal/selectContainerModal.html",controller:"SelectContainerModalCtr",size:"md",resolve:{info:function(){return{containerList:e.instanceList[t].containers,hostIp:e.instanceList[t].hostIp,resourceId:u,type:"CLUSTER"}}}})}}]),domeApp.controller("AddHostCtr",["$scope","$state","$stateParams","$domeCluster","$domeMonitor","$domeGlobal","$domePublic",function(e,t,n,i,o,r,a){function s(){var t=["curl -o "];"centos"==e.selectedOS?t.push("start_node_centos.sh http://domeos-script.bjctc.scs.sohucs.com/start_node_centos.sh && sudo sh start_node_centos.sh"):t.push("start_node_ubuntu.sh http://domeos-script.bjctc.scs.sohucs.com/start_node_ubuntu.sh && sudo bash start_node_ubuntu.sh"),l.api_servers&&t.push(" --api-server "+l.api_servers),l.cluster_dns&&t.push(" --cluster-dns "+l.cluster_dns),l.cluster_domain&&t.push(" --cluster-domain "+l.cluster_domain),l.monitor_transfer&&t.push(" --monitor-transfer "+l.monitor_transfer),l.heartbeat_addr&&t.push(" --heartbeat-addr "+l.heartbeat_addr),l.registry_type&&t.push(" --registry-type "+l.registry_type),l.registry_arg&&t.push(" --registry-arg "+l.registry_arg),l.domeos_server&&t.push(" --domeos-server "+l.domeos_server),l.etcd_server&&t.push(" --etcd-server "+l.etcd_server),l.node_labels&&t.push(" --node-labels "+l.node_labels),l.hostname_override&&t.push(" --hostname-override "+l.hostname_override),e.hostCmd=t.join("")}e.$emit("pageTitle",{title:"添加主机",descrition:"请按照步骤操作，将您的主机添加到DomeOS上。",mod:"cluster"}),void 0!==n.id&&""!==n.id||t.go("clusterManage"),e.parentState='clusterDetail({"id":'+n.id+"})",e.isLoading=!0,e.hostInfo={labels:"",env:{test:!0,prod:!1}},e.selectedOS="centos",e.hostname="";var l={},c=r.getGloabalInstance("registry"),u=r.getGloabalInstance("server"),d=i.getInstance("ClusterService");e.getCmdLabels=function(){for(var t=e.hostInfo.labels.split(" "),n=[],i=0;i<t.length;i++)""!==t[i]&&n.push(t[i]+"=USER_LABEL_VALUE,");e.hostInfo.env.test&&n.push("TESTENV=HOSTENVTYPE"),e.hostInfo.env.prod&&n.push(",PRODENV=HOSTENVTYPE,"),l.node_labels=n.join(""),s()},e.toggleOS=function(t){e.selectedOS!==t&&(e.selectedOS=t,s())},e.changeEnv=function(t,n){n?e.getCmdLabels():"prod"==t&&!e.hostInfo.env.test||"test"==t&&!e.hostInfo.env.prod?("prod"==t?e.hostInfo.env.prod=!0:e.hostInfo.env.test=!0,a.openWarning("至少选择一种环境！")):e.getCmdLabels()},e.changeHostName=function(){l.hostname_override=e.hostname,s()},d.getData(n.id).then(function(t){var n=t.data.result;l.api_servers=n.api,l.cluster_dns=n.dns,l.cluster_domain=n.domain,l.etcd_server=n.etcd,l.etcd_server&&","==l.etcd_server.slice(-1)&&(l.etcd_server=l.etcd_server.slice(0,-1)),e.getCmdLabels(),o.getMonitorInfo().then(function(e){var t=e.data.result;t&&(l.monitor_transfer=t.transfer,l.heartbeat_addr=t.hbs),s()}),c.getData().then(function(e){1===e.status?l.registry_type="https":l.registry_type="http",e.url&&(e.url=e.url.replace("http://",""),e.url=e.url.replace("https://","")),l.registry_arg=e.url,s()}),u.getData().then(function(e){l.domeos_server=e.url,s()})},function(){a.openWarning("请求失败！"),t.go("clusterManage")})["finally"](function(){e.isLoading=!1})}]),function(e){function t(e,t,n,i){var o=this;o.projectInfo=e,o.loadingIns=n.getLoadingInstance(),o.buildWay="Branch",o.searchKey="",o.imageTag="",o.selectedBranch="",o.projectInfo.hasCodeInfo&&(o.loadingIns.startLoading("branch"),t.projectService.getBranches(o.projectInfo.projectId).then(function(e){o.branches=e.data.result||[]})["finally"](function(){o.loadingIns.finishLoading("branch")}),o.loadingIns.startLoading("tag"),t.projectService.getTags(o.projectInfo.projectId).then(function(e){o.tags=e.data.result||[]})["finally"](function(){o.loadingIns.finishLoading("tag")})),o.toggleBuildWay=function(e){o.buildWay=e,o.searchKey="",o.selectedBranch=""},o.toggleBranch=function(e){o.selectedBranch=e,o.searchKey=""},o.close=function(){i.dismiss("cancel")},o.toBuild=function(){var e={projectId:o.projectInfo.projectId,codeInfo:{},imageInfo:{}};o.projectInfo.hasCodeInfo&&("Branch"==o.buildWay?e.codeInfo.codeBranch=o.selectedBranch:e.codeInfo.codeTag=o.selectedBranch),o.imageTag&&(e.imageInfo.imageTag=o.imageTag),o.loadingIns.startLoading("submit"),t.projectService.build(e).then(function(e){200==e.data.resultCode?(i.close(),n.openPrompt("成功，正在构建！")):(i.close(),n.openWarning("构建失败！错误信息："+e.data.resultMsg))},function(){n.openWarning("构建失败，请重试！")})["finally"](function(){o.loadingIns.finishLoading("submit")})}}t.$inject=["projectInfo","$domeProject","$domePublic","$modalInstance"],e.controller("BuildModalCtr",t)}(window.domeApp||{}),domeApp.controller("HostListModalCtr",["$scope","hostList","$modalInstance","filterFilter",function(e,t,n,i){e.hostList=i(t,{labelFilter:!0})}]),domeApp.controller("OtherImageModalCtr",["$scope","$modalInstance",function(e,t){e.imageInfo={name:"",tag:"",registry:""},e.submitImage=function(){t.close(e.imageInfo)}}]),domeApp.controller("InstanceLogModalCtr",["$scope","instanceInfo","$location",function(e,t,n){var i="ws://"+n.host();n.port()&&(i+=":"+n.port()),t.containers||(t.containers=[]);for(var o=0;o<t.containers.length;o++){var r=encodeURIComponent(i+"/api/deploy/instance/log/realtime?clusterid="+t.clusterId+"&namespace="+t.namespace+"&instancename="+t.instanceName+"&containername="+t.containers[o].containerName);t.containers[o].pageTxt=t.containers[o].containerId.substring(0,12)+"("+t.containers[o].imageName+")",t.containers[o].href="/log/log.html?url="+r}e.instanceInfo=t}]),domeApp.controller("SelectContainerModalCtr",["$scope","info","$modalInstance",function(e,t,n){e.containerList=t.containerList||[],e.hostIp=t.hostIp,e.resourceId=t.resourceId,e.type=t.type;for(var i=0;i<e.containerList.length;i++)e.containerList[i].shortContainerId=e.containerList[i].containerId.substring(0,12),e.containerList[i].pageContainer=e.containerList[i].shortContainerId+" ("+e.containerList[i].imageName+")";e.toggleCurrentContainer=function(t){e.currentContainer=e.containerList[t]},e.containerList[0]&&e.toggleCurrentContainer(0),e.cancel=function(){n.dismiss("")}}]),function(){function e(e,t,n,i){var o=this;n.projectService.previewDockerfile(t._formartProject()).then(function(e){200==e.data.resultCode?o.dockerfileTxt=e.data.result?i.trustAsHtml(e.data.result.replace(/[\n\r]/g,"<br/>")):i.trustAsHtml("无数据！"):o.dockerfileTxt=i.trustAsHtml('<h4 class="txt-error">请求失败！</h4><p class="txt-error">错误信息：'+e.data.resultMsg+"</p>")},function(){o.dockerfileTxt=i.trustAsHtml('<p class="txt-error">请求失败！</p>')}),o.cancel=function(){e.dismiss("cancel")}}domeApp.controller("DockerfileModalCtr",e),e.$inject=["$modalInstance","project","$domeProject","$sce"]}(),function(){function e(e,t,n,i){var o=this;o.check="Branch",o.branchKey="",i?(t.projectService.getBranches(i).then(function(e){o.branches=e.data.result||[]}),t.projectService.getTags(i).then(function(e){o.tags=e.data.result||[]})):(t.projectService.getBranchesWithoutId(n.codeId,n.codeManagerUserId,n.codeManager).then(function(e){o.branches=e.data.result||[]}),t.projectService.getTagsWithoutId(n.codeId,n.codeManagerUserId,n.codeManager).then(function(e){o.tags=e.data.result||[]})),o.toggle=function(e){o.check=e,o.branchKey="",o.selectedBranch=""},o.cancel=function(){e.dismiss("cancel")},o.submitBranch=function(){e.close({type:o.check.toLowerCase(),value:o.selectedBranch})},o.toggleBranch=function(e){o.branchKey="",o.selectedBranch=e}}domeApp.controller("BranchCheckModalCtr",e),e.$inject=["$modalInstance","$domeProject","codeInfo","projectId"]}(),domeApp.controller("TplUserListCtr",["$scope","$domeUser","$domePublic","$state","$domeDeploy",function(e,t,n,i,o){function r(){for(var t=0,n=0;n<e.userInfos.length&&!("MASTER"==e.userInfos[n].role&&(t++,t>1));n++);return t}switch(e.resourceType){case"PROJECT":e.resourceName="项目";break;case"DEPLOY":e.resourceName="部署";break;case"group":e.resourceName="组";break;case"CLUSTER":e.resourceName="集群";break;case"ALARM":e.resourceName="报警组";break;default:e.resourceName=""}e.isEdit=!1,e.selectWay="member",e.selectedRole="REPORTER",e.userKey={key:""};var a,s=t.userService,l=function(){e.selectedGroup={},e.selectedUsers=[],e.selectResource={};var n;s.getUserList().then(function(t){e.userList=t.data.result||[]}),"group"!==e.resourceType?("ALARM"===e.resourceType?(a=t.alarmGroupService,a.getData().then(function(i){n={resourceType:"alarm",userInfos:i.data.result||[]},e.resourceInfo=t.getInstance("ResourceUser",n),e.userInfos=e.resourceInfo.resourceInfo.userInfos,e.groupInfo=e.resourceInfo.resourceInfo.groupInfo})):(s.getSigResourceUser(e.resourceType,e.resourceId).then(function(n){e.resourceInfo=t.getInstance("ResourceUser",n.data.result),e.userInfos=e.resourceInfo.resourceInfo.userInfos,e.groupInfo=e.resourceInfo.resourceInfo.groupInfo,e.$emit("memberPermisson",!0)},function(){e.$emit("memberPermisson",!1)}),s.getResourceUser(e.resourceType).then(function(t){e.selectResourceUser=t.data.result||[]})),s.getGroup().then(function(t){e.groupList=t.data.result||[]})):s.getGroupUser(e.resourceId).then(function(i){n={resourceId:e.resourceId,resourceType:"group",userInfos:i.data.result||[]},e.resourceInfo=t.getInstance("ResourceUser",n),e.userInfos=e.resourceInfo.resourceInfo.userInfos,e.groupInfo=e.resourceInfo.resourceInfo.groupInfo})};l(),e.checkUser=function(t){for(var n=!1,i=0;i<e.selectedUsers.length;i++)if(e.selectedUsers[i].username===t.username){n=!0;break}n||e.selectedUsers.push({username:t.username,ownerId:t.id,ownerType:"USER"}),e.userKey.key=""},e.cancelUser=function(t){e.selectedUsers.splice(t,1)},e.userKeyUp=function(t,n,i){13==t.keyCode&&i&&e.checkUser(i),n||8!=t.keyCode||e.selectedUsers.pop()},e.toggleRole=function(t){"oldRole"==t?"group"==e.selectWay?e.selectedRole="保留原有组权限":e.selectedRole="保留原有"+e.resourceName+"权限":e.selectedRole=t},e.toggleWay=function(t){t!==e.selectWay&&(e.selectResource={},e.selectWay=t,"member"==t?e.toggleRole("REPORTER"):e.toggleRole("oldRole"))},e.toggleResource=function(t){e.selectResource=e.selectResourceUser[t]},e.toggleGroup=function(t,n){e.selectedGroup.name=t,e.selectedGroup.id=n},e.saveRole=function(i){t.getLoginUser().then(function(t){"group"==e.resourceType&&t.username===i.username&&"MASTER"==i.role&&r()<=1?n.openWarning("您是最后一个master，不能降低权限！"):e.resourceInfo.saveRole(i).then(function(){"ALARM"==e.resourceType&&t.username===i.username&&"MASTER"!==i.newRole&&e.$emit("memberPermisson",!1)})})},e.addMember=function(){var t={resourceId:e.resourceInfo.resourceInfo.resourceId,resourceType:e.resourceInfo.resourceInfo.resourceType},i=[],o=0,r=function(e,t){var i=t?a.setData:s.modifyResourceUser;n.openConfirm("会覆盖已有成员的权限，是否继续？").then(function(){i(e).then(function(){n.openPrompt("添加成功！"),l()})})};if("group"==e.selectWay){if(!e.selectedGroup.id)return void n.openWarning("请选择组！");s.getGroupUser(e.selectedGroup.id).then(function(a){var s=a.data.result;if(!s||0===s)return void n.openWarning("该组没有成员！");if("ALARM"==e.resourceType){for(o=0;o<s.length;o++)i.push({userId:s[o].userId,role:"保留原有组权限"==e.selectedRole?s[o].role:e.selectedRole});r(i,!0)}else{for(o=0;o<s.length;o++)i.push({ownerId:s[o].userId,ownerType:"USER",role:"保留原有组权限"==e.selectedRole?s[o].role:e.selectedRole});t.ownerInfos=i,r(t)}})}else if("member"==e.selectWay){if(0===e.selectedUsers.length)return void n.openWarning("请选择成员！");if("group"==e.resourceType){var c=[];for(o=0;o<e.selectedUsers.length;o++)c.push({userId:e.selectedUsers[o].ownerId,role:e.selectedRole});s.modifyGroupUsers(e.resourceId,{members:c}).then(function(){n.openPrompt("添加成功！"),l()},function(e){n.openWarning({title:"添加失败！",msg:"Message:"+e.data.resultMsg})})}else if("ALARM"==e.resourceType){for(o=0;o<e.selectedUsers.length;o++)i.push({userId:e.selectedUsers[o].ownerId,role:e.selectedRole});r(i,!0)}else{for(o=0;o<e.selectedUsers.length;o++)i.push({ownerId:e.selectedUsers[o].ownerId,ownerType:"USER",role:e.selectedRole});t.ownerInfos=i,r(t)}}else{if(void 0===e.selectResource.userInfos)return void n.openWarning("请选择"+e.resourceName+"！");if(e.selectResource.userInfos=e.selectResource.userInfos||[],0===e.selectResource.userInfos.length)return void n.openWarning("当前"+e.resourceName+"无成员！");for(o=0;o<e.selectResource.userInfos.length;o++){var u=e.selectResource.userInfos[o];i.push({ownerId:u.userId,ownerType:"USER",role:e.selectedRole=="保留原有"+e.resourceName+"权限"?u.role:e.selectedRole})}t.ownerInfos=i,r(t)}},e.deleteUser=function(o){"group"==e.resourceType?t.getLoginUser().then(function(t){o.userId===t.id?r()>1?n.openDelete("确定要离开该组吗？").then(function(){e.resourceInfo.deleteUser(o)}):n.openWarning("您是组中唯一的master，不能离开该组！"):n.openDelete().then(function(){e.resourceInfo.deleteUser(o)})}):t.getLoginUser().then(function(t){var n;o.userId===t.id&&(n=!0),e.resourceInfo.deleteUser(o,n).then(function(){n&&"ALARM"==e.resourceType&&"admin"!==t.username&&i.go("monitor")})})}}]),domeApp.controller("MirrorCustomCtr",["$scope","$domeImage","$domePublic","$modal","$q","$location","$state","$util","$timeout",function(e,t,n,i,o,r,a,s,l){e.$emit("pageTitle",{title:"镜像定制",descrition:"在这里您可以定制满足个性化需求的镜像。",mod:"image"});var c;e.specificImg={language:"java",imgType:"compileimage",isSelected:!1},e.customtype="dockerfile",e.mirror=t.getMirrorInstance(),e.config=e.mirror.config,e.toggleCustomType=function(t){e.customtype=t,e.config.autoCustom="dockerfile"==t?0:1,e.config.envSettings=[{key:"",value:"",description:""}],e.config.publish=1,e.config.imageName="",e.config.imageTag="",e.config.description="",e.specificImg={language:"java",imgType:"compileimage",isSelected:!1},e.config.dockerfileContent="",e.config.files=[{fileName:"",filePath:"",content:""}]},e.tabActive=[{active:!1},{active:!1}];var u=t.imageService,d=function(t){u.buildCustomImage(t).then(function(e){n.openPrompt("成功，正在构建！")},function(e){n.openWarning({
title:"启动构建失败",msg:"Message:"+e.data.resultMsg}),u.deleteCustomImage(t)})["finally"](function(){e.isLoading=!1})},f=function(){u.createCustomImage(e.config).then(function(e){var t=e.data.result||{};d(t.id)},function(e){n.openWarning({title:"创建失败",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isLoading=!1})};e.nameTest=function(){e.isLoading=!0,u.validImageName(e.config.imageName,e.config.imageTag).then(function(e){var t=e.data.result;"PROJECT"==t?n.openWarning("存在与该镜像同名的项目！"):"BASEIMAGE"==t?n.openWarning("存在与该镜像同名的基础镜像！"):"NEITHER"==t?n.openPrompt("不存在同名镜像，可继续构建。"):"IMAGE_IN_REGISTRY"==t&&n.openWarning("镜像仓库中存在同名镜像，如继续会覆盖原镜像!")},function(e){n.openWarning({title:"检测失败",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isLoading=!1})},e.creatBuild=function(){e.isLoading=!0,u.validImageName(e.config.imageName,e.config.imageTag).then(function(e){"NEITHER"==e.data.result?f():n.openConfirm("该镜像名已存在，如继续构建会覆盖原镜像！").then(function(){f()})},function(e){n.openWarning({title:"重名检测失败",msg:"Message:"+e.data.resultMsg})})["finally"](function(){e.isLoading=!1})},e.assigImgName=function(t){t?e.config.imageName=e.specificImg.imgType+"-"+e.specificImg.language:e.config.imageName=""},e.selectMirror=function(t){e.img.mirrorNameList=[],e.img.type=t;var n,i,o,r=e.img[t],a=r.length;if("baseImages"==t||"projectImages"==t){for(e.img.mirror="baseImages"==t?"基础镜像":"项目镜像",n=0;a>n;n++)for(i=n+1;a>i;i++)r[n].imageName==r[i].imageName&&(r.splice(i,1),a--,i--);var s=r.length;for(o=0;s>o;o++)e.img.mirrorNameList.push({imageName:r[o].imageName,registry:r[o].registry});e.config.sourceImage.imageName=e.img.mirrorNameList[0].imageName,e.config.sourceImage.registryUrl=e.img.mirrorNameList[0].registry}else if("otherImages"==t){for(e.img.mirror="非项目镜像",n=0;a>n;n++)e.img.mirrorNameList.push({imageName:r[n],registry:""});e.config.sourceImage.imageName=e.img.mirrorNameList[0].imageName}},e.selectMirrorName=function(t,n){e.config.sourceImage.imageName=t,e.config.sourceImage.registryUrl=n,e.img.mirrorTagList=[];var i,o=e.img[e.img.type],r=o.length,a=0;if("baseImages"==e.img.type){for(i=0;r>i;i++)o[i].imageName==t&&(e.img.mirrorTagList[a++]=o[i].imageTag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||""}else"projectImages"==e.img.type?(e.isLoading=!0,u.getImageTags(t,n).then(function(t){for(var n=t.data.result||[],i=n.length,o=0;i>o;o++)e.img.mirrorTagList.push(n[o].tag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||""}),e.isLoading=!1):"otherImages"==e.img.type&&(e.isLoading=!0,u.getImageInfo(t).then(function(t){for(var n=t.data.result||[],i=n.length,o=0;i>o;o++)e.img.mirrorTagList.push(n[o].tag);e.config.sourceImage.imageTag=e.img.mirrorTagList[0]||"",e.config.sourceImage.registryUrl=n[0].registry}),e.isLoading=!1)};var p=function(){e.isLoading=!0,u.getAllImages().then(function(t){var n=t.data.result||{};e.img=n,e.img.baseImages=n.baseImages||[],e.img.projectImages=n.projectImages||[],e.img.otherImages=n.otherImages||[],0!==e.img.baseImages.length?(e.img.type="baseImages",e.img.mirror="基础镜像",e.selectMirror("baseImages"),e.selectMirrorName(e.img.baseImages[0].imageName,e.img.baseImages[0].registry)):0!==e.img.projectImages.length?(e.img.type="projectImages",e.img.mirror="项目镜像",e.selectMirror("projectImages"),e.selectMirrorName(e.img.projectImages[0].imageName,e.img.projectImages[0].registry)):0!==e.img.otherImages&&(e.img.type="otherImages",e.img.mirror="其他镜像",e.selectMirror("otherImages"),e.selectMirrorName(e.img.otherImages[0],""))})["finally"](function(){e.isLoading=!1})};p(),e.toggleMirrorHub=function(t){e.config.sourceImage.thirdParty=t,0===t?p():(e.config.sourceImage.registryUrl="",e.config.sourceImage.imageName="",e.config.sourceImage.imageTag="")},e.customImgList=[];var g=function(e,t){var n="";e.interval=s.getPageInterval(e.createTime,e.finishTime),e.createTime=s.getPageDate(e.createTime),0===e.autoCustom?e.type="Dockerfile":e.type="配置文件","Building"==e.state?n="ws://"+t+"/api/ci/build/log/realtime?buildId="+e.id+"&type=baseimage":"Success"!==e.state&&"Fail"!==e.state||(n=r.protocol()+"://"+t+"/api/image/custom/download/"+e.id),e.logHref="/log/log.html?url="+encodeURIComponent(n)};e.getImgList=function(){c&&l.cancel(c),u.getCustomImages().then(function(t){var n,i,o,s,u=t.data.result||[],d=r.host(),f=0;if(r.port()&&(d+=":"+r.port()),0===e.customImgList.length){for(n=0;n<u.length;n++)g(u[n],d);e.customImgList=u}else for(n=0;n<u.length;n++){for(o=!1,s=u[n],g(s,d),i=f;i<e.customImgList.length;i++)if(s.id===e.customImgList[i].id){e.customImgList[i].imageSize=s.imageSize,e.customImgList[i].type=s.type,e.customImgList[i].state!==s.state&&(e.customImgList[i].state=s.state,e.customImgList[i].logHref=s.logHref),e.customImgList[i].interval=s.interval,e.customImgList[i].createTime=s.createTime,o=!0;break}o||(e.customImgList.splice(f,0,s),f++)}"mirrorCustom.log"==a.$current.name&&(c=l(function(){e.getImgList()},4e3))})["finally"](function(){e.isLoading=!1})},e.selectOption={state:{All:!0,Preparing:!1,Building:!1,Success:!1,Fail:!1},builduser:{All:!0,own:!1},type:{All:!0,dockerfile:!1,configfile:!1}},e.toggleAll=function(t){angular.forEach(e.selectOption[t],function(n,i){e.selectOption[t][i]=!1}),e.selectOption[t].All=!0},e.toggleSelect=function(t,n){var i=!0;e.selectOption[t][n]=!e.selectOption[t][n],e.selectOption[t][n]?e.selectOption[t].All&&(e.selectOption[t].All=!1):(angular.forEach(e.selectOption[t],function(n,o){"All"!==o&&e.selectOption[t][o]&&i&&(i=!1)}),i&&e.toggleAll(t))},e.toggleShowDetail=function(){e.selectOption.isshowmore=!e.selectOption.isshowmore},e.$on("$destroy",function(e){c&&l.cancel(c)});var m=a.$current.name;-1!==m.indexOf("log")?(e.tabActive[1].active=!0,e.getImgList()):e.tabActive[0].active=!0}]);