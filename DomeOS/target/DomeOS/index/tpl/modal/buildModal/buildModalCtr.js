'use strict';

/*
 * @author ChandraLee
 */

(function (domeApp, undefined) {
	function BuildModalCtr(projectInfo, $domeProject, $domePublic, $modalInstance) {
		'use strict';

		var vm = this;
		vm.projectInfo = projectInfo;
		vm.loadingIns = $domePublic.getLoadingInstance();
		vm.buildWay = 'Branch';
		vm.searchKey = '';
		vm.imageTag = '';
		vm.selectedBranch = '';

		if (vm.projectInfo.hasCodeInfo) {
			vm.loadingIns.startLoading('branch');
			$domeProject.projectService.getBranches(vm.projectInfo.projectId).then(function (res) {
				vm.branches = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('branch');
			});
			vm.loadingIns.startLoading('tag');
			$domeProject.projectService.getTags(vm.projectInfo.projectId).then(function (res) {
				vm.tags = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('tag');
			});
		}

		vm.toggleBuildWay = function (type) {
			vm.buildWay = type;
			vm.searchKey = '';
			vm.selectedBranch = '';
		};
		vm.toggleBranch = function (branch) {
			vm.selectedBranch = branch;
			vm.searchKey = '';
		};
		vm.close = function () {
			$modalInstance.dismiss('cancel');
		};
		vm.toBuild = function () {
			var buildInfo = {
				projectId: vm.projectInfo.projectId,
				codeInfo: {}, //代码信息
				imageInfo: {} //镜像信息
			};
			if (vm.projectInfo.hasCodeInfo) {
				if (vm.buildWay == 'Branch') buildInfo.codeInfo.codeBranch = vm.selectedBranch;else buildInfo.codeInfo.codeTag = vm.selectedBranch;
			}

			if (vm.imageTag) {
				buildInfo.imageInfo.imageTag = vm.imageTag;
			}
			vm.loadingIns.startLoading('submit');
			$domeProject.projectService.build(buildInfo).then(function (res) {
				if (res.data.resultCode == 200) {
					$modalInstance.close();
					$domePublic.openPrompt('成功，正在构建！');
				} else {
					$modalInstance.close();
					$domePublic.openWarning('构建失败！错误信息：' + res.data.resultMsg);
				}
			}, function () {
				$domePublic.openWarning('构建失败，请重试！');
			}).finally(function () {
				vm.loadingIns.finishLoading('submit');
			});
		};
	}

	BuildModalCtr.$inject = ['projectInfo', '$domeProject', '$domePublic', '$modalInstance'];
	domeApp.controller('BuildModalCtr', BuildModalCtr);
})(window.domeApp);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4L3RwbC9tb2RhbC9idWlsZE1vZGFsL2J1aWxkTW9kYWxDdHIuZXMiXSwibmFtZXMiOlsiZG9tZUFwcCIsInVuZGVmaW5lZCIsIkJ1aWxkTW9kYWxDdHIiLCJwcm9qZWN0SW5mbyIsIiRkb21lUHJvamVjdCIsIiRkb21lUHVibGljIiwiJG1vZGFsSW5zdGFuY2UiLCJ2bSIsImxvYWRpbmdJbnMiLCJnZXRMb2FkaW5nSW5zdGFuY2UiLCJidWlsZFdheSIsInNlYXJjaEtleSIsImltYWdlVGFnIiwic2VsZWN0ZWRCcmFuY2giLCJoYXNDb2RlSW5mbyIsInN0YXJ0TG9hZGluZyIsInByb2plY3RTZXJ2aWNlIiwiZ2V0QnJhbmNoZXMiLCJwcm9qZWN0SWQiLCJ0aGVuIiwicmVzIiwiYnJhbmNoZXMiLCJkYXRhIiwicmVzdWx0IiwiZmluYWxseSIsImZpbmlzaExvYWRpbmciLCJnZXRUYWdzIiwidGFncyIsInRvZ2dsZUJ1aWxkV2F5IiwidHlwZSIsInRvZ2dsZUJyYW5jaCIsImJyYW5jaCIsImNsb3NlIiwiZGlzbWlzcyIsInRvQnVpbGQiLCJidWlsZEluZm8iLCJjb2RlSW5mbyIsImltYWdlSW5mbyIsImNvZGVCcmFuY2giLCJjb2RlVGFnIiwiYnVpbGQiLCJyZXN1bHRDb2RlIiwib3BlblByb21wdCIsIm9wZW5XYXJuaW5nIiwicmVzdWx0TXNnIiwiJGluamVjdCIsImNvbnRyb2xsZXIiLCJ3aW5kb3ciXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7QUFJQSxDQUFDLFVBQUNBLE9BQUQsRUFBVUMsU0FBVixFQUF3QjtBQUN4QixVQUFTQyxhQUFULENBQXVCQyxXQUF2QixFQUFvQ0MsWUFBcEMsRUFBa0RDLFdBQWxELEVBQStEQyxjQUEvRCxFQUErRTtBQUM5RTs7QUFDQSxNQUFJQyxLQUFLLElBQVQ7QUFDQUEsS0FBR0osV0FBSCxHQUFpQkEsV0FBakI7QUFDQUksS0FBR0MsVUFBSCxHQUFnQkgsWUFBWUksa0JBQVosRUFBaEI7QUFDQUYsS0FBR0csUUFB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d0IsV0FBeEI7QUFDQSxJQVZELEVBVUduQixPQVZILENBVVcsWUFBTTtBQUNoQmpCLE9BQUdDLFVBQUgsQ0FBY2lCLGFBQWQsQ0FBNEIsUUFBNUI7QUFDQSxJQVpEO0FBYUEsR0E1QkQ7QUE2QkE7O0FBRUR2QixlQUFjMkMsT0FBZCxHQUF3QixDQUFDLGFBQUQsRUFBZ0IsY0FBaEIsRUFBZ0MsYUFBaEMsRUFBK0MsZ0JBQS9DLENBQXhCO0FBQ0E3QyxTQUFROEMsVUFBUixDQUFtQixlQUFuQixFQUFvQzVDLGFBQXBDO0FBRUEsQ0F4RUQsRUF3RUc2QyxPQUFPL0MsT0F4RVYiLCJmaWxlIjoiaW5kZXgvdHBsL21vZGFsL2J1aWxkTW9kYWwvYnVpbGRNb2RhbEN0ci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBhdXRob3IgQ2hhbmRyYUxlZVxyXG4gKi9cclxuXHJcbigoZG9tZUFwcCwgdW5kZWZpbmVkKSA9PiB7XHJcblx0ZnVuY3Rpb24gQnVpbGRNb2RhbEN0cihwcm9qZWN0SW5mbywgJGRvbWVQcm9qZWN0LCAkZG9tZVB1YmxpYywgJG1vZGFsSW5zdGFuY2UpIHtcclxuXHRcdCd1c2Ugc3RyaWN0JztcclxuXHRcdGxldCB2bSA9IHRoaXM7XHJcblx0XHR2bS5wcm9qZWN0SW5mbyA9IHByb2plY3RJbmZvO1xyXG5cdFx0dm0ubG9hZGluZ0lucyA9ICRkb21lUHVibGljLmdldExvYWRpbmdJbnN0YW5jZSgpO1xyXG5cdFx0dm0uYnVpbGRXYXkgPSAnQnJhbmNoJztcclxuXHRcdHZtLnNlYXJjaEtleSA9ICcnO1xyXG5cdFx0dm0uaW1hZ2VUYWcgPSAnJztcclxuXHRcdHZtLnNlbGVjdGVkQnJhbmNoID0gJyc7XHJcblxyXG5cdFx0aWYgKHZtLnByb2plY3RJbmZvLmhhc0NvZGVJbmZvKSB7XHJcblx0XHRcdHZtLmxvYWRpbmdJbnMuc3RhcnRMb2FkaW5nKCdicmFuY2gnKTtcclxuXHRcdFx0JGRvbWVQcm9qZWN0LnByb2plY3RTZXJ2aWNlLmdldEJyYW5jaGVzKHZtLnByb2plY3RJbmZvLnByb2plY3RJZCkudGhlbigocmVzKSA9PiB7XHJcblx0XHRcdFx0dm0uYnJhbmNoZXMgPSByZXMuZGF0YS5yZXN1bHQgfHwgW107XHJcblx0XHRcdH0pLmZpbmFsbHkoKCkgPT4ge1xyXG5cdFx0XHRcdHZtLmxvYWRpbmdJbnMuZmluaXNoTG9hZGluZygnYnJhbmNoJyk7XHJcblx0XHRcdH0pO1xyXG5cdFx0XHR2bS5sb2FkaW5nSW5zLnN0YXJ0TG9hZGluZygndGFnJyk7XHJcblx0XHRcdCRkb21lUHJvamVjdC5wcm9qZWN0U2VydmljZS5nZXRUYWdzKHZtLnByb2plY3RJbmZvLnByb2plY3RJZCkudGhlbigocmVzKSA9PiB7XHJcblx0XHRcdFx0dm0udGFncyA9IHJlcy5kYXRhLnJlc3VsdCB8fCBbXTtcclxuXHRcdFx0fSkuZmluYWxseSgoKSA9PiB7XHJcblx0XHRcdFx0dm0ubG9hZGluZ0lucy5maW5pc2hMb2FkaW5nKCd0YWcnKTtcclxuXHRcdFx0fSk7XHJcblx0XHR9XHJcblxyXG5cdFx0dm0udG9nZ2xlQnVpbGRXYXkgPSAodHlwZSkgPT4ge1xyXG5cdFx0XHR2bS5idWlsZFdheSA9IHR5cGU7XHJcblx0XHRcdHZtLnNlYXJjaEtleSA9ICcnO1xyXG5cdFx0XHR2bS5zZWxlY3RlZEJyYW5jaCA9ICcnO1xyXG5cdFx0fTtcclxuXHRcdHZtLnRvZ2dsZUJyYW5jaCA9IChicmFuY2gpID0+IHtcclxuXHRcdFx0dm0uc2VsZWN0ZWRCcmFuY2ggPSBicmFuY2g7XHJcblx0XHRcdHZtLnNlYXJjaEtleSA9ICcnO1xyXG5cdFx0fTtcclxuXHRcdHZtLmNsb3NlID0gKCkgPT4ge1xyXG5cdFx0XHQkbW9kYWxJbnN0YW5jZS5kaXNtaXNzKCdjYW5jZWwnKTtcclxuXHRcdH07XHJcblx0XHR2bS50b0J1aWxkID0gKCkgPT4ge1xyXG5cdFx0XHRsZXQgYnVpbGRJbmZvID0ge1xyXG5cdFx0XHRcdHByb2plY3RJZDogdm0ucHJvamVjdEluZm8ucHJvamVjdElkLFxyXG5cdFx0XHRcdGNvZGVJbmZvOiB7fSwgLy/ku6PnoIHkv6Hmga9cclxuXHRcdFx0XHRpbWFnZUluZm86IHt9IC8v6ZWc5YOP5L+h5oGvXHJcblx0XHRcdH07XHJcblx0XHRcdGlmICh2bS5wcm9qZWN0SW5mby5oYXNDb2RlSW5mbykge1xyXG5cdFx0XHRcdGlmICh2bS5idWlsZFdheSA9PSAnQnJhbmNoJykgYnVpbGRJbmZvLmNvZGVJbmZvLmNvZGVCcmFuY2ggPSB2bS5zZWxlY3RlZEJyYW5jaDtcclxuXHRcdFx0XHRlbHNlIGJ1aWxkSW5mby5jb2RlSW5mby5jb2RlVGFnID0gdm0uc2VsZWN0ZWRCcmFuY2g7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGlmICh2bS5pbWFnZVRhZykge1xyXG5cdFx0XHRcdGJ1aWxkSW5mby5pbWFnZUluZm8uaW1hZ2VUYWcgPSB2bS5pbWFnZVRhZztcclxuXHRcdFx0fVxyXG5cdFx0XHR2bS5sb2FkaW5nSW5zLnN0YXJ0TG9hZGluZygnc3VibWl0Jyk7XHJcblx0XHRcdCRkb21lUHJvamVjdC5wcm9qZWN0U2VydmljZS5idWlsZChidWlsZEluZm8pLnRoZW4oKHJlcykgPT4ge1xyXG5cdFx0XHRcdGlmIChyZXMuZGF0YS5yZXN1bHRDb2RlID09IDIwMCkge1xyXG5cdFx0XHRcdFx0JG1vZGFsSW5zdGFuY2UuY2xvc2UoKTtcclxuXHRcdFx0XHRcdCRkb21lUHVibGljLm9wZW5Qcm9tcHQoJ+aIkOWKn++8jOato+WcqOaehOW7uu+8gScpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHQkbW9kYWxJbnN0YW5jZS5jbG9zZSgpO1xyXG5cdFx0XHRcdFx0JGRvbWVQdWJsaWMub3Blbldhcm5pbmcoJ+aehOW7uuWksei0pe+8gemUmeivr+S/oeaBr++8micgKyByZXMuZGF0YS5yZXN1bHRNc2cpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSwgKCkgPT4ge1xyXG5cdFx0XHRcdCRkb21lUHVibGljLm9wZW5XYXJuaW5nKCfmnoTlu7rlpLHotKXvvIzor7fph43or5XvvIEnKTtcclxuXHRcdFx0fSkuZmluYWxseSgoKSA9PiB7XHJcblx0XHRcdFx0dm0ubG9hZGluZ0lucy5maW5pc2hMb2FkaW5nKCdzdWJtaXQnKTtcclxuXHRcdFx0fSk7XHJcblx0XHR9O1xyXG5cdH1cclxuXHJcblx0QnVpbGRNb2RhbEN0ci4kaW5qZWN0ID0gWydwcm9qZWN0SW5mbycsICckZG9tZVByb2plY3QnLCAnJGRvbWVQdWJsaWMnLCAnJG1vZGFsSW5zdGFuY2UnXTtcclxuXHRkb21lQXBwLmNvbnRyb2xsZXIoJ0J1aWxkTW9kYWxDdHInLCBCdWlsZE1vZGFsQ3RyKTtcclxuXHJcbn0pKHdpbmRvdy5kb21lQXBwKTsiXX0=
