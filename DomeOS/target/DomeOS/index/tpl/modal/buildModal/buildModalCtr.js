'use strict';

/*
 * @author ChandraLee
 */

(function (domeApp, undefined) {
	function BuildModalCtr(projectInfo, $domeProject, $domePublic, $modalInstance) {
		'use strict';

		var vm = this;
		vm.projectInfo = projectInfo;
		vm.loadingIns = $domePublic.getLoadingInstance();
		vm.buildWay = 'Branch';
		vm.searchKey = '';
		vm.imageTag = '';
		vm.selectedBranch = '';

		if (vm.projectInfo.hasCodeInfo) {
			vm.loadingIns.startLoading('branch');
			$domeProject.projectService.getBranches(vm.projectInfo.projectId).then(function (res) {
				vm.branches = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('branch');
			});
			vm.loadingIns.startLoading('tag');
			$domeProject.projectService.getTags(vm.projectInfo.projectId).then(function (res) {
				vm.tags = res.data.result || [];
			}).finally(function () {
				vm.loadingIns.finishLoading('tag');
			});
		}

		vm.toggleBuildWay = function (type) {
			vm.buildWay = type;
			vm.searchKey = '';
			vm.selectedBranch = '';
		};
		vm.toggleBranch = function (branch) {
			vm.selectedBranch = branch;
			vm.searchKey = '';
		};
		vm.close = function () {
			$modalInstance.dismiss('cancel');
		};
		vm.toBuild = function () {
			var buildInfo = {
				projectId: vm.projectInfo.projectId,
				codeInfo: {}, //代码信息
				imageInfo: {} //镜像信息
			};
			if (vm.projectInfo.hasCodeInfo) {
				if (vm.buildWay == 'Branch') buildInfo.codeInfo.codeBranch = vm.selectedBranch;else buildInfo.codeInfo.codeTag = vm.selectedBranch;
			}

			if (vm.imageTag) {
				buildInfo.imageInfo.imageTag = vm.imageTag;
			}
			vm.loadingIns.startLoading('submit');
			$domeProject.projectService.build(buildInfo).then(function (res) {
				if (res.data.resultCode == 200) {
					$modalInstance.close();
					$domePublic.openPrompt('成功，正在构建！');
				} else {
					$modalInstance.close();
					$domePublic.openWarning('构建失败！错误信息：' + res.data.resultMsg);
				}
			}, function () {
				$domePublic.openWarning('构建失败，请重试！');
			}).finally(function () {
				vm.loadingIns.finishLoading('submit');
			});
		};
	}

	BuildModalCtr.$inject = ['projectInfo', '$domeProject', '$domePublic', '$modalInstance'];
	domeApp.controller('BuildModalCtr', BuildModalCtr);
})(window.domeApp);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4L3RwbC9tb2RhbC9idWlsZE1vZGFsL2J1aWxkTW9kYWxDdHIuZXMiXSwibmFtZXMiOlsiZG9tZUFwcCIsInVuZGVmaW5lZCIsIkJ1aWxkTW9kYWxDdHIiLCJwcm9qZWN0SW5mbyIsIiRkb21lUHJvamVjdCIsIiRkb21lUHVibGljIiwiJG1vZGFsSW5zdGFuY2UiLCJ2bSIsImxvYWRpbmdJbnMiLCJnZXRMb2FkaW5nSW5zdGFuY2UiLCJidWlsZFdheSIsInNlYXJjaEtleSIsImltYWdlVGFnIiwic2VsZWN0ZWRCcmFuY2giLCJoYXNDb2RlSW5mbyIsInN0YXJ0TG9hZGluZyIsInByb2plY3RTZXJ2aWNlIiwiZ2V0QnJhbmNoZXMiLCJwcm9qZWN0SWQiLCJ0aGVuIiwicmVzIiwiYnJhbmNoZXMiLCJkYXRhIiwicmVzdWx0IiwiZmluYWxseSIsImZpbmlzaExvYWRpbmciLCJnZXRUYWdzIiwidGFncyIsInRvZ2dsZUJ1aWxkV2F5IiwidHlwZSIsInRvZ2dsZUJyYW5jaCIsImJyYW5jaCIsImNsb3NlIiwiZGlzbWlzcyIsInRvQnVpbGQiLCJidWlsZEluZm8iLCJjb2RlSW5mbyIsImltYWdlSW5mbyIsImNvZGVCcmFuY2giLCJjb2RlVGFnIiwiYnVpbGQiLCJyZXN1bHRDb2RlIiwib3BlblByb21wdCIsIm9wZW5XYXJuaW5nIiwicmVzdWx0TXNnIiwiJGluamVjdCIsImNvbnRyb2xsZXIiLCJ3aW5kb3ciXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7QUFJQSxDQUFDLFVBQUNBLE9BQUQsRUFBVUMsU0FBVixFQUF3QjtBQUN4QixVQUFTQyxhQUFULENBQXVCQyxXQUF2QixFQUFvQ0MsWUFBcEMsRUFBa0RDLFdBQWxELEVBQStEQyxjQUEvRCxFQUErRTtBQUM5RTs7QUFDQSxNQUFJQyxLQUFLLElBQVQ7QUFDQUEsS0FBR0osV0FBSCxHQUFpQkEsV0FBakI7QUFDQUksS0FBR0MsVUFBSCxHQUFnQkgsWUFBWUksa0JBQVosRUFBaEI7QUFDQUYsS0FBR0csUUFB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d0IsV0FBeEI7QUFDQSxJQVZELEVBVUduQixPQVZILENBVVcsWUFBTTtBQUNoQmpCLE9BQUdDLFVBQUgsQ0FBY2lCLGFBQWQsQ0FBNEIsUUFBNUI7QUFDQSxJQVpEO0FBYUEsR0E1QkQ7QUE2QkE7O0FBRUR2QixlQUFjMkMsT0FBZCxHQUF3QixDQUFDLGFBQUQsRUFBZ0IsY0FBaEIsRUFBZ0MsYUFBaEMsRUFBK0MsZ0JBQS9DLENBQXhCO0FBQ0E3QyxTQUFROEMsVUFBUixDQUFtQixlQUFuQixFQUFvQzVDLGFBQXBDO0FBRUEsQ0F4RUQsRUF3RUc2QyxPQUFPL0MsT0F4RVYiLCJmaWxlIjoiaW5kZXgvdHBsL21vZGFsL2J1aWxkTW9kYWwvYnVpbGRNb2RhbEN0ci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAYXV0aG9yIENoYW5kcmFMZWVcbiAqL1xuXG4oKGRvbWVBcHAsIHVuZGVmaW5lZCkgPT4ge1xuXHRmdW5jdGlvbiBCdWlsZE1vZGFsQ3RyKHByb2plY3RJbmZvLCAkZG9tZVByb2plY3QsICRkb21lUHVibGljLCAkbW9kYWxJbnN0YW5jZSkge1xuXHRcdCd1c2Ugc3RyaWN0Jztcblx0XHRsZXQgdm0gPSB0aGlzO1xuXHRcdHZtLnByb2plY3RJbmZvID0gcHJvamVjdEluZm87XG5cdFx0dm0ubG9hZGluZ0lucyA9ICRkb21lUHVibGljLmdldExvYWRpbmdJbnN0YW5jZSgpO1xuXHRcdHZtLmJ1aWxkV2F5ID0gJ0JyYW5jaCc7XG5cdFx0dm0uc2VhcmNoS2V5ID0gJyc7XG5cdFx0dm0uaW1hZ2VUYWcgPSAnJztcblx0XHR2bS5zZWxlY3RlZEJyYW5jaCA9ICcnO1xuXG5cdFx0aWYgKHZtLnByb2plY3RJbmZvLmhhc0NvZGVJbmZvKSB7XG5cdFx0XHR2bS5sb2FkaW5nSW5zLnN0YXJ0TG9hZGluZygnYnJhbmNoJyk7XG5cdFx0XHQkZG9tZVByb2plY3QucHJvamVjdFNlcnZpY2UuZ2V0QnJhbmNoZXModm0ucHJvamVjdEluZm8ucHJvamVjdElkKS50aGVuKChyZXMpID0+IHtcblx0XHRcdFx0dm0uYnJhbmNoZXMgPSByZXMuZGF0YS5yZXN1bHQgfHwgW107XG5cdFx0XHR9KS5maW5hbGx5KCgpID0+IHtcblx0XHRcdFx0dm0ubG9hZGluZ0lucy5maW5pc2hMb2FkaW5nKCdicmFuY2gnKTtcblx0XHRcdH0pO1xuXHRcdFx0dm0ubG9hZGluZ0lucy5zdGFydExvYWRpbmcoJ3RhZycpO1xuXHRcdFx0JGRvbWVQcm9qZWN0LnByb2plY3RTZXJ2aWNlLmdldFRhZ3Modm0ucHJvamVjdEluZm8ucHJvamVjdElkKS50aGVuKChyZXMpID0+IHtcblx0XHRcdFx0dm0udGFncyA9IHJlcy5kYXRhLnJlc3VsdCB8fCBbXTtcblx0XHRcdH0pLmZpbmFsbHkoKCkgPT4ge1xuXHRcdFx0XHR2bS5sb2FkaW5nSW5zLmZpbmlzaExvYWRpbmcoJ3RhZycpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0dm0udG9nZ2xlQnVpbGRXYXkgPSAodHlwZSkgPT4ge1xuXHRcdFx0dm0uYnVpbGRXYXkgPSB0eXBlO1xuXHRcdFx0dm0uc2VhcmNoS2V5ID0gJyc7XG5cdFx0XHR2bS5zZWxlY3RlZEJyYW5jaCA9ICcnO1xuXHRcdH07XG5cdFx0dm0udG9nZ2xlQnJhbmNoID0gKGJyYW5jaCkgPT4ge1xuXHRcdFx0dm0uc2VsZWN0ZWRCcmFuY2ggPSBicmFuY2g7XG5cdFx0XHR2bS5zZWFyY2hLZXkgPSAnJztcblx0XHR9O1xuXHRcdHZtLmNsb3NlID0gKCkgPT4ge1xuXHRcdFx0JG1vZGFsSW5zdGFuY2UuZGlzbWlzcygnY2FuY2VsJyk7XG5cdFx0fTtcblx0XHR2bS50b0J1aWxkID0gKCkgPT4ge1xuXHRcdFx0bGV0IGJ1aWxkSW5mbyA9IHtcblx0XHRcdFx0cHJvamVjdElkOiB2bS5wcm9qZWN0SW5mby5wcm9qZWN0SWQsXG5cdFx0XHRcdGNvZGVJbmZvOiB7fSwgLy/ku6PnoIHkv6Hmga9cblx0XHRcdFx0aW1hZ2VJbmZvOiB7fSAvL+mVnOWDj+S/oeaBr1xuXHRcdFx0fTtcblx0XHRcdGlmICh2bS5wcm9qZWN0SW5mby5oYXNDb2RlSW5mbykge1xuXHRcdFx0XHRpZiAodm0uYnVpbGRXYXkgPT0gJ0JyYW5jaCcpIGJ1aWxkSW5mby5jb2RlSW5mby5jb2RlQnJhbmNoID0gdm0uc2VsZWN0ZWRCcmFuY2g7XG5cdFx0XHRcdGVsc2UgYnVpbGRJbmZvLmNvZGVJbmZvLmNvZGVUYWcgPSB2bS5zZWxlY3RlZEJyYW5jaDtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHZtLmltYWdlVGFnKSB7XG5cdFx0XHRcdGJ1aWxkSW5mby5pbWFnZUluZm8uaW1hZ2VUYWcgPSB2bS5pbWFnZVRhZztcblx0XHRcdH1cblx0XHRcdHZtLmxvYWRpbmdJbnMuc3RhcnRMb2FkaW5nKCdzdWJtaXQnKTtcblx0XHRcdCRkb21lUHJvamVjdC5wcm9qZWN0U2VydmljZS5idWlsZChidWlsZEluZm8pLnRoZW4oKHJlcykgPT4ge1xuXHRcdFx0XHRpZiAocmVzLmRhdGEucmVzdWx0Q29kZSA9PSAyMDApIHtcblx0XHRcdFx0XHQkbW9kYWxJbnN0YW5jZS5jbG9zZSgpO1xuXHRcdFx0XHRcdCRkb21lUHVibGljLm9wZW5Qcm9tcHQoJ+aIkOWKn++8jOato+WcqOaehOW7uu+8gScpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdCRtb2RhbEluc3RhbmNlLmNsb3NlKCk7XG5cdFx0XHRcdFx0JGRvbWVQdWJsaWMub3Blbldhcm5pbmcoJ+aehOW7uuWksei0pe+8gemUmeivr+S/oeaBr++8micgKyByZXMuZGF0YS5yZXN1bHRNc2cpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LCAoKSA9PiB7XG5cdFx0XHRcdCRkb21lUHVibGljLm9wZW5XYXJuaW5nKCfmnoTlu7rlpLHotKXvvIzor7fph43or5XvvIEnKTtcblx0XHRcdH0pLmZpbmFsbHkoKCkgPT4ge1xuXHRcdFx0XHR2bS5sb2FkaW5nSW5zLmZpbmlzaExvYWRpbmcoJ3N1Ym1pdCcpO1xuXHRcdFx0fSk7XG5cdFx0fTtcblx0fVxuXG5cdEJ1aWxkTW9kYWxDdHIuJGluamVjdCA9IFsncHJvamVjdEluZm8nLCAnJGRvbWVQcm9qZWN0JywgJyRkb21lUHVibGljJywgJyRtb2RhbEluc3RhbmNlJ107XG5cdGRvbWVBcHAuY29udHJvbGxlcignQnVpbGRNb2RhbEN0cicsIEJ1aWxkTW9kYWxDdHIpO1xuXG59KSh3aW5kb3cuZG9tZUFwcCk7Il19
